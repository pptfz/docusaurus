# CentOS7.6安装Confluence6.3.1

# 一、环境说明

## 1.1系统环境

```python
#本机IP
10.0.0.10


#系统版本
cat /etc/redhat-release 
CentOS Linux release 7.6.1810 (Core) 


#内核版本
uname -a
Linux test1 3.10.0-957.el7.x86_64 #1 SMP Thu Nov 8 23:39:32 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux


#内存
free -m
              total        used        free      shared  buff/cache   available
Mem:           1994         277         940          10         776        1545
Swap:             0           0           0


#磁盘
20G
```



## 1.2软件版本

```python
mysql5.7

confluence6.3.1
```





# 二、安装mysql、jdk

```python
//安装jdk
oracle官网自行下载jdk8
https://www.oracle.com/technetwork/java/javase/downloads/index.html

  
//安装mysql5.7
http://note.youdao.com/noteshare?id=8a342cde47a9182c419a3ce0686023bf
  
在mysql配置文件/etc/my.cnf中做以下操作
[mysqld]
character-set-server=utf8
collation-server=utf8_bin
default-storage-engine=INNODB
max_allowed-packet=34M
sql_mode=ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
innodb_log_file_size=256M
init_connect='SET collation_connection = utf8_unicode_ci'
init_connect='SET NAMES utf8'

[client]
default-character-set=utf8

[mysql]
default-character-set=utf8
```





# 三、相关安装包准备

```python
//百度网盘安装包
链接:https://pan.baidu.com/s/1flZnKbYYoujxC_y9i05lSQ  密码:4bqf

      
包中包含的软件包列表
atlassian-confluence-6.3.1-x64.bin
atlassian-extras-decoder-v2-3.2.jar
atlassian-universal-plugin-manager-plugin-2.22.jar
mysql-connector-java-5.0.8-bin.jar
```



# 四、安装过程

## 4.1上传安装包到服务器

```python
1.将包上传到服务器/usr/src下

2.cd /usr/src/confluence/ && ls
atlassian-confluence-6.3.1-x64.bin
atlassian-extras-decoder-v2-3.2.jar
atlassian-universal-plugin-manager-plugin-2.22.jar
mysql-connector-java-5.0.8-bin.jar
```



## 4.2创建confluence数据库并授权

```python
mysql> create database confluence;
mysql> grant all on confluence.* to confluence@'%' identified by 'confluence';
mysql> flush privileges;
```



## 4.3运行安装包

```python
//给confluence赋予执行权限
chmod +x atlassian-confluence-6.3.1-x64.bin

//运行安装包
./atlassian-confluence-6.3.1-x64.bin
```

**安装过程**

![image-20191224203341786](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224203341786.png)



**confluence安装到了/opt/atlassian/confluence和/var/atlassian/application-data/confluence目录下，并且confluence默认监听的端口是8090**



⚠️

**confluence的主要配置文件为/opt/atlassian/confluence/conf/server.xml，和jira类似。此server.xml相当于tomcat中的server.xml配置文件，如果要修改访问端口，可以这里修改。**
**如果要修改confluence的数据目录，可以在安装的时候，在安装过程中进行更换（默认是/var/atlassian/application-data/confluence）！**



## 4.4查看confluence启动

```python
//confluence两个默认端口8000和8090已经启动
netstat -ntpl|tail -2
tcp6       0      0 :::8090                 :::*                    LISTEN      16640/java          
tcp6       0      0 127.0.0.1:8000          :::*                    LISTEN      16640/java          

```



## 4.5浏览器访问confluence

**10.0.0.10:8090**

**选择语言为中文**

![image-20191224203913159](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224203913159.png)



**选择产品安装，然后下一步**

![image-20191224204005490](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224204043835.png)





**可选插件，自行选择，然后下一步**

![image-20191224204043835](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224204212482.png)



**获取服务器ID**

![image-20191224204212482](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224211746770.png)



**⚠️⚠️⚠️这里要把相应的破解包拷贝到confluence目录下**

```python
1.先备份文件，方便回退
cp /opt/atlassian/confluence/confluence/WEB-INF/lib/atlassian-extras-decoder-v2-3.2.jar /tmp
cp /opt/atlassian/confluence/confluence/WEB-INF/atlassian-bundled-plugins/atlassian-universal-plugin-manager-plugin-2.22.1.jar /tmp

2.将破解文件拷贝到confluence中
\cp /usr/src/confluence/atlassian-extras-decoder-v2-3.2.jar /opt/atlassian/confluence/confluence/WEB-INF/lib/atlassian-extras-decoder-v2-3.2.jar
\cp /usr/src/confluence/atlassian-universal-plugin-manager-plugin-2.22.jar /opt/atlassian/confluence/confluence/WEB-INF/atlassian-bundled-plugins/
```



**登陆atlassian，可以选择谷歌账号或者微软账号**

![image-20191224211203784](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224212109710.png)



**选择New Trial License**

![image-20191224211746770](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224211203784.png)





**相关选择，生成授权码**

![image-20191224212109710](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224212232994.png)



**⚠️⚠️⚠️这一步是自动弹出的，必须有，否则否许会报错服务器错误！！！**

![image-20191224215447557](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224204005490.png)





**复制生成的key**

![image-20191224212232994](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224212648251.png)



**将复制的授权码粘贴到confluence授权码框中**

![image-20191224212648251](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224213231675.png)





**配置集群节点，在2G内存的虚拟机中安装会提示这一步，建了貌似也没什么影响**

![image-20191224215610671](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224213352961.png)





**选择数据库**

![image-20191224212805105](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224213102162.png)



**点击外部数据库后会有一个报错**

![image-20191224213102162](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224215610671.png)



⚠️**需要把mysql的驱动放到/opt/atlassian/confluence/lib**

```python
//当前路径
pwd
/usr/src/confluence

//拷贝mysql驱动
cp /usr/src/confluence/mysql-connector-java-5.0.8-bin.jar /opt/atlassian/confluence/lib/

//重启confluence
/etc/init.d/confluence restart
```



**重启后选择JDBC**

![image-20191224213231675](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224212805105.png)





**配置数据库连接**

![image-20191224213352961](https://gitee.com/pptfz/picgo-images/raw/master/img/image-20191224215447557.png)









测试confluence mysql连接，报错Collation error The database collation 'utf8_general_ci' is not supported by Confluence.

create database confluence character set utf8 collate utf8_bin;



报错：您的数据库必须使用'READ-COMMITTED'作为默认隔离级别。

```
SET GLOBAL tx_isolation='READ-COMMITTED';
```



