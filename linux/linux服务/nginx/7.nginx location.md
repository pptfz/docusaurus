[toc]



# nginx location

[nginx location官方文档](https://nginx.org/en/docs/http/ngx_http_core_module.html#location)



# 匹配语法

```nginx
location [ = | ~ | ~* | ^~ ] uri { ... }
location @name { ... }
```



```nginx
location [匹配模式] uri {
...
}
```





# location匹配规则

**匹配规则总览**

| **匹配模式**         | **匹配符** | **优先级** |
| -------------------- | ---------- | ---------- |
| **精确匹配**         | **=**      | **1**      |
| **前缀匹配**         | **^~**     | **2**      |
| **正则匹配**         | **~**      | **3**      |
| **正常匹配**         | **uri**    | **4**      |
| **全匹配(通用匹配)** | **/**      | **5**      |



**匹配规则细分**

| **匹配符** | **匹配规则**                     | **优先级** |
| ---------- | -------------------------------- | ---------- |
| **=**      | **精确匹配**                     | **1**      |
| **^~**     | **以某个字符串开头**             | **2**      |
| **~**      | **区分大小写的正则匹配**         | **3**      |
| **~***     | **不区分大小写的正则匹配**       | **4**      |
| **!~**     | **区分大小写不匹配的正则**       | **5**      |
| **!~***    | **不区分大小写不匹配的正则**     | **6**      |
| **/**      | **通用匹配，任何请求都会匹配到** | **7**      |







# location匹配优先级

路径匹配优先级

- 精确匹配 > 前缀匹配 > 正则匹配 > 正常匹配 > 全匹配



# 匹配示例

## 精确匹配

**⚠️`server_name _ 中的_只是一个无效域名的表示方法`**



**编辑nginx配置文件**

```nginx
server {
  listen 80;
  server_name _;
  # 第1段
  location /nginx {
    #return 200 "aaa";
    root /data/nginx/html4/;
    index index.html;
  }

  # 第2段
  location = /nginx {
    #return 200 "bbb";
    root /data/nginx/html3/;
    index index.html;
  }
}
```

创建网站根目录

```shell
mkdir -p /data/nginx/html{3,4}/nginx
echo 'html3' >/data/nginx/html3/nginx/index.html
echo 'html4' >/data/nginx/html4/nginx/index.html
```

访问测试

```shell
$ curl 127.0.0.1/nginx
<html>
<head><title>301 Moved Permanently</title></head>
<body>
<center><h1>301 Moved Permanently</h1></center>
<hr><center>nginx/1.18.0</center>
</body>
</html>

$ curl 127.0.0.1/nginx/
html4
```

精确匹配中 `/nginx/` 中优先匹配到第2段，再访问 `/nginx/index.html`，此次内部跳转uri已经是 `/nginx/index.html`，而非 ` = ` 的，最终访问结果是第1段中的 `index.html`。



:::info

**结论：精确匹配区分大小写，不能使用正则，访问的URI必须完全与 `=` 后面的一致，多一个 `/` 或者少一个 `/` ，都是不可以的**

:::









## 前缀匹配

**编辑nginx配置文件**

```nginx
server {
  listen 80;
  server_name _;
  location ^~ /nginx/ {
    rewrite ^ https://www.163.com break;
  }

  location ^~ /nginx/bcd/ {
    rewrite ^ https://www.qq.com break;
  }

  location ^~ /Abc/ {
    rewrite ^ https://www.sina.com.cn break;
  }
}
```

**访问测试**

访问`127.0.0.1/nginx/`，在终端中会返回302，在浏览器中会跳转到`www.163.com`

```shell
$ curl 127.0.0.1/nginx/
<html>
<head><title>302 Found</title></head>
<body>
<center><h1>302 Found</h1></center>
<hr><center>nginx/1.18.0</center>
</body>
</html>
```



访问`127.0.0.1/nginx/bcd/`，在终端中会返回302，在浏览器中会跳转到`www.qq.com`

⚠️如果bcd后边不加 `/` ，跳转页面是`www.163.com`，即只匹配前缀 `/nginx`

```shell
$ curl 127.0.0.1/nginx/bcd/
<html>
<head><title>302 Found</title></head>
<body>
<center><h1>302 Found</h1></center>
<hr><center>nginx/1.18.0</center>
</body>
</html>
```



访问一个不存在的页面`127.0.0.1/nginx/abcd/`，在终端中会返回302，在浏览器中会跳转到`www.163.com`

```shell
$ curl 127.0.0.1/nginx/abcd/
<html>
<head><title>302 Found</title></head>
<body>
<center><h1>302 Found</h1></center>
<hr><center>nginx/1.18.0</center>
</body>
</html>
```



访问`127.0.0.1/Abc/`，在终端中会返回302，在浏览器中会跳转到`www.sina.com.cn`

```shell
$ curl 127.0.0.1/nginx/abc/
<html>
<head><title>302 Found</title></head>
<body>
<center><h1>302 Found</h1></center>
<hr><center>nginx/1.18.0</center>
</body>
</html>
```



:::info

**结论：前缀匹配不能使用正则，区分大小写，只要前缀相同，都可以匹配成功，不管后面有没有字符，保证前缀相同即可**

:::





## 正则匹配

**编辑nginx配置文件**

```nginx
server {
  listen 80;
  server_name _;

  location ~ /[a-z]nginx/ {
    rewrite ^ https://www.baidu.com break;
  }

  location ~* /[a-z]nginx/ {
    rewrite ^ https://www.163.com break;
  }
}
```



**访问测试**

访问`127.0.0.1/anginx/`，在终端中会返回302，在浏览器中会跳转到`www.baidu.com`

```shell
$ curl 127.0.0.1/anginx/
<html>
<head><title>302 Found</title></head>
<body>
<center><h1>302 Found</h1></center>
<hr><center>nginx/1.18.0</center>
</body>
</html>
```



访问`127.0.0.1/anginx/abc`在终端中会返回302，在浏览器中会跳转到`www.baidu.com`

```shell
$ curl 127.0.0.1/anginx/abc/
<html>
<head><title>302 Found</title></head>
<body>
<center><h1>302 Found</h1></center>
<hr><center>nginx/1.18.0</center>
</body>
</html>
```



访问`127.0.0.1/Anginx/`，在终端中会返回302，在浏览器中会跳转到`www.163.com`

```shell
$ curl 127.0.0.1/Anginx/
<html>
<head><title>302 Found</title></head>
<body>
<center><h1>302 Found</h1></center>
<hr><center>nginx/1.18.0</center>
</body>
</html>
```



:::info

**结论：正则匹配 `~` 区分大小写，`~*` 不区分大小写, 并且与前缀匹配比较类似，只需要匹配模式开头部分，这两种同时存在时，优先匹配区分大小写的**

:::

## 正常匹配

- 正常匹配就是匹配模式为空的匹配规则



**编辑 nginx配置文件**

```nginx
server {
  listen 80;
  server_name _;

  # 第1段
  location /nginx/ {
    rewrite ^ https://www.baidu.com break;
  }

  # 第2段
  location /[0-9]nginx/ {
    rewrite ^ https://www.qq.com break;
  }
}
```



**访问测试**

访问`127.0.0.1/nginx/`，在终端中会返回302，在浏览器中会跳转到`www.baidu.com`

```shell
$ curl 127.0.0.1/nginx/
<html>
<head><title>302 Found</title></head>
<body>
<center><h1>302 Found</h1></center>
<hr><center>nginx/1.18.0</center>
</body>
</html>
```



上述配置文件中第2段访问不生效，404



**⚠️`location ^~ /nginx/`与`location /nginx/`不能同时出现**

:::info

**结论：正常匹配与前缀匹配的差别，只在于优先级**

:::

## 全匹配(通用匹配)

**编辑nginx配置文件**

```nginx
server {
  listen 80;
  server_name _;

  location / {
    root /data/nginx/html;
    index index.html index.htm;
  }
}
```



**全匹配没有匹配模式，并且匹配的uri仅是一个斜杠/，通常用在一个默认页面的地方**



## 命名匹配

**命名匹配一般用于静态页面或者错误页面(404，500等)，并且这个命名匹配中，不允许有alias。**

```shell
error_page 404 = @notfound;
location @notfound {
  rewrite ^ https://www.baidu.com break;
}
```





















