# zabbix3.4自定义监控项

# 一、实验环境

| **服务器角色** | **ip**     | **主机名**    |
| -------------- | ---------- | ------------- |
| zabbix-server  | 10.0.0.200 | zabbix-server |
| zabbix-agent   | 10.0.0.10  | test1         |



# 二、zabbix自定义监控项整体过程

## 2.1在对应的agent主机上编写自定义监控TCP的11种状态（在agent本地进行取值）

```python
#进到/etc/zabbix/zabbix_agentd.d
[root@test1 zabbix_agentd.d]# pwd
/etc/zabbix/zabbix_agentd.d

#编写自定义取值文件
[root@test1 zabbix_agentd.d]# cat > tcp_state.conf <<EOF
UserParameter=tcp_state[*],ss -an|awk '{print $2}'|grep -i "$1"|wc -l
EOF

#重启zabbix-agent
[root@test1 zabbix_agentd.d]# systemctl restart zabbix-agent
```



## 2.2在server上使用zabbix_get获取对应主机的值

```python
[root@test1 zabbix-server]# zabbix_get -s 10.0.0.10 -k tcp_state[estb]
```



## 2.3在web界面添加

- **监控项**   

- **将监控项制作了一个图形**

- **将主机关联该 TCP状态的模板**



# 三、创建zabbix自定义监控项

## 3.1自定义监控tcp11种状态(传参方式，在本地取值)

```python
//创建自定义监控项文件
[root@test ~]# cd /etc/zabbix/zabbix_agentd.d/ 
[root@test ~]# cat > tcp_state.conf <<EOF
UserParameter=tcp_state[*],ss -an|awk '{print $2}'|grep -i "$1"|wc -l
EOF

//重启zabbix-agent 
[root@zabbix-agent ~]# systemctl restart zabbix-agent 

//zabbix-server测试 
[root@zabbix-server ~]# zabbix_get -s 10.0.0.10 -k tcp_state[LISTEN] 
258
```



## 3.2在zabbix-web端先创建模板

**配置-->模板-->创建模板**

![1](5.zabbix3.4自定义监控项.assets/1.png)

**添加模板后可以在配置-->模板中看到刚新建的模板**

**![2](5.zabbix3.4自定义监控项.assets/2.png)**



## 3.3点击创建的模板中的监控项，不要点主机中的监控项，然后点击创建监控项

![3](5.zabbix3.4自定义监控项.assets/3.png)

点击添加后就可以看到刚创建的监控项

![4](5.zabbix3.4自定义监控项.assets/4.png)

## 3.4利用克隆快速添加监控项

**点击刚创建的监控项**

![5](5.zabbix3.4自定义监控项.assets/5.png)

**点击克隆**

![6](5.zabbix3.4自定义监控项.assets/6.png)

**然后填写信息，再点击最下方添加**

![7](5.zabbix3.4自定义监控项.assets/7.png)

**其余tcp状态依照克隆方法依次添加**

![8](5.zabbix3.4自定义监控项.assets/8.png)

tcp12种状态，tcp_state.conf为在agent端/etc/zabbix/zabbix_agentd.d路径下创建的文件中自定义的

```python
[root@test1 zabbix_agentd.d]# cat tcp_state.conf 
UserParameter=tcp_state[*],ss -an|awk '{print $2}'|grep -i "$1"|wc -l
```



> tcp_state[ESTABLISHED]
>
> tcp_state[SYN-SENT]
>
> tcp_state[SYN-RECV]
>
> tcp_state[FIN-WAIT1]
>
> tcp_state[FIN-WAIT2]
>
> tcp_state[TIME-WAIT]
>
> tcp_state[CLOSE]
>
> tcp_state[CLOSE-WAIT]
>
> tcp_state[LAST-ACK]
>
> tcp_state[LISTEN]
>
> tcp_state[CLOSING]
>
> tcp_state[UNKNOWN]



**在配置-->模板中可以看新建的模板的信息，此时的模板是新建的，与主机没有任何关系，除非主机链接这个模板，这里可以看到有刚创建的12项监控项，但是没有图形，需要手动再创建图形**

![9](5.zabbix3.4自定义监控项.assets/9.png)



## 3.5创建图形

**配置-->模板-->创建的模板(这里为Linux TCP Status)-->图形-->创建图形**



![clipboard](5.zabbix3.4自定义监控项.assets/clipboard.png)

![11](5.zabbix3.4自定义监控项.assets/11.png)

**添加后的图形**

![12](5.zabbix3.4自定义监控项.assets/12.png)

**配置-->模板-->新建的模板 可以看到刚创建的图形**

![13](5.zabbix3.4自定义监控项.assets/13.png)



**配置-->主机-->模板**

![Xnip2020-01-14_17-11-58](5.zabbix3.4自定义监控项.assets/Xnip2020-01-14_17-11-58.jpg)

![Xnip2020-01-14_17-14-24](5.zabbix3.4自定义监控项.assets/Xnip2020-01-14_17-14-24.jpg)

**查看图形，监测中-->最新数据**

![15](5.zabbix3.4自定义监控项.assets/15.png)

