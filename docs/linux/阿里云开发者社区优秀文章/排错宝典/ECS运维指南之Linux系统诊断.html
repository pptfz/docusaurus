<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-linux/阿里云开发者社区优秀文章/排错宝典/ECS运维指南之Linux系统诊断" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">ECS运维指南之Linux系统诊断 | 我的站点</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://pptfz.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://pptfz.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://pptfz.github.io/docs/linux/阿里云开发者社区优秀文章/排错宝典/ECS运维指南之Linux系统诊断"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="ECS运维指南之Linux系统诊断 | 我的站点"><meta data-rh="true" name="description" content="[toc]"><meta data-rh="true" property="og:description" content="[toc]"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://pptfz.github.io/docs/linux/阿里云开发者社区优秀文章/排错宝典/ECS运维指南之Linux系统诊断"><link data-rh="true" rel="alternate" href="https://pptfz.github.io/docs/linux/阿里云开发者社区优秀文章/排错宝典/ECS运维指南之Linux系统诊断" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://pptfz.github.io/docs/linux/阿里云开发者社区优秀文章/排错宝典/ECS运维指南之Linux系统诊断" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://SICNXLSDBZ-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="我的站点" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.061a1b25.css">
<script src="/assets/js/runtime~main.3599ad11.js" defer="defer"></script>
<script src="/assets/js/main.21de94ca.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="announcementBar_mb4j" style="background-color:pink;color:@091E42" role="banner"><div class="content_knG7 announcementBarContent_xLdY">一名运维，两台电脑，三餐不定，只为设备工作四平八稳，拼得五脏俱损，六神无主，仍然七点起床，八点出发，晚上九点不返，十分辛苦！<br> 十年运维，九转功成，八面张罗，忙得七窍流血，换得六神不宁，五体欠安，仍然四处奔波，三更不眠，只为两个铜板，一生拼搏！</div></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">我的站点</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">笔记</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs">😂 😂  😂</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/github/github下载加速">github</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/go/go功能脚本/k8s/获取k8s集群资源配置">go</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/idea/vscode/vscode好用的插件">idea</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/linux/big-data/Ambari/CentOS7中用Ambari快速搭建大数据平台">linux</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/big-data/Ambari/CentOS7中用Ambari快速搭建大数据平台">big-data</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/git/CentOS7编译安装git">git</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/kvm/安装/kvm安装">kvm</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/linux其他/CentOS7安装字体">linux其他</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/linux内核/Linux升级内核">linux内核</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/linux命令/Linux权限总结">linux命令</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/linux实用开源小工具/bat">linux实用开源小工具</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/linux服务/VPN/CentOS7一键安装OpenVPN">linux服务</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/linux系统/deepin/deepin15.11使用记录">linux系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/monitor/grafana/安装/grafana安装">monitor</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/openstack/mitaka/centos7.8搭建openstack Mitaka版">openstack</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/shell/expect自动化交互式程序">shell</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/包管理工具/gvm/gvm安装">包管理工具</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/性能测试/文件删除效率测试/测试Linux下删除大量文件的效率">性能测试</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/日志/Linux 日志切割神器 Logrotate 原理和配置详解">日志</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/生产环境开源项目/bi工具/superset/superset安装">生产环境开源项目</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/生产问题总结/ssh/记录一次诡异的ssh连接问题">生产问题总结</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/linux/科学上网">科学上网</a><button aria-label="展开侧边栏分类 &#x27;科学上网&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/网络协议/http/HTTP 协议">网络协议</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/自动化运维平台/ansible/ansible playbook">自动化运维平台</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/linux/阿里云开发者社区优秀文章/shell脚本/shell脚本速查手册">阿里云开发者社区优秀文章</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/linux/阿里云开发者社区优秀文章/shell脚本/shell脚本速查手册">shell脚本</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/linux/阿里云开发者社区优秀文章/排错宝典/ECS运维指南之Linux系统诊断">排错宝典</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/linux/阿里云开发者社区优秀文章/排错宝典/ECS运维指南之Linux系统诊断">ECS运维指南之Linux系统诊断</a></li></ul></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/mac专区/brew安装">mac专区</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/python/python-other/nginx+django+uwsgi部署项目">python</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/web/css/css基础知识">web</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/云原生/k8s/helm/helm3安装">云原生</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/其他/wps/wps冻结窗口">其他</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/博客工具/Docusaurus/Docusaurus 安装">博客工具</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/操作小技巧/linux/linux一些骚操作">操作小技巧</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/数据库/mongodb/centos7安装mongodb">数据库</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/翻车问题合集/翻车问题-ssh密钥问题">翻车问题合集</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">linux</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">阿里云开发者社区优秀文章</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">排错宝典</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">ECS运维指南之Linux系统诊断</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><p>[toc]</p>
<h1>ECS运维指南之Linux系统诊断</h1>
<p><a href="https://developer.aliyun.com/topic/ebook" target="_blank" rel="noopener noreferrer">文档抄袭于阿里云开发者社区</a></p>
<h1>目录</h1>
<p>Linux启动与登陆问题</p>
<ul>
<li>
<p>超详细系统启动与登陆异常排查点</p>
</li>
<li>
<p>grub.conf 文件内容被清空了怎么办</p>
</li>
<li>
<p>巧妙利用 strace 查找丢失的文件</p>
</li>
<li>
<p>小心 PAM 不让你登录</p>
</li>
<li>
<p>CentOS 登录卡住的原因被我找到了</p>
</li>
</ul>
<p>Linux 性能问题</p>
<ul>
<li>
<p>找到 Linux 虚机 Load 高的&quot;元凶&quot;</p>
</li>
<li>
<p>OOM killer 是被谁触发的</p>
</li>
<li>
<p>我的服务器内存去哪儿了</p>
</li>
<li>
<p>CPU 占用不高但网络性能很差的一个原因</p>
</li>
<li>
<p>一次 IO 异常捕获过程</p>
</li>
</ul>
<p>Linux 主机网络问题</p>
<ul>
<li>
<p>ifdown ifup 命令丢失处理</p>
</li>
<li>
<p>网络不通？ strace 二度出手</p>
</li>
<li>
<p>TIME_WAIT &amp; CLOSE_WAIT 的讨论总结</p>
</li>
<li>
<p>一次网络抖动经典案例分析</p>
</li>
</ul>
<p>Linux 系统服务与参数问题</p>
<ul>
<li>
<p>4 个 limits 生效的问题</p>
</li>
<li>
<p>6 步排查 ss&amp; netstat 统计结果不一样的原因</p>
</li>
<li>
<p>为什么明明内存很充足但是 java 程序仍申请不到内存</p>
</li>
<li>
<p>请不要忽略 min_free_kbytes 的设置</p>
</li>
</ul>
<p>最后的彩蛋</p>
<ul>
<li>某地区口罩项目架构演进及优化经验</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1linux启动与登陆问题">1.Linux启动与登陆问题<a href="#1linux启动与登陆问题" class="hash-link" aria-label="1.Linux启动与登陆问题的直接链接" title="1.Linux启动与登陆问题的直接链接">​</a></h2>
<p><strong>说明</strong></p>
<blockquote>
<p><strong>Linux 启动与登录问题是 ECS 的高频问题，而往往处理不及时会直接影响到用户业务的正常可持续运行，因此也变成了我们处理问题优先级的重中之重。 在云环境上影响 ECS 启动与登录的因素非常多，镜像、管控、虚拟化、底层硬件、系统与文件异常等等，本文仅从系统与文件本身角度，在大量处理经验的基础上，归纳总结了一些可能会引起系统启动与登录问题的排查点，并给出几个比较常见的典型案例来具体展示和说明。</strong></p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-超详细系统启动与登陆异常排查点">1.1 超详细系统启动与登陆异常排查点<a href="#11-超详细系统启动与登陆异常排查点" class="hash-link" aria-label="1.1 超详细系统启动与登陆异常排查点的直接链接" title="1.1 超详细系统启动与登陆异常排查点的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="111-系统启动异常">1.1.1 系统启动异常<a href="#111-系统启动异常" class="hash-link" aria-label="1.1.1 系统启动异常  的直接链接" title="1.1.1 系统启动异常的直接链接">​</a></h4>
<ul>
<li>
<p>部分 CentOS 系统启动黑屏，无异常报错的场景，可以 fsck 一下系统盘。</p>
</li>
<li>
<p>根分区空间满，以及 inode 数量耗尽。</p>
</li>
<li>
<p>升级内核或者从老的共享实例迁移到独享规格导致的启动异常。</p>
<ul>
<li>手动注入驱动 (mkinitrd virtio 相关驱动 )。</li>
<li>修改 grub 的启动顺序，优先尝试使用老内核启动。</li>
<li>/boot 目录下面内核的关联文件是否全（下面仅为 demo，不同系统内核版 本文件不一致，部分内核版本 boot 下的 i386 目录也是有用的）。</li>
</ul>
</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">config-4.9.0-7-amd64</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">initrd.img-4.9.0-7-amd64</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">System.map-4.9.0-7-amd64</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vmlinuz-4.9.0-7-amd64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>
<p><code>/boot/grub/device.map</code> 里面的 hda 改成 vda。</p>
</li>
<li>
<p><code>fstab/grub</code> 中的 uuid 不对，可以直接修改为 <code>/dev/vda1</code> 这种形式尝试。 数据盘分区异常加载起不来的场景，可以去注释 fstab 所有的行，添加类似下面的启动项尝试， 也适用于系统盘快照创建云盘挂载后，uuid 一致导致的启动异 常，改成非 UUID 的挂载即可。</p>
</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/dev/vda1 / ext4 defaults 1 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>根目录权限 777（部分目录 777）也会导致启动异常，或者 ssh 登陆异常。</li>
</ul>
<p><a href="https://yq.aliyun.com/articles/761371" target="_blank" rel="noopener noreferrer">可参考此文章权限修复尝试</a></p>
<ul>
<li>常见的关键目录缺失，有的是软链，也可以看看对应目录下面的文件数量（文件数量要跟同内核版本或者相差不大的版本对比），简单判断。</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin /sbin /lib /lib32 /lib64 /etc /boot /usr/bin /usr/sbin /usr/lib / usr/lib64 等目录或文件缺失</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">for i in /bin /sbin /lib /lib32 /lib64 /etc /boot /usr/bin /usr/sbin / usr/lib /usr/lib64 ;do ls -l $i |wc -l ;done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>影响启动的参数。 如果参数设置不当，是会导致启动异常的，如 <code>/etc/sysctl.conf</code> 以及检查 <code>rc.local</code> 的配置，<code>profile</code> 的检查。</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm.nr_hugepages</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm.min_free_kbytes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>CentOS 的 selinux 需要关闭。</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># This file controls the state of SELinux on the system.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># SELINUX= can take one of these three values:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#     enforcing - SELinux security policy is enforced.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#     permissive - SELinux prints warnings instead of enforcing.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#     disabled - No SELinux policy is loaded.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SELINUX=disabled</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># SELINUXTYPE= can take one of three two values:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#     targeted - Targeted processes are protected,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#     minimum - Modification of targeted policy. Only selected processes are protected. </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#     mls - Multi Level Security protection.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SELINUXTYPE=targeted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="112-root-登陆异常">1.1.2 root 登陆异常<a href="#112-root-登陆异常" class="hash-link" aria-label="1.1.2 root 登陆异常的直接链接" title="1.1.2 root 登陆异常的直接链接">​</a></h4>
<ul>
<li>
<p><code>/etc/passwd</code>、<code>/etc/shadow</code> ( 用户名 root polikt dbus 等关键用户存在与否，文 件为空，格式乱（dos2unix)。</p>
</li>
<li>
<p><code>/etc/pam.d</code> 目录下是否有为空的文件及参数设置是否正常， 如常见的 <code>system-auth passwd</code>。</p>
</li>
<li>
<p><code>/etc/pam.d</code> 下面所有文件里面涉及的 so 文件，看看文件是否存在，是否为空 <code>/ usr/lib64/security</code>。</p>
</li>
<li>
<p>查 <code>/etc /lib64</code>、 <code>/bin</code>、 <code>/sbin</code>、<code>/usr/bin</code>、 <code>/usr/sbin</code> 等目录有没有 size 为 0 的文件。</p>
</li>
<li>
<p><code>/etc/profile</code>、<code>/etc/profile.d</code>( 打 印 列 表 )、 <code>/etc/bashrc</code>、 <code>/root/.bash_profile</code>、<code>/root/.bashrc</code> 等涉及登陆环境设置的文件是否异常。</p>
</li>
<li>
<p>注意内核版本，是否存在新老内核，多更换几个内核试下。</p>
</li>
<li>
<p>系统日志也是一个比较重要的检查项（后面会介绍无法登陆怎么检查）。</p>
</li>
<li>
<p>Ubuntu 12.04 登陆异常在 <code>/etc/login.defs</code> 里面配置了错误的 <code>ERASECHAR</code> 导致，恢复默认 0177 即可。</p>
</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">configuration error - cannot parse erasechar value</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>输入 root 后直接 login 失败三连，日志如下。</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Feb 12 18:18:03 iZbp1cabe6lyx26ikmjie2Z login: FAILED LOGIN 1 FROM tty1 FOR root, Authentication failure</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Feb 12 18:18:03 iZbp1cabe6lyx26ikmjie2Z login: FAILED LOGIN 2 FROM tty1 FOR (unknown), Authentication failure</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Feb 12 18:18:03 iZbp1cabe6lyx26ikmjieZZ login: FAILED LOGIN SESSION FROM tty1 FOR (unknown), Authentication failure</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>找个同内核版本的机器对比发现没有 <code>/etc/pam.d/login</code>。</p>
<p>rpm 包校验一下，确认 login 文件没了，手动创建一个，内容拷贝过来，好了。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[root@iZbp1cabe6lyx26ikmjie2Z pam.d]# rpm -V util-linux </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">missing c /etc/pam.d/login</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[root@iZbp1cabe6lyx26ikmjie2Z pam.d]# rpm -ql util-linux|egrep -vi &quot;gz|mo|share&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/etc/mtab</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/etc/pam.d/chfn</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/etc/pam.d/chsh</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/etc/pam.d/login</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/etc/pam.d/runuser</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/etc/pam.d/runuser-l</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/etc/pam.d/su</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/etc/pam.d/su-l</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>
<p><code>/etc/ssh/sshd_config</code> 相关参数如 <code>LoginGraceTime/Allowusers/PermitRootLogin</code>。</p>
</li>
<li>
<p>问题不好确认的时候， 可以将 shadow 密码字段清空， 看看登陆是否正常， 可以判断是否到密码验证阶段了。 之前有过一篇关于 ssh 问题排查的文档，可参考：<a href="https://yq.aliyun.com/articles/540769" target="_blank" rel="noopener noreferrer">ssh问题排查指南</a></p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="113-系统登陆不进去了不挂盘的情况下怎么操作">1.1.3 系统登陆不进去了，不挂盘的情况下怎么操作？<a href="#113-系统登陆不进去了不挂盘的情况下怎么操作" class="hash-link" aria-label="1.1.3 系统登陆不进去了，不挂盘的情况下怎么操作？的直接链接" title="1.1.3 系统登陆不进去了，不挂盘的情况下怎么操作？的直接链接">​</a></h4>
<p>上面的检查点很多是需要切换到另外的系统环境下去做检查，比如挂载 LiveCD 或者 chroot 切换；但对于使用 ECS 的用户来说，阿里云暂还未提供实例挂载 ISO 镜像的功能，那么如何进行上面的操作呢？可以借助阿里云新推出的卸载系统盘功能，可以把系统盘卸载掉，作为数据盘挂载到一个新的机器，这样就可以执行上面的检查了。</p>
<p><a href="https://help.aliyun.com/document_detail/146752.html" target="_blank" rel="noopener noreferrer">帮助文档</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="114-场景覆盖">1.1.4 场景覆盖<a href="#114-场景覆盖" class="hash-link" aria-label="1.1.4 场景覆盖的直接链接" title="1.1.4 场景覆盖的直接链接">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1141-linux-系统常见问题诊断覆盖以下场景">1.1.4.1 Linux 系统常见问题诊断覆盖以下场景<a href="#1141-linux-系统常见问题诊断覆盖以下场景" class="hash-link" aria-label="1.1.4.1 Linux 系统常见问题诊断覆盖以下场景的直接链接" title="1.1.4.1 Linux 系统常见问题诊断覆盖以下场景的直接链接">​</a></h5>
<ul>
<li>常用端口是否正确监听（包括ssh端口、80、443)</li>
<li>常用端口安全组检测（包括ssh端口、80、443)</li>
<li><code>tcp_timestamps&amp;tcp_tw_recycle</code>参数检测</li>
<li>cpu占用高分析</li>
<li>fstab配置问题</li>
<li>软链接缺失</li>
<li>ssh相关文件权限异常（比如文件权限777)</li>
<li>selinux启用检测</li>
<li>hugepage参数检测</li>
<li>iptables启用检测</li>
<li><code>/etc/security/limits.conf</code>配置检查</li>
<li><code>/etc/passwd</code>等文件格式校验</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1142-linux-系统常见启动问题修复覆盖以下场景">1.1.4.2 Linux 系统常见启动问题修复覆盖以下场景<a href="#1142-linux-系统常见启动问题修复覆盖以下场景" class="hash-link" aria-label="1.1.4.2 Linux 系统常见启动问题修复覆盖以下场景的直接链接" title="1.1.4.2 Linux 系统常见启动问题修复覆盖以下场景的直接链接">​</a></h5>
<ul>
<li>系统启动-fsck检测修复</li>
<li>系统启动-磁盘/inode占满</li>
<li>系统启动-系统文件/软链接检测</li>
<li>系统启动-根目录/ssh目录777</li>
<li>系统启动-fstab/grub校验</li>
<li>系统启动-selinux检测</li>
<li>系统启动-sysctl内核参数hugepage&amp;minfree检测</li>
<li>vnc登陆-sshdconfig配置检测</li>
<li>vnc登陆-passwd/shadow文件格式&amp;用户检测</li>
<li>vnc登陆-pam.d文件&amp;配置检测</li>
<li>vnc登陆-相关目录0size文件检测</li>
<li>vnc登陆-profile/bashrc检测</li>
<li>vnc登陆-多内核检测</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="115-各种脚本">1.1.5 各种脚本<a href="#115-各种脚本" class="hash-link" aria-label="1.1.5 各种脚本的直接链接" title="1.1.5  各种脚本的直接链接">​</a></h4>
<p><a href="https://public-beijing.oss-cn-beijing.aliyuncs.com/oos/caiji.sh" target="_blank" rel="noopener noreferrer">OS参数收集脚本</a></p>
<p><a href="https://github.com/huigher/os-performance-optimization" target="_blank" rel="noopener noreferrer">OS优化脚本 github链接</a></p>
<p><a href="https://xiaoling-public.oss-cn-hangzhou.aliyuncs.com/os_performance_optimization.py" target="_blank" rel="noopener noreferrer">OS优化脚本OSS链接</a></p>
<p>[OS离线修复脚本](<a href="https://public-beijing.oss-cn-beijing.aliyuncs.com/oo" target="_blank" rel="noopener noreferrer">https://public-beijing.oss-cn-beijing.aliyuncs.com/oo</a> oos_noak.sh)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-grubconf-文件内容被清空了怎么办">1.2 grub.conf 文件内容被清空了怎么办<a href="#12-grubconf-文件内容被清空了怎么办" class="hash-link" aria-label="1.2 grub.conf 文件内容被清空了怎么办的直接链接" title="1.2 grub.conf 文件内容被清空了怎么办的直接链接">​</a></h3>
<p><strong>简介</strong></p>
<blockquote>
<p><strong>/boot/grub/grub.conf 被清空，系统启动就进入 grub 状态（CentOS 6.8）。</strong></p>
</blockquote>
<ul>
<li>
<p><code>find /boot/grub/stage1</code>。 显示为（hd0,0）。</p>
</li>
<li>
<p>确认一下内核的具体版本 <code>ls -l /boot</code></p>
</li>
<li>
<p>手动设置 grub 具体步骤如下</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">grub&gt; root (hd0,0) # 是说跟分区在第一块硬盘的第 1 个分区 实际对于前面的 find 出来的那个文件</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">grub&gt; kernel /boot/vmlinuz-2.6.32-696.3.2.el6.x86_64 ro root=/dev/vda1 # 指明内核路径和根分区，注意 ro 是只读</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">grub&gt; initrd /boot/initramfs-2.6.32-696.3.2.el6.x86_64.img # 指明 initramfs 路径启动系统加载驱动</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">grub&gt; boot # 启动上面指定的系统，如果是 reboot 就等于重启整个系统了，刚才的设置就失效了</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果没有报错的话，即可成功启动，进入到系统内部后需要继续支持。</p>
</li>
<li>
<p><code>mount -e remount,rw /</code> 重新挂载分区为读写。</p>
</li>
<li>
<p><code>service network restart</code>。 如果提示 eth0 eth1 失败，ifconfig 看不到网卡的话。</p>
</li>
<li>
<p><code>lsmod |grep net</code>。 看下 virtio_net 这个驱动有没有，如果没有的话（网卡报错基本都不会有）。</p>
</li>
<li>
<p><code>insmod /lib/modules/2.6.32-696.3.2.el6.x86_64/kernel/drivers/net/virtio_ net.ko</code>。</p>
</li>
<li>
<p>重启网络服务，嗨 ~ 网通了。</p>
</li>
<li>
<p>登陆 ssh， 找个同版本系统的 grub.conf，拷贝一份过来， 不然重启之后又进 grub 了。<a href="https://yq.aliyun.com/articles/203048" target="_blank" rel="noopener noreferrer">参考文章</a></p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-巧妙利用-strace-查找丢失的文件">1.3 巧妙利用 strace 查找丢失的文件<a href="#13-巧妙利用-strace-查找丢失的文件" class="hash-link" aria-label="1.3 巧妙利用 strace 查找丢失的文件的直接链接" title="1.3 巧妙利用 strace 查找丢失的文件的直接链接">​</a></h3>
<p><strong>问题描述</strong></p>
<blockquote>
<p><strong>客户反馈系统无法远程登陆，实际系统启动本身就有问题。</strong></p>
</blockquote>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0412.07.21.png" alt="iShot2020-08-0412.07.21" class="img_ev3q"></p>
<p>根据报错信息来看，是系统内读取 user 有问题，需要挂盘查看。</p>
<ul>
<li>
<p>挂盘后 chroot 如下 <code>ihave no name</code>，这里本身就是有问题了，说明系统内缺少了什么文件导致异常。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@debian:~# chroot/mnt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[ I have no name !@debian / ] #</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪 贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>strace 跟踪一下 chroot 的过程，看下丢失的文件。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">strace -F -ff -t -tt -s 256 -o ch.out chroot /mnt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">grep -i &quot;no such&quot; ch.out.pid |grep &quot;so&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0412.09.49.png" alt="iShot2020-08-0412.09.49" class="img_ev3q"></p>
</li>
<li>
<p>查看对应文件的关系 （测试机补图）。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0412.10.23.png" alt="iShot2020-08-0412.10.23" class="img_ev3q"></p>
</li>
<li>
<p>确认系统上丢了最终的<code>libnss_files-2.12.so</code>，尝试拷贝一个。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ifconfig eth1 &lt; 网卡 IP&gt; netmask &lt; 掩码地址 &gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">route add default gw &lt; 网关 IP&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0412.11.11.png" alt="iShot2020-08-0412.11.11" class="img_ev3q"></p>
</li>
<li>
<p>此时已经可以上网了，去拷贝一个同版本的文件试试吧。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0412.12.44.png" alt="iShot2020-08-0412.12.44" class="img_ev3q"></p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="14-小心-pam-不让你登陆">1.4 小心 PAM 不让你登陆<a href="#14-小心-pam-不让你登陆" class="hash-link" aria-label="1.4 小心 PAM 不让你登陆的直接链接" title="1.4 小心 PAM 不让你登陆的直接链接">​</a></h3>
<p><strong>问题描述</strong></p>
<blockquote>
<p><strong>ssh 可以登陆，管理终端无法登陆 root，提示 login in...</strong></p>
</blockquote>
<p>先通过 ssh 方式登录系统，查看登录日志是否有异常。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ cat /var/log/secure</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Jun 2 09:26:48 iZbp1begsz1x269nxhtip4Z login: FAILED LOGIN 1 FROM tty1 FOR root，Authentication failure</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>似乎是 login 验证模块的问题进一步查看对应的配置文件 <code>/etc/pam.d/login</code>。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ cat /etc/pam.d/login</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#%PAM-1.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">auth required pam_succeed_if.so user != root quiet</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">auth [user_unknown=ignore success=ok ignore=ignore default=bad] pam_ securetty.so</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">auth substack system-auth</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">auth include postlogin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">account required pam_nologin.so</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">account include system-auth</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">password include system-auth</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># pam_selinux.so close should be the first session rule</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">session required pam_selinux.so close</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">session required pam_loginuid.so</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">session optional pam_console.so</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># pam_selinux.so open should only be followed by sessions to be executed in the user context</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">session required pam_selinux.so open</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">session required pam_namespace.so</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">session optional pam_keyinit.so force revoke</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">session include system-auth</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">session include postlogin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-session optional pam_ck_connector.so</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中一行的作用为禁止本地登录，可以将其注释掉即可。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">auth required pam_succeed_if.so user != root quiet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="15-centos-登陆卡住的原因被我找到了">1.5 CentOS 登陆卡住的原因被我找到了<a href="#15-centos-登陆卡住的原因被我找到了" class="hash-link" aria-label="1.5 CentOS 登陆卡住的原因被我找到了的直接链接" title="1.5 CentOS 登陆卡住的原因被我找到了的直接链接">​</a></h3>
<p><strong>问题描述</strong></p>
<blockquote>
<p><strong>系统登陆卡住，需要 ctrl +c 才能进去，如图。</strong></p>
</blockquote>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0412.21.52.png" alt="iShot2020-08-0412.21.52" class="img_ev3q"></p>
<p>如果一直等的话，会提示如下截图：</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0412.22.25.png" alt="iShot2020-08-0412.22.25" class="img_ev3q"></p>
<p><strong>原因</strong></p>
<blockquote>
<p><strong>/etc/profile 里面有 source /etc/profile 引起死循环，注释即可。</strong></p>
</blockquote>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0412.23.10.png" alt="iShot2020-08-0412.23.10" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2linux-性能问题">2.Linux 性能问题<a href="#2linux-性能问题" class="hash-link" aria-label="2.Linux 性能问题的直接链接" title="2.Linux 性能问题的直接链接">​</a></h2>
<p><strong>说明</strong></p>
<blockquote>
<p><strong>Linux 性能问题的排查和处理一直是系统管理和运维人员的&quot;心头之患&quot;， CPU 负载高但找不到消耗大的进程；系统出现 OOM（Out of Memory）只会一味地增大内存容量，而没有很好地理解和分析问题背后产生的根因。而这些都对线上业务的可靠和稳定性提出了挑战。本文将阿里云售后遇到的较为常见的几个系统性能问题进行展开分析，并给出一些合理的改进和优化方案。</strong></p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-找到-linux-虚机-load-高的元凶">2.1 找到 Linux 虚机 Load 高的&quot;元凶&quot;<a href="#21-找到-linux-虚机-load-高的元凶" class="hash-link" aria-label="2.1 找到 Linux 虚机 Load 高的&quot;元凶&quot;的直接链接" title="2.1 找到 Linux 虚机 Load 高的&quot;元凶&quot;的直接链接">​</a></h3>
<p><strong>问题描述</strong></p>
<blockquote>
<p><strong>有客户反馈他们的一台 ECS 周期性地 load 升高，他们的业务流量并没有上升，需要 我们排查是什么原因造成的，是否因为底层异常？</strong></p>
<p><strong>要弄清 Linux 虚机 load 高，我们要搞清楚 Linux top 命令中 Load 的含义。</strong></p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="211-load-average-的值从何而来">2.1.1 Load average 的值从何而来<a href="#211-load-average-的值从何而来" class="hash-link" aria-label="2.1.1 Load average 的值从何而来的直接链接" title="2.1.1 Load average 的值从何而来的直接链接">​</a></h4>
<p>在使用 top 命令检查系统负载的时候，可以看到 <code>Load averages</code> 字段，但是这个字段并不是表示 CPU 的繁忙程度，而是度量系统整体负载。</p>
<p>Load averages 采样是从 <code>/proc/loadavg</code> 中获取的：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">0.00 0.01 0.05 1/161 29703</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">每个值的含义依次为：</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	lavg_1 (0.00) 1- 分钟平均负载</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	lavg_5 (0.01) 5- 分钟平均负载</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	lavg_15(0.05) 15- 分钟平均负载</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nr_running (1) </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	在采样时刻，运行队列的任务的数目，与 /proc/stat 的 procs_running 表示相同意思，		这个数值是当前可运行的内核调度对象（进程，线程）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nr_threads (161) </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	在采样时刻，系统中活跃的任务的个数（不包括运行已经结束的任务），即这个数值表示当前存	在系统中的内核可调度对象的数量。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">last_pid(29703)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	系统最近创建的进程的 PID，包括轻量级进程，即线程。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">假设当前有两个 CPU，则每个 CPU 的当前任务数为 0.00/2=0.00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果你看到 load average 数值是 10， 则表明平均有 10 个进程在运行或等待状态。 有可能系统有很高的负载但是 CPU 使用率却很低，或者负载很低而 CPU 利用率很高，因为这两者没有直接关系。源码中对于这一块的说明</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">loadavg_proc_show</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">seq_file</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">m，</span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">v</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	</span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> avnrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	</span><span class="token function" style="color:rgb(130, 170, 255)">get_avenrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">avnrun，FIXED_1</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token number" style="color:rgb(247, 140, 108)">200</span><span class="token plain">，</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	</span><span class="token function" style="color:rgb(130, 170, 255)">seq_printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">m，</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;%lu.%02lu %lu.%02lu %lu.%02lu %ld/%d %d\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">		</span><span class="token function" style="color:rgb(130, 170, 255)">LOAD_INT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">avnrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">，</span><span class="token function" style="color:rgb(130, 170, 255)">LOAD_FRAC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">avnrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">		</span><span class="token function" style="color:rgb(130, 170, 255)">LOAD_INT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">avnrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">，</span><span class="token function" style="color:rgb(130, 170, 255)">LOAD_FRAC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">avnrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">		</span><span class="token function" style="color:rgb(130, 170, 255)">LOAD_INT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">avnrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">，</span><span class="token function" style="color:rgb(130, 170, 255)">LOAD_FRAC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">avnrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">		</span><span class="token function" style="color:rgb(130, 170, 255)">nr_running</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">，nr_threads</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">		</span><span class="token function" style="color:rgb(130, 170, 255)">task_active_pid_ns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">current</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">-&gt;</span><span class="token plain">last_pid</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	</span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Load 的计算函数：</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">calc_load</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> load，</span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> exp，</span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> active</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	load </span><span class="token operator" style="color:rgb(137, 221, 255)">*=</span><span class="token plain"> exp</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	load </span><span class="token operator" style="color:rgb(137, 221, 255)">+=</span><span class="token plain"> active </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">FIXED_1 </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> exp</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	</span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> load </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;&gt;</span><span class="token plain"> FSHIFT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">* calc_load - update the avenrun load estimates 10 ticks after the</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">* CPUs have updated calc_load_tasks.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">calc_global_load</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">void</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	</span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> upd </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> calc_load_update </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	</span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> active</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	</span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">time_before</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">jiffies，upd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">		</span><span class="token keyword" style="font-style:italic">return</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	active </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">atomic_long_read</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">calc_load_tasks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	active </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> active </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> active </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> FIXED_1 </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  avenrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">calc_load</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">avenrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">，EXP_1，active</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	avenrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">calc_load</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">avenrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">，EXP_5，active</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	avenrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">calc_load</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">avenrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">，EXP_15，active</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	calc_load_update </span><span class="token operator" style="color:rgb(137, 221, 255)">+=</span><span class="token plain"> LOAD_FREQ</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">* These are the constant used to fake the fixed-point load-average</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">* counting. Some notes:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">*	- 11 bit fractions expand to 22 bits by the multiplies: this gives</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">*	a load-average precision of 10 bits integer + 11 bits fractional</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">*	- if you want to count load-averages more often，you need more</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">*	precision，or rounding will get you. With 2-second counting freq,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">*	the EXP_n values would be 1981，2034 and 2043 if still using only</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">*	11 bit fractions.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">extern</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> avenrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">	</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* Load averages */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">extern</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">get_avenrun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">loads，</span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> offset，</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> shift</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">FSHIFT</span><span class="token macro property">	</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">11</span><span class="token macro property expression">	</span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* nr of bits of precision */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">FIXED_1</span><span class="token macro property">	</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">1</span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token macro property expression">FSHIFT</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression">	</span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* 1.0 as fixed-point */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">LOAD_FREQ</span><span class="token macro property">	</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">5</span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">*</span><span class="token macro property expression">HZ</span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">+</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">1</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression">	</span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* 5 sec intervals */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">EXP_1</span><span class="token macro property">		</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">1884</span><span class="token macro property expression">	</span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* 1/exp(5sec/1min) as fixed-point */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">EXP_5</span><span class="token macro property">		</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">2014</span><span class="token macro property expression">	</span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* 1/exp(5sec/5min) */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">EXP_15</span><span class="token macro property">	</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">2037</span><span class="token macro property expression">	</span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* 1/exp(5sec/15min) */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name function" style="color:rgb(130, 170, 255)">CALC_LOAD</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression">load</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token macro property expression">exp</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token macro property expression">n</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression"> </span><span class="token macro property punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token macro property"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token macro property">	</span><span class="token macro property expression">load </span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">*=</span><span class="token macro property expression"> exp</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token macro property expression"> </span><span class="token macro property punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token macro property"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token macro property">	</span><span class="token macro property expression">load </span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">+=</span><span class="token macro property expression"> n</span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">*</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression">FIXED_1</span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">-</span><span class="token macro property expression">exp</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token macro property expression"> </span><span class="token macro property punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token macro property"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token macro property">	</span><span class="token macro property expression">load </span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">&gt;&gt;=</span><span class="token macro property expression"> FSHIFT</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从这个函数中可以看到， 内核计算 load 采用的是一种平滑移动的算法，Linux 的系统负载指运行队列的平均长度， 需要注意的是：可运行的进程是指处于运行队列的进程， 不是指正在运行的进程。 即进程的状态是 <code>TASK_RUNNING</code> 或者 <code>TASK_ UNINTERRUPTIBLE</code>。</p>
<p>Linux 内核定义一个长度为3的双字数组 avenrun，双字的低 11 位用于存放负载的小数部分，高 21 位用于存放整数部分。当进程所耗的 CPU 时间片数超过 CPU 在5秒内能够提供的时间片数时，内核计算上述的三个负载，负载初始化为 0。</p>
<p>假设最近 1、5、15 分钟内的平均负载分别为 load1、load5 和 load15，那么下一个计算时刻到来时，内核通过下面的算式计算负载：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">load1 -= load1 - exp(-5 / 60) -+ n (1 - exp(-5 / 60 )) </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">load5 -= load5 - exp(-5 / 300) + n (1 - exp(-5 / 300)) </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">load15 = load15 exp(-5 / 900) + n (1 - exp(-5 / 900))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中，exp(x) 为 e 的 x 次幂，n 为当前运行队列的长度。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="212-如何找出系统中-load-高时处于运行队列的进程">2.1.2 如何找出系统中 load 高时处于运行队列的进程<a href="#212-如何找出系统中-load-高时处于运行队列的进程" class="hash-link" aria-label="2.1.2 如何找出系统中 load 高时处于运行队列的进程的直接链接" title="2.1.2 如何找出系统中 load 高时处于运行队列的进程的直接链接">​</a></h4>
<p>通过前面的讲解， 我们已经明白有可能系统有很高的负载但是 CPU 使用率却很低， 或者负载很低而 CPU 利用率很高，这两者没有直接关系，如何用脚本统计出来处于运行队列的进程呢？</p>
<p>每隔 1s 统计一次：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LANG=C</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PATH=/sbin:/usr/sbin:/bin:/usr/bin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">interval=1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">length=86400</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">for i in $(seq 1 $(expr ${length} / ${interval}));do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">date</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	LANG=C ps -eTo stat,pid,tid,ppid,comm --no-header | sed -e &#x27;s/^ \*//&#x27; | 	perl -nE &#x27;chomp;say if (m!^\S*[RD]+\S*!)&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	date</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	cat /proc/loadavg</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	echo -e &quot;\n&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	sleep ${interval}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从统计出来的结果可以看到：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">at Jan 20 15:54:12 CST 2018</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 958 958 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 959 959 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 960 960 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 961 961 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">R 962 962 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 963 963 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 964 964 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 965 965 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 966 966 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 967 967 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 968 968 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 969 969 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 970 970 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 971 971 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 972 972 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 973 973 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 974 974 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">R 975 975 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 976 976 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 977 977 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 978 978 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 979 979 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">R 980 980 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 983 983 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 984 984 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 985 985 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 986 986 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 987 987 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 988 988 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">D 989 989 957 nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">R 11908 11908 18870 ps</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sat Jan 20 15:54:12 CST 2018</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">25.76 20.60 19.00 12/404 11912</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">注：R 代表运行中的队列，D 是不可中断的睡眠进程</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 load 比较高的时候，有大量的 nginx 处于 R 或者 D 状态，他们才是造成 load 上升的元凶，和我们底层的负载确实是没有关系的。</p>
<p>最后也给大家 share 一下查 CPU 使用率比较高的线程小脚本：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LANG=C</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PATH=/sbin:/usr/sbin:/bin:/usr/bin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">interval=1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">length=86400</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">for i in $(seq 1 $(expr ${length} / ${interval}));do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	date</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	LANG=C ps -eT -o%cpu,pid,tid,ppid,comm | grep -v CPU | sort -n -r | head -20</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	date</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	LANG=C cat /proc/loadavg</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	{ LANG=C ps -eT -o%cpu,pid,tid,ppid,comm | sed -e &#x27;s/^ *//&#x27; | tr -s &#x27; &#x27; | grep -v CPU | sort -n -r | cut -d &#x27; &#x27; -f 1 | xargs -I{} echo -n &quot;{} + &quot; &amp;&amp; echo &#x27;0&#x27;; } | bc -l</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	sleep ${interval}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">done</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fuser -k $0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-oom-killer-是被谁触发的">2.2 OOM killer 是被谁触发的<a href="#22-oom-killer-是被谁触发的" class="hash-link" aria-label="2.2 OOM killer 是被谁触发的的直接链接" title="2.2 OOM killer 是被谁触发的的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="221-问题描述">2.2.1 问题描述<a href="#221-问题描述" class="hash-link" aria-label="2.2.1 问题描述的直接链接" title="2.2.1 问题描述的直接链接">​</a></h4>
<p>用户发现自己的服务器 CPU 在某一时刻陡然升高，但从监控上看，同一时刻的业务量却并不高，客户怀疑是云服务器有问题，希望技术支持团队予以解决。</p>
<p>经过我们的排查， 发现 cpu 的两次间歇飙高是由于客户系统当时发生了 OOM（out of memory）的情况， 并触发了 oom-killer 造成的。 但客户并不接受这个结论， 认为是云服务器的异常导致了 cpu 飙高，而 cpu 的升高又导致了 oom 情况的发生。也就是对于 cpu 升高和 oom 谁为因果这件事上，客户和我们持完全相反的态度。</p>
<p>下面我们将通过对 oom 时系统日志的解读来说明 cpu 升高和 oom 之间的因果关系。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="222-知识点梳理">2.2.2 知识点梳理<a href="#222-知识点梳理" class="hash-link" aria-label="2.2.2 知识点梳理的直接链接" title="2.2.2 知识点梳理的直接链接">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="2221-预备知识">2.2.2.1 预备知识<a href="#2221-预备知识" class="hash-link" aria-label="2.2.2.1 预备知识的直接链接" title="2.2.2.1 预备知识的直接链接">​</a></h5>
<blockquote>
<p><strong>在解读日志之前，我们先回顾一下 linux 内 核的内存管理。</strong></p>
</blockquote>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="22211-几个基本的概念">2.2.2.1.1 几个基本的概念<a href="#22211-几个基本的概念" class="hash-link" aria-label="2.2.2.1.1 几个基本的概念的直接链接" title="2.2.2.1.1 几个基本的概念的直接链接">​</a></h6>
<p>(1) Page 页	处理器的最小 &#x27;寻址单元&#x27; 是字节或者字，而页是内存的 &#x27;管理单元&#x27;。</p>
<p>(2) Zone 区</p>
<p>(a) 区存在的原因：</p>
<ul>
<li>
<p>有些硬件设备只能对特定的内存地址执行 DMA（direct memory access） 操作。</p>
</li>
<li>
<p>在一些架构中，实际物理内存是比系统可寻址的虚拟内存要大的，这就导致有些物理内存没有办法被永久的映射在内核的地址空间中。</p>
</li>
<li>
<p>区的划分也是直接以上面两个原因为依据的。</p>
<p>(b) 区的种类</p>
</li>
<li>
<p><code>ZONE_DMA</code>	这个区包含的 page 可以执行 DMA 操作。这部分区域的大小和 CPU 架构有关，在 x86 架构中，该部分区域大小限制为 16MB。</p>
</li>
<li>
<p><code>ZONE_DMA32</code>    类似于 <code>ZOME_DMA</code>， 这个区也包含可以执行 DMA 操作的page。该区域只存在于64位系统中，适合32位的设备访问。</p>
</li>
<li>
<p><code>ZONE_NORMAL</code>    这个区包含可以正常映射到地址空间中的 page，或者说这个区包含了除了 DMA 和 HIGHMEM 以外的内存。 许多内核操作都仅在这个区域进行。</p>
</li>
<li>
<p><code>ZONE_HIGHMEM</code>    这个区包含的是 high memory，也就是那些不能被永久映射到内核地址空间的页。</p>
</li>
<li>
<p>32位的 x86 架构中存在三种内存区域，<code>ZONE_DMA</code>，<code>ZONE_NORMAL</code>， <code>ZONE_HIGHMEM</code>。根据地址空间划分的不同，三个区域的大小不一样：</p>
<ul>
<li>
<p>1G 内核空间 /3G 用户空间</p>
<table><thead><tr><th><strong>区域</strong></th><th><strong>内存 范围</strong></th></tr></thead><tbody><tr><td><strong>ZONE_DMA</strong></td><td><strong>&lt; 16M</strong></td></tr><tr><td><strong>ZONE_NORMAL</strong></td><td><strong>16M ~ 896M</strong></td></tr><tr><td><strong>ZONE_HIGHMEM</strong></td><td><strong>&gt; 896M</strong></td></tr></tbody></table>
</li>
<li>
<p>4G 内核空间 /4G 用户空间</p>
<table><thead><tr><th><strong>区域</strong></th><th><strong>内存范围</strong></th></tr></thead><tbody><tr><td><strong>ZONE_DMA</strong></td><td><strong>&lt; 16M</strong></td></tr><tr><td><strong>ZONE_NORMAL</strong></td><td><strong>16M ~ 3968M</strong></td></tr><tr><td><strong>ZONE_HIGHMEM</strong></td><td><strong>&gt; 3968M</strong></td></tr></tbody></table>
<p>64位的系统由于寻址能力的提高， 不存在 highmem 区， 所以64位系统中存在的区有 DMA，DMA32 和 NORMAL 三个区。</p>
<table><thead><tr><th><strong>区域</strong></th><th><strong>内存范围</strong></th></tr></thead><tbody><tr><td><strong>ZONE_DMA</strong></td><td><strong>&lt; 16M</strong></td></tr><tr><td><strong>ZONE_DMA32</strong></td><td><strong>16M ~ 4G</strong></td></tr><tr><td><strong>ZONE_NORMAL</strong></td><td><strong>&gt; 4G</strong></td></tr></tbody></table>
</li>
</ul>
</li>
</ul>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="22212-内核分配内存的函数">2.2.2.1.2 内核分配内存的函数<a href="#22212-内核分配内存的函数" class="hash-link" aria-label="2.2.2.1.2 内核分配内存的函数的直接链接" title="2.2.2.1.2 内核分配内存的函数的直接链接">​</a></h6>
<p>下面是内核分配内存的核心函数之一，它会分配2的 order 次方个连续的物理页内存，并将第一页的逻辑地址返回。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">__get_free_pages</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 107)">gfp_t</span><span class="token plain"> gfp_mask，</span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> order</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>内核空间的内存分配函数和用户空间最大的不同就是每个函数会有一个 <code>gfp_ mask</code> 参数。</p>
<p>其中 gfp 代表的就是我们上面的内存分配函数<code> __get_free_pages()</code>。</p>
<p>gfp_mask 可以分成三种：行为修饰符（action modifier）, 区修饰符（zone modifier）和类型（type）。</p>
<ul>
<li>
<p><strong>行为修饰符</strong>是用来指定内核该如何分配内存的。 比如分配内存时是否可 以进行磁盘 io，是否可以进行文件系统操作，内核是否可以睡眠（sleep） 等等。</p>
</li>
<li>
<p><strong>区修饰符</strong>指定内存需要从哪个区来分配。</p>
</li>
<li>
<p><strong>类型</strong>是行为修饰符和区修饰符结合之后的产物。在一些特定的内存分配场 合下， 我们可能需要同时指定多个行为修饰符和区修饰符， 而 type 就是 针对这些固定的场合，将所需要的行为修饰符和区修饰符都整合到了一起， 这样使用者只要指定一个 type 就可以了。</p>
</li>
</ul>
<p>不同 type 所代表的含义可以参看下面的表格：</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="2222-日志解读">2.2.2.2 日志解读<a href="#2222-日志解读" class="hash-link" aria-label="2.2.2.2 日志解读的直接链接" title="2.2.2.2 日志解读的直接链接">​</a></h5>
<p>下面是从 oom killer 被触发到进程到被杀掉的一个大概过程， 我们来具体看 一下。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">nginx invoked oom</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">killer</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> gfp_mask</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0x200da</span><span class="token plain">，order</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">，oom_score_adj</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nginx cpuset</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">6011</span><span class="token plain">a7f12bac1c4592ce41407bb41d49836197001a0e355f5a1d9589e4001e42 mems_allowed</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CPU</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> PID</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10242</span><span class="token plain"> Comm</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> nginx Not tainted </span><span class="token number" style="color:rgb(247, 140, 108)">3.13</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">86</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">generic #</span><span class="token number" style="color:rgb(247, 140, 108)">130</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">Ubuntu</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Hardware name</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> Xen HVM domU，BIOS </span><span class="token number" style="color:rgb(247, 140, 108)">4.0</span><span class="token number" style="color:rgb(247, 140, 108)">.1</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">12</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token number" style="color:rgb(247, 140, 108)">2014</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	</span><span class="token number" style="color:rgb(247, 140, 108)">0000000000000000</span><span class="token plain"> ffff880070611a00 ffffffff8172a3b4 ffff88012af6c800</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	</span><span class="token number" style="color:rgb(247, 140, 108)">0000000000000000</span><span class="token plain"> ffff880070611a88 ffffffff8172495d ffffffff81069b76</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	ffff880070611a60 ffffffff810ca5ac ffff88020fff7e38 </span><span class="token number" style="color:rgb(247, 140, 108)">0000000000000000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Node </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> DMA free</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">15908</span><span class="token plain">kB min</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">128</span><span class="token plain">kB low</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">160</span><span class="token plain">kB high</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">192</span><span class="token plain">kB active_anon</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB inactive_anon</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB active_file</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB inactive_file</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB unevictable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB </span><span class="token function" style="color:rgb(130, 170, 255)">isolated</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">anon</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB </span><span class="token function" style="color:rgb(130, 170, 255)">isolated</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">file</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB present</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">15992</span><span class="token plain">kB managed</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">15908</span><span class="token plain">kB mlocked</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB dirty</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB writeback</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB mapped</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB shmem</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB slab_ reclaimable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB slab_unreclaimable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB kernel_stack</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB pagetables</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB unstable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB bounce</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB free_cma</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB writeback_tmp</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB pages_scanned</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> all_ unreclaimable</span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> yes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">lowmem_reserve</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3746</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">7968</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">7968</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Node </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> DMA32 free</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">48516</span><span class="token plain">kB min</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">31704</span><span class="token plain">kB low</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">39628</span><span class="token plain">kB high</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">47556</span><span class="token plain">kB active_ anon</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">3619272</span><span class="token plain">kB inactive_anon</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">216</span><span class="token plain">kB active_file</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">556</span><span class="token plain">kB inactive_file</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">1516</span><span class="token plain">kB unevictable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB </span><span class="token function" style="color:rgb(130, 170, 255)">isolated</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">anon</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB </span><span class="token function" style="color:rgb(130, 170, 255)">isolated</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">file</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB present</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">3915776</span><span class="token plain">kB managed</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">3836724</span><span class="token plain">kB mlocked</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB dirty</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain">kB writeback</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB mapped</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">324</span><span class="token plain">kB shmem</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">1008</span><span class="token plain">kB slab_reclaimable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">67136</span><span class="token plain">kB slab_unreclaimable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">67488</span><span class="token plain">kB kernel_ stack</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">1792</span><span class="token plain">kB pagetables</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">14540</span><span class="token plain">kB unstable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB bounce</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB free_cma</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB writeback_tmp</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB pages_scanned</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">7365</span><span class="token plain"> all_unreclaimable</span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> yes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">lowmem_reserve</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">4221</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">4221</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Node </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> Normal free</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">35640</span><span class="token plain">kB min</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">35748</span><span class="token plain">kB low</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">44684</span><span class="token plain">kB high</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">53620</span><span class="token plain">kB active_ anon</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">4019124</span><span class="token plain">kB inactive_anon</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">292</span><span class="token plain">kB active_file</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">1292</span><span class="token plain">kB inactive_file</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">2972</span><span class="token plain">kB unevictable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB </span><span class="token function" style="color:rgb(130, 170, 255)">isolated</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">anon</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB </span><span class="token function" style="color:rgb(130, 170, 255)">isolated</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">file</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB present</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">4456448</span><span class="token plain">kB managed</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">4322984</span><span class="token plain">kB mlocked</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB dirty</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">24</span><span class="token plain">kB writeback</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain">kB mapped</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">1296</span><span class="token plain">kB shmem</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">1324</span><span class="token plain">kB slab_reclaimable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">81196</span><span class="token plain">kB slab_unreclaimable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">83432</span><span class="token plain">kB kernel_ stack</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">3392</span><span class="token plain">kB pagetables</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">20252</span><span class="token plain">kB unstable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB bounce</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB free_cma</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB writeback_tmp</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB pages_scanned</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">7874</span><span class="token plain"> all_unreclaimable</span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> yes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">lowmem_reserve</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Node </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> DMA</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">kB </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token plain">kB </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">32</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">64</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">128</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">256</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">512</span><span class="token plain">kB </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">1024</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">2048</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">R</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">4096</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">15908</span><span class="token plain">kB Node </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> DMA32</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1101</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">UE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">745</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">UEM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">475</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">UEM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">263</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">32</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">EM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">88</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">64</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">UEM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">25</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">128</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">E</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token number" style="color:rgb(247, 140, 108)">12</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">256</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">EM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">6</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">512</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">E</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">7</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">1024</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">EM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">2048</span><span class="token plain">kB </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">4096</span><span class="token plain">kB </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">48524</span><span class="token plain">kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Node </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> Normal</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">5769</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">EM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1495</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">EM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">24</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token plain">kB </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">UE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">32</span><span class="token plain">kB </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">64</span><span class="token plain">kB </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">128</span><span class="token plain">kB </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">256</span><span class="token plain">kB </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">512</span><span class="token plain">kB </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">1024</span><span class="token plain">kB </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">2048</span><span class="token plain">kB </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">4096</span><span class="token plain">kB </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">35420</span><span class="token plain">kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Node </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> hugepages_total</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> hugepages_free</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> hugepages_surp</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> hugepages_ size</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">2048</span><span class="token plain">kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">2273</span><span class="token plain"> total pagecache pages</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> pages in swap cache</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Swap cache stats</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> add </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">，delete </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">，find </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Free swap </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Total swap </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">2097054</span><span class="token plain"> pages RAM</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> pages HighMem</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">MovableOnly</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">33366</span><span class="token plain"> pages reserved</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> pid </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> uid tgid total_vm rss nr_ptes swapents oom_score_adj name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">355</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">355</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">4868</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">66</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">13</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">upstart</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">udev</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">br</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">361</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">361</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">12881</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">145</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">28</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">            </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemd</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">udevd  </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">499</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">499</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">3814</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">60</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">13</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">upstart</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">socket</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">562</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">562</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">5855</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">79</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">15</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">rpcbind  </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">644</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">106</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">644</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">5398</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">142</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> rpc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">statd</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">775</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">775</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">3818</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">58</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">12</span><span class="token plain">       </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">upstart</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">file</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">br</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">（此处有省略）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">10396</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">104</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">10396</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">21140</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">12367</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">44</span><span class="token plain">      </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">10397</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">104</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">10397</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">21140</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">12324</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">44</span><span class="token plain">      </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">10398</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">104</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">10398</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">21140</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">12324</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">44</span><span class="token plain">      </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">10399</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">104</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">10399</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">21140</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">12367</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">44</span><span class="token plain">      </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Out of memory</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> Kill process </span><span class="token number" style="color:rgb(247, 140, 108)">10366</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> score </span><span class="token number" style="color:rgb(247, 140, 108)">6</span><span class="token plain"> or sacrifice child</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Killed process </span><span class="token number" style="color:rgb(247, 140, 108)">10366</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> total</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">vm</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">84784</span><span class="token plain">kB，anon</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">rss</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">49156</span><span class="token plain">kB，filerss</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">520</span><span class="token plain">kB  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>先来看一下第一行，它给出了 oom killer 是由谁触发的信息。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">nginx invoked oom</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">killer</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> gfp_mask</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0x200da</span><span class="token plain">，order</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">，oom_score_adj</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>order=0 告诉我们所请求的内存的大小是多少， 即 nginx 请求了2的0次方这么多个 page 的内存，也就是一个 page，或者说是 4KB。 gfp_mask 的最后两个 bit 代表的是 zone mask，也就是说它指明内存应该从哪个区来分配。</p>
<p>Flag value Description</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token number" style="color:rgb(247, 140, 108)">0x00u</span><span class="token plain">			</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> implicitly means allocate from ZONE_NORMAL</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>__GFP_DMA 0x01u Allocate from ZONE_DMA if possible</p>
<p>__GFP_HIGHMEM 0x02u Allocate from ZONE_HIGHMEM if possible</p>
<p>(这里有一点需要注意，在 64 位的 x86 系统中，是没有 highmem 区的，64 位系统中的 normal 区就对应上表中的 highmem 区。）</p>
<p>在本案例中，zonemask是2，也就是说 nginx 正在从 zone － normal（64 位 系统）中请求内存。</p>
<p>其他标志位的含义如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GFP_WAIT</span><span class="token macro property">	</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0x10u</span><span class="token macro property expression">	</span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* Can wait and reschedule? */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GFP_HIGH</span><span class="token macro property">	</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0x20u</span><span class="token macro property expression">	</span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* Should access emergency pools? */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GFP_IO</span><span class="token macro property">		</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0x40u</span><span class="token macro property expression">	</span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* Can start physical IO? */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GFP_FS</span><span class="token macro property">		</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0x80u</span><span class="token macro property expression">	</span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* Can call down to low-level FS? */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GFP_COLD</span><span class="token macro property">	</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0x100u</span><span class="token macro property expression">	</span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* Cache-cold page required */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GFP_NOWARN</span><span class="token macro property"> </span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">*</span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">/</span><span class="token macro property expression">	</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0x200u</span><span class="token macro property expression">	</span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* Suppress page allocation failure warning */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GFP_REPEAT</span><span class="token macro property">	</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0x400u</span><span class="token macro property expression">	</span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* Retry the allocation. Might fail */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GFP_NOFAIL</span><span class="token macro property">	</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0x800u</span><span class="token macro property expression">	</span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* Retry for ever.	Cannot fail */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GFP_NORETRY</span><span class="token macro property">	</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0x1000u</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* Do not retry.	Might fail */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GFP_NO_GROW</span><span class="token macro property">	</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0x2000u</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* Slab internal usage */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GFP_COMP</span><span class="token macro property">	</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0x4000u</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* Add compound page metadata */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GFP_ZERO</span><span class="token macro property">	</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0x8000u</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* Return zeroed page on success */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GFP_NOMEMALLOC</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0x10000u</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* Don’t use emergency reserves */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GFP_NORECLAIM</span><span class="token macro property"> </span><span class="token macro property expression">allocation </span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0x20000u</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(105, 112, 152);font-style:italic">/* No realy zone reclaim during */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>所以我们当前这个内存请求带有这几个标志：<code>GFP_NORECLAIM</code>，<code>GFP_FS</code>， <code>GFP_IO</code>，<code>GFP_WAIT</code>，都是比较正常的几个标志，那么我们这个请求为什么 会有问题呢？继续往下看，可以看到下面的信息：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Node </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> Normal free</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">35640</span><span class="token plain">kB min</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">35748</span><span class="token plain">kB low</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">44684</span><span class="token plain">kB high</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">53620</span><span class="token plain">kB active_ anon</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">4019124</span><span class="token plain">kB inactive_anon</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">292</span><span class="token plain">kB active_file</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">1292</span><span class="token plain">kB inactive_file</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">2972</span><span class="token plain">kB unevictable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB </span><span class="token function" style="color:rgb(130, 170, 255)">isolated</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">anon</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB </span><span class="token function" style="color:rgb(130, 170, 255)">isolated</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">file</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB present</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">4456448</span><span class="token plain">kB managed</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">4322984</span><span class="token plain">kB mlocked</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB dirty</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">24</span><span class="token plain">kB writeback</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain">kB mapped</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">1296</span><span class="token plain">kB shmem</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">1324</span><span class="token plain">kB slab_reclaimable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">81196</span><span class="token plain">kB slab_unreclaimable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">83432</span><span class="token plain">kB kernel_ stack</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">3392</span><span class="token plain">kB pagetables</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">20252</span><span class="token plain">kB unstable</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB bounce</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB free_cma</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB writeback_tmp</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">kB pages_scanned</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">7874</span><span class="token plain"> all_unreclaimable</span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到 normal 区 free 的内存只有 35640KB，比系统允许的最小值（min）还要低，这意味着 application 已经无法再从系统中申请到内存了，并且系统会开始启动 oom killer 来缓解系统内存压力。</p>
<p>这里我们说一下一个常见的误区，就是有人会认为触发了 oom killer 的进程就是问题的罪魁祸首，比如我们这个例子中的这个 nginx 进程。其实日志中 invoke oom killer 的这个进程有时候可能只是一个受害者， 因为其他应用／进程已将系统内存用尽， 而这个 invoke oomkiller 的进程恰好在此时发起了一个分配内存的请求而已。 在系统内存已经不足的情况下， 任何一个内存请求都可能触发 oom killer 的启动。</p>
<p>oom killer 的启动会使系统从用户空间转换到内核空间。内核会在短时间内进行大量的工作， 比如计算每个进程的 oom 分值， 从而筛选出最适合杀掉的进程。 我们从日志中也可以看到这一筛选过程：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> pid </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> uid tgid total_vm   rss nr_ptes swapents oom_score_adj name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">355</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">355</span><span class="token plain">     </span><span class="token number" style="color:rgb(247, 140, 108)">4868</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">66</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">13</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">upstart</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">udev</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">br</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">361</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">361</span><span class="token plain">     </span><span class="token number" style="color:rgb(247, 140, 108)">12881</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">145</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">28</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">         </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemd</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">udevd  </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">499</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">499</span><span class="token plain">     </span><span class="token number" style="color:rgb(247, 140, 108)">3814</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">60</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">13</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">upstart</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">socket</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">562</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">562</span><span class="token plain">     </span><span class="token number" style="color:rgb(247, 140, 108)">5855</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">79</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">15</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">rpcbind</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">644</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">106</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">644</span><span class="token plain">     </span><span class="token number" style="color:rgb(247, 140, 108)">5398</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">142</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> rpc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">statd</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">775</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">775</span><span class="token plain">     </span><span class="token number" style="color:rgb(247, 140, 108)">3818</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">58</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">12</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">upstart</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">file</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">br</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">10396</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">104</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10396</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">21140</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">12367</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">44</span><span class="token plain">            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">10397</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">104</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10397</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">21140</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">12324</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">44</span><span class="token plain">            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">10398</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">104</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10398</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">21140</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">12324</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">44</span><span class="token plain">            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">10399</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">104</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10399</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">21140</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">12367</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">44</span><span class="token plain">            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> nginx  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>本例中，一个 nginx 进程被选中作为缓解内存压力的牺牲进程：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Out of memory</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> Kill process </span><span class="token number" style="color:rgb(247, 140, 108)">10366</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> score </span><span class="token number" style="color:rgb(247, 140, 108)">6</span><span class="token plain"> or sacrifice child</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Killed process </span><span class="token number" style="color:rgb(247, 140, 108)">10366</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> total</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">vm</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">84784</span><span class="token plain">kB，anon</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">rss</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">49156</span><span class="token plain">kB， file</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">rss</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">520</span><span class="token plain">kB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>整个过程进行的时间很短，只有毫秒级别，但是工作量／计算量很大，这就导致了 cpu 短时间内迅速飙升， 出现峰值。 但这一切工作都由内核在内核空间中完成，所以用户在自己的业务监控数据上并不会看到业务量的异常。这些短时间升高的 cpu 是内核使用的，而不是用户的业务。</p>
<p>本例中客户只是偶尔看到这个现象，且业务并没有受到影响。我们给客户的建议是分析业务内存需求量最大值，如果系统已经没有办法满足特定时段业务的内存需求， 建议用户升级内存来避免 oom 的情况发生， 因为严重的 oom 情况是可能引发系统崩溃的。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-我的服务器内存去哪儿了">2.3 我的服务器内存去哪儿了<a href="#23-我的服务器内存去哪儿了" class="hash-link" aria-label="2.3 我的服务器内存去哪儿了的直接链接" title="2.3 我的服务器内存去哪儿了的直接链接">​</a></h3>
<p><strong>背景</strong></p>
<blockquote>
<p><strong>收到报警，系统的内存使用率触发阈值（部分图是后补的）。</strong></p>
</blockquote>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0510.02.30.png" alt="iShot2020-08-0510.02.30" class="img_ev3q"></p>
<p>登陆系统，使用命令(top 按M)查看内存分配。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0510.04.33.png" alt="iShot2020-08-0510.04.33" class="img_ev3q"></p>
<p>使用命令<code>free -m</code>查看内存使用情况</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0510.05.17.png" alt="iShot2020-08-0510.05.17" class="img_ev3q"></p>
<p>使用命令<code>atop</code>看下内存分配（cat /proc/meminfo 也可以看到一些细化的内存使用信息）。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0510.06.49.png" alt="iShot2020-08-0510.06.49" class="img_ev3q"></p>
<p>发现 cache 才 1.7G，slab 非常高，4.4G，<strong><span style="color:red">slab 内存简单理解为是系统占用的</span></strong>。 使用 slabtop 继续分析。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0510.10.52.png" alt="iShot2020-08-0510.10.52" class="img_ev3q"></p>
<p>看到 <code>proc_inode_cache</code> 使用的最多， 这个代表是 proc 文件系统的 inode 占用的。</p>
<p>使用命令<code>ps -eLf</code>查进程，但是进程不多，再查线程，可以通过如下命令进行检查。得到如下的结果：( 原图缺失，使用测试机查看到的截图来补充说明 )</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0510.11.49.png" alt="iShot2020-08-0510.11.49" class="img_ev3q"></p>
<p>计算 socket</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ ll /proc/22360/task/*/fd/ |grep socket |wc -l</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">140</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>计算一下有多少fd</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ ll /proc/22360/task/*/fd/ | wc -l</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">335</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>每个 socket 的 inode 也不一样。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0510.17.07.png" alt="iShot2020-08-0510.17.07" class="img_ev3q"></p>
<p>当时看到的现场有几万个 fd， 基本全是 socket， 每个 inode 都是占用空间的， 且 proc 文件系统是全内存的。 所以我们才会看到 slab 中 proc_inode_cache 内存占用高。</p>
<p><strong>建议</strong></p>
<blockquote>
<p><strong>建议用户需要从程序上优化相关的 server 端 ~</strong></p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="24-cpu-占用不高但网络性能很差的一个原因">2.4 CPU 占用不高但网络性能很差的一个原因<a href="#24-cpu-占用不高但网络性能很差的一个原因" class="hash-link" aria-label="2.4 CPU 占用不高但网络性能很差的一个原因的直接链接" title="2.4 CPU 占用不高但网络性能很差的一个原因的直接链接">​</a></h3>
<p><strong>简介</strong></p>
<blockquote>
<p><strong>我们经常碰到整体 cpu 不高，但是性能不佳的案例，这种案例往往跟 CPU 处理中断的核心跑满有关系，话不多说，我们来看看中断相关的案例。</strong></p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="241-什么是中断">2.4.1 什么是中断？<a href="#241-什么是中断" class="hash-link" aria-label="2.4.1 什么是中断？的直接链接" title="2.4.1 什么是中断？的直接链接">​</a></h4>
<p>当一个硬件 ( 如磁盘控制器或者以太网卡 )，需要打断 CPU 的工作时，它就触发一个中断。该中断通知 CPU 发生了某些事情并且 CPU 应该放下当前的工作去处理这个事情。为了防止多个设置发送相同的中断，Linux 设计了一套中断请求系统，使得计算机系统中的每个设备被分配了各自的中断号，以确保它的中断请求的唯一性。</p>
<p>从 2.4 内核开始，Linux 改进了分配特定中断到指定的处理器 ( 或处理器组 ) 的功能。 这被称为 <code>SMP IRQ affinity</code>，它可以控制系统如何响应各种硬件事件。允许你限制或者重新分配服务器的工作负载，从而让服务器更有效的工作。</p>
<p><strong><span style="color:red">以网卡中断为例，在没有设置 <code>SMP IRQ affinity</code> 时，所有网卡中断都关联到 CPU0， 这导致了 CPU0 负载过高，而无法有效快速的处理网络数据包，导致了瓶颈。</span></strong></p>
<p><strong><span style="color:blue">通过 <code>SMP IRQ affinity</code>，把网卡多个中断分配到多个 CPU 上，可以分散 CPU 压力， 提高数据处理速度。 但是 <code>smp_affinity</code> 要求网卡支持多队列， 如果网卡支持多队列则设置才有作用，网卡有多队列，才会有多个中断号，这样就可以把不同的中断号分配到不同 CPU 上，这样中断号就能相对均匀的分配到不同的 CPU 上。</span></strong></p>
<p>而单队列的网卡可以通过 RPS/RFS 来模拟多队列的情况，但是该效果并不如网卡本身多队列 + 开启 RPSRFS 来的有效。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="242-什么是-rpsrfs">2.4.2 什么是 RPS/RFS<a href="#242-什么是-rpsrfs" class="hash-link" aria-label="2.4.2 什么是 RPS/RFS的直接链接" title="2.4.2 什么是 RPS/RFS的直接链接">​</a></h4>
<p><strong>RPS（Receive Packet Steering）主要是把软中断的负载均衡到各个 cpu</strong>，简单来说，是网卡驱动对每个流生成一个 hash 标识， 这个 HASH 值得计算可以通过四元组来计算（SIP，SPORT，DIP，DPORT），然后由中断处理的地方根据这个 hash 标识分配到相应的 CPU 上去，这样就可以比较充分的发挥多核的能力了。通俗点说就是在软件层面模拟实现硬件的多队列网卡功能，<strong>如果网卡本身支持多队列功能的话 RPS 就不会有任何的作用</strong>。<strong>该功能主要针对单队列网卡多 CPU 环境</strong>，如网卡支持多队列则可使用 <code>SMP irq affinity</code> 直接绑定硬中断。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0510.21.08.png" alt="iShot2020-08-0510.21.08" class="img_ev3q"></p>
<p>由于 RPS 只是单纯把数据包均衡到不同的 cpu，这个时候如果应用程序所在的 cpu 和软中断处理的 cpu 不是同一个， 此时对于 cpu cache 的影响会很大， 那么 RFS （Receive flow steering）确保应用程序处理的 cpu 跟软中断处理的 cpu 是同一个，这样就充分利用 cpu 的 cache，这两个补丁往往都是一起设置，来达到最好的优化效果，主要是针对单队列网卡多 CPU 环境。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0510.21.46.png" alt="iShot2020-08-0510.21.46" class="img_ev3q"></p>
<p><code>rps_flow_cnt</code>，<code>rps_sock_flow_entries</code>， 参数的值会被进位到最近的2的幂次方值，对于单队列设备， 单队列的 <code>rps_flow_cnt</code> 值被配置成与<code>rps_sock_flow_ entries</code> 相同。</p>
<p>RFS 依靠 RPS 的机制插入数据包到指定 CPU 的 backlog 队列，并唤醒那个 CPU 来执行。</p>
<p>默认情况下，开启 <code>irqbalance</code> 是足够用的，但是对于一些对网络性能要求比较高的场景，手动绑定中断磨合是比较好的选择。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">开启 irqbalance，会存在一些问题，比如：</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">a) 有时候计算出来的值不合理，导致 CPU 使用还是不均衡。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">b) 在系统比较空闲 IRQ 处于 Power-save mode 时，irqbalance 会将中断集中分配给第一个 CPU，</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">以保证其它空闲 CPU 的睡眠时间，降低能耗。如果压力突然上升，可能会由于调整的滞后性带来性能 问题。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">c) 处理中断的 CPU 总是会变，导致了更多的 context switch。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">d）也存在一些情况，启动了 irqbalance，但是并没有生效，没有真正去设置处理中断的cpu。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="243-如何查看网卡的队列数">2.4.3 如何查看网卡的队列数<a href="#243-如何查看网卡的队列数" class="hash-link" aria-label="2.4.3 如何查看网卡的队列数的直接链接" title="2.4.3 如何查看网卡的队列数的直接链接">​</a></h4>
<p>Combined 代表队列个数，说明我的测试机有 4 个队列。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ethtool -l eth0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Channel parameters for eth0:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Pre-set maximums:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RX:		0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">TX:		0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Other:	0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Combined:	4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Current hardware settings:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RX:	0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">TX:	0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Other:	0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Combined:	4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以 CentOS7.6 为例，系统处理中断的记录在 <code>/proc/interrupts</code> 文件里面，默认这个文件记录比较多，影响查看，同时如果 cpu 核心也非常多的话， 对于阅读的影响非常大。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># cat /proc/interrupts</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">						CPU0		CPU1		CPU2		CPU3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  0:				 141			0       0       0		IO-APIC-edge	timer		</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  1:          10      0       0       0   IO-APIC-edge  i8042 </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  4:         807      0       0       0   IO-APIC-edge  serial</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  6:           3      0       0       0   IO-APIC-edge  floppy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  8:           0      0       0       0   IO-APIC-edge  rtc0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  9:           0      0       0       0   IO-APIC-fasteoi acpi</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  10:          0      0       0       0   IO-APIC-fasteoi virtio3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  11:         22      0       0       0   IO-APIC-fasteoi hcd:usb1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  12:         15      0       0       0   IO-APIC-edge	i8042</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  14:          0      0       0       0   IO-APIC-edge	ata_piix</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  15:          0      0       0       0   IO-APIC-edge	ata_piix</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  24:          0      0       0       0   PCI-MSI-edge	virtio1-config</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	。。。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  27:       1913      0       0       0   PCI-MSI-edge	virtio2-input.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  28:          3    834       0       0   PCI-MSI-edge	virtio2-output.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">input0 说明是 cpu0（第 1 个 CPU）处理的网络中断</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">阿里云 ecs 网络中断，如果是多个中断的话，还有 input.1 input.2 input.3 这种形式	</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果 ecs 的 cpu 核心非常多，那这个文件看起来就会比较费劲了，可使用下面 的命令查看处理中断的核心。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">使用下面这个命令，即可将阿里云 ecs 处理中断的 cpu 找出来了（下面这个演示是 8c4个队列）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># for i in $(egrep &quot;\-input.&quot; /proc/interrupts |awk -F &quot;:&quot; &#x27;{print $1}&#x27;);do cat /proc/irq/$i/smp_affinity_list;done</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">7</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">处理一下 sar 拷贝用</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># for i in $(egrep &quot;\-input.&quot; /proc/interrupts |awk -F &quot;:&quot; &#x27;{print $1}&#x27;);do cat /proc/irq/$i/smp_affinity_list;done |tr -s &#x27;\n&#x27; &#x27;,&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">5,7,1,3,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># sar -P 5,7,1,3 1 每秒刷新一次 cpu 序号为 5,7,1,3 核心的 cpu 使用率</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># sar -P ALL 1 每秒刷新所有核心，用于少量 CPU 核心的监控，这样我们就可以知道处理慢的原因是不是因为队列不够导致的了</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Linux 3.10.0-957.5.1.el7.x86_64 (iZwz98aynkjcxvtra0f375Z) x86_64_ (4 CPU)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">05:10:06 PM		CPU		%user		%nice		%system		%iowait		%steal	%idle</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">05:10:07 PM		all		5.63		0.00		3.58			1.02			0.00		89.77</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">05:10:07 PM		0			6.12		0.00		3.06			1.02			0.00		89.90</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">05:10:07 PM		1			5.10		0.00		5.10			0.00			0.00		89.80</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">05:10:07 PM		2			5.10		0.00		3.06			2.04			0.00		89.80</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">05:10:07 PM		3			5.10		0.00		4.08			1.02			0.00		89.80</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">05:10:07 PM		CPU		%user		%nice		%system		%iowait		%steal	%idle</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">05:10:08 PM   all		8.78		0.00		15.01			0.69			0.00		75.52		</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">05:10:08 PM 	0			10.00		0.00		16.36			0.91			0.00		75.73</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">05:10:08 PM		1			4.81		0.00		13.46			1.92			0.00		79.81</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">05:10:08 PM		2			10.91		0.00		15.45			0.91			0.00		72.73</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">05:10:08 PM		3			9.09		0.00		14.55			0.00			0.00		76.36</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sar 小技巧</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">打印 idle 小于 10 的核心</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sar -P 1,3,5,7 1 |tail -n+3|awk &#x27;$NF&lt;10 {print $0}&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">看所有核心是否有单核打满的把 1357 换成 ALL 即可</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sar -P ALL 1 |tail -n+3|awk &#x27;$NF&lt;10 {print $0}&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">再贴一个 4c8g 规格的配置（ecs.c6.xlarge），可以看到 4c 也给了四个队列，但是默认设置的是在 cpu0 和 2 上处理中断</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># grep -i &quot;input&quot; /proc/interrupts</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">27: 	1932		0		0		0			PCI-MSI-edge		virtio2-input.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">29:		2				0		0		1627	PCI-MSI-edge		virtio2-input.1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">32:		1974		0		0		0			PCI-MSI-edge		virtio2-input.2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">35:		3				0		284	0			PCI-MSI-edge		virtio2-input.3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># for i in $(egrep &quot;\-input.&quot; /proc/interrupts |awk -F &quot;:&quot; &#x27;{print $1}&#x27;);do cat /proc/irq/$i/smp_affinity_list;done</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">原因是 cpu 是超线程的，&quot;每个 vCPU 绑定到一个物理 CPU 超线程&quot;, 所以即使是4个队列默认也在2个 cpu 核心上</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># lscpu</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Architecture:			x86_64</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CPU op-mode(s):			32-bit，64-bit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Byte Order:			Little Endian</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CPU(s):			4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">On-line CPU(s) list:			0-3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Thread(s) per core:			2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Core(s) per socket:			2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Socket(s):			1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NUMA node(s):			1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>关闭 IRQbalance。</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># service irqbalance status</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Redirecting to /bin/systemctl status irqbalance.service</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">● irqbalance.service - irqbalance daemon</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	Loaded: loaded (/usr/lib/systemd/system/irqbalance.service; enabled; vendor preset: enabled)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	Active: inactive (dead) since Wed 2020-05-27 14:39:28 CST; 2s ago</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	Process: 1832 ExecStart=/usr/sbin/irqbalance --foreground $IRQBALANCE_ ARGS (code=exited，status=0/SUCCESS)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	Main PID: 1832 (code=exited，status=0/SUCCESS)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	May 27 14:11:40 iZbp1ee4vpiy3w4b8y2m8qZ systemd[1]: Started irqbalance daemon.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	May 27 14:39:28 iZbp1ee4vpiy3w4b8y2m8qZ systemd[1]: Stopping irqbalance daemon...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	May 27 14:39:28 iZbp1ee4vpiy3w4b8y2m8qZ systemd[1]: Stopped irqbalance daemon.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>手动设置 RPS。</strong></p>
<p>手动设置之前我们需要先了解下面的文件（IRQ_number 就是前面 grep input 拿到的序号）。</p>
<p>进入 <code>/proc/irq/${IRQ_number}/</code>， 关注两个文件：<code>smp_affinity</code> 和 <code>smp_ affinity_list</code>。</p>
<p><code>smp_affinity</code> 是 bitmask+16 进制，</p>
<p><code>smp_affinity_list</code>：这个文件更好理解，采用的是 10 进制，可读性高。</p>
<p>改这两个任意一个文件，另一个文件会同步更改。</p>
<p>为了方便理解，咱们直接看十进制的文件 <code>smp_affinity_list</code> 即可。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">如果这一步没看明白，注意前面的 /proc/interrupts 的输出</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># for i in $(egrep &quot;\-input.&quot; /proc/interrupts |awk -F &quot;:&quot; &#x27;{print $1}&#x27;); do cat /proc/irq/$i/smp_affinity_list;done</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">手动设置处理中断的 CPU 号码可以直接 echo 修改，下面就是将序号 27 的中断放到 cpu0 上处理，一般建议可以把 cpu0 空出来</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># echo 0 &gt;&gt; /proc/irq/27/smp_affinity_list</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># cat /proc/irq/27/smp_affinity_list</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">关于 bitmas</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;f&quot; 是十六进制的值对应的 二进制是 &quot;1111&quot;（可以理解为 4c 的配置设置为 f 的话，所有的 cpu 参与处理中断）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">二进制中的每个位代表了服务器上的每个 CPU. 一个简单的 demo</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CPU序号		二进制		十六进制</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CPU 0			0001		1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CPU 1			0010		2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CPU 2			0100		4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CPU 3			1000		8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>需要对每块网卡每个队列分别进行设置。如对 eth0 的 0 号队列设置：</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">echo ff &gt; /sys/class/net/eth0/queues/rx-0/rps_cpus</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里的设置方式和中断亲和力设置的方法是类似的。采用的是掩码的方式，但是这里通常要将所有的 CPU 设置进入，如：</p>
<p>4core，f</p>
<p>8core，ff</p>
<p>16core，ffff</p>
<p>32core，ffffffff</p>
<p>默认在 0 号 cpu 上</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># cat /sys/class/net/eth0/queues/rx-0/rps_cpus</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># echo f &gt;&gt;/sys/class/net/eth0/queues/rx-0/rps_cpus</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># cat /sys/class/net/eth0/queues/rx-0/rps_cpus</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>设置 RFS 的方式。</strong></p>
<p>需要设置两个地方：</p>
<ul>
<li>
<p>全局表<code>rps_sock_flow_table</code> 的条目数量。通过一个内核参数控制：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># sysctl -a |grep net.core.rps_sock_flow_entries</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.core.rps_sock_flow_entries = 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># sysctl -w net.core.rps_sock_flow_entries=1024</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.core.rps_sock_flow_entries = 1024</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>每个网卡队列 hash 表的条目数：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># cat /sys/class/net/eth0/queues/rx-0/rps_flow_cnt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># echo 256 &gt;&gt; /sys/class/net/eth0/queues/rx-0/rps_flow_cnt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># cat /sys/class/net/eth0/queues/rx-0/rps_flow_cnt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">256</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>需要启动 RFS，两者都需要设置。 建议机器上所有的网卡队列设置的 <code>rps_flow_cnt</code> 相加应该小于或者等于 <code>rps_sock_flow_entries</code>。 因为是4个队列， 因此每个队列设置 256， 可以根据实际情况增大。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="25-一次-io-异常捕获过程">2.5 一次 IO 异常捕获过程<a href="#25-一次-io-异常捕获过程" class="hash-link" aria-label="2.5 一次 IO 异常捕获过程的直接链接" title="2.5 一次 IO 异常捕获过程的直接链接">​</a></h3>
<p><strong>简介</strong></p>
<blockquote>
<p><strong>遇到一个 IO 异常飙升的问题，IO 起飞后系统响应异常缓慢，看不到现场一直无法定位问题， 检查对应时间点应用日志也没有发现异常的访问， 这种问题怎么办呢？</strong></p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="251-采集系统-io确认-io-异常发生在系统盘还是数据盘使用系统自带的-iostat-即可采集">2.5.1 采集系统 IO，确认 IO 异常发生在系统盘，还是数据盘，使用系统自带的 iostat 即可采集<a href="#251-采集系统-io确认-io-异常发生在系统盘还是数  据盘使用系统自带的-iostat-即可采集" class="hash-link" aria-label="2.5.1 采集系统 IO，确认 IO 异常发生在系统盘，还是数据盘，使用系统自带的 iostat 即可采集的直接链接" title="2.5.1 采集系统 IO，确认 IO 异常发生在系统盘，还是数据盘，使用系统自带的 iostat 即可采集的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># iostat -d 3 -k -x -t 30</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Linux 3.10.0-957.21.3.el7.x86_64 (tencent) 	08/05/2020 	_x86_64_	(1 CPU)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">06/12/2018 11:51:49 AM</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vda               0.12    12.66    4.59    8.55   127.03   143.35    41.16     0.07    7.91   15.92    3.61   0.65   0.85</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">scd0              0.00     0.00    0.00    0.00     0.00     0.00     7.10     0.00    1.03    1.03    0.00   1.02   0.00</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">06/12/2018 11:51:52 AM</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vda               0.00    27.61   10.44   69.70   247.81   397.31    16.10     0.99   15.57    1.71   17.65   0.16   1.28</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">scd0              0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>每隔 3 秒采集一次磁盘 io，输出时间，一共采集 30 次，想一直抓的话把 30 去掉即可，注意磁盘空余量。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">通过这个命令我们可以确认如下信息：</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- 问题发生的时间</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- 哪块盘发生的 io</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- 磁盘的 IOPS（ r/s	w/s）以及吞吐量（ rkB/s	wkB/s ）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="252-确认哪块盘发生了-io-还不够再抓一下发生-io-的进程需要安装-iotop-进行捕获">2.5.2 确认哪块盘发生了 IO 还不够，再抓一下发生 IO 的进程，需要安装 iotop 进行捕获<a href="#252-确认哪块盘发生了-io-还不够再抓一下发生-io-的进程需要安装-iotop-进行捕获" class="hash-link" aria-label="2.5.2 确认哪块盘发生了 IO 还不够，再抓一下发生 IO 的进程，需要安装 iotop 进行捕获的直接链接" title="2.5.2 确认哪块盘发生了 IO 还不够，再抓一下发生 IO 的进程，需要安装 iotop 进行捕获的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># iotop -b -o -d 3 -t -qqq -n 30</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">10:18:41 7024 be/4 root 0.00 B/s 2.64 M/s 0.00 % 93.18 % fio</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-direct=1 -iodepth=128 -rw=randwrite -ioengine=libaio -bs=1k -size=1G</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-numjobs=1 -runtime=1000 -group_reporting -filename=iotest -name=Rand_ Write_Testing</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">每隔 3 秒采集一次，一共采集 30 次，静默模式，只显示有 io 发生的进程</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">通过这个命令我们可以确认如下信息：</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- 问题发生的时间</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- 产生 IO 的进程 id 以及进程参数（command）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- 进程产生的吞吐量（如果有多个可以把 qqq 去掉可显示总量）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- 进程占用当前 IO 的百分比</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>俗话说得好，光说不练假把式，我们实操来看一下 ( 涉及用户进程信息 , 没有得到客户授权因此以 fio 为演示 )。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="253-使用-fio-进行-io-压测具体参数可以参考块存储性能">2.5.3 使用 fio 进行 IO 压测，具体参数可以参考<a href="https://help.aliyun.com/document_detail/25382.html?spm=a2c4e.11153940.0.0.23263337ldOT1e" target="_blank" rel="noopener noreferrer">块存储性能</a><a href="#253-使用-fio-进行-io-压测具体参数可以参考块存储性能" class="hash-link" aria-label="253-使用-fio-进行-io-压测具体参数可以参考块存储性能的直接链接" title="253-使用-fio-进行-io-压测具体参数可以参考块存储性能的直接链接">​</a></h4>
<p><strong>压测窗口：</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">fio -direct=1 -iodepth=128 -rw=randwrite -ioengine=libaio -bs=1k -size=1G -numjobs=1 -runtime=1000 -group_reporting -filename=iotest -name=Rand_ Write_Testing</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Rand_Write_Testing: (g=0): rw=randwrite，bs=1K-1K/1K-1K/1K-1K， ioengine=libaio，iodepth=128</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fio-2.0.13</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Starting 1 process</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">^Cbs: 1 (f=1): [w] [8.5% done] [0K/2722K/0K /s] [0 /2722 /0 iops] [eta 05m:53s]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fio: terminating on signal 2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Rand_Write_Testing: (groupid=0，jobs=1): err= 0: pid=11974: Tue Jun 12 10:36:30 2018</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	write: io=88797KB，bw=2722.8KB/s，iops=2722 ，runt= 32613msec</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">	......</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>iotop 窗口：</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># iotop -n 10 -b -o -d 3 -t -qqq</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">10:36:03 11974 be/4 root 0.00 B/s 2.63 M/s 0.00 % 93.95 % fio</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-direct=1 -iodepth=128 -rw=randwrite -ioengine=libaio -bs=1k -size=1G</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-numjobs=1 -runtime=1000 -group_reporting -filename=iotest -name=Rand_ Write_Testing</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">10:36:06 11974 be/4 root 0.00 B/s 2.64 M/s 0.00 % 92.68 % fio</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-direct=1 -iodepth=128 -rw=randwrite -ioengine=libaio -bs=1k -size=1G</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-numjobs=1 -runtime=1000 -group_reporting -filename=iotest -name=Rand_ Write_Testing</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>iostat 窗口：</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># iostat -d 3 -k -x -t 10</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Linux 3.10.0-957.21.3.el7.x86_64 (tencent) 	08/05/2020 	_x86_64_	(1 CPU)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">06/12/2018 12:26:41 PM</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vda               0.12    12.66    4.59    8.56   127.09   143.47    41.16     0.07    7.91   15.91    3.61   0.65   0.85</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">scd0              0.00     0.00    0.00    0.00     0.00     0.00     7.10     0.00    1.03    1.03    0.00   1.02   0.00</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">06/12/2018 12:26:44 PM</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vda               0.00    81.14   32.66   84.18  1202.69  2488.89    63.19     0.31    2.75    3.00    2.66   0.34   3.97</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">scd0              0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过输出结果的时间点进行对比分析， 相对于 fio 的 IOPS， 吞吐量跟 iotop 以及 iostat 监控到的数据是一致。因此，看到这，您已经学会怎么查消耗 IO 的进程了。</p>
<p><strong>⚠️为了压测的慢一些特意把 bs 设置为 1k，这样执行的时间会比较久，fio 压 测详见前面的块存储性能。</strong></p>
<p>心细的同学可能发现 iotop 输出不带年月日，如果抓日志的时间超过 24 小时，时间重复怎么办？</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># iotop -b -o -d 1 -qqq |awk &#x27;{ print $0&quot;\t&quot; strftime(&quot;%Y-%m-%d-%H:%M:%S&quot;, systime()) } &#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 1252 be/3 root        0.00 B/s   22.83 K/s  0.00 %  1.12 % [jbd2/vda1-8]       2018-06-12:28:19</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">16374 be/4 root       76.12 K/s    0.00 B/s  0.00 %  0.33 % YDService   2018-06-12:28:19</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">21495 be/4 mysql       0.00 B/s  121.79 K/s  0.00 %  0.15 % mysqld --defaults-file=/etc/my.cnf  2018-06-12:28:19</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">21493 be/4 mysql       0.00 B/s    0.00 B/s  0.00 %  0.11 % mysqld --defaults-file=/etc/my.cnf  2018-06-12:28:19</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">21500 be/4 mysql       0.00 B/s    3.81 K/s  0.00 %  0.11 % mysqld --defaults-file=/etc/my.cnf  2018-06-12:28:19</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">13377 be/4 mysql       0.00 B/s    3.81 K/s  0.00 %  0.09 % mysqld --defaults-file=/etc/my.cnf  2018-06-12:28:19</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">18071 be/4 mysql       0.00 B/s    3.81 K/s  0.00 %  0.09 % mysqld --defaults-file=/etc/my.cnf  2018-06-12:28:19</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">32718 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.01 % [kworker/0:2]       2018-06-12:28:19</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">10641 be/4 root        0.00 B/s   11.42 K/s  0.00 %  0.00 % java -server -Xms1024m -Xmx1024m -jar ./kooteam.jar 2018-06-12:28:19</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">30019 be/4 polkitd     0.00 B/s   19.03 K/s  0.00 %  0.00 % postgres: stats collector process   2018-06-12:28:19</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 1252 be/3 root        0.00 B/s    0.00 B/s  0.00 %  0.71 % [jbd2/vda1-8]       2018-06-12:28:20</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">16374 be/4 root       90.77 K/s    0.00 B/s  0.00 %  0.47 % YDService   2018-06-12:28:20</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">21494 be/4 mysql       0.00 B/s    0.00 B/s  0.00 %  0.33 % mysqld --defaults-file=/etc/my.cnf  2018-06-12:28:20</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">21495 be/4 mysql       0.00 B/s   90.77 K/s  0.00 %  0.14 % mysqld --defaults-file=/etc/my.cnf  2018-06-12:28:20</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 3922 be/4 mysql       0.00 B/s    3.78 K/s  0.00 %  0.11 % mysqld --defaults-file=/etc/my.cnf  2018-06-12:28:20</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>详细参数就不讲了，大家可以看下输出结果行最后一列是年月日时分秒，那么 IO 消耗的始作俑者会查了吗？</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3linux-主机网络问题">3.Linux 主机网络问题<a href="#3linux-主机网络问题" class="hash-link" aria-label="3.Linux 主机网络问题的直接链接" title="3.Linux 主机网络问题的直接链接">​</a></h2>
<p><strong>说明</strong></p>
<blockquote>
<p><strong>从售后处理角度，阿里云用户业务系统搭建在 ECS 云服务器反馈最多的影响业务可用性问题：一个是前面已经讨论过的系统启停问题，另一个就是网络连通性问题。网络作为业务系统数据交互和转发的 &quot;通道&quot;，影响着 IT 系统的各个方面。网络问题涵盖的因素简化来讲一般涉及到收发节点，转发节点，流量链路等方面，由于本文主要分享系统诊断相关的处理经验，因此我们也更关注与 ECS 主机层面相关的网络影响，希望能带给一些处理主机层面网络问题的点拨。</strong></p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-ifdown-ifup-命令丢失处理">3.1 ifdown ifup 命令丢失处理<a href="#31-ifdown-ifup-命令丢失处理" class="hash-link" aria-label="3.1 ifdown ifup 命令丢失处理的直接链接" title="3.1 ifdown ifup 命令丢失处理的直接链接">​</a></h3>
<p><strong>问题现象</strong></p>
<blockquote>
<p><strong>主机网络不通，登录主机看网卡没有正确配置。</strong></p>
</blockquote>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.31.17.png" alt="iShot2020-08-0512.31.17" class="img_ev3q"></p>
<p><strong>解决方法</strong></p>
<blockquote>
<p><strong>尝试重启网卡，发现 ifdown ifup 命令不存在：</strong></p>
</blockquote>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.32.06.png" alt="iShot2020-08-0512.32.06" class="img_ev3q"></p>
<p>通过 <code>ifconfig</code> 配置 IP 信息</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ifconfig &lt;网卡&gt;	&lt;IP&gt;	netmask &lt;掩码&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后添加路由</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">route add -net 0.0.0.0/0	gw	&lt;公网网关&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果是经典网络需要配置上内外网卡 ip 和路由，路由命令</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">route add -net 10.0.0.0/8 gw	&lt;内网网关&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">route add -net 100.64.0.0/10 gw	&lt;内网网关&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>网络通了后运行命令</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">yum -y install initscripts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>安装上 ifup ifdown 相关的包</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.34.15.png" alt="iShot2020-08-0512.34.15" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-网络不通-strace-二度出手">3.2 网络不通？ strace 二度出手<a href="#32-网络不通-strace-二度出手" class="hash-link" aria-label="3.2 网络不通？ strace 二度出手的直接链接" title="3.2 网络不通？ strace 二度出手的直接链接">​</a></h3>
<p><strong>问题现象</strong></p>
<blockquote>
<p><strong>主机网络不通，路由不正确，0.0.0.0 指向了 eth0。</strong></p>
</blockquote>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.35.25-6602152.png" alt="iShot2020-08-0512.35.25-6602152" class="img_ev3q"></p>
<p><strong>问题分析</strong></p>
<p>尝试重启 network 服务，发现不行。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.36.33.png" alt="iShot2020-08-0512.36.33" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.37.12.png" alt="iShot2020-08-0512.37.12" class="img_ev3q"></p>
<p>尝试停止网络服务，然后通过 <code>ifup eth1</code> 发现路由是正常的。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.39.08.png" alt="iShot2020-08-0512.39.08" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.39.39.png" alt="iShot2020-08-0512.39.39" class="img_ev3q"></p>
<p>然后 <code>ifup eth0</code> 发现路由就异常了，基本定位在启动 eth0 网卡的时候出现了异常。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.40.15.png" alt="iShot2020-08-0512.40.15" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.40.43.png" alt="iShot2020-08-0512.40.43" class="img_ev3q"></p>
<p>用 <code>strace -f -e open ifup eth0|more</code> 追踪一下。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.41.30.png" alt="iShot2020-08-0512.41.30" class="img_ev3q"></p>
<p>运气加眼神比较好，发现调用了 <code>/etc/sysconfig/network</code> 文件。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.42.03.png" alt="iShot2020-08-0512.42.03" class="img_ev3q"></p>
<p>打开 <code>/etc/sysconfig/network</code> 文件，发现多了一行 <code>GATEWAYDEV=eth0</code>。</p>
<p><strong>解决方案</strong></p>
<p>注释 <code>/etc/sysconfig/network</code> 文件的 <code>GATEWAYDEV=eth0</code>，重启网络服务。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.43.23.png" alt="iShot2020-08-0512.43.23" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.43.48.png" alt="iShot2020-08-0512.43.48" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-time_wait--close_wait-的讨论总结">3.3 TIME_WAIT &amp; CLOSE_WAIT 的讨论总结<a href="#33-time_wait--close_wait-的讨论总结" class="hash-link" aria-label="3.3 TIME_WAIT &amp; CLOSE_WAIT 的讨论总结的直接链接" title="3.3 TIME_WAIT &amp; CLOSE_WAIT 的讨论总结的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.44.23.png" alt="iShot2020-08-0512.44.23" class="img_ev3q"></p>
<p>TIME_WAIT 是 TCP 连接关闭过程中的一个状态，具体是这么形成的：</p>
<ol>
<li>
<p>主动关闭端 A：发 FIN，进入 FIN-WAIT-1 状态，并等待 ......</p>
</li>
<li>
<p>被动关闭端 P：收到 FIN 后必须立即发 ACK，进入 CLOSE_WAIT 状态，并等 待 ......</p>
</li>
<li>
<p>主动关闭端 A：收到 ACK 后进入 FIN-WAIT-2 状态，并等待 ......</p>
</li>
<li>
<p>被动关闭端 P：发 FIN，进入 LAST_ACK 状态，并等待 ......</p>
</li>
<li>
<p>主动关闭端 A：收到 FIN 后必须立即发 ACK， 进入 TIME_WAIT 状态， 等待 2MSL 后结束 Socket。</p>
</li>
<li>
<p>被动关闭端 P：收到 ACK 后结束 Socket。 58　　&gt;　TIME_WAIT &amp; CLOSE_WAIT 的讨论总结</p>
</li>
</ol>
<p>因此，TIME_WAIT 状态是出现在主动发起连接关闭的一点， 和是谁发起的连接无关，可以是 client 端，也可以是 server 端。</p>
<p>而从 TIME_WAIT 状态到 CLOSED 状 态， 有一个超时设置， 这个超时设置是 2*MSL（RFC793 定义了 MSL 为 2 分钟，Linux 设置成了 30s）。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="331-为什么需要-time_wait-">3.3.1 为什么需要 TIME_WAIT ？<a href="#331-为什么需要-time_wait-" class="hash-link" aria-label="3.3.1 为什么需要 TIME_WAIT ？的直接链接" title="3.3.1 为什么需要 TIME_WAIT ？的直接链接">​</a></h4>
<p>主要有两个原因：</p>
<ul>
<li>为了确保两端能完全关闭连接。<!-- -->
<ul>
<li>假设 A 服务器是主动关闭连接方，B 服务器是被动方。 如果没有 TIME_WAIT 状态，A 服务器发出最后一个 ACK 就进入关闭状态， 如果这个 ACK 对端没有收到，对端就不能完成关闭。对端没有收到 ACK，会重发 FIN，此时连接关闭，这个 FIN 也得不到 ACK， 而有 TIME_WAIT， 则会重发这个 ACK， 确保对端能正常关闭连接。</li>
</ul>
</li>
<li>为了确保后续的连接不会收到“脏数据”。<!-- -->
<ul>
<li>刚才提到主动端进入 TIME_WAIT 后， 等待 2MSL 后 CLOSE， 这里的 MSL 是指（maximum segment lifetime， 我们内核一般是 30s，2MSL 就是1分钟）， 网络上数据包最大的生命周期。 这是为了使网络上由于重传出现的 old duplicate segment 都消失后，才能创建参数（四元组，源 IP/PORT，目标 IP/ PORT）相同的连接，如果等待时间不够长，又创建好了一样的连接，再收到 old duplicate segment，数据就错乱了。</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="332-time_wait-会导致什么问题">3.3.2 TIME_WAIT 会导致什么问题<a href="#332-time_wait-会导致什么问题" class="hash-link" aria-label="3.3.2 TIME_WAIT 会导致什么问题的直接链接" title="3.3.2 TIME_WAIT 会导致什么问题的直接链接">​</a></h4>
<ul>
<li>
<p>新建连接失败。</p>
<ul>
<li>
<p>TIME_WAIT 到 CLOSED，需要 2MSL=60s 的时间。这个时间非常长。每个连接在业务结束之后，需要 60s 的时间才能完全释放。 如果业务上采用的是短连接的方式，会导致非常多的 TIME_WAIT 状态的连接，会占用一些资源，主要是本地端口资源。</p>
</li>
<li>
<p>一台服务器的本地可用端口是有限的，也就几万个端口，由这个参数控制：</p>
<p><code>sysctl net.ipv4.ip_local_port_range</code></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.ip_local_port_range = 32768 61000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>当服务器存在非常多的 TIME_WAIT 连接， 将本地端口都占用了， 就不能主动发起新的连接去连其他服务器了。</p>
</li>
<li>
<p>这里需要注意，是主动发起连接，又是主动发起关闭的一方才会遇到这个问题。</p>
</li>
<li>
<p>如果是 server 端主动关闭 client 端建立的连接产生了大量的 TIME_WAIT 连接，这是不会出现这个问题的。除非是其中涉及到的某个客户端的 TIME_WAIT 连接都有好几万个了。</p>
</li>
</ul>
</li>
<li>
<p>TIME_WAIT 条目超出限制。</p>
<ul>
<li>
<p>这个限制，是由一个内核参数控制的：</p>
<p>sysctl net.ipv4.tcp_max_tw_buckets</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_max_tw_buckets = 5000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>超出了这个限制会报一条 INFO 级别的内核日志，然后继续关闭掉连接。并没有什么特别大的影响，只是增加了刚才提到的收到脏数据的风险而已。</p>
</li>
<li>
<p>另外的风险就是，关闭掉 TIME_WAIT 连接后，刚刚发出的 ACK 如果对端没有收到， 重发 FIN 包出来时，不能正确回复 ACK，只是回复一个 RST 包， 导致对端程序报错，说 connection reset。</p>
</li>
<li>
<p>因此 net.ipv4.tcp_max_tw_buckets 这个参数是建议不要改小的，改小会带来风险，没有什么收益，只是表面上通过 netstat 看到的 TIME_WAIT 少了些而已，有啥用呢？并且，建议是当遇到条目不够，增加这个值，仅仅是浪费一点点内存而已。</p>
</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="333-如何解决-time_wait">3.3.3 如何解决 time_wait?<a href="#333-如何解决-time_wait" class="hash-link" aria-label="3.3.3 如何解决 time_wait?的直接链接" title="3.3.3 如何解决 time_wait?的直接链接">​</a></h4>
<p>1）最佳方案是应用改造长连接，但是一般不太适用。</p>
<p>2）修改系统回收参数。设置以下参数。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_timestamps = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_tw_recycle = 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>设置该参数会带来什么问题？</p>
<p>如果这两个参数同时开启， 会校验源 ip 过来的包携带的 timestamp 是否递增， 如果不是递增的话，则会导致三次握手建联不成功，具体表现为抓包的时候看到 syn 发出，server 端不响应 syn ack。</p>
<p>通俗一些来讲就是，一个局域网有多个客户端访问您，如果有客户端的时间比别的客户端时间慢，就会建联不成功。</p>
<p>治标不治本的方式：</p>
<p>放大端口范围。 sysctl net.ipv4.ip_local_port_range</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.ip_local_port_range = 32768 61000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>放大 time_wait 的 buckets</p>
<p>sysctl net.ipv4.tcp_max_tw_buckets</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_max_tw_buckets = 180000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>关于 net.ipv4.tcp_max_tw_buckets 到底要不要放大，目前云上 ecs 多数是设置了 5000，在很多场景下可能是不够的。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0512.54.07.png" alt="iShot2020-08-0512.54.07" class="img_ev3q"></p>
<p>简单来说 net.ipv4.tcp_max_tw_buckets 的作用是为了 &quot;优雅&quot; 的关闭连接。</p>
<ol>
<li>
<p>完整的关闭连接。</p>
</li>
<li>
<p>避免有数据包重  复。</p>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="334-如果-tw-满了会怎么样">3.3.4 如果 tw 满了会怎么样<a href="#334-如果-tw-满了会怎么样" class="hash-link" aria-label="3.3.4 如果 tw 满了会怎么样的直接链接" title="3.3.4 如果 tw 满了会怎么样的直接链接">​</a></h4>
<p>TCP: time wait bucket table overflow。</p>
<p><strong>新内核</strong></p>
<ul>
<li>tw_bucket 满了的话， 会影响 established 状态的连接在 finack 的时候直接进入 closed 状态。</li>
</ul>
<p><strong>老内核</strong></p>
<ul>
<li>tw_bucket 满了的话，会将 tw_bucket 里面的 time_wait 按照一定的规则（如 LRU），将一批 time_Wait 直接进入 closed 状态 ，然后 established 状态发送 finack 后进 入 time_wait。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="335-tw-的开销是什么">3.3.5 tw 的开销是什么<a href="#335-tw-的开销是什么" class="hash-link" aria-label="3.3.5 tw 的开销是什么的直接链接" title="3.3.5 tw 的开销是什么的直接链接">​</a></h4>
<ul>
<li>
<p>特别少量的内存。</p>
</li>
<li>
<p>占用本地端口。</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="336-tw-放大的好与坏">3.3.6 tw 放大的好与坏<a href="#336-tw-放大的好与坏" class="hash-link" aria-label="3.3.6 tw 放大的好与坏的直接链接" title="3.3.6 tw 放大的好与坏的直接链接">​</a></h4>
<ol>
<li>
<p>放大的话需要更多的内存开销，但是几乎可以忽略不计。</p>
</li>
<li>
<p>占用更多的本地端口，需要适当的放大本地端口范围， 端口范围经过简单的测试，建议设置为 tw 的 1.5 倍。net.ipv4.ip_local_port_range</p>
</li>
<li>
<p>netstat 大量的扫描 socket 的时候（ss 不会扫描， 但是 ss 在 slab 内存特别高 的时候，也有可能会引起抖动），极端情况下可能会引起性能抖动。</p>
</li>
<li>
<p>tw 放大，local_port_range 放大，还可以配置复用以及快速回收等参数。</p>
</li>
<li>
<p>使用快速回收可能会导致 snat 时间戳递增校验问题，不递增的话 syn 不响应。</p>
</li>
</ol>
<p>特殊场景的时候（本机会发起大量短链接的时候）。</p>
<ol>
<li>
<p>nginx 结合 php-fpm 需要本地起端口。</p>
</li>
<li>
<p>nginx 反代如（java，容器等）。</p>
</li>
</ol>
<p>tcp_tw_reuse 参数需要结合 net.ipv4.tcp_timestamps = 1 一起来用。</p>
<p>即服务器即做客户端，也做 server 端的时候。</p>
<p>tcp_tw_reuse 参数用来设置是否可以在新的连接中重用 TIME_WAIT 状态的套接字。 注意， 重用的是 TIME_WAIT 套接字占用的端口号， 而不是 TIME_WAIT 套接字的内存等。这个参数对客户端有意义，在主动发起连接的时候会在调用的 inet_ hash_connect() 中会检查是否可以重用 TIME_WAIT 状态的套接字。如果你在服务器段设置这个参数的话，则没有什么作用，因为服务器端 ESTABLISHED 状态的套 接字和监听套接字的本地 IP、端口号是相同的，没有重用的概念。但并不是说服务器端就没有 TIME_WAIT 状态套接字。</p>
<p>因此该类场景最终建议是：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_tw_recycle = 0 关掉快速回收</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_tw_reuse = 1	开启 tw 状态的端口复用（客户端角色）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_timestamps = 1 复用需要 timestamp 校验为 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_max_tw_buckets = 30000 放大 bucket</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.ip_local_port_range = 15000 65000 放大本地端口范围</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>内存开销测试。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ss -s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Total: 15254 (kernel 15288)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">TCP: 15169 (estab 5，closed 15158，orphaned 0，synrecv 0，timewait 3/0)，ports 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Transport Total		IP		IPv6</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">*					15288		-			-</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RAW				0				0			0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">UDP				5				4			1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">TCP				11			11		0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">INET			16			15		1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">FRAG			0				0			0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">15000个socket消耗30多m内存</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0519.43.59.png" alt="iShot2020-08-0519.43.59" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="337-关于close_wait">3.3.7 关于CLOSE_WAIT<a href="#337-关于close_wait" class="hash-link" aria-label="3.3.7 关于CLOSE_WAIT的直接链接" title="3.3.7 关于CLOSE_WAIT的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0519.44.48.png" alt="iShot2020-08-0519.44.48" class="img_ev3q"></p>
<p>如上所示，CLOSE_WAIT 的状态是 服务器端 / 客户端程序收到外部过来的 FIN 之 后，响应了 ACK 包，之后就进入了 CLOSE_WAIT 状态。 一般来说，如果一切正常，稍后服务器端 / 客户端程序需要发出 FIN 包，进而迁移到 LAST_ACK 状态，收到对端过来的 ACK 后，完成 TCP 连接关 闭的整个过程。</p>
<p><strong>⚠️不管是服务器还是客户端， 只要是被动接收第一个 FIN 的那一方才会进入 CLOSE_WAIT 状态。</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="34-一次网络抖动经典案例分析">3.4 一次网络抖动经典案例分析<a href="#34-一次网络抖动经典案例分析" class="hash-link" aria-label="3.4 一次网络抖动经典案例分析的直接链接" title="3.4 一次网络抖动经典案例分析的直接链接">​</a></h3>
<p><strong>简介：</strong></p>
<blockquote>
<p><strong>本文记录的是一次多团队协作处理的抖动问题的过程，由于用户的执着，也得我们在这个案例分析得较为深入，希望对大家今后的此类案例的处理有所启发。</strong></p>
</blockquote>
<p><strong>视频学习</strong></p>
<p><a href="https://yq.aliyun.com/live/1037" target="_blank" rel="noopener noreferrer">性能抖动剖析(一)</a></p>
<p><a href="https://yq.aliyun.com/live/1038" target="_blank" rel="noopener noreferrer">性能抖动剖析(二)</a></p>
<p><a href="https://yq.aliyun.com/live/1078?spm=a2c6h.12873639.0.0.4a7f428cMLnIqV" target="_blank" rel="noopener noreferrer">性能抖动剖析(三)</a></p>
<p>网络抖动案例是一类处理难度较大的问题，原因主要是很多抖动发生的频率不高，且持续时间非常短极限情况可能仅有 100ms 以下，而很多用户的业务应用对实时性要求非常高，因此对此类在百毫秒的延迟也会非常敏感。本文记录的是一次多团队协作处理的抖动问题的过程，由于用户的执着，也使得我们在这个案例分析得较为深入，希望对大家今后的此类案例的处理有所启发。</p>
<p><strong>问题现象</strong></p>
<p>让我们先来看看问题现象吧，用户的应用日志记录了百毫秒甚至 1-2 秒级别的延迟， 而且发生较为频繁，由于业务的实时性要求较高，因此对业务的影响较大，当然其中也影响到了用户对迁云的信心。</p>
<p><strong>初步排查</strong></p>
<p>在用户通过应用层面的排查怀疑问题来源于虚拟网络环境的时候，我们需要做的第一 件事就是首先要将问题简单化。这一步是非常必要的，因为我们对用户的应用不可能有非常深入的了解，所以用户的应用日志具体含义和记录方式对我们来说更像黑盒。 我们所要做的是将问题现象转移到我们常见的系统组件上来，比如简单到 ping。所以我们第一件所做的事情就是编写脚本进行两台机器的内网互 ping，并将每次 ping 的延迟记录到文件。选择 ping 当然也是由于 ping 的间隔是可以设置到百毫秒的，比较容易说明问题。</p>
<p>在互 ping 的测试中我们确实发现有百毫秒以上的延迟，那么随后我们为了排除物理网络的影响，选择一台机器进行对网关的 ping 测试，同样发现了类似的延迟：</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0519.49.49.png" alt="iShot2020-08-0519.49.49" class="img_ev3q"></p>
<p>来看看上面的 ping 测试结果吧，初看也仅仅是一些百毫秒延迟的集中发生而已，但是仔细观察就会发现每次发生都有这样的情况，就是延迟在一组连续的 ping 上发生的，并且延迟是倒序排列的。那么这意味着什么呢？</p>
<p><strong>分析一</strong></p>
<p>通过以上的 ping 测试我们把问题简单化到了 ping 网关延迟上，但是上面如此规律的测试结果的具体含义是什么。首先他意味着并没有丢包发生，所以的 ICMP 请求都被系统发出并且收到回复，但是这样的倒序排列，更像是在问题时间段内所有的回复都没有被第一时间处理，而是突然在 800ms 之后系统处理了所有之前发生回复，因此才会产生这样的现象。那么我们此时可以有一个假设，在这 800ms 之前系统停止了对网络包的处理。那么什么样的情况会导致系统停止对网络包的处理呢？</p>
<p>答案是中断禁用，硬件中断是系统处理网络包的第一也是必须步骤，中断禁用会导致系统的软中断和中断都不能在 CPU 上发生，从而使得当前在 CPU 上运行的指令是无法被打断的，这经常被用于一些可能存在竞争风险的内核代码片段上，这些代码片段可能会因为被中断打断而导致数据不同步甚至损坏。</p>
<p>在当时我们内核团队甚至通过编写示例驱动，通过记录 timer 函数在一段时间内未能触发来验证了中断禁用的发生。那么庞大的内核代码中究竟是哪一部分的代码导致了这样的问题呢？</p>
<p><strong>分析二</strong></p>
<p>在这段分析过程中，我们做了大量实验，比如通过编写内核驱动来禁用中断，测试各类内核追踪方法是否能获得更进一步的信息，如禁用中断的堆栈，但是很可惜，目前尚无很好的方法在不影响业务的情况下较轻量级地获得禁用中断时的内核堆栈，原理也很简单，硬件中断本身优先级要高于一般进程和软中断，在其被禁用之后自然普通 软件层面的追踪方法也不起作用了。</p>
<p>然而问题就隐藏在一类系统的内存资源上，即系统的 slab 占用量相比正常系统要高出不少：</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0519.51.44.png" alt="iShot2020-08-0519.51.44" class="img_ev3q"></p>
<p>我们可以看到其中 dentry 在 slab 中的占用量达到了非常高的程度，dentry 是内存中表示目录和文件的对象，作为与 inode 的链接存在，在一般情况下如此高数字的 dentry 项可能代表这系统有大量被打开的文件。 然而此时我们首先需要解释大量的 dentry 项与禁用中断的关系，我们来看看 2.6 内核的这一段代码：</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0519.52.31.png" alt="iShot2020-08-0519.52.31" class="img_ev3q"></p>
<p>这是一段计算 slab 总量的代码，我们注意到它是以遍历链表的方式来统计 slab 总量的，而在进入链表之前调用了 <code>spin_lock_irq</code> 函数，我们来看看它的实现：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">inline</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">__spin_lock_irq</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 107)">spinlock_t</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">local_irq_disable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>于是我们可以确认在统计 slab 信息的时候，系统的行为是首先禁用中断，然后遍历链表统计 slab，最后再次启用中断。那么整个禁用中断的时间将取决于链表中对象的 个数，如果其对象数量惊人，很可能就会导致禁用中断时间过长。</p>
<p>验证问题也非常简单，我们可以主动运行 <code>cat /proc/slabinfo</code> 在获取 slab 信息，那么 以上函数也将会被调用，同时观察 ping 测试输出符合以上问题点的情况，即可以大致确认问题原因了。</p>
<p>此时我们已经有了可以暂时缓解问题的方法了，对 dentry 项是作为文件系统缓存的 一部分存在的，也就是真正的文件信息是存放于磁盘上的，dentry 只不过是在系统打开文件系统缓存在内存中的对象而已，即使缓存被清空，未来系统一样可以通过读取磁盘文件来重新生成 dentry 信息，因此我们可以通过类似 <code>echo 2 &gt; /proc/sys/vm/ drop_caches &amp;&amp; sync</code> 的方式来释放缓存，缓解问题。</p>
<p>但是其实事情远远没有就此结束，我们需要注意两个关键性的问题：</p>
<ol>
<li>是什么程序在反复地获取 slab 信息，产生类似 <code>cat /proc/slabinfo</code> 的效果。</li>
<li>这么多 dentry 生成的原因是什么。</li>
</ol>
<p>  如果不知道这两点这个问题随时可能会复现。而周期性地 drop cache 并不是一个长久根治的方案。</p>
<p>看到这里，这个缓存问题的处理是不是在哪儿见过？对的，在系统性能分析那一章节我们也提到相似的问题，建议再往前回顾一下心中应该就差不多有答案了。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4linux-系统服务与参数问题">4.Linux 系统服务与参数问题<a href="#4linux-系统服务与参数问题" class="hash-link" aria-label="4.Linux 系统服务与参数问题的直接链接" title="4.Linux 系统服务与参数问题的直接链接">​</a></h2>
<p>至此，我们分享了关于系统启动登录、性能、网络等三个方面遇到的一些经典和有趣案例，而这三个方面也基本涵盖了目前我们遇到的大部分的系统故障问题。此外，还有一类系统服务参数问题在我们处理的案例中也屡见不鲜。阿里云结合多年云上 ECS 运维经验和用户业务反馈，不断优化 ECS 系统镜像以最大化发挥用户业务效益，但很多时候由于业务增长缺少准确的预估，应用程序不合理设计等方面，需要调整系统默认的参数配置来适应和改善业务运行状态。下面我们分享几个案例来帮助大家更好的理解一些系统参数的实际参考和应用意义。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-4-个-limits-生效的问题">4.1 4 个 limits 生效的问题<a href="#41-4-个-limits-生效的问题" class="hash-link" aria-label="4.1 4 个 limits 生效的问题的直接链接" title="4.1 4 个 limits 生效的问题的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="411-第一个问题">4.1.1 第一个问题<a href="#411-第一个问题" class="hash-link" aria-label="4.1.1 第一个问题的直接链接" title="4.1.1 第一个问题的直接链接">​</a></h4>
<blockquote>
<p><strong>limits.conf 的限制在 /proc/pid/limits 中未生效。</strong></p>
</blockquote>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># cat /proc/3606/limits</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Limit					Soft Limit		Hard Limit		Units</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Max processes 31202					31202					processes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Max open files	1024				4096					files</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 CentOS 7 &amp; Ubuntu 系统中，使用 Systemd 替代了之前的 SysV。<code>/etc/security/ limits.conf</code> 文件的配置作用域缩小了。</p>
<p><code>/etc/security/limits.conf</code> 的配置， 只适用于通过 PAM 认证登录用户的资源限制， 它对 systemd 的 service 的资源限制不生效。 因此登录用户的限制， 通过 <code>/etc/ security/limits.conf</code> 与 <code>/etc/security/limits.d</code> 下的文件设置即可。 对于 systemd service 的资源设置，则需修改全局配置， 全局配置文件放在 <code>/etc/systemd/system.conf</code> 和 <code>/etc/systemd/user.conf</code>，同时也会加载两个对应目录中的所有 .conf 文件 <code>/etc/systemd/system.conf.d/.conf</code> 和 <code>/etc/systemd/user.conf.d/.conf</code>。 system.conf 是系统实例使用的，user.conf 是用户实例使用的。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">vim /etc/systemd/system.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DefaultLimitNOFILE=100000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DefaultLimitNPROC=65535</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>修改并重启即可。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># cat /proc/3613/limits</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Limit					Soft Limit		Hard Limit		Units</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Max processes 65535					65535					processes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Max open files	100000			100000				files</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="412-第二个问题">4.1.2 第二个问题<a href="#412-第二个问题" class="hash-link" aria-label="4.1.2 第二个问题的直接链接" title="4.1.2 第二个问题的直接链接">​</a></h4>
<blockquote>
<p><strong>在服务里面设置 LimitNOFILE=infinity 为什么不是无穷大？</strong></p>
<p><strong>在服务里面设置 LimitNOFILE=infinity 后， 通过查看 pid 的 limit 发现 openfile 是 65536 ，而不是无穷大。</strong></p>
</blockquote>
<p>查看服务配置</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[root@iZwz98aynkjcxvtra0f375Z ~]# cat /etc/systemd/system/multi-user.target.wants/docker.service |grep -vi &quot;^#&quot;|grep -vi &quot;^$&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Description=Docker Application Container Engine</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Documentation=https://docs.docker.com</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BindsTo=containerd.service</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">After=network-online.target firewalld.service containerd.service</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Wants=network-online.target</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Requires=docker.socket</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Type=notify</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ExecStart=/usr/bin/dockerd -H fd://</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ExecStartPost=/usr/sbin/iptables -P FORWARD ACCEPT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ExecReload=/bin/kill -s HUP $MAINPID</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">TimeoutSec=0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RestartSec=2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Restart=always</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">StartLimitBurst=3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">StartLimitInterval=60s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LimitNOFILE=infinity</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LimitNPROC=infinity</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LimitCORE=infinity</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">TasksMax=infinity</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Delegate=yes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">KillMode=process</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">WantedBy=multi-user.target</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>查看配置效果</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.03.33.png" alt="iShot2020-08-0520.03.33" class="img_ev3q"></p>
<p>这个是 systemd 的 bug，低于 240 的版本需要手动设置才可以生效。</p>
<p>LimitNOFILE=102400</p>
<p><a href="https://github.com/systemd/systemd/issues/6559" target="_blank" rel="noopener noreferrer">github上的说明</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="413- 第三个问题">4.1.3 第三个问题<a href="#413-第三个问题" class="hash-link" aria-label="4.1.3 第三个问题的直接链接" title="4.1.3 第三个问题的直接链接">​</a></h4>
<blockquote>
<p><strong>为什么 openfile 不能设置为 unlimited。</strong></p>
</blockquote>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[root@iZwz98aynkjcxvtra0f375Z ~]# ulimit -n</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">65535</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[root@iZwz98aynkjcxvtra0f375Z ~]# ulimit -n unlimited</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-bash: ulimit: open files: cannot modify limit: Operation not permitted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>原因是 <strong><span style="color:red">CentOS7里 openfile 不能大于 nr_open</span></strong>。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[root@iZwz98aynkjcxvtra0f375Z ~]# cat /proc/sys/fs/nr_open</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1048576</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[root@iZwz98aynkjcxvtra0f375Z ~]# ulimit -n 1048577</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-bash: ulimit: open files: cannot modify limit: Operation not permitted</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[root@iZwz98aynkjcxvtra0f375Z ~]# ulimit -n 1048576</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[root@iZwz98aynkjcxvtra0f375Z ~]# ulimit -n</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1048576</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="414-第四个问题">4.1.4 第四个问题<a href="#414-第四个问题" class="hash-link" aria-label="4.1.4 第四个问题的直接链接" title="4.1.4 第四个问题的直接链接">​</a></h4>
<p>使用 supervisor 管理进程（测试环境 Ubuntu 16.04）启动进程后，maxfile 是1024。</p>
<p>需要修改配置文件。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># cat /etc/supervisor/supervisord.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[supervisord]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">logfile=/var/log/supervisor/supervisord.log ; (main log file;default $CWD/ supervisord.log)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pidfile=/var/run/supervisord.pid ; (supervisord pidfile;default supervisord.pid)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">childlogdir=/var/log/supervisor		; (&#x27;AUTO&#x27; child log dir, default $TEMP)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">下面这两行</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">minfds=655350		; min. avail startup file descriptors;default 1024</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">minprocs=65535	; min. avail process descriptors;default 200</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.10.02.png" alt="iShot2020-08-0520.10.02" class="img_ev3q"></p>
<p><a href="https://www.kernel.org/doc/Documentation/sysctl/fs.txt" target="_blank" rel="noopener noreferrer">关于 file-max nr_open file_nr 的解释可参考此文章</a></p>
<p>参考外部文档</p>
<p><a href="https://www.cnblogs.com/zengkefu/p/5635153.html" target="_blank" rel="noopener noreferrer">cnblogs</a></p>
<p><a href="https://blog.csdn.net/google0802/article/details/52304776" target="_blank" rel="noopener noreferrer">csdn1</a></p>
<p><a href="http://blog.cloud.360.cn/post/tuning-your-system-for-high-concurrency.html" target="_blank" rel="noopener noreferrer">360云</a></p>
<p><a href="https://blog.csdn.net/qq_38165374/article/details/104881340" target="_blank" rel="noopener noreferrer">csdn2</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-六步排查-ss--netstat-统计结果不一样的原因">4.2 六步排查 ss &amp; netstat 统计结果不一样的原因<a href="#42-六步排查-ss--netstat-统计结果不一样的原因" class="hash-link" aria-label="4.2 六步排查 ss &amp; netstat 统计结果不一样的原因的直接链接" title="4.2 六步排查 ss &amp; netstat 统计结果不一样的原因的直接链接">​</a></h3>
<p><strong>ss 的结果，closed 状态的有 3w 多</strong></p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.15.45.png" alt="iShot2020-08-0520.15.45" class="img_ev3q"></p>
<p><strong>netstat 统计只有一百来个连接</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># netstat -n | awk &#x27;/^tcp/ {++S[$NF]} END {for(a in S) print a，S[a]}&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ESTABLISHED 9</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">TIME_WAIT 79</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>通过 strace 看看二者的统计方式得不同</strong></p>
<p><strong><span style="color:red">ss 直接取自 /proc/net/sockstat。</span></strong></p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.16.53.png" alt="iShot2020-08-0520.16.53" class="img_ev3q"></p>
<p><strong><span style="color:red">netstat 是读取的 /proc/pid/fd 下面关联 tcp 的 socket。</span></strong></p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.18.53.png" alt="iShot2020-08-0520.18.53" class="img_ev3q"></p>
<p><strong>netstat 也有扫到三万多个 socket， 为什么输出的时候没有展示呢？</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">By default，netstat displays a list of open sockets. If you don’t specify any address families，then the active sockets of all configured address families will be printed.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">默认情况下，netstat显示打开的套接字列表。如果不指定任何地址系列，则所有已配置地址系列的活动套接字将被打印</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>找出来哪个 pid 的 socket 比较多， 对 /proc/pid/fd 目录做批  量扫描</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">for d in /proc/[0-9]*;do pid=$(basename $d);s=$(ls -l $d/fd | egrep -i socket | wc -l 2&gt;/dev/null); [ -n &quot;$s&quot; ] &amp;&amp; echo &quot;$s $pid&quot;;done | sort -n | tail -20</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>进入到 <code>/proc/7136/</code>(上述命令打印出的目录) 目录查看 cmdline 或者直接 ps -ef |grep pid 拿到进程，后面就需要客户自查了</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-为什么明明内存很充足但是-java-程序仍申请不到内存">4.3 为什么明明内存很充足但是 java 程序仍申请不到内存<a href="#43-为什么明明内存很充足但是-java-程序仍申请不到内存" class="hash-link" aria-label="4.3 为什么明明内存很充足但是 java 程序仍申请不到内存的直接链接" title="4.3 为什么明明内存很充足但是 java 程序仍申请不到内存的直接链接">​</a></h3>
<p><strong>背景信息</strong></p>
<blockquote>
<p><strong>用户有一台 8G 内存的实例，剩余内存还 很多（7G 左右），而 java 程序使用了 4G 内 存申请，直接抛出 OOM。</strong></p>
</blockquote>
<p><strong>排查如下</strong></p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.23.37.png" alt="iShot2020-08-0520.23.37" class="img_ev3q"></p>
<p>oom 的记录显示为申请 4g 内存失败。</p>
<p>4294967296 /1024 /1024 = 4096 M</p>
<p>1.第一反应是想起来之前的 <code>vm.min_free_kbytes &amp; nr_hugepage</code> 导致的 free 大于 available 案例有关。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">centos7 memavailable 小于 memfree</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">二者的统计方式不一样</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">MemFree: The sum of LowFree+HighFree</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+MemAvailable: An estimate of how much memory is available for starting new</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+		applications，without swapping. Calculated from MemFree,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+		SReclaimable，the size of the file LRU lists，and the low</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+		watermarks in each zone.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+		The estimate takes into account that the system needs some</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+		page cache to function well，and that not all reclaimable</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+		slab will be reclaimable，due to items being in use. The</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+		impact of those factors will vary from system to system.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/ commit/?id=34e431b0ae398fc54ea69ff85ec700722c9da773</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">memfree 统计的是所有内存的 free 内存，而 memavailable 统计的是可以拿来给程序用的内存，而客户设置了 vm.min_free_kbytes（2.5G），这个内存在 free 统计，但是不在 memavailable 统计</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nr_hugepage 也会有这个问题</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2.跟客户要 <code>free -m &amp;&amp; sysctl -p &amp;&amp; /proc/meminfo</code> 等信息分析问题。</p>
<p>HugePages_Total 为 0 说明没有设置 nr_hugepage。</p>
<p>MemAvailable: 7418172 kB 说明这么多内存可用。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.26.48.png" alt="iShot2020-08-0520.26.48" class="img_ev3q"></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># sysctl -p</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.ip_forward = 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.conf.default.accept_source_route = 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kernel.sysrq = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kernel.core_uses_pid = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_syncookies = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kernel.msgmnb = 65536</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kernel.msgmax = 65536</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kernel.shmmax = 500000000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kernel.shmmni = 4096</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kernel.shmall = 4000000000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kernel.sem = 250 512000 100 2048</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_tw_recycle=1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_max_syn_backlog=4096</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.core.netdev_max_backlog=10000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm.overcommit_memory=2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.conf.all.arp_filter = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.ip_local_port_range=1025 65535</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kernel.msgmni = 2048</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv6.conf.all.disable_ipv6=1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_max_tw_buckets = 5000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_max_syn_backlog = 8192</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_keepalive_time = 600</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#cat /proc/meminfo</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">MemTotal:		8009416 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">MemFree:		7347684 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">MemAvailable:		7418172 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Buffers:		18924 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Cached:		262836 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SwapCached:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Active:		315188 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Inactive:		222364 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Active(anon):		256120 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Inactive(anon):		552 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Active(file):		59068 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Inactive(file):		221812 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Unevictable:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Mlocked:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SwapTotal:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SwapFree:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Dirty:		176 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Writeback:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">AnonPages:		255804 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Mapped:		85380 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Shmem:		880 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Slab:		40660 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SReclaimable:		22240 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SUnreclaim:		18420 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">KernelStack:		4464 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PageTables:		6512 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NFS_Unstable:		0 kB		</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Bounce:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">WritebackTmp:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CommitLimit:		4004708 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Committed_AS:		2061568 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">VmallocTotal:		34359738367 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">VmallocUsed:		21452 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">VmallocChunk:		34359707388 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HardwareCorrupted:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">AnonHugePages:		126976 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CmaTotal:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CmaFree:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HugePages_Total:		0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HugePages_Free:		0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HugePages_Rsvd:		0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HugePages_Surp:		0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Hugepagesize:		2048 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DirectMap4k:		114560 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DirectMap2M:		4079616 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DirectMap1G:		6291456 kB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3.实际上面的 meminfo 已经说明了问题，但是由于经验不足，一时没有看明白怎么回事，尝试自行测试。</p>
<p>使用 java 命令，去申请超出我的测试机物理内存尝试，拿到报错。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[root@test ~]# java -Xmx8192M -version</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">openjdk version &quot;1.8.0_242&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">OpenJDK Runtime Environment (build 1.8.0_242-b08)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">OpenJDK 64-Bit Server VM (build 25.242-b08，mixed mode)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[root@test ~]# java -Xms8192M -version</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">OpenJDK 64-Bit Server VM warning: INFO: os::commit_ memory(0x00000005c0000000，5726797824，0) failed; error=&#x27;Cannot allocate memory&#x27; (errno=12)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># There is insufficient memory for the Java Runtime Environment to continue.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Native memory allocation (mmap) failed to map 5726797824 bytes for committing reserved memory.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># An error report file with more information is saved as:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># /root/hs_err_pid8769.log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[root@test ~]# java -Xms4096M -version</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">openjdk version &quot;1.8.0_242&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">OpenJDK Runtime Environment (build 1.8.0_242-b08)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">OpenJDK 64-Bit Server VM (build 25.242-b08，mixed mode)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[root@test ~]# java -Xms5000M -version</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">OpenJDK 64-Bit Server VM warning: INFO: os::commit_ memory(0x0000000687800000，3495428096，0) failed; error=&#x27;Cannot allocate memory&#x27; (errno=12)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">......</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--------------- S Y S T E M</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">---------------</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">OS:CentOS Linux release 7.4.1708 (Core)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">uname:Linux 3.10.0-693.2.2.el7.x86_64 #1 SMP Tue Sep 12 22:26:13 UTC 2017 x86_64</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">libc:glibc 2.17 NPTL 2.17</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">rlimit: STACK 8192k，CORE 0k，NPROC 15088，NOFILE 65535，AS infinity</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">load average:0.05 0.05 0.05</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/proc/meminfo:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">MemTotal:		3881692 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">MemFree:		2567724 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">MemAvailable:		2968640 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Buffers:		69016 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Cached:		536116 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SwapCached:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Active:		355280 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Inactive:		326020 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Active(anon):		87864 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Inactive(anon):		13296 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Active(file):		267416 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Inactive(file):		312724 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Unevictable:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Mlocked:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SwapTotal:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SwapFree:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Dirty:		72 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Writeback:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">AnonPages:		72200 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Mapped:		31232 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Shmem:		24996 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Slab:		63032 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SReclaimable:		51080 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SUnreclaim:		11952 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">KernelStack:		1664 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PageTables:		4044 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NFS_Unstable:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Bounce:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">WritebackTmp:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CommitLimit:		1678700 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Committed_AS:		2282236 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">VmallocTotal:		34359738367 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">VmallocUsed:		14280 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">VmallocChunk:		34359715580 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HardwareCorrupted:		0 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">AnonHugePages:		30720 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HugePages_Total:		256</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HugePages_Free:		256</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HugePages_Rsvd:		0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HugePages_Surp:		0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Hugepagesize:		2048 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DirectMap4k:		57216 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DirectMap2M:		3088384 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DirectMap1G:		3145728 kB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">container (cgroup) information:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">container_type: cgroupv1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cpu_cpuset_cpus: 0-1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cpu_memory_nodes: 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">active_processor_count: 2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cpu_quota: -1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cpu_period: 100000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cpu_shares: -1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">memory_limit_in_bytes: -1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">memory_and_swap_limit_in_bytes: -1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">memory_soft_limit_in_bytes: -1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">memory_usage_in_bytes: 697741312</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">memory_max_usage_in_bytes: 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CPU:total 2 (initial active 2) (1 cores per cpu，2 threads per core) family 6 model 79 stepping 1，cmov，cx8，fxsr，mmx，sse，sse2，sse3，ssse3，sse4.1， sse4.2，popcnt，avx，avx2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">，aes，clmul，erms，rtm，3dnowpref，lzcnt，ht，tsc，bmi1，bmi2，adx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/proc/cpuinfo:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">processor		: 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vendor_id		: GenuineIntel</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cpu family		: 6</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">model		: 79</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">model name		: Intel(R) Xeon(R) CPU E5-2682 v4 @ 2.50GHz</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">stepping		: 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">microcode		: 0x1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cpu MHz		: 2500.036</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cache size		: 40960 KB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">physical id : 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">siblings		: 2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">core id		: 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cpu cores		: 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apicid		: 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">initial apicid		: 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fpu		: yes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fpu_exception		: yes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cpuid level : 13</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">wp		: yes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">flags : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">eagerfpu pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch fsgsbase tsc_adjust</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">bmi1 hle avx2 smep bmi2 erms invpcid rtm rdseed adx smap xsaveopt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">bogomips		: 5000.07</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">clflush size		: 64</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cache_alignment : 64</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">address sizes		: 46 bits physical，48 bits virtual</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">power management:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">processor		: 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vendor_id		: GenuineIntel</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cpu family		: 6</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">model		: 79</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">model name		: Intel(R) Xeon(R) CPU E5-2682 v4 @ 2.50GHz</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">stepping		: 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">microcode		: 0x1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cpu MHz		: 2500.036</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cache size		: 40960 KB</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">physical id : 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">siblings		: 2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">core id		: 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cpu cores		: 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apicid		: 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">initial apicid		: 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fpu		: yes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fpu_exception		: yes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cpuid level : 13</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">wp		: yes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">eagerfpu pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch fsgsbase tsc_adjust</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">bmi1 hle avx2 smep bmi2 erms invpcid rtm rdseed adx smap xsaveopt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">bogomips		: 5000.07</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">clflush size		: 64</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cache_alignment : 64</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">address sizes		: 46 bits physical，48 bits virtual</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">power management:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Memory: 4k page，physical 3881692k(2567600k free), swap 0k(0k free)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">vm_info: OpenJDK 64-Bit Server VM (25.242-b08) for linux-amd64 JRE (1.8.0_242-b08)，built on Jan 28 2020 14:28:22 by &quot;mockbuild&quot; with gcc 4.8.5 20150623 (Red Hat 4.8.5-39)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">time: Thu Feb 20 15:13:30 2020</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">timezone: CST</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">elapsed time: 0 seconds (0d 0h 0m 0s)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>4.java 测试证明正常申请内存不会有问题，超额的内存才会 oom，那么为什么超额呢，视线回归到 sysctl -p 有所发现。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.39.33.png" alt="iShot2020-08-0520.39.33" class="img_ev3q"></p>
<p>5.两相对照，说明客户设置的 vm.overcommit_memory 在生效， 建议改回 0 再试试。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.40.16.png" alt="iShot2020-08-0520.40.16" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="44-请不要忽略-min_free_kbytes-的设置">4.4 请不要忽略 min_free_kbytes 的设置<a href="#44-请不要忽略-min_free_kbytes-的设置" class="hash-link" aria-label="4.4 请不要忽略 min_free_kbytes 的设置的直接链接" title="4.4 请不要忽略 min_free_kbytes 的设置的直接链接">​</a></h3>
<p><strong>问题背景</strong></p>
<blockquote>
<p><strong>服务器内主要运行程序：Jadeos。</strong></p>
</blockquote>
<p><strong>问题描述</strong></p>
<blockquote>
<p><strong>LINUX tmpfs 空间使用未达到 100%，内存也未占满。 执行任何命令提示 bash: fork: Cannot allocate memory 过几秒时间系统会自动重启。 但在客户本地环境是没有这种情况的，即使 tmpfs 使用达到 100% 系统未提示 Cannot allocate memory。</strong></p>
</blockquote>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.42.24.png" alt="iShot2020-08-0520.42.24" class="img_ev3q"></p>
<p><strong>处理过程</strong></p>
<p>1.首先判断客户是否内存不足导致，每次执行测试操作后，free 结果显示可用内存是有的。</p>
<p>2.当进程 Process 比较多， 导致无法分配 pid， 也会提示 Cannot allocate memory，执行命令 pstree -a | wc -l 统计下进程数，排除进程数过多导致的内存无法分配。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.43.42.png" alt="iShot2020-08-0520.43.42" class="img_ev3q"></p>
<p>3.登录主机内部查看客户客户内部设置 min_free_kbytes 值为 1G。</p>
<p>即强制 Linux 系统最低保留多少空闲内存（Kbytes），如果系统可用内存低于该值，默认会启用 oom killer 或者强制重启。</p>
<p>当耗尽内存直至系统最低保存内存时会有两种现象， 根据内核参数 <code>vm.panic_ on_oom</code> 设置值的不同而有不同的行为。</p>
<p><code>vm.panic_on_oom=0</code> 系统会提示 oom ，并启动 oom-killer 杀掉占用最高内存的进程。 <code>vm.panic_on_oom =1</code>. 系统关闭 oom, 不会启动 oom-killer，而是会自动重启。</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.44.52.png" alt="iShot2020-08-0520.44.52" class="img_ev3q"></p>
<p><strong>解决方案</strong></p>
<ul>
<li>建议客户降低 <code>min_free_kbytes</code> 值。</li>
<li>更改减小 <code>min_free_kbytes</code> 后，再执行更多次的拷贝，最后一次 free 可用内存显示解决到设置值是，才提示内存不足。 这个是符合 linux 系统对内存管理的预期的。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5最后的彩蛋">5.最后的彩蛋<a href="#5最后的彩蛋" class="hash-link" aria-label="5.最后的彩蛋的直接链接" title="5.最后的彩蛋的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="某地区口罩项目架构演进及优化经验">某地区口罩项目架构演进及优化经验<a href="#某地区口罩项目架构演进及优化经验" class="hash-link" aria-label="某地区口罩项目架构演进及优化经验的直接链接" title="某地区口罩项目架构演进及优化经验的直接链接">​</a></h3>
<p><strong>简介</strong></p>
<blockquote>
<p><strong>疫情初期某地政府决定发放一批免费口罩面向该市市民，该市市民均可免费预约领取，预约时间为早上 9点 -12点，因此该场景为限时抢购类型场景， 会面临非常大的定时超大流量超大并发问题，在该项目的落地过程中，涉及的架构演变，做了一些记录和思考。</strong></p>
</blockquote>
<p><strong>原始架构图示 &amp; 分析（2月2号晚上 22 点左右的原始架构）。</strong></p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.48.57.png" alt="iShot2020-08-0520.48.57" class="img_ev3q"></p>
<ul>
<li>
<p>客户端走 https 协议直接访问 ecs。</p>
</li>
<li>
<p>ECS 上使用 nginx 自建 https 监听。-</p>
</li>
<li>
<p>Nginx 反代 tomcat，Nginx 处理静态文件，tomcat 处理动态请求。</p>
</li>
<li>
<p>程序先去 redis 查缓存， 如未命中则去数据库查询数据， 同时 redis 与 mysql 之间的数据同步靠程序控制。</p>
<ul>
<li>优点：易管理，易部署。</li>
<li>缺点：性能差，无扩展性，存在单点风险。 事实证明：该应用一经上线立刻被打挂了（未知原因预约页面泄露，导致还未到预约时间即被打挂）。</li>
</ul>
</li>
</ul>
<p><strong>我方介入后的二代架构（24点左右找的我们，早上9点要开服，时间太紧，任务太重， 程序不能动的情况下，几十万的并发架构如何做？ 2月3号早上9点左右的架构，4号也恢复了这个架构）。</strong></p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.51.16.png" alt="iShot2020-08-0520.51.16" class="img_ev3q"></p>
<ul>
<li>
<p>接入 slb，通过镜像横向扩展负载能力。</p>
</li>
<li>
<p>接入读写分离数据库架构， 通过阿里云数据库自动进行读写分离， 自动同步数据。</p>
</li>
<li>
<p>调整 nginx 协议。</p>
</li>
<li>
<p>同架构备集群启用（域名解析做了两个 A 记录）。</p>
</li>
<li>
<p>分析访问日志发现失败原因在获取短信 &amp; 登陆初始化 cookie 的点上。</p>
<ul>
<li>优点：增加了高可用性，扩展了负载能力。</li>
<li>缺点：对流量预估不足， 静态页面也在 ECS 上， 因此 SLB 的出带宽一度达到最大值 5.xG，并发高达 22w+，用户一度打不开页面，同时由于新网的限制客户无法自助添加解析， 当晚联系不到新网客服导致 CDN 方案搁浅。</li>
</ul>
</li>
</ul>
<p><strong>知耻而后勇的第三代架构（2月4号 &amp; 2月5号的架构，5号应用）。</strong></p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.53.38.png" alt="iShot2020-08-0520.53.38" class="img_ev3q"></p>
<ul>
<li>
<p>接入 CDN 分流超大带宽。</p>
</li>
<li>
<p>取消 nginx 的代理。</p>
</li>
<li>
<p>做了新程序无法准时上线的灾备切换方案（没想到还真用到了）。</p>
</li>
<li>
<p>使用虚拟服务器组做新老程序的切换，但是缺点是一个七层监听的 slb 后端只能挂 200 个机器，再多 slb 也扛不住了，导致老程序刚承接的时候再度挂掉。</p>
</li>
<li>
<p>5号使用这个架构上线，7分钟库存售罄，且体验极度流程，丝般顺滑，健康同学开发的新程序真是太爽的。</p>
<ul>
<li>优点：CDN 负担静态资源的流量降低了 SLB 的出带宽，压测的效果也非常理想。</li>
<li>缺点：需要多一个独立的域名在 页面里面，涉及跨域，4号临开服之际测试发现入库 &amp; 预约短信乱码返回，紧急切换回了老程序，即二代架构。</li>
</ul>
</li>
</ul>
<p><strong>理想架构</strong></p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-10-14%2015.17.59.png" alt="iShot2020-10-14 15.17.59" class="img_ev3q"></p>
<ul>
<li>
<p>主域名接入 CDN，</p>
</li>
<li>
<p>CDN 通过设置回源 http、https 协议去访问 SLB 的不同监听实现新老程序之间的切换，具体实现为回源协议对应。不同监听，监听对应不同的程序。</p>
<ul>
<li>优点：静态加速降低 SLB 带宽，动态回源，无跨域问题 ，切换方便。</li>
<li>缺点：仍需手工设置，镜像部署 ecs 不方便，如果时间充足，可以直接上容器的架构该有多美好呢，一个 scale 可以扩出来几十上百的 pod，也可以做节点自动扩容。</li>
</ul>
</li>
</ul>
<p><strong>总结</strong></p>
<p>总结：时间紧任务重，遇到了 N 多的坑，想起来一个补一个 ~</p>
<ol>
<li>
<p>vcpu 购买额度。</p>
</li>
<li>
<p>slb 后端挂载额度。</p>
</li>
<li>
<p>客户余额不足欠费停机。</p>
</li>
<li>
<p>新网解析需要联系客服添加。</p>
</li>
<li>
<p>第一次考虑 CDN 架构的时候未考虑跨域问题。</p>
</li>
<li>
<p>新程序开发期间未连接主库测试，导致上线失败（主库乱码）。</p>
</li>
<li>
<p>第一次（3 号）被打挂的时候只关注了 slb 的流量，未详细分析失败最多的环节。</p>
</li>
<li>
<p>上线前压测缺失，纯靠人工测试功能。</p>
</li>
<li>
<p>压测靠人手一台 jmeter（4号晚上到5号早上引入了PTS进行压测）。</p>
</li>
<li>
<p>突然想起来客户原始的程序是放在 windows 上的，导致性能出现了大大的折扣。</p>
</li>
</ol>
<p>最后的成果统计（采样分析，实际数据比这个还大）：</p>
<p><img decoding="async" loading="lazy" src="https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-08-0520.57.36.png" alt="iShot2020-08-0520.57.36" class="img_ev3q"></p>
<p>最后上线的三代架构，为了保险起见上了 150 台机器，但是根据活动期间的观察，以及对压测结果的评估，上50台机器应该就可以抗住了，从持续5小时一直崩溃被终端用户骂街，到7分钟库存售罄的领导赞赏，虽然经历了3个通宵的戮战，依然可以隐隐约约感觉到身心都得到了升华 ~</p>
<p><strong>优化参数笔记</strong></p>
<p><strong>1.参数优化</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_max_tw_buckets = 5000 --&gt; 50000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_max_syn_backlog = 1024 --&gt; 4096</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.core.somaxconn = 128 --&gt; 4096</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_tw_reuse = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_timestamps = 1(5 和 6 同时开启可能会导致nat上网环境建联概率失败 )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.tcp_tw_recycle = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/etc/security/limits.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">* soft nofile 65535</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">* hard nofile 65535</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nginx 参数优化</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">worker_connections	1024--&gt;10240;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">worker_processes	1--&gt;16;（根据实际情况设置，可以设置成 auto）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">worker_rlimit_nofile 1024--&gt;102400;	</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">listen 80 backlog 511--&gt;65533；</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">部分场景也可以考虑 nginx 开启长连接来优化短链接带来的开销</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2.架构优化</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">扩容SLB后端ECS数量，ecs配置统一</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nginx反代后端upstream无效端口去除</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">云助手批量处理服务，参数优化，添加实例标识</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">云监控大盘监控，ECS slb dcdn redis</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">调整SLB为7层监听模式，前7后4关闭会话保持导致登录状态失效，</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>3.程序优化</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">添加 gc log，捕捉 gc 分析问题，设置进程内存</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/usr/bin/java -server -Xmx8g -verbose:gc -XX:+PrintGCDetails -Xloggc:/var/ log/9052.gc.log -Dserver.port=9052 -jar /home/app/we.*****.com/serverboot0.0.1-SNAPSHOT.jar</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">优化短信发送逻辑，登陆先查询 redis 免登 session，无免登 session 再允许发送短信验证码（降短信的量，优化登陆体验）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">jedis 连接池优化</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">maxTotal 8--&gt;20</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">acceptcount 优化（对标 somaxconn）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">bug：</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">springboot1.5 带的 jedis2.9.1 的 redis 连接泄漏的问题，导致 tomcat 800 进程用满后都无 限等待 redis 连接</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">后来进一步调研发现这个问题在 2.10.2 已经修复，而且 2.10.2 向后兼容 2.9.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>4.数据库优化</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis 公网地址变更为内网地址</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis session 超时设置缩短，用于释放 redis 连接</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">server.servlet.session.timeout=300s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spring.session.timeout=300s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">慢 SQL 优化（RDS 的 CloudDBA 非常好用哟）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">添加只读实例，自动读写分离</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">优化 backlog</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">添加读写分离实例数量</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/linux/阿里云开发者社区优秀文章/shell脚本/shell脚本速查手册"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">shell脚本速查手册</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/mac专区/brew安装"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">brew安装</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1linux启动与登陆问题" class="table-of-contents__link toc-highlight">1.Linux启动与登陆问题</a><ul><li><a href="#11-超详细系统启动与登陆异常排查点" class="table-of-contents__link toc-highlight">1.1 超详细系统启动与登陆异常排查点</a><ul><li><a href="#111-系统启动异常" class="table-of-contents__link toc-highlight">1.1.1 系统启动异常</a></li><li><a href="#112-root-登陆异常" class="table-of-contents__link toc-highlight">1.1.2 root 登陆异常</a></li><li><a href="#113-系统登陆不进去了不挂盘的情况下怎么操作" class="table-of-contents__link toc-highlight">1.1.3 系统登陆不进去了，不挂盘的情况下怎么操作？</a></li><li><a href="#114-场景覆盖" class="table-of-contents__link toc-highlight">1.1.4 场景覆盖</a><ul><li><a href="#1141-linux-系统常见问题诊断覆盖以下场景" class="table-of-contents__link toc-highlight">1.1.4.1 Linux 系统常见问题诊断覆盖以下场景</a></li><li><a href="#1142-linux-系统常见启动问题修复覆盖以下场景" class="table-of-contents__link toc-highlight">1.1.4.2 Linux 系统常见启动问题修复覆盖以下场景</a></li></ul></li><li><a href="#115-各种脚本" class="table-of-contents__link toc-highlight">1.1.5 各种脚本</a></li></ul></li><li><a href="#12-grubconf-文件内容被清空了怎么办" class="table-of-contents__link toc-highlight">1.2 grub.conf 文件内容被清空了怎么办</a></li><li><a href="#13-巧妙利用-strace-查找丢失的文件" class="table-of-contents__link toc-highlight">1.3 巧妙利用 strace 查找丢失的文件</a></li><li><a href="#14-小心-pam-不让你登陆" class="table-of-contents__link toc-highlight">1.4 小心 PAM 不让你登陆</a></li><li><a href="#15-centos-登陆卡住的原因被我找到了" class="table-of-contents__link toc-highlight">1.5 CentOS 登陆卡住的原因被我找到了</a></li></ul></li><li><a href="#2linux-性能问题" class="table-of-contents__link toc-highlight">2.Linux 性能问题</a><ul><li><a href="#21-找到-linux-虚机-load-高的元凶" class="table-of-contents__link toc-highlight">2.1 找到 Linux 虚机 Load 高的&quot;元凶&quot;</a><ul><li><a href="#211-load-average-的值从何而来" class="table-of-contents__link toc-highlight">2.1.1 Load average 的值从何而来</a></li><li><a href="#212-如何找出系统中-load-高时处于运行队列的进程" class="table-of-contents__link toc-highlight">2.1.2 如何找出系统中 load 高时处于运行队列的进程</a></li></ul></li><li><a href="#22-oom-killer-是被谁触发的" class="table-of-contents__link toc-highlight">2.2 OOM killer 是被谁触发的</a><ul><li><a href="#221-问题描述" class="table-of-contents__link toc-highlight">2.2.1 问题描述</a></li><li><a href="#222-知识点梳理" class="table-of-contents__link toc-highlight">2.2.2 知识点梳理</a><ul><li><a href="#2221-预备知识" class="table-of-contents__link toc-highlight">2.2.2.1 预备知识</a><ul><li><a href="#22211-几个基本的概念" class="table-of-contents__link toc-highlight">2.2.2.1.1 几个基本的概念</a></li><li><a href="#22212-内核分配内存的函数" class="table-of-contents__link toc-highlight">2.2.2.1.2 内核分配内存的函数</a></li></ul></li><li><a href="#2222-日志解读" class="table-of-contents__link toc-highlight">2.2.2.2 日志解读</a></li></ul></li></ul></li><li><a href="#23-我的服务器内存去哪儿了" class="table-of-contents__link toc-highlight">2.3 我的服务器内存去哪儿了</a></li><li><a href="#24-cpu-占用不高但网络性能很差的一个原因" class="table-of-contents__link toc-highlight">2.4 CPU 占用不高但网络性能很差的一个原因</a><ul><li><a href="#241-什么是中断" class="table-of-contents__link toc-highlight">2.4.1 什么是中断？</a></li><li><a href="#242-什么是-rpsrfs" class="table-of-contents__link toc-highlight">2.4.2 什么是 RPS/RFS</a></li><li><a href="#243-如何查看网卡的队列数" class="table-of-contents__link toc-highlight">2.4.3 如何查看网卡的队列数</a></li></ul></li><li><a href="#25-一次-io-异常捕获过程" class="table-of-contents__link toc-highlight">2.5 一次 IO 异常捕获过程</a><ul><li><a href="#251-采集系统-io确认-io-异常发生在系统盘还是数据盘使用系统自带的-iostat-即可采集" class="table-of-contents__link toc-highlight">2.5.1 采集系统 IO，确认 IO 异常发生在系统盘，还是数据盘，使用系统自带的 iostat 即可采集</a></li><li><a href="#252-确认哪块盘发生了-io-还不够再抓一下发生-io-的进程需要安装-iotop-进行捕获" class="table-of-contents__link toc-highlight">2.5.2 确认哪块盘发生了 IO 还不够，再抓一下发生 IO 的进程，需要安装 iotop 进行捕获</a></li><li><a href="#253-使用-fio-进行-io-压测具体参数可 以参考块存储性能" class="table-of-contents__link toc-highlight">2.5.3 使用 fio 进行 IO 压测，具体参数可以参考块存储性能</a></li></ul></li></ul></li><li><a href="#3linux-主机网络问题" class="table-of-contents__link toc-highlight">3.Linux 主机网络问题</a><ul><li><a href="#31-ifdown-ifup-命令丢失处理" class="table-of-contents__link toc-highlight">3.1 ifdown ifup 命令丢失处理</a></li><li><a href="#32-网络不通-strace-二度出手" class="table-of-contents__link toc-highlight">3.2 网络不通？ strace 二度出手</a></li><li><a href="#33-time_wait--close_wait-的讨论总结" class="table-of-contents__link toc-highlight">3.3 TIME_WAIT &amp; CLOSE_WAIT 的讨论总结</a><ul><li><a href="#331-为什么需要-time_wait-" class="table-of-contents__link toc-highlight">3.3.1 为什么需要 TIME_WAIT ？</a></li><li><a href="#332-time_wait-会导致什么问题" class="table-of-contents__link toc-highlight">3.3.2 TIME_WAIT 会导致什么问题</a></li><li><a href="#333-如何解决-time_wait" class="table-of-contents__link toc-highlight">3.3.3 如何解决 time_wait?</a></li><li><a href="#334-如果-tw-满了会怎么样" class="table-of-contents__link toc-highlight">3.3.4 如果 tw 满了会怎么样</a></li><li><a href="#335-tw-的开销是什么" class="table-of-contents__link toc-highlight">3.3.5 tw 的开销是什么</a></li><li><a href="#336-tw-放大的好与坏" class="table-of-contents__link toc-highlight">3.3.6 tw 放大的好与坏</a></li><li><a href="#337-关于close_wait" class="table-of-contents__link toc-highlight">3.3.7 关于CLOSE_WAIT</a></li></ul></li><li><a href="#34-一次网络抖动经典案例分析" class="table-of-contents__link toc-highlight">3.4 一次网络抖动经典案例分析</a></li></ul></li><li><a href="#4linux-系统服务与参数问题" class="table-of-contents__link toc-highlight">4.Linux 系统服务与参数问题</a><ul><li><a href="#41-4-个-limits-生效的问题" class="table-of-contents__link toc-highlight">4.1 4 个 limits 生效的问题</a><ul><li><a href="#411-第一个问题" class="table-of-contents__link toc-highlight">4.1.1 第一个问题</a></li><li><a href="#412-第二个问题" class="table-of-contents__link toc-highlight">4.1.2 第二个问题</a></li><li><a href="#413-第三个问题" class="table-of-contents__link toc-highlight">4.1.3 第三个问题</a></li><li><a href="#414-第四个问题" class="table-of-contents__link toc-highlight">4.1.4 第四个问题</a></li></ul></li><li><a href="#42-六步排查-ss--netstat-统计结果不一样的原因" class="table-of-contents__link toc-highlight">4.2 六步排查 ss &amp; netstat 统计结果不一样的原因</a></li><li><a href="#43-为什么明明内存很充足但是-java-程序仍申请不到内存" class="table-of-contents__link toc-highlight">4.3 为什么明明内存很充足但是 java 程序仍申请不到内存</a></li><li><a href="#44-请不要忽略-min_free_kbytes-的设置" class="table-of-contents__link toc-highlight">4.4 请不要忽略 min_free_kbytes 的设置</a></li></ul></li><li><a href="#5最后的彩蛋" class="table-of-contents__link toc-highlight">5.最后的彩蛋</a><ul><li><a href="#某地区口罩项目架构演进及优化经验" class="table-of-contents__link toc-highlight">某地区口罩项目架构演进及优化经验</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">笔记</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 泡泡吐肥皂o</div></div></div></footer></div>
</body>
</html>