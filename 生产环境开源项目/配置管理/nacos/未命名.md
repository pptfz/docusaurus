





```
172.17.0.5      dn1.qike.bds.com	生产环境
172.17.0.7      dn2.qike.bds.com  QA环境
172.17.0.8      dn3.qike.bds.com	测试环境
```







```
#!/bin/bash
#
dn1=`nc -z dn1.qike.bds.com 18891 ; echo $?`
dn2=`nc -z dn2.qike.bds.com 18891 ; echo $?` 
dn3=`nc -z dn3.qike.bds.com 18891 ; echo $?` 
dn4=`nc -z dn4.qike.bds.com 18891 ; echo $?` 
dn5=`nc -z dn5.qike.bds.com 18891 ; echo $?`

echo dn1 ${dn1}
echo dn2 ${dn2}
echo dn3 ${dn3}
echo dn4 ${dn4}
echo dn5 ${dn5}

if [[ $dn1 -eq $dn2 && $dn2 -eq $dn3 && $dn3 -eq $dn4 && $dn4 -eq $dn5 ]];then
    echo "服务挂了"
else 
    echo "没事"
f
```











```
#!/bin/bash
#
dn1=`nc -z dn1.qike.bds.com 18891 ; echo $?`
dn2=`nc -z dn2.qike.bds.com 18891 ; echo $?` 
dn3=`nc -z dn3.qike.bds.com 18891 ; echo $?` 
dn4=`nc -z dn4.qike.bds.com 18891 ; echo $?` 
dn5=`nc -z dn5.qike.bds.com 18891 ; echo $?`

echo dn1 ${dn1}
echo dn2 ${dn2}
echo dn3 ${dn3}
echo dn4 ${dn4}
echo dn5 ${dn5}


wx(){
#将下面的webhook地址替换成你的企业微信机器人地址，$1为告警消息 $2为@人的手机号 $2可以为空
cat > $0.msg << EOF
curl 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=57e311f2-56d5-4c43-8888-645cdaa242a9' \
   -H 'Content-Type: application/json' \
   -d '
   {
        "msgtype": "text",
        "text": {
            "content": "$1",
            "mentioned_mobile_list":["$2"]
        }
   }'
EOF
sh $0.msg && rm -rf $0.msg
}

if [[ $dn1 -eq $dn2 && $dn2 -eq $dn3 && $dn3 -eq $dn4 && $dn4 -eq $dn5 ]];then
    wx "集群数据接口18891正常"
else 
    wc "集群数据接口18891正常"
fi
```

p

ls













```
#!/bin/bash

wx(){
#将下面的webhook地址替换成你的企业微信机器人地址，$1为告警消息 $2为@人的手机号 $2可以为空
cat > $0.msg << EOF
curl 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=57e311f2-56d5-4c43-8888-645cdaa242a9' \
   -H 'Content-Type: application/json' \
   -d '
   {
        "msgtype": "text",
        "text": {
            "content": "$1",
            "mentioned_mobile_list":["$2"]
        }
   }'
EOF
sh $0.msg && rm -rf $0.msg
}
```





第一次执行备份

```
mysqldump -uroot -h172.17.0.3 -P33026 -p -A >all.sql
Enter password: 
Warning: A partial dump from a server that has GTIDs will by default include the GTIDs of all transactions, even those that changed suppressed parts of the database. If you don't want to restore GTIDs, pass --set-gtid-purged=OFF. To make a complete dump, pass --all-databases --triggers --routines --events. 
```









```sh
mysql -uroot -p < all.sql 
Enter password: 
ERROR 1839 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_MODE = ON.
```







```
Warning: Using a password on the command line interface can be insecure.
ERROR 1064 (42000) at line 1: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'Warning: Using a password on the command line interface can be insecure.
```





```
Warning: Using a password on the command line interface can be insecure.
Warning: A partial dump from a server that has GTIDs will by default include the GTIDs of all transactions, even those that changed suppressed parts of the database. If you don't want to restore GTIDs, pass --set-gtid-purged=OFF. To make a complete dump, pass --all-databases --triggers --routines --events. 
-- MySQL dump 10.13  Distrib 5.6.51, for Linux (x86_64)
--
-- Host: 172.17.0.3    Database: 
-- ------------------------------------------------------
-- Server version       5.6.28-cdb2016-log
```







```nginx
upstream em-servers{
     server dn1.bid.bds.com:18889 weight=1 max_fails=3 fail_timeout=30s;
     server dn2.bid.bds.com:18889 weight=1 max_fails=3 fail_timeout=30s;
     server dn3.bid.bds.com:18889 weight=1 max_fails=3 fail_timeout=30s;
     server dn4.bid.bds.com:18889 weight=1 max_fails=3 fail_timeout=30s;
     server dn5.bid.bds.com:18889 weight=1 max_fails=3 fail_timeout=30s;
}  
```











```
# 瓦力检出仓库目录
CODE_PATH='/data/release'

# 项目名称
PROJECT_NAME='www.abc.com'

# 获取瓦力最新链接目录
LAST_DIR=`cd /data/xmadx_api/xmadx_wechat_game && ls -l | grep $PROJECT_NAME | awk '{print $NF}'`

# 项目vendor .env路径
VENDOR_PATH='/data/vendor_xmadx/www.abc.com'

# 拷贝vendor目录和env文件到瓦力最新链接目录
\cp -rp $VENDOR_PATH/{vendor,.env} $LAST_DIR

# 修改目录权限
chown -R www.www /data/release/www.abc.com
```





