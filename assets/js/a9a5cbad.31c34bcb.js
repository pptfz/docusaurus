"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[7271],{91931:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>a,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var r=n(74848),s=n(28453);const o={},l="\u83b7\u53d6k8s\u96c6\u7fa4\u8d44\u6e90\u914d\u7f6e",i={id:"go/go\u529f\u80fd\u811a\u672c/k8s/\u83b7\u53d6k8s\u96c6\u7fa4\u8d44\u6e90\u914d\u7f6e",title:"\u83b7\u53d6k8s\u96c6\u7fa4\u8d44\u6e90\u914d\u7f6e",description:"deployment",source:"@site/docs/go/go\u529f\u80fd\u811a\u672c/k8s/\u83b7\u53d6k8s\u96c6\u7fa4\u8d44\u6e90\u914d\u7f6e.md",sourceDirName:"go/go\u529f\u80fd\u811a\u672c/k8s",slug:"/go/go\u529f\u80fd\u811a\u672c/k8s/\u83b7\u53d6k8s\u96c6\u7fa4\u8d44\u6e90\u914d\u7f6e",permalink:"/docs/go/go\u529f\u80fd\u811a\u672c/k8s/\u83b7\u53d6k8s\u96c6\u7fa4\u8d44\u6e90\u914d\u7f6e",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"github\u4e0b\u8f7d\u52a0\u901f",permalink:"/docs/github/github\u4e0b\u8f7d\u52a0\u901f"},next:{title:"\u83b7\u53d6\u963f\u91cc\u4e91slb\u4fe1\u606f",permalink:"/docs/go/go\u529f\u80fd\u811a\u672c/\u4e91\u5e73\u53f0/\u963f\u91cc\u4e91/\u83b7\u53d6\u963f\u91cc\u4e91slb\u4fe1\u606f"}},a={},c=[{value:"deployment",id:"deployment",level:2},{value:"statefulset",id:"statefulset",level:2}];function f(t){const e={code:"code",h1:"h1",h2:"h2",img:"img",p:"p",pre:"pre",...(0,s.R)(),...t.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h1,{id:"\u83b7\u53d6k8s\u96c6\u7fa4\u8d44\u6e90\u914d\u7f6e",children:"\u83b7\u53d6k8s\u96c6\u7fa4\u8d44\u6e90\u914d\u7f6e"}),"\n",(0,r.jsx)(e.h2,{id:"deployment",children:"deployment"}),"\n",(0,r.jsxs)(e.p,{children:["\u53ef\u4ee5\u5728\u5207\u7247\u4e2d\u5b9a\u4e49\u591a\u4e2a\u60f3\u8981\u67e5\u8be2\u7684\u547d\u540d\u7a7a\u95f4 ",(0,r.jsx)(e.code,{children:'namespaces := []string{"ns1", "ns2", "ns3"}'})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-go",children:'package main\n\nimport (\n\t"context"\n\t"fmt"\n\t"log"\n        "os"\n\t"path/filepath"\n\n\t"github.com/xuri/excelize/v2"\n\t"k8s.io/client-go/informers"\n\t"k8s.io/client-go/kubernetes"\n\t"k8s.io/client-go/rest"\n\t"k8s.io/client-go/tools/clientcmd"\n\t"k8s.io/client-go/util/homedir"\n\tmetav1 "k8s.io/apimachinery/pkg/apis/meta/v1"\n)\n\nfunc main() {\n\t// \u8981\u67e5\u8be2\u7684\u547d\u540d\u7a7a\u95f4\u5217\u8868\n\tnamespaces := []string{"ns1", "ns2", "ns3"}\n\n\t// \u521b\u5efa Excel \u6587\u4ef6\n\tf := excelize.NewFile()\n\n\t// \u5728 Excel \u6587\u4ef6\u4e2d\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5de5\u4f5c\u8868\n\tindex, err := f.NewSheet("Deployment Resources")\n\tif err != nil {\n\t\tlog.Fatalf("Error creating new sheet: %s", err.Error())\n\t}\n\tf.SetActiveSheet(index)\n\n\t// \u8bbe\u7f6e Excel \u8868\u5934\n\tf.SetCellValue("Deployment Resources", "A1", "Namespace")\n\tf.SetCellValue("Deployment Resources", "B1", "Deployment")\n\tf.SetCellValue("Deployment Resources", "C1", "Request CPU")\n\tf.SetCellValue("Deployment Resources", "D1", "Request Memory")\n\tf.SetCellValue("Deployment Resources", "E1", "Limit CPU")\n\tf.SetCellValue("Deployment Resources", "F1", "Limit Memory")\n\n\t// \u5faa\u73af\u904d\u5386\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\n\tfor _, namespace := range namespaces {\n\t\t// \u83b7\u53d6 Kubernetes \u914d\u7f6e\n\t\tconfig, err := rest.InClusterConfig()\n\t\tif err != nil {\n\t\t\tkubeconfig := filepath.Join(homedir.HomeDir(), ".kube", "config")\n\t\t\tconfig, err = clientcmd.BuildConfigFromFlags("", kubeconfig)\n\t\t\tif err != nil {\n\t\t\t\tlog.Fatalf("Error building kubeconfig: %s", err.Error())\n\t\t\t}\n\t\t}\n\n\t\t// \u521b\u5efa Kubernetes \u5ba2\u6237\u7aef\n\t\tclientset, err := kubernetes.NewForConfig(config)\n\t\tif err != nil {\n\t\t\tlog.Fatalf("Error creating Kubernetes client: %s", err.Error())\n\t\t}\n\n\t\t// \u4f7f\u7528 Informer \u76d1\u542c Deployment \u8d44\u6e90\u7684\u53d8\u5316\n\t\tctx := context.TODO()\n\t\tfactory := informers.NewSharedInformerFactoryWithOptions(clientset, 0, informers.WithNamespace(namespace))\n\t\tdeploymentInformer := factory.Apps().V1().Deployments().Informer()\n\n\t\t// \u542f\u52a8 Informer\n\t\tstopCh := make(chan struct{})\n\t\tdefer close(stopCh)\n\t\tgo deploymentInformer.Run(stopCh)\n\n\t\t// \u7b49\u5f85 Informer \u540c\u6b65\n\t\tif !deploymentInformer.HasSynced() {\n\t\t\tfmt.Println("Waiting for informer to sync")\n\t\t}\n\n\t\t// \u83b7\u53d6 Deployment \u8d44\u6e90\u5e76\u5199\u5165 Excel \u6587\u4ef6\n\t\tdeployments, err := clientset.AppsV1().Deployments(namespace).List(ctx, metav1.ListOptions{})\n\t\tif err != nil {\n\t\t\tlog.Fatalf("Error listing deployments in namespace %s: %s", namespace, err.Error())\n\t\t}\n\n\t\tfor _, deployment := range deployments.Items {\n\t\t\trow, err := f.GetRows("Deployment Resources")\n\t\t\tif err != nil {\n\t\t\t\tlog.Fatalf("Error getting rows: %s", err.Error())\n\t\t\t}\n\t\t\tnextRow := len(row) + 1 // \u83b7\u53d6\u5f53\u524d\u884c\u6570\u5e76\u52a01\uff0c\u56e0\u4e3a\u7b2c\u4e00\u884c\u662f\u8868\u5934\n\n\t\t\t// \u83b7\u53d6 Deployment \u7684\u8bf7\u6c42\u548c\u9650\u5236\u503c\n\t\t\tcpuReq := deployment.Spec.Template.Spec.Containers[0].Resources.Requests.Cpu().String()\n\t\t\tmemReq := deployment.Spec.Template.Spec.Containers[0].Resources.Requests.Memory().String()\n\t\t\tcpuLimit := deployment.Spec.Template.Spec.Containers[0].Resources.Limits.Cpu().String()\n\t\t\tmemLimit := deployment.Spec.Template.Spec.Containers[0].Resources.Limits.Memory().String()\n\n\t\t\t// \u5c06\u8bf7\u6c42\u548c\u9650\u5236\u503c\u5199\u5165 Excel \u6587\u4ef6\n\t\t\tf.SetCellValue("Deployment Resources", fmt.Sprintf("A%d", nextRow), namespace)\n\t\t\tf.SetCellValue("Deployment Resources", fmt.Sprintf("B%d", nextRow), deployment.Name)\n\t\t\tf.SetCellValue("Deployment Resources", fmt.Sprintf("C%d", nextRow), cpuReq)\n\t\t\tf.SetCellValue("Deployment Resources", fmt.Sprintf("D%d", nextRow), memReq)\n\t\t\tf.SetCellValue("Deployment Resources", fmt.Sprintf("E%d", nextRow), cpuLimit)\n\t\t\tf.SetCellValue("Deployment Resources", fmt.Sprintf("F%d", nextRow), memLimit)\n\t\t}\n\t}\n\n\t// \u5c06 Excel \u6587\u4ef6\u4fdd\u5b58\u5230\u78c1\u76d8\n\tif err := f.SaveAs("deployment_resources.xlsx"); err != nil {\n\t\tfmt.Println("Error saving Excel file:", err)\n\t} else {\n\t\t// \u8bbe\u7f6e\u6587\u4ef6\u6743\u9650\u4e3a 0640\n\t\tif err := filepath.Walk("deployment_resources.xlsx", func(path string, info os.FileInfo, err error) error {\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\treturn os.Chmod(path, 0640)\n\t\t}); err != nil {\n\t\t\tfmt.Println("Error setting file permissions:", err)\n\t\t} else {\n\t\t\tfmt.Println("Excel file saved successfully as deployment_resources.xlsx")\n\t\t}\n\t}\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u6267\u884c\u540e\uff0c\u8f93\u51fa\u7684excel\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot_2024-04-25_15.15.31.png",alt:"iShot_2024-04-25_15.15.31"})}),"\n",(0,r.jsx)(e.h2,{id:"statefulset",children:"statefulset"}),"\n",(0,r.jsxs)(e.p,{children:["\u53ef\u4ee5\u5728\u5207\u7247\u4e2d\u5b9a\u4e49\u591a\u4e2a\u60f3\u8981\u67e5\u8be2\u7684\u547d\u540d\u7a7a\u95f4 ",(0,r.jsx)(e.code,{children:'namespaces := []string{"ns1", "ns2", "ns3"}'})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-go",children:'package main\n\nimport (\n\t"context"\n\t"fmt"\n\t"log"\n\t"os"\n\t"path/filepath"\n\n\t"github.com/xuri/excelize/v2"\n\t"k8s.io/client-go/informers"\n\t"k8s.io/client-go/kubernetes"\n\t"k8s.io/client-go/rest"\n\t"k8s.io/client-go/tools/clientcmd"\n\t"k8s.io/client-go/util/homedir"\n\tmetav1 "k8s.io/apimachinery/pkg/apis/meta/v1"\n)\n\nfunc main() {\n\t// \u8981\u67e5\u8be2\u7684\u547d\u540d\u7a7a\u95f4\u5217\u8868\n\tnamespaces := []string{"ns1", "ns2", "ns3"}\n\n\t// \u521b\u5efa Excel \u6587\u4ef6\n\tf := excelize.NewFile()\n\n\t// \u5728 Excel \u6587\u4ef6\u4e2d\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5de5\u4f5c\u8868\n\tindex, err := f.NewSheet("StatefulSet Resources")\n\tif err != nil {\n\t\tlog.Fatalf("Error creating new sheet: %s", err.Error())\n\t}\n\tf.SetActiveSheet(index)\n\n\t// \u8bbe\u7f6e Excel \u8868\u5934\n\tf.SetCellValue("StatefulSet Resources", "A1", "Namespace")\n\tf.SetCellValue("StatefulSet Resources", "B1", "StatefulSet")\n\tf.SetCellValue("StatefulSet Resources", "C1", "Request CPU")\n\tf.SetCellValue("StatefulSet Resources", "D1", "Request Memory")\n\tf.SetCellValue("StatefulSet Resources", "E1", "Limit CPU")\n\tf.SetCellValue("StatefulSet Resources", "F1", "Limit Memory")\n\n\t// \u5faa\u73af\u904d\u5386\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\n\tfor _, namespace := range namespaces {\n\t\t// \u83b7\u53d6 Kubernetes \u914d\u7f6e\n\t\tconfig, err := rest.InClusterConfig()\n\t\tif err != nil {\n\t\t\tkubeconfig := filepath.Join(homedir.HomeDir(), ".kube", "config")\n\t\t\tconfig, err = clientcmd.BuildConfigFromFlags("", kubeconfig)\n\t\t\tif err != nil {\n\t\t\t\tlog.Fatalf("Error building kubeconfig: %s", err.Error())\n\t\t\t}\n\t\t}\n\n\t\t// \u521b\u5efa Kubernetes \u5ba2\u6237\u7aef\n\t\tclientset, err := kubernetes.NewForConfig(config)\n\t\tif err != nil {\n\t\t\tlog.Fatalf("Error creating Kubernetes client: %s", err.Error())\n\t\t}\n\n\t\t// \u4f7f\u7528 Informer \u76d1\u542c StatefulSet \u8d44\u6e90\u7684\u53d8\u5316\n\t\tctx := context.TODO()\n\t\tfactory := informers.NewSharedInformerFactoryWithOptions(clientset, 0, informers.WithNamespace(namespace))\n\t\tstatefulSetInformer := factory.Apps().V1().StatefulSets().Informer()\n\n\t\t// \u542f\u52a8 Informer\n\t\tstopCh := make(chan struct{})\n\t\tdefer close(stopCh)\n\t\tgo statefulSetInformer.Run(stopCh)\n\n\t\t// \u7b49\u5f85 Informer \u540c\u6b65\n\t\tif !statefulSetInformer.HasSynced() {\n\t\t\tfmt.Println("Waiting for informer to sync")\n\t\t}\n\n\t\t// \u83b7\u53d6 StatefulSet \u8d44\u6e90\u5e76\u5199\u5165 Excel \u6587\u4ef6\n\t\tstatefulSets, err := clientset.AppsV1().StatefulSets(namespace).List(ctx, metav1.ListOptions{})\n\t\tif err != nil {\n\t\t\tlog.Fatalf("Error listing statefulsets in namespace %s: %s", namespace, err.Error())\n\t\t}\n\n\t\tfor _, statefulSet := range statefulSets.Items {\n\t\t\trow, err := f.GetRows("StatefulSet Resources")\n\t\t\tif err != nil {\n\t\t\t\tlog.Fatalf("Error getting rows: %s", err.Error())\n\t\t\t}\n\t\t\tnextRow := len(row) + 1 // \u83b7\u53d6\u5f53\u524d\u884c\u6570\u5e76\u52a01\uff0c\u56e0\u4e3a\u7b2c\u4e00\u884c\u662f\u8868\u5934\n\n\t\t\t// \u83b7\u53d6 StatefulSet \u7684\u8bf7\u6c42\u548c\u9650\u5236\u503c\n\t\t\tcpuReq := statefulSet.Spec.Template.Spec.Containers[0].Resources.Requests.Cpu().String()\n\t\t\tmemReq := statefulSet.Spec.Template.Spec.Containers[0].Resources.Requests.Memory().String()\n\t\t\tcpuLimit := statefulSet.Spec.Template.Spec.Containers[0].Resources.Limits.Cpu().String()\n\t\t\tmemLimit := statefulSet.Spec.Template.Spec.Containers[0].Resources.Limits.Memory().String()\n\n\t\t\t// \u5c06\u8bf7\u6c42\u548c\u9650\u5236\u503c\u5199\u5165 Excel \u6587\u4ef6\n\t\t\tf.SetCellValue("StatefulSet Resources", fmt.Sprintf("A%d", nextRow), namespace)\n\t\t\tf.SetCellValue("StatefulSet Resources", fmt.Sprintf("B%d", nextRow), statefulSet.Name)\n\t\t\tf.SetCellValue("StatefulSet Resources", fmt.Sprintf("C%d", nextRow), cpuReq)\n\t\t\tf.SetCellValue("StatefulSet Resources", fmt.Sprintf("D%d", nextRow), memReq)\n\t\t\tf.SetCellValue("StatefulSet Resources", fmt.Sprintf("E%d", nextRow), cpuLimit)\n\t\t\tf.SetCellValue("StatefulSet Resources", fmt.Sprintf("F%d", nextRow), memLimit)\n\t\t}\n\t}\n\n\t// \u5c06 Excel \u6587\u4ef6\u4fdd\u5b58\u5230\u78c1\u76d8\n\tif err := f.SaveAs("statefulset_resources.xlsx"); err != nil {\n\t\tfmt.Println("Error saving Excel file:", err)\n\t} else {\n\t\t// \u8bbe\u7f6e\u6587\u4ef6\u6743\u9650\u4e3a 0640\n\t\tif err := filepath.Walk("statefulset_resources.xlsx", func(path string, info os.FileInfo, err error) error {\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\treturn os.Chmod(path, 0640)\n\t\t}); err != nil {\n\t\t\tfmt.Println("Error setting file permissions:", err)\n\t\t} else {\n\t\t\tfmt.Println("Excel file saved successfully as statefulset_resources.xlsx")\n\t\t}\n\t}\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u6267\u884c\u540e\uff0c\u8f93\u51fa\u7684excel\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot_2024-04-25_19.27.04.png",alt:"iShot_2024-04-25_19.27.04"})})]})}function m(t={}){const{wrapper:e}={...(0,s.R)(),...t.components};return e?(0,r.jsx)(e,{...t,children:(0,r.jsx)(f,{...t})}):f(t)}},28453:(t,e,n)=>{n.d(e,{R:()=>l,x:()=>i});var r=n(96540);const s={},o=r.createContext(s);function l(t){const e=r.useContext(o);return r.useMemo((function(){return"function"==typeof t?t(e):{...e,...t}}),[e,t])}function i(t){let e;return e=t.disableParentContext?"function"==typeof t.components?t.components(s):t.components||s:l(t.components),r.createElement(o.Provider,{value:e},t.children)}}}]);