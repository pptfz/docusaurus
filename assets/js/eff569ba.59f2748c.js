"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[8481],{85586:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>c,toc:()=>a});var i=s(74848),r=s(28453);const t={},o="\u4f7f\u7528 kubeadm \u642d\u5efa v1.22.2 \u7248\u672c Kubernetes \u96c6\u7fa4",c={id:"\u4e91\u539f\u751f/k8s/k8s\u5b89\u88c5/\u4f7f\u7528kubeadm\u642d\u5efa v1.22.2\u7248\u672c kubernetes\u96c6\u7fa4",title:"\u4f7f\u7528kubeadm\u642d\u5efa v1.22.2\u7248\u672c kubernetes\u96c6\u7fa4",description:"[toc]",source:"@site/docs/\u4e91\u539f\u751f/k8s/k8s\u5b89\u88c5/\u4f7f\u7528kubeadm\u642d\u5efa v1.22.2\u7248\u672c kubernetes\u96c6\u7fa4.md",sourceDirName:"\u4e91\u539f\u751f/k8s/k8s\u5b89\u88c5",slug:"/\u4e91\u539f\u751f/k8s/k8s\u5b89\u88c5/\u4f7f\u7528kubeadm\u642d\u5efa v1.22.2\u7248\u672c kubernetes\u96c6\u7fa4",permalink:"/docs/\u4e91\u539f\u751f/k8s/k8s\u5b89\u88c5/\u4f7f\u7528kubeadm\u642d\u5efa v1.22.2\u7248\u672c kubernetes\u96c6\u7fa4",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"\u4f7f\u7528kubeadm\u5b89\u88c5k8s\u96c6\u7fa4",permalink:"/docs/\u4e91\u539f\u751f/k8s/k8s\u5b89\u88c5/\u4f7f\u7528kubeadm\u5b89\u88c5k8s\u96c6\u7fa4"},next:{title:"k8s\u5e38\u7528\u547d\u4ee4\u901f\u67e5",permalink:"/docs/\u4e91\u539f\u751f/k8s/k8s\u5e38\u7528\u547d\u4ee4\u901f\u67e5"}},d={},a=[{value:"1.\u73af\u5883\u51c6\u5907",id:"1\u73af\u5883\u51c6\u5907",level:2},{value:"1.1 \u5b9e\u9a8c\u73af\u5883",id:"11-\u5b9e\u9a8c\u73af\u5883",level:3},{value:"1.2 \u7f16\u8f91\u73af\u5883\u53d8\u91cf\u6587\u4ef6",id:"12-\u7f16\u8f91\u73af\u5883\u53d8\u91cf\u6587\u4ef6",level:3},{value:"1.3 \u6bcf\u4e2a\u8282\u70b9\u914d\u7f6ehost\u4fe1\u606f",id:"13-\u6bcf\u4e2a\u8282\u70b9\u914d\u7f6ehost\u4fe1\u606f",level:3},{value:"1.4 \u521b\u5efa <code>/etc/sysctl.d/k8s.conf</code> \u6587\u4ef6\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9",id:"14-\u521b\u5efa-etcsysctldk8sconf-\u6587\u4ef6\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9",level:3},{value:"1.5 \u5b89\u88c5ipvs",id:"15-\u5b89\u88c5ipvs",level:3},{value:"1.6 \u5b89\u88c5Containerd",id:"16-\u5b89\u88c5containerd",level:3},{value:"1.6.1 \u4e0b\u8f7d\u5b89\u88c5\u5305",id:"161-\u4e0b\u8f7d\u5b89\u88c5\u5305",level:4},{value:"1.6.2  \u5b89\u88c5\u914d\u7f6econtainerd",id:"162--\u5b89\u88c5\u914d\u7f6econtainerd",level:4},{value:"1.6.2.1 \u89e3\u538b\u7f29\u5305",id:"1621-\u89e3\u538b\u7f29\u5305",level:5},{value:"1.6.2.2 \u5bfc\u51fa\u547d\u4ee4 <code>PATH</code> \u73af\u5883\u53d8\u91cf",id:"1622-\u5bfc\u51fa\u547d\u4ee4-path-\u73af\u5883\u53d8\u91cf",level:5},{value:"1.6.2.3 \u521b\u5efacontainerd\u914d\u7f6e\u6587\u4ef6",id:"1623-\u521b\u5efacontainerd\u914d\u7f6e\u6587\u4ef6",level:5},{value:"1.6.2.4 \u4fee\u6539containerd\u914d\u7f6e\u6587\u4ef6",id:"1624-\u4fee\u6539containerd\u914d\u7f6e\u6587\u4ef6",level:5},{value:"1.6.2.5 \u914d\u7f6econtainerd\u4ed3\u5e93\u52a0\u901f",id:"1625-\u914d\u7f6econtainerd\u4ed3\u5e93\u52a0\u901f",level:5},{value:"1.6.3 \u542f\u52a8containerd",id:"163-\u542f\u52a8containerd",level:4},{value:"1.6.4 \u9a8c\u8bc1",id:"164-\u9a8c\u8bc1",level:4},{value:"1.7 \u5b89\u88c5Kubeadm",id:"17-\u5b89\u88c5kubeadm",level:2},{value:"1.7.1 \u4f7f\u7528\u963f\u91cc\u4e91yum\u6e90",id:"171-\u4f7f\u7528\u963f\u91cc\u4e91yum\u6e90",level:3},{value:"1.7.2 \u5b89\u88c5 kubeadm\u3001kubelet\u3001kubectl",id:"172-\u5b89\u88c5-kubeadmkubeletkubectl",level:3},{value:"1.7.3 \u8bbe\u7f6ekubelet\u5f00\u673a\u81ea\u542f",id:"173-\u8bbe\u7f6ekubelet\u5f00\u673a\u81ea\u542f",level:3},{value:"1.7.4 \u8bbe\u7f6ek8s\u547d\u4ee4\u81ea\u52a8\u8865\u5168",id:"174-\u8bbe\u7f6ek8s\u547d\u4ee4\u81ea\u52a8\u8865\u5168",level:3},{value:"2.1 master\u8282\u70b9\u64cd\u4f5c\uff0c\u914d\u7f6e kubeadm \u521d\u59cb\u5316\u6587\u4ef6",id:"21-master\u8282\u70b9\u64cd\u4f5c\u914d\u7f6e-kubeadm-\u521d\u59cb\u5316\u6587\u4ef6",level:2},{value:"2.2 \u521d\u59cb\u5316master",id:"22-\u521d\u59cb\u5316master",level:2},{value:"2.3 master\u6dfb\u52a0\u8282\u70b9",id:"23-master\u6dfb\u52a0\u8282\u70b9",level:2},{value:"2.4 master\u8282\u70b9\u5b89\u88c5\u7f51\u7edc\u63d2\u4ef6flannel",id:"24-master\u8282\u70b9\u5b89\u88c5\u7f51\u7edc\u63d2\u4ef6flannel",level:2},{value:"2.4.1 \u4e0b\u8f7d\u6587\u4ef6",id:"241-\u4e0b\u8f7d\u6587\u4ef6",level:3},{value:"2.4.2 \u4fee\u6539\u6587\u4ef6\u5185\u5bb9",id:"242-\u4fee\u6539\u6587\u4ef6\u5185\u5bb9",level:3},{value:"2.4.3 \u4fee\u6539\u5b8c\u6210\u540e\u5b89\u88c5flannel\u7f51\u7edc\u63d2\u4ef6",id:"243-\u4fee\u6539\u5b8c\u6210\u540e\u5b89\u88c5flannel\u7f51\u7edc\u63d2\u4ef6",level:3},{value:"2.4.4 \u5b89\u88c5\u5b8c\u6210\u540e\u7a0d\u7b49\u4e00\u4f1a\u67e5\u770bpods\u72b6\u6001\uff0c\u5168\u90e8\u4e3arunning\u5373\u4e3a\u6b63\u786e",id:"244-\u5b89\u88c5\u5b8c\u6210\u540e\u7a0d\u7b49\u4e00\u4f1a\u67e5\u770bpods\u72b6\u6001\u5168\u90e8\u4e3arunning\u5373\u4e3a\u6b63\u786e",level:3},{value:"2.4.5 \u67e5\u770bnode\u72b6\u6001",id:"245-\u67e5\u770bnode\u72b6\u6001",level:3},{value:"2.5 \u5b89\u88c5Dashboard(\u53ef\u9009)",id:"25-\u5b89\u88c5dashboard\u53ef\u9009",level:2},{value:"2.5.1 \u4e0b\u8f7dyaml\u6587\u4ef6",id:"251-\u4e0b\u8f7dyaml\u6587\u4ef6",level:3},{value:"2.5.2 \u4fee\u6539\u6587\u4ef6",id:"252-\u4fee\u6539\u6587\u4ef6",level:3},{value:"2.5.3 \u90e8\u7f72dashboard",id:"253-\u90e8\u7f72dashboard",level:3},{value:"2.5.4 \u67e5\u770bdashboard\u7684\u8fd0\u884c\u72b6\u6001\u53ca\u5916\u7f51\u8bbf\u95ee\u7aef\u53e3",id:"254-\u67e5\u770bdashboard\u7684\u8fd0\u884c\u72b6\u6001\u53ca\u5916\u7f51\u8bbf\u95ee\u7aef\u53e3",level:3},{value:"2.5.5 \u521b\u5efa\u4e00\u4e2a\u5177\u6709\u5168\u5c40\u6240\u6709\u6743\u9650\u7684\u7528\u6237\u6765\u767b\u5f55Dashboard",id:"255-\u521b\u5efa\u4e00\u4e2a\u5177\u6709\u5168\u5c40\u6240\u6709\u6743\u9650\u7684\u7528\u6237\u6765\u767b\u5f55dashboard",level:3},{value:"2.5.6 \u67e5\u770bdashboard token",id:"256-\u67e5\u770bdashboard-token",level:3},{value:"2.5.6 \u8bbf\u95eedashboard",id:"256-\u8bbf\u95eedashboard",level:3},{value:"2.7 \u5b89\u88c5k8s\u5207\u6362\u547d\u540d\u7a7a\u95f4\u5de5\u5177(\u53ef\u9009)",id:"27-\u5b89\u88c5k8s\u5207\u6362\u547d\u540d\u7a7a\u95f4\u5de5\u5177\u53ef\u9009",level:2}];function l(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"[toc]"}),"\n",(0,i.jsx)(n.h1,{id:"\u4f7f\u7528-kubeadm-\u642d\u5efa-v1222-\u7248\u672c-kubernetes-\u96c6\u7fa4",children:"\u4f7f\u7528 kubeadm \u642d\u5efa v1.22.2 \u7248\u672c Kubernetes \u96c6\u7fa4"}),"\n",(0,i.jsx)(n.h2,{id:"1\u73af\u5883\u51c6\u5907",children:"1.\u73af\u5883\u51c6\u5907"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u5355master\u67b6\u6784\u56fe"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-07-0410.58.42.png",alt:"iShot2020-07-0410.58.42"})}),"\n",(0,i.jsx)(n.h3,{id:"11-\u5b9e\u9a8c\u73af\u5883",children:"1.1 \u5b9e\u9a8c\u73af\u5883"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u89d2\u8272"}),(0,i.jsx)(n.th,{children:"IP\u5730\u5740"}),(0,i.jsx)(n.th,{children:"\u4e3b\u673a\u540d"}),(0,i.jsx)(n.th,{children:"containerd\u7248\u672c"}),(0,i.jsx)(n.th,{children:"\u786c\u4ef6\u914d\u7f6e"}),(0,i.jsx)(n.th,{children:"\u7cfb\u7edf"}),(0,i.jsx)(n.th,{children:"\u786c\u76d8"}),(0,i.jsx)(n.th,{children:"\u5185\u6838"}),(0,i.jsx)(n.th,{children:"\u5b89\u88c5\u7ec4\u4ef6"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"master"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"172.30.100.101"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"k8s-master01"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"1.5.5"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"2C4G"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"CentOS7.6"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"40g+50g"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"3.10.0-957.21.3.el7.x86_64"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"kube-apiserver\uff0ckube-controller-manager\uff0ckube-scheduler\uff0cetcd"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"node1"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"172.30.100.102"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"k8s-node01"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"1.5.5"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"2C4G"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"CentOS7.6"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"40g+50g"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"3.10.0-957.21.3.el7.x86_64"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"kubelet\uff0ckube-proxy\uff0cdocker\uff0cetcd"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"node2"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"172.30.100.103"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"k8s-node02"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"1.5.5"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"2C4G"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"CentOS7.6"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"40g+50g"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"3.10.0-957.21.3.el7.x86_64"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"kubelet\uff0ckube-proxy\uff0cdocker\uff0cetcd"})})]})]})]}),"\n",(0,i.jsx)(n.p,{children:":::tip\u8bf4\u660e"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u5982\u65e0\u7279\u6b8a\u8bf4\u660e\uff0c\u4ee5\u4e0b\u6240\u6709\u64cd\u4f5c\u5747\u5728master\u8282\u70b9"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u5df2\u63d0\u524d\u914d\u7f6e\u597dmaster\u53ef\u4ee5\u514d\u5bc6\u767b\u9646node\u8282\u70b9"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u5b9e\u9a8c\u5f00\u59cb\u524d\u5df2\u4e34\u65f6\u5f00\u542froot\u8fdc\u7a0b\u767b\u9646\uff0c\u5b9e\u9a8c\u7ed3\u675f\u540e\u5173\u95edroot\u8fdc\u7a0b\u767b\u9646\uff0c\u91c7\u7528sudo\u7528\u6237\u5bc6\u94a5\u767b\u9646\u65b9\u5f0f"})}),"\n",(0,i.jsx)(n.p,{children:":::"}),"\n",(0,i.jsx)(n.h3,{id:"12-\u7f16\u8f91\u73af\u5883\u53d8\u91cf\u6587\u4ef6",children:"1.2 \u7f16\u8f91\u73af\u5883\u53d8\u91cf\u6587\u4ef6"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"[ -d /opt/k8s/script ] || mkdir -p /opt/k8s/script && cd /opt/k8s/script\ncat > /opt/k8s/script/env.sh <<EOF\nexport NODE_IPS=(172.30.100.101 172.30.100.102 172.30.100.103)\nexport NODE_NAMES=(k8s-master01 k8s-node01 k8s-node02)\nexport SSH_USER=root\nexport SSH_PORT=22\nexport SSH_KEY_FILE=/root/.ssh/id_rsa\nexport K8S_VERSION=1.22.2\nexport POD_SUBNET=10.244.0.0/16\nexport SERVICE_SUBNET=10.96.0.0/12\nEOF\n"})}),"\n",(0,i.jsx)(n.h3,{id:"13-\u6bcf\u4e2a\u8282\u70b9\u914d\u7f6ehost\u4fe1\u606f",children:"1.3 \u6bcf\u4e2a\u8282\u70b9\u914d\u7f6ehost\u4fe1\u606f"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# \u52a0\u8f7d\u53d8\u91cf\u6587\u4ef6\nsource /opt/k8s/script/env.sh\n\n# master\u8282\u70b9\u7f16\u8f91hosts\u6587\u4ef6\ncat >> /etc/hosts << EOF\n${NODE_IPS[0]} ${NODE_NAMES[0]}\n${NODE_IPS[1]} ${NODE_NAMES[1]}\n${NODE_IPS[2]} ${NODE_NAMES[2]}\nEOF\n\n# \u62f7\u8d1dhosts\u6587\u4ef6\u5230node\u8282\u70b9\nfor node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo ">>> ${node_ip}"\n      scp -o StrictHostKeyChecking=no -P${SSH_PORT} -i${SSH_KEY_FILE} /etc/hosts ${SSH_USER}@${node_ip}:/etc \n    }&  \n  done  \n'})}),"\n",(0,i.jsxs)(n.h3,{id:"14-\u521b\u5efa-etcsysctldk8sconf-\u6587\u4ef6\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9",children:["1.4 \u521b\u5efa ",(0,i.jsx)(n.code,{children:"/etc/sysctl.d/k8s.conf"})," \u6587\u4ef6\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"for node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo \">>> ${node_ip}\"\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'cat > /etc/sysctl.d/k8s.conf << EOF\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipv4.ip_forward = 1\nvm.swappiness = 0\nEOF'\n    }&  \n  done  \n\n# \u4f7f\u914d\u7f6e\u751f\u6548  \nfor node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo \">>> ${node_ip}\"\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'modprobe br_netfilter && sysctl -p /etc/sysctl.d/k8s.conf'\n    }&\n  done    \n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"bridge-nf \u8bf4\u660e"})}),"\n",(0,i.jsxs)(n.p,{children:["bridge-nf \u4f7f\u5f97 netfilter \u53ef\u4ee5\u5bf9 Linux \u7f51\u6865\u4e0a\u7684 IPv4/ARP/IPv6 \u5305\u8fc7\u6ee4\u3002\u6bd4\u5982\uff0c\u8bbe\u7f6e ",(0,i.jsx)(n.code,{children:"net.bridge.bridge-nf-call-iptables\uff1d1"})," \u540e\uff0c\u4e8c\u5c42\u7684\u7f51\u6865\u5728\u8f6c\u53d1\u5305\u65f6\u4e5f\u4f1a\u88ab iptables\u7684 FORWARD \u89c4\u5219\u6240\u8fc7\u6ee4\u3002\u5e38\u7528\u7684\u9009\u9879\u5305\u62ec\uff1a"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"net.bridge.bridge-nf-call-arptables"}),"\uff1a\u662f\u5426\u5728 arptables \u7684 FORWARD \u4e2d\u8fc7\u6ee4\u7f51\u6865\u7684 ARP \u5305"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"net.bridge.bridge-nf-call-ip6tables"}),"\uff1a\u662f\u5426\u5728 ip6tables \u94fe\u4e2d\u8fc7\u6ee4 IPv6 \u5305"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"net.bridge.bridge-nf-call-iptables"}),"\uff1a\u662f\u5426\u5728 iptables \u94fe\u4e2d\u8fc7\u6ee4 IPv4 \u5305"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"net.bridge.bridge-nf-filter-vlan-tagged"}),"\uff1a\u662f\u5426\u5728 iptables/arptables \u4e2d\u8fc7\u6ee4\u6253\u4e86 vlan \u6807\u7b7e\u7684\u5305"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"15-\u5b89\u88c5ipvs",children:"1.5 \u5b89\u88c5ipvs"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["\u521b\u5efa ",(0,i.jsx)(n.code,{children:"/etc/sysconfig/modules/ipvs.modules"})," \u6587\u4ef6\uff0c\u76ee\u7684\u662f\u4fdd\u8bc1\u5728\u8282\u70b9\u91cd\u542f\u540e\u80fd\u81ea\u52a8\u52a0\u8f7d\u6240\u9700\u6a21\u5757\u3002\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"lsmod | grep -e ip_vs -e nf_conntrack_ipv4"})," \u547d\u4ee4\u67e5\u770b\u662f\u5426\u5df2\u7ecf\u6b63\u786e\u52a0\u8f7d\u6240\u9700\u7684\u5185\u6838\u6a21\u5757"]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"# \u7f16\u8f91\u6587\u4ef6\nfor node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo \">>> ${node_ip}\"\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'cat > /etc/sysconfig/modules/ipvs.modules << EOF\nmodprobe -- ip_vs\nmodprobe -- ip_vs_rr\nmodprobe -- ip_vs_wrr\nmodprobe -- ip_vs_sh\nmodprobe -- nf_conntrack\nmodprobe -- nf_conntrack_ipv4\nEOF'\n    }&\n  done  \n\n# \u4f7f\u914d\u7f6e\u751f\u6548  \nfor node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo \">>> ${node_ip}\"\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack_ipv4'\n    }&\n  done\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u5b89\u88c5ipset\u548cipvsadm(\u4fbf\u4e8e\u67e5\u770b ipvs \u7684\u4ee3\u7406\u89c4\u5219)"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"for node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo \">>> ${node_ip}\"\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'yum -y install ipset ipvsadm'\n    }&\n  done\n"})}),"\n",(0,i.jsx)(n.h3,{id:"16-\u5b89\u88c5containerd",children:"1.6 \u5b89\u88c5Containerd"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://github.com/containerd/containerd",children:"containerd github\u5730\u5740"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://containerd.io/",children:"containerd\u5b98\u7f51"})}),"\n",(0,i.jsx)(n.h4,{id:"161-\u4e0b\u8f7d\u5b89\u88c5\u5305",children:"1.6.1 \u4e0b\u8f7d\u5b89\u88c5\u5305"}),"\n",(0,i.jsxs)(n.p,{children:["\u7531\u4e8e containerd \u9700\u8981\u8c03\u7528 runc\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u9700\u8981\u5148\u5b89\u88c5 runc\uff0c\u4e0d\u8fc7 containerd \u63d0\u4f9b\u4e86\u4e00\u4e2a\u5305\u542b\u76f8\u5173\u4f9d\u8d56\u7684\u538b\u7f29\u5305 ",(0,i.jsx)(n.code,{children:"cri-containerd-cni-${VERSION}.${OS}-${ARCH}.tar.gz"}),"\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u5305\u6765\u8fdb\u884c\u5b89\u88c5\u3002"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["\u5982\u679cgithub\u4e0b\u8f7d\u901f\u5ea6\u8f83\u6162\uff0c\u53ef\u4ee5\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"https://download.fastgit.org/containerd/containerd/releases/download/v1.5.5/cri-containerd-cni-1.5.5-linux-amd64.tar.gz"})," \u52a0\u901f\u4e0b\u8f7d"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"for node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo \">>> ${node_ip}\"\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'wget -P /opt https://github.com/containerd/containerd/releases/download/v1.5.5/cri-containerd-cni-1.5.5-linux-amd64.tar.gz'\n    }\n  done\n"})}),"\n",(0,i.jsx)(n.h4,{id:"162--\u5b89\u88c5\u914d\u7f6econtainerd",children:"1.6.2  \u5b89\u88c5\u914d\u7f6econtainerd"}),"\n",(0,i.jsx)(n.h5,{id:"1621-\u89e3\u538b\u7f29\u5305",children:"1.6.2.1 \u89e3\u538b\u7f29\u5305"}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["tar\u5305\u89e3\u538b\u7f29\u540e\u662f3\u4e2a\u76ee\u5f55 ",(0,i.jsx)(n.code,{children:"etc"})," \u3001 ",(0,i.jsx)(n.code,{children:"opt"})," \u3001 ",(0,i.jsx)(n.code,{children:"usr"})]})})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"for node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo \">>> ${node_ip}\"\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'tar xf /opt/cri-containerd-cni-1.5.5-linux-amd64.tar.gz -C /'\n    }&\n  done\n"})}),"\n",(0,i.jsxs)(n.h5,{id:"1622-\u5bfc\u51fa\u547d\u4ee4-path-\u73af\u5883\u53d8\u91cf",children:["1.6.2.2 \u5bfc\u51fa\u547d\u4ee4 ",(0,i.jsx)(n.code,{children:"PATH"})," \u73af\u5883\u53d8\u91cf"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:'for node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo ">>> ${node_ip}"\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} \'echo "export PATH=$PATH:/usr/local/bin:/usr/local/sbin" > /etc/profile.d/containerd.sh && source /etc/profile\'\n    }&\n  done\n'})}),"\n",(0,i.jsx)(n.h5,{id:"1623-\u521b\u5efacontainerd\u914d\u7f6e\u6587\u4ef6",children:"1.6.2.3 \u521b\u5efacontainerd\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,i.jsxs)(n.p,{children:["containerd \u7684\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u4e3a ",(0,i.jsx)(n.code,{children:"/etc/containerd/config.toml"}),"\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 ",(0,i.jsx)(n.code,{children:"containerd config default > /etc/containerd/config.toml"})," \u547d\u4ee4\u751f\u6210\u4e00\u4e2a\u9ed8\u8ba4\u7684\u914d\u7f6e"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"for node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo \">>> ${node_ip}\"\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'mkdir -p /etc/containerd && containerd config default > /etc/containerd/config.toml'\n    }&\n  done\n"})}),"\n",(0,i.jsx)(n.h5,{id:"1624-\u4fee\u6539containerd\u914d\u7f6e\u6587\u4ef6",children:"1.6.2.4 \u4fee\u6539containerd\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,i.jsxs)(n.p,{children:["\u5bf9\u4e8e\u4f7f\u7528 systemd \u4f5c\u4e3a init system \u7684 Linux \u7684\u53d1\u884c\u7248\uff0c\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"systemd"})," \u4f5c\u4e3a\u5bb9\u5668\u7684 ",(0,i.jsx)(n.code,{children:"cgroup driver"})," \u53ef\u4ee5\u786e\u4fdd\u8282\u70b9\u5728\u8d44\u6e90\u7d27\u5f20\u7684\u60c5\u51b5\u66f4\u52a0\u7a33\u5b9a\uff0c\u6240\u4ee5\u63a8\u8350\u5c06 containerd \u7684 cgroup driver \u914d\u7f6e\u4e3a systemd"]}),"\n",(0,i.jsxs)(n.p,{children:["\u4fee\u6539\u524d\u9762\u751f\u6210\u7684\u914d\u7f6e\u6587\u4ef6 ",(0,i.jsx)(n.code,{children:"/etc/containerd/config.toml"}),"\uff0c\u5728 ",(0,i.jsx)(n.code,{children:'plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options'})," \u914d\u7f6e\u5757\u4e0b\u9762\u5c06 ",(0,i.jsx)(n.code,{children:"SystemdCgroup"})," \u8bbe\u7f6e\u4e3a ",(0,i.jsx)(n.code,{children:"true"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"\u4fee\u6539\n\tSystemdCgroup = false\n\n\u4fee\u6539\u4e3a\n\tSystemdCgroup = true\n"})}),"\n",(0,i.jsx)(n.h5,{id:"1625-\u914d\u7f6econtainerd\u4ed3\u5e93\u52a0\u901f",children:"1.6.2.5 \u914d\u7f6econtainerd\u4ed3\u5e93\u52a0\u901f"}),"\n",(0,i.jsxs)(n.p,{children:["\u9700\u8981\u5728 cri \u914d\u7f6e\u5757\u4e0b\u9762\u7684 ",(0,i.jsx)(n.code,{children:"registry"})," \u914d\u7f6e\u5757\u4e0b\u9762\u8fdb\u884c\u914d\u7f6e ",(0,i.jsx)(n.code,{children:"registry.mirrors"})]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["\u5982\u679c\u6211\u4eec\u7684\u8282\u70b9\u4e0d\u80fd\u6b63\u5e38\u83b7\u53d6 ",(0,i.jsx)(n.code,{children:"k8s.gcr.io"})," \u7684\u955c\u50cf\uff0c\u90a3\u4e48\u6211\u4eec\u9700\u8981\u5728\u4e0a\u9762\u91cd\u65b0\u914d\u7f6e ",(0,i.jsx)(n.code,{children:"sandbox_image"})," \u955c\u50cf\uff0c\u5426\u5219\u540e\u9762 kubelet \u8986\u76d6\u8be5\u955c\u50cf\u4e0d\u4f1a\u751f\u6548\uff1a",(0,i.jsx)(n.code,{children:"Warning: For remote container runtime, --pod-infra-container-image is ignored in kubelet, which should be set in that remote runtime instead"}),"\u3002\u56e0\u6b64\u5c06 ",(0,i.jsx)(n.code,{children:"sandbox_image"})," \u4e2d\u7684\u955c\u50cf\u4ed3\u5e93\u5730\u5740\u4fee\u6539\u4e3a\u963f\u91cc\u4e91\u5730\u5740"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:'[plugins."io.containerd.grpc.v1.cri"]\n  ...\n  # sandbox_image = "k8s.gcr.io/pause:3.5"\n  sandbox_image = "registry.aliyuncs.com/k8sxio/pause:3.5"\n  ...\n  [plugins."io.containerd.grpc.v1.cri".registry]\n    [plugins."io.containerd.grpc.v1.cri".registry.mirrors]\n      [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]\n        endpoint = ["https://bqr1dr1n.mirror.aliyuncs.com"]\n      [plugins."io.containerd.grpc.v1.cri".registry.mirrors."k8s.gcr.io"]\n        endpoint = ["https://registry.aliyuncs.com/k8sxio"]\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"/etc/containerd/config.toml "}),"  \u6700\u7ec8\u5185\u5bb9"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-toml",children:'cat > /etc/containerd/config.toml << \'EOF\'\ndisabled_plugins = []\nimports = []\noom_score = 0\nplugin_dir = ""\nrequired_plugins = []\nroot = "/var/lib/containerd"\nstate = "/run/containerd"\nversion = 2\n\n[cgroup]\n  path = ""\n\n[debug]\n  address = ""\n  format = ""\n  gid = 0\n  level = ""\n  uid = 0\n\n[grpc]\n  address = "/run/containerd/containerd.sock"\n  gid = 0\n  max_recv_message_size = 16777216\n  max_send_message_size = 16777216\n  tcp_address = ""\n  tcp_tls_cert = ""\n  tcp_tls_key = ""\n  uid = 0\n\n[metrics]\n  address = ""\n  grpc_histogram = false\n\n[plugins]\n\n  [plugins."io.containerd.gc.v1.scheduler"]\n    deletion_threshold = 0\n    mutation_threshold = 100\n    pause_threshold = 0.02\n    schedule_delay = "0s"\n    startup_delay = "100ms"\n\n  [plugins."io.containerd.grpc.v1.cri"]\n    disable_apparmor = false\n    disable_cgroup = false\n    disable_hugetlb_controller = true\n    disable_proc_mount = false\n    disable_tcp_service = true\n    enable_selinux = false\n    enable_tls_streaming = false\n    ignore_image_defined_volumes = false\n    max_concurrent_downloads = 3\n    max_container_log_line_size = 16384\n    netns_mounts_under_state_dir = false\n    restrict_oom_score_adj = false\n    sandbox_image = "registry.aliyuncs.com/k8sxio/pause:3.5"\n    selinux_category_range = 1024\n    stats_collect_period = 10\n    stream_idle_timeout = "4h0m0s"\n    stream_server_address = "127.0.0.1"\n    stream_server_port = "0"\n    systemd_cgroup = false\n    tolerate_missing_hugetlb_controller = true\n    unset_seccomp_profile = ""\n\n    [plugins."io.containerd.grpc.v1.cri".cni]\n      bin_dir = "/opt/cni/bin"\n      conf_dir = "/etc/cni/net.d"\n      conf_template = ""\n      max_conf_num = 1\n\n    [plugins."io.containerd.grpc.v1.cri".containerd]\n      default_runtime_name = "runc"\n      disable_snapshot_annotations = true\n      discard_unpacked_layers = false\n      no_pivot = false\n      snapshotter = "overlayfs"\n\n      [plugins."io.containerd.grpc.v1.cri".containerd.default_runtime]\n        base_runtime_spec = ""\n        container_annotations = []\n        pod_annotations = []\n        privileged_without_host_devices = false\n        runtime_engine = ""\n        runtime_root = ""\n        runtime_type = ""\n\n        [plugins."io.containerd.grpc.v1.cri".containerd.default_runtime.options]\n\n      [plugins."io.containerd.grpc.v1.cri".containerd.runtimes]\n\n        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]\n          base_runtime_spec = ""\n          container_annotations = []\n          pod_annotations = []\n          privileged_without_host_devices = false\n          runtime_engine = ""\n          runtime_root = ""\n          runtime_type = "io.containerd.runc.v2"\n\n          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]\n            BinaryName = ""\n            CriuImagePath = ""\n            CriuPath = ""\n            CriuWorkPath = ""\n            IoGid = 0\n            IoUid = 0\n            NoNewKeyring = false\n            NoPivotRoot = false\n            Root = ""\n            ShimCgroup = ""\n            SystemdCgroup = true\n\n      [plugins."io.containerd.grpc.v1.cri".containerd.untrusted_workload_runtime]\n        base_runtime_spec = ""\n        container_annotations = []\n        pod_annotations = []\n        privileged_without_host_devices = false\n        runtime_engine = ""\n        runtime_root = ""\n        runtime_type = ""\n\n        [plugins."io.containerd.grpc.v1.cri".containerd.untrusted_workload_runtime.options]\n\n    [plugins."io.containerd.grpc.v1.cri".image_decryption]\n      key_model = "node"\n\n    [plugins."io.containerd.grpc.v1.cri".registry]\n      config_path = ""\n\n      [plugins."io.containerd.grpc.v1.cri".registry.auths]\n\n      [plugins."io.containerd.grpc.v1.cri".registry.configs]\n\n      [plugins."io.containerd.grpc.v1.cri".registry.headers]\n\n      [plugins."io.containerd.grpc.v1.cri".registry.mirrors]\n        [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]\n          endpoint = ["https://bqr1dr1n.mirror.aliyuncs.com"]\n        [plugins."io.containerd.grpc.v1.cri".registry.mirrors."k8s.gcr.io"]\n          endpoint = ["https://registry.aliyuncs.com/k8sxio"]\n\n    [plugins."io.containerd.grpc.v1.cri".x509_key_pair_streaming]\n      tls_cert_file = ""\n      tls_key_file = ""\n\n  [plugins."io.containerd.internal.v1.opt"]\n    path = "/opt/containerd"\n\n  [plugins."io.containerd.internal.v1.restart"]\n    interval = "10s"\n\n  [plugins."io.containerd.metadata.v1.bolt"]\n    content_sharing_policy = "shared"\n\n  [plugins."io.containerd.monitor.v1.cgroups"]\n    no_prometheus = false\n\n  [plugins."io.containerd.runtime.v1.linux"]\n    no_shim = false\n    runtime = "runc"\n    runtime_root = ""\n    shim = "containerd-shim"\n    shim_debug = false\n\n  [plugins."io.containerd.runtime.v2.task"]\n    platforms = ["linux/amd64"]\n\n  [plugins."io.containerd.service.v1.diff-service"]\n    default = ["walking"]\n\n  [plugins."io.containerd.snapshotter.v1.aufs"]\n    root_path = ""\n\n  [plugins."io.containerd.snapshotter.v1.btrfs"]\n    root_path = ""\n\n  [plugins."io.containerd.snapshotter.v1.devmapper"]\n    async_remove = false\n    base_image_size = ""\n    pool_name = ""\n    root_path = ""\n\n  [plugins."io.containerd.snapshotter.v1.native"]\n    root_path = ""\n\n  [plugins."io.containerd.snapshotter.v1.overlayfs"]\n    root_path = ""\n\n  [plugins."io.containerd.snapshotter.v1.zfs"]\n    root_path = ""\n\n[proxy_plugins]\n\n[stream_processors]\n\n  [stream_processors."io.containerd.ocicrypt.decoder.v1.tar"]\n    accepts = ["application/vnd.oci.image.layer.v1.tar+encrypted"]\n    args = ["--decryption-keys-path", "/etc/containerd/ocicrypt/keys"]\n    env = ["OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf"]\n    path = "ctd-decoder"\n    returns = "application/vnd.oci.image.layer.v1.tar"\n\n  [stream_processors."io.containerd.ocicrypt.decoder.v1.tar.gzip"]\n    accepts = ["application/vnd.oci.image.layer.v1.tar+gzip+encrypted"]\n    args = ["--decryption-keys-path", "/etc/containerd/ocicrypt/keys"]\n    env = ["OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf"]\n    path = "ctd-decoder"\n    returns = "application/vnd.oci.image.layer.v1.tar+gzip"\n\n[timeouts]\n  "io.containerd.timeout.shim.cleanup" = "5s"\n  "io.containerd.timeout.shim.load" = "5s"\n  "io.containerd.timeout.shim.shutdown" = "3s"\n  "io.containerd.timeout.task.state" = "2s"\n\n[ttrpc]\n  address = ""\n  gid = 0\n  uid = 0\nEOF\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u62f7\u8d1d\u6587\u4ef6\u5230node\u8282\u70b9"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:'for node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo ">>> ${node_ip}"\n      scp -o StrictHostKeyChecking=no -P${SSH_PORT} -i${SSH_KEY_FILE} /opt/k8s/config.toml ${SSH_USER}@${node_ip}:/etc/containerd\n    }&\n  done  \n'})}),"\n",(0,i.jsx)(n.h4,{id:"163-\u542f\u52a8containerd",children:"1.6.3 \u542f\u52a8containerd"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"for node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo \">>> ${node_ip}\"\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'systemctl daemon-reload && systemctl enable containerd && systemctl start containerd'\n    }&\n  done\n"})}),"\n",(0,i.jsx)(n.h4,{id:"164-\u9a8c\u8bc1",children:"1.6.4 \u9a8c\u8bc1"}),"\n",(0,i.jsx)(n.p,{children:"\u67e5\u770b\u8fd0\u884c\u72b6\u6001"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"for node_ip in ${NODE_IPS[@]}\n  do\n    echo \">>> ${node_ip}\"\n    ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'systemctl status containerd|grep Active'\n  done\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u542f\u52a8\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528 containerd \u7684\u672c\u5730 CLI \u5de5\u5177 ",(0,i.jsx)(n.code,{children:"ctr"})," \u548c ",(0,i.jsx)(n.code,{children:"crictl"})," \u4e86\uff0c\u6bd4\u5982\u67e5\u770b\u7248\u672c"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"for node_ip in ${NODE_IPS[@]}\n  do\n    echo \">>> ${node_ip}\"\n    ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'ctr version'\n  done\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"$ ctr version\nClient:\n  Version:  v1.5.5\n  Revision: 72cec4be58a9eb6b2910f5d10f1c01ca47d231c0\n  Go version: go1.16.6\n\nServer:\n  Version:  v1.5.5\n  Revision: 72cec4be58a9eb6b2910f5d10f1c01ca47d231c0\n  UUID: 992ed032-c65e-4aa1-b2dc-e15453b3ab42\n"})}),"\n",(0,i.jsx)(n.h2,{id:"17-\u5b89\u88c5kubeadm",children:"1.7 \u5b89\u88c5Kubeadm"}),"\n",(0,i.jsx)(n.h3,{id:"171-\u4f7f\u7528\u963f\u91cc\u4e91yum\u6e90",children:"1.7.1 \u4f7f\u7528\u963f\u91cc\u4e91yum\u6e90"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"for node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo \">>> ${node_ip}\"\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'cat > /etc/yum.repos.d/kubernetes.repo << EOF\n[kubernetes]\nname=Kubernetes\nbaseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0\ngpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg\n        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF' \n    }&\n  done \n"})}),"\n",(0,i.jsx)(n.h3,{id:"172-\u5b89\u88c5-kubeadmkubeletkubectl",children:"1.7.2 \u5b89\u88c5 kubeadm\u3001kubelet\u3001kubectl"}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"\u963f\u91cc\u4e91yum\u6e90\u4f1a\u968f\u5b98\u65b9\u66f4\u65b0\u6700\u65b0\u7248\uff0c\u56e0\u6b64\u6307\u5b9a\u7248\u672c"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"for node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo \">>> ${node_ip}\"\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'export K8S_VERSION=1.22.2 && yum -y install kubelet-${K8S_VERSION} kubeadm-${K8S_VERSION} kubectl-${K8S_VERSION}'\n    }&\n  done\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u67e5\u770b\u7248\u672c"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"for node_ip in ${NODE_IPS[@]}\n  do\n    echo \">>> ${node_ip}\"\n    ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'kubeadm version'\n  done\n"})}),"\n",(0,i.jsx)(n.h3,{id:"173-\u8bbe\u7f6ekubelet\u5f00\u673a\u81ea\u542f",children:"1.7.3 \u8bbe\u7f6ekubelet\u5f00\u673a\u81ea\u542f"}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["\u6b64\u65f6kubelet\u662f\u65e0\u6cd5\u542f\u52a8\u7684\uff0c\u56e0\u4e3a\u53ea\u6709\u5b8c\u6210master\u7684 ",(0,i.jsx)(n.code,{children:"kubeadm init"})," \u7684\u64cd\u4f5c\uff0ckubelet\u624d\u80fd\u6b63\u5e38\u542f\u52a8"]})})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"for node_ip in ${NODE_IPS[@]}\n  do\n    echo \">>> ${node_ip}\"\n    ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'systemctl enable kubelet'\n  done\n"})}),"\n",(0,i.jsx)(n.h3,{id:"174-\u8bbe\u7f6ek8s\u547d\u4ee4\u81ea\u52a8\u8865\u5168",children:"1.7.4 \u8bbe\u7f6ek8s\u547d\u4ee4\u81ea\u52a8\u8865\u5168"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'for node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo ">>> ${node_ip}"\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} \'yum -y install bash-completion && \\\nsource /usr/share/bash-completion/bash_completion && \\\nsource <(kubectl completion bash) && \\\necho "source <(kubectl completion bash)" >> ~/.bashrc\'\n    }&\n  done\n'})}),"\n",(0,i.jsx)(n.h1,{id:"2\u521d\u59cb\u5316\u96c6\u7fa4",children:"2.\u521d\u59cb\u5316\u96c6\u7fa4"}),"\n",(0,i.jsx)(n.h2,{id:"21-master\u8282\u70b9\u64cd\u4f5c\u914d\u7f6e-kubeadm-\u521d\u59cb\u5316\u6587\u4ef6",children:"2.1 master\u8282\u70b9\u64cd\u4f5c\uff0c\u914d\u7f6e kubeadm \u521d\u59cb\u5316\u6587\u4ef6"}),"\n",(0,i.jsxs)(n.p,{children:["\u5f53\u6211\u4eec\u6267\u884c ",(0,i.jsx)(n.code,{children:"kubelet --help"})," \u547d\u4ee4\u7684\u65f6\u5019\u53ef\u4ee5\u770b\u5230\u539f\u6765\u5927\u90e8\u5206\u547d\u4ee4\u884c\u53c2\u6570\u90fd\u88ab ",(0,i.jsx)(n.code,{children:"DEPRECATED"}),"\u4e86\uff0c\u8fd9\u662f\u56e0\u4e3a\u5b98\u65b9\u63a8\u8350\u6211\u4eec\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"--config"})," \u6765\u6307\u5b9a\u914d\u7f6e\u6587\u4ef6\uff0c\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\u539f\u6765\u8fd9\u4e9b\u53c2\u6570\u7684\u914d\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7\u5b98\u65b9\u6587\u6863 ",(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/",children:"Set Kubelet parameters via a config file"})," \u4e86\u89e3\u66f4\u591a\u76f8\u5173\u4fe1\u606f\uff0c\u8fd9\u6837 Kubernetes \u5c31\u53ef\u4ee5\u652f\u6301\u52a8\u6001 Kubelet \u914d\u7f6e\uff08Dynamic Kubelet Configuration\uff09\u4e86\uff0c\u53c2\u8003 ",(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/",children:"Reconfigure a Node\u2019s Kubelet in a Live Cluster"}),"\u3002"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u5bfc\u51fa\u9ed8\u8ba4\u7684\u521d\u59cb\u5316\u914d\u7f6e"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"kubeadm config print init-defaults > kubeadm.yaml\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u65b9\u6cd5\u4e00"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"\u547d\u4ee4\u521d\u59cb\u5316"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"kubeadm init \\\n--apiserver-advertise-address=172.30.100.101 \\\n--image-repository registry.aliyuncs.com/google_containers \\\n--kubernetes-version v1.22.2 \\\n--service-cidr=10.96.0.0/16 \\\n--pod-network-cidr=10.20.0.0/16\n"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u53c2\u6570"}),(0,i.jsx)(n.th,{children:"\u8bf4\u660e"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"--apiserver-advertise-address=172.30.100.101"}),(0,i.jsx)(n.td,{children:"master\u8282\u70b9IP"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"--image-repository registry.aliyuncs.com/google_containers"}),(0,i.jsx)(n.td,{children:"\u6307\u5b9a\u963f\u91cc\u4e91\u955c\u50cf\u4ed3\u5e93"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"--kubernetes-version v1.22.2"}),(0,i.jsx)(n.td,{children:"k8s\u7248\u672c"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"--service-cidr=10.96.0.0/16"}),(0,i.jsx)(n.td,{children:"service IP\u7f51\u6bb5"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"--pod-network-cidr=10.20.0.0/16"}),(0,i.jsx)(n.td,{children:"pod IP\u7f51\u6bb5\uff0c\u540e\u7eed\u7f51\u7edc\u63d2\u4ef6\u4f1a\u7528\u5230"})]})]})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u65b9\u6cd5\u4e8c"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"\u6587\u4ef6\u521d\u59cb\u5316"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta3",children:"\u5b98\u65b9\u6e05\u5355\u8bf4\u660e\u6587\u6863"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'[ -d /opt/k8s/yaml ] || mkdir -p /opt/k8s/yaml && cd /opt/k8s/yaml\ncat > kubeadm.yaml << EOF\napiVersion: kubeadm.k8s.io/v1beta3\nbootstrapTokens:\n- groups:\n  - system:bootstrappers:kubeadm:default-node-token\n  token: abcdef.0123456789abcdef\n  ttl: 24h0m0s\n  usages:\n  - signing\n  - authentication\nkind: InitConfiguration\nlocalAPIEndpoint:\n  advertiseAddress: 172.30.100.101  # \u6307\u5b9amaster\u8282\u70b9\u5185\u7f51IP\n  bindPort: 6443\nnodeRegistration:\n  criSocket: /run/containerd/containerd.sock  # \u4f7f\u7528 containerd \u7684 Unix socket \u5730\u5740\n  imagePullPolicy: IfNotPresent\n  name: k8s-master01 # master\u8282\u70b9\u4e3b\u673a\u540d\n  taints:  # \u7ed9master\u6dfb\u52a0\u6c61\u70b9\uff0cmaster\u8282\u70b9\u4e0d\u80fd\u8c03\u5ea6\u5e94\u7528\n  - effect: "NoSchedule"\n    key: "node-role.kubernetes.io/master"\n\n---\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nkind: KubeProxyConfiguration\nmode: ipvs  # kube-proxy \u6a21\u5f0f\n\n---\napiServer:\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta3\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns: {}\netcd:\n  local:\n    dataDir: /var/lib/etcd\nimageRepository: registry.aliyuncs.com/k8sxio\nkind: ClusterConfiguration\nkubernetesVersion: 1.22.2\nnetworking:\n  dnsDomain: cluster.local\n  serviceSubnet: 10.96.0.0/12\n  podSubnet: 10.244.0.0/16  # \u6307\u5b9a pod \u5b50\u7f51\nscheduler: {}\n\n---\napiVersion: kubelet.config.k8s.io/v1beta1\nauthentication:\n  anonymous:\n    enabled: false\n  webhook:\n    cacheTTL: 0s\n    enabled: true\n  x509:\n    clientCAFile: /etc/kubernetes/pki/ca.crt\nauthorization:\n  mode: Webhook\n  webhook:\n    cacheAuthorizedTTL: 0s\n    cacheUnauthorizedTTL: 0s\nclusterDNS:\n- 10.96.0.10\nclusterDomain: cluster.local\ncpuManagerReconcilePeriod: 0s\nevictionPressureTransitionPeriod: 0s\nfileCheckFrequency: 0s\nhealthzBindAddress: 127.0.0.1\nhealthzPort: 10248\nhttpCheckFrequency: 0s\nimageMinimumGCAge: 0s\nkind: KubeletConfiguration\ncgroupDriver: systemd  # \u914d\u7f6e cgroup driver\nlogging: {}\nmemorySwap: {}\nnodeStatusReportFrequency: 0s\nnodeStatusUpdateFrequency: 0s\nrotateCertificates: true\nruntimeRequestTimeout: 0s\nshutdownGracePeriod: 0s\nshutdownGracePeriodCriticalPods: 0s\nstaticPodPath: /etc/kubernetes/manifests\nstreamingConnectionIdleTimeout: 0s\nsyncFrequency: 0s\nvolumeStatsAggPeriod: 0s\nEOF\n'})}),"\n",(0,i.jsx)(n.h2,{id:"22-\u521d\u59cb\u5316master",children:"2.2 \u521d\u59cb\u5316master"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u53ef\u4ee5\u5148\u5c06\u9700\u8981\u7684\u955c\u50cfpull\u4e0b\u6765"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:'$ kubeadm config images pull --config kubeadm.yaml\n[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-apiserver:v1.22.2\n[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-controller-manager:v1.22.2\n[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-scheduler:v1.22.2\n[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-proxy:v1.22.2\n[config/images] Pulled registry.aliyuncs.com/k8sxio/pause:3.5\n[config/images] Pulled registry.aliyuncs.com/k8sxio/etcd:3.5.0-0\nfailed to pull image "registry.aliyuncs.com/k8sxio/coredns:v1.8.4": output: time="2021-11-07T17:23:37+08:00" level=fatal msg="pulling image: rpc error: code = NotFound desc = failed to pull and unpack image \\"registry.aliyuncs.com/k8sxio/coredns:v1.8.4\\": failed to resolve reference \\"registry.aliyuncs.com/k8sxio/coredns:v1.8.4\\": registry.aliyuncs.com/k8sxio/coredns:v1.8.4: not found"\n, error: exit status 1\nTo see the stack trace of this error execute with --v=5 or higher\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u4e0a\u9762\u5728\u62c9\u53d6 ",(0,i.jsx)(n.code,{children:"coredns"})," \u955c\u50cf\u7684\u65f6\u5019\u51fa\u9519\u4e86\uff0c\u6ca1\u6709\u627e\u5230\u8fd9\u4e2a\u955c\u50cf\uff0c\u6211\u4eec\u53ef\u4ee5\u624b\u52a8 pull \u8be5\u955c\u50cf\uff0c\u7136\u540e\u91cd\u65b0 tag \u4e0b\u955c\u50cf\u5730\u5740\u5373\u53ef"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"# \u624b\u52a8pull\u955c\u50cf\n$ ctr -n k8s.io i pull docker.io/coredns/coredns:1.8.4\ndocker.io/coredns/coredns:1.8.4:                                                  resolved       |++++++++++++++++++++++++++++++++++++++|\nindex-sha256:6e5a02c21641597998b4be7cb5eb1e7b02c0d8d23cce4dd09f4682d463798890:    done           |++++++++++++++++++++++++++++++++++++++|\nmanifest-sha256:10683d82b024a58cc248c468c2632f9d1b260500f7cd9bb8e73f751048d7d6d4: done           |++++++++++++++++++++++++++++++++++++++|\nlayer-sha256:bc38a22c706b427217bcbd1a7ac7c8873e75efdd0e59d6b9f069b4b243db4b4b:    done           |++++++++++++++++++++++++++++++++++++++|\nconfig-sha256:8d147537fb7d1ac8895da4d55a5e53621949981e2e6460976dae812f83d84a44:   done           |++++++++++++++++++++++++++++++++++++++|\nlayer-sha256:c6568d217a0023041ef9f729e8836b19f863bcdb612bb3a329ebc165539f5a80:    exists         |++++++++++++++++++++++++++++++++++++++|\nelapsed: 12.4s                                                                    total:  12.0 M (991.3 KiB/s)\nunpacking linux/amd64 sha256:6e5a02c21641597998b4be7cb5eb1e7b02c0d8d23cce4dd09f4682d463798890...\ndone: 410.185888ms\n\n# \u624b\u52a8\u6253tag\nctr -n k8s.io i tag docker.io/coredns/coredns:1.8.4 registry.aliyuncs.com/k8sxio/coredns:v1.8.4\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u5f00\u59cb\u521d\u59cb\u5316\u96c6\u7fa4"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"kubeadm init --config kubeadm.yaml\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# \u4ee5\u4e0b\u4e3a\u5b8c\u6574\u8f93\u51fa\u7ed3\u679c\n[init] Using Kubernetes version: v1.22.2\n[preflight] Running pre-flight checks\n[preflight] Pulling images required for setting up a Kubernetes cluster\n[preflight] This might take a minute or two, depending on the speed of your internet connection\n[preflight] You can also perform this action in beforehand using \'kubeadm config images pull\'\n[certs] Using certificateDir folder "/etc/kubernetes/pki"\n[certs] Generating "ca" certificate and key\n[certs] Generating "apiserver" certificate and key\n[certs] apiserver serving cert is signed for DNS names [k8s-master01 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 172.30.100.101]\n[certs] Generating "apiserver-kubelet-client" certificate and key\n[certs] Generating "front-proxy-ca" certificate and key\n[certs] Generating "front-proxy-client" certificate and key\n[certs] Generating "etcd/ca" certificate and key\n[certs] Generating "etcd/server" certificate and key\n[certs] etcd/server serving cert is signed for DNS names [k8s-master01 localhost] and IPs [172.30.100.101 127.0.0.1 ::1]\n[certs] Generating "etcd/peer" certificate and key\n[certs] etcd/peer serving cert is signed for DNS names [k8s-master01 localhost] and IPs [172.30.100.101 127.0.0.1 ::1]\n[certs] Generating "etcd/healthcheck-client" certificate and key\n[certs] Generating "apiserver-etcd-client" certificate and key\n[certs] Generating "sa" key and public key\n[kubeconfig] Using kubeconfig folder "/etc/kubernetes"\n[kubeconfig] Writing "admin.conf" kubeconfig file\n[kubeconfig] Writing "kubelet.conf" kubeconfig file\n[kubeconfig] Writing "controller-manager.conf" kubeconfig file\n[kubeconfig] Writing "scheduler.conf" kubeconfig file\n[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"\n[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"\n[kubelet-start] Starting the kubelet\n[control-plane] Using manifest folder "/etc/kubernetes/manifests"\n[control-plane] Creating static Pod manifest for "kube-apiserver"\n[control-plane] Creating static Pod manifest for "kube-controller-manager"\n[control-plane] Creating static Pod manifest for "kube-scheduler"\n[etcd] Creating static Pod manifest for local etcd in "/etc/kubernetes/manifests"\n[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory "/etc/kubernetes/manifests". This can take up to 4m0s\n[apiclient] All control plane components are healthy after 12.002784 seconds\n[upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace\n[kubelet] Creating a ConfigMap "kubelet-config-1.22" in namespace kube-system with the configuration for the kubelets in the cluster\n[upload-certs] Skipping phase. Please see --upload-certs\n[mark-control-plane] Marking the node k8s-master01 as control-plane by adding the labels: [node-role.kubernetes.io/master(deprecated) node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]\n[mark-control-plane] Marking the node k8s-master01 as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]\n[bootstrap-token] Using token: abcdef.0123456789abcdef\n[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles\n[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes\n[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials\n[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token\n[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster\n[bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace\n[kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key\n[addons] Applied essential addon: CoreDNS\n[addons] Applied essential addon: kube-proxy\n\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nAlternatively, if you are the root user, you can run:\n\n  export KUBECONFIG=/etc/kubernetes/admin.conf\n\nYou should now deploy a pod network to the cluster.\nRun "kubectl apply -f [podnetwork].yaml" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 172.30.100.101:6443 --token abcdef.0123456789abcdef \\\n\t--discovery-token-ca-cert-hash sha256:4dbb97534e8304bb78023352236b898730062a35569e1c7f9247e6c7e81f250d  \n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:[(0,i.jsx)(n.code,{children:"kubeadm init"})," \u9047\u5230\u7684\u95ee\u9898"]})}),"\n",(0,i.jsx)(n.p,{children:"\u6267\u884c\u521d\u59cb\u5316\u62a5\u9519 kubelet check \u8d85\u65f6"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot_2022-10-11_18.19.14.png",alt:"iShot_2022-10-11_18.19.14"})}),"\n",(0,i.jsxs)(n.p,{children:["\u6267\u884c\u547d\u4ee4 ",(0,i.jsx)(n.code,{children:"kubeadm reset"})," \u91cd\u7f6e\u540e\u52a0\u53c2\u6570 ",(0,i.jsx)(n.code,{children:"-v=7"})," \u67e5\u770b\u8be6\u7ec6\u65e5\u5fd7\uff0c\u53d1\u73b0\u5e76\u6ca1\u6709\u660e\u663e\u7684\u6392\u67e5\u601d\u8def"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot_2022-10-11_18.27.29.png",alt:"iShot_2022-10-11_18.27.29"})}),"\n",(0,i.jsxs)(n.p,{children:["\u7531\u4e8e\u4f7f\u7528\u7684\u662fcontainerd\uff0c\u56e0\u6b64\u67e5\u770bcontainerd\u65e5\u5fd7\uff0c\u6267\u884c\u547d\u4ee4 ",(0,i.jsx)(n.code,{children:"journalctl -xe -u containerd"})," \u53d1\u73b0\u65e5\u5fd7\u62a5\u9519 ",(0,i.jsx)(n.code,{children:'exit status 127: runc: error while loading shared libraries: libseccomp.so.2: cannot open shared object file: No such file or directory\\\\n\\"\\n"'})," \uff0c\u63d0\u793a\u7f3a\u5c11 ",(0,i.jsx)(n.code,{children:"libseccomp.so.2"}),"\uff0c\u6267\u884c\u547d\u4ee4 ",(0,i.jsx)(n.code,{children:"yum -y install libseccomp"})," \u5b89\u88c5\u8fd9\u4e2a\u5305\u5373\u53ef"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot_2022-10-11_18.28.33.png",alt:"iShot_2022-10-11_18.28.33"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"kubeadm init"})," \u547d\u4ee4\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\u56fe\u6240\u793a"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-10-20%2016.02.59.png",alt:"iShot2020-10-20 16.02.59"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u62f7\u8d1d kubeconfig \u6587\u4ef6"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# $HOME\u8def\u5f84\u4e3a/root\nmkdir -p $HOME/.kube\ncp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nchown $(id -u):$(id -g) $HOME/.kube/config\n"})}),"\n",(0,i.jsx)(n.h2,{id:"23-master\u6dfb\u52a0\u8282\u70b9",children:"2.3 master\u6dfb\u52a0\u8282\u70b9"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["\u5c06master\u8282\u70b9\u4e0a\u7684 ",(0,i.jsx)(n.code,{children:"/root/.kube/config"})," \u6587\u4ef6\u62f7\u8d1d\u5230node\u8282\u70b9\u5bf9\u5e94\u7684\u6587\u4ef6\u4e2d"]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"for node_ip in ${NODE_IPS[@]}\n  do\n    {\n      echo \">>> ${node_ip}\"\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'mkdir -p $HOME/.kube'\n      scp -P${SSH_PORT} -i${SSH_KEY_FILE} $HOME/.kube/config ${SSH_USER}@${node_ip}:$HOME/.kube\n      ssh -p${SSH_PORT} -i${SSH_KEY_FILE} ${SSH_USER}@${node_ip} 'chown $(id -u):$(id -g) $HOME/.kube/config' \n    }&\n  done  \n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u5c06node1\u548cnode2\u52a0\u5165\u5230\u96c6\u7fa4\u4e2d"})}),"\n",(0,i.jsx)(n.p,{children:"\u8fd9\u91cc\u9700\u8981\u7528\u52302.2\u4e2d\u521d\u59cb\u5316master\u6700\u540e\u751f\u6210\u7684token\u548csha256\u503c"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"kubeadm join 172.30.100.101:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:4dbb97534e8304bb78023352236b898730062a35569e1c7f9247e6c7e81f250d\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"\u8f93\u51fa\u7ed3\u679c  \n[preflight] Running pre-flight checks\n[preflight] Reading configuration from the cluster...\n[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Starting the kubelet\n[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...\n\nThis node has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun 'kubectl get nodes' on the control-plane to see this node join the cluster.\n\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"kubeadm join"})," \u547d\u4ee4\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\u6240\u793a"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-10-20%2016.04.22.png",alt:"iShot2020-10-20 16.04.22"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u5982\u679c\u5fd8\u8bb0\u4e86token\u548csha256\u503c\uff0c\u53ef\u4ee5\u5728master\u8282\u70b9\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u67e5\u770b"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"# \u67e5\u770btoken\n$ kubeadm token list\nTOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS\nabcdef.0123456789abcdef   23h         2021-11-08T10:22:16Z   authentication,signing   <none>                                                     system:bootstrappers:kubeadm:default-node-token\n            \n# \u67e5\u770bsha256            \n$ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'\n4dbb97534e8304bb78023352236b898730062a35569e1c7f9247e6c7e81f250d\n\n# \u540c\u65f6\u67e5\u770btoken\u548csha256\n$ kubeadm token create --print-join-command\nkubeadm join 172.30.100.101:6443 --token ztnnf4.rnk33s1lpfyc4w98 --discovery-token-ca-cert-hash sha256:4dbb97534e8304bb78023352236b898730062a35569e1c7f9247e6c7e81f250d\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["\u8fd9\u4e2a\u65f6\u5019\u5176\u5b9e\u96c6\u7fa4\u8fd8\u4e0d\u80fd\u6b63\u5e38\u4f7f\u7528\uff0c\u56e0\u4e3a\u8fd8\u6ca1\u6709\u5b89\u88c5\u7f51\u7edc\u63d2\u4ef6\uff0c\u63a5\u4e0b\u6765\u5b89\u88c5\u7f51\u7edc\u63d2\u4ef6\uff0c\u53ef\u4ee5\u5728\u6587\u6863 ",(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/",children:"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/"})," \u4e2d\u9009\u62e9\u6211\u4eec\u81ea\u5df1\u7684\u7f51\u7edc\u63d2\u4ef6\uff0c\u8fd9\u91cc\u6211\u4eec\u5b89\u88c5 flannel"]})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/",children:"k8s\u7f51\u7edc\u63d2\u4ef6\u5b98\u65b9\u6587\u6863"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/",children:"calio\u63d2\u4ef6\u5b98\u65b9\u6587\u6863"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"$ kubectl get nodes\nNAME           STATUS   ROLES                  AGE    VERSION\nk8s-master01   Ready    control-plane,master   24m    v1.22.2\nk8s-node01     Ready    <none>                 101s   v1.22.2\nk8s-node02     Ready    <none>                 112s   v1.22.2\n"})}),"\n",(0,i.jsx)(n.h2,{id:"24-master\u8282\u70b9\u5b89\u88c5\u7f51\u7edc\u63d2\u4ef6flannel",children:"2.4 master\u8282\u70b9\u5b89\u88c5\u7f51\u7edc\u63d2\u4ef6flannel"}),"\n",(0,i.jsx)(n.h3,{id:"241-\u4e0b\u8f7d\u6587\u4ef6",children:"2.4.1 \u4e0b\u8f7d\u6587\u4ef6"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\n"})}),"\n",(0,i.jsx)(n.h3,{id:"242-\u4fee\u6539\u6587\u4ef6\u5185\u5bb9",children:"2.4.2 \u4fee\u6539\u6587\u4ef6\u5185\u5bb9"}),"\n",(0,i.jsxs)(n.p,{children:["\u641c\u7d22 ",(0,i.jsx)(n.code,{children:"kube-flannel-ds"})," \uff0c\u5728 ",(0,i.jsx)(n.code,{children:"kube-flannel-ds"})," \u4e2d ",(0,i.jsx)(n.code,{children:"containers"})," \u4e0b\u7684 ",(0,i.jsx)(n.code,{children:"args"})," \u6dfb\u52a0\u4e00\u884c ",(0,i.jsx)(n.code,{children:"- --iface=eth0"}),"\uff0c\u8fd9\u4e48\u505a\u662f\u4e3a\u4e86\u907f\u514d\u673a\u5668\u4e2d\u662f\u591a\u7f51\u5361\u7684\u60c5\u51b5\uff0c\u8fd9\u91cc\u624b\u52a8\u6307\u5b9a\u4e00\u4e0b\u7f51\u5361\u540d\u79f0"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"containers:\n- name: kube-flannel\n  image: quay.io/coreos/flannel:v0.15.0\n  command:\n  - /opt/bin/flanneld\n  args:\n  - --ip-masq\n  - --kube-subnet-mgr\n  - --iface=eth0\t# \u589e\u52a0\u4e00\u884c\n"})}),"\n",(0,i.jsx)(n.h3,{id:"243-\u4fee\u6539\u5b8c\u6210\u540e\u5b89\u88c5flannel\u7f51\u7edc\u63d2\u4ef6",children:"2.4.3 \u4fee\u6539\u5b8c\u6210\u540e\u5b89\u88c5flannel\u7f51\u7edc\u63d2\u4ef6"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f kube-flannel.yml\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"caution",children:(0,i.jsxs)(n.p,{children:["\u8fd9\u91cc\u6709\u5751\uff01\uff01\uff01\uff0c\u6267\u884c\u5b8c ",(0,i.jsx)(n.code,{children:"kubectl apply -f kube-flannel.yml"})," \u547d\u4ee4\u540e\u67e5\u770b\u6240\u6709pod\u72b6\u6001\uff0c\u8fd9\u4e2a\u65f6\u5019coredns\u4e00\u5b9a\u662f\u6709\u95ee\u9898\u7684\uff0c\u67e5\u770bcoredns\u4f1a\u53d1\u73b0\u5982\u4e0b\u62a5\u9519"]})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:'could not add IP address to "cni0": permission denied'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2021-11-14%2017.36.23.png",alt:"iShot2021-11-14 17.36.23"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2021-11-07%2023.39.13.png",alt:"iShot2021-11-07 23.39.13"})}),"\n",(0,i.jsxs)(n.p,{children:["\u6267\u884c  ",(0,i.jsx)(n.code,{children:"ip a"}),"  \u547d\u4ee4\u67e5\u770b\u7f51\u5361\u4fe1\u606f\uff0c\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a\u865a\u62df\u7f51\u5361 ",(0,i.jsx)(n.code,{children:"cni0"})," \uff0c\u8fd9\u4e2a\u865a\u62df\u7f51\u5361\u7684IP\u6bb5\u662f ",(0,i.jsx)(n.code,{children:"10.88.0.0/16"})," \u6bb5\u7684\uff0c\u8fd9\u4e2a\u5c31\u662f\u5e94\u7528flannel\u540e\u521b\u5efa\u7684\u865a\u62df\u7f51\u5361"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2021-11-14%2017.37.34.png",alt:"iShot2021-11-14 17.37.34"})}),"\n",(0,i.jsx)(n.p,{children:"\u67e5\u770bcni\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"$  ls /etc/cni/net.d/\n10-containerd-net.conflist  10-flannel.conflist\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"10.88.0.0./16"}),"  \u5c31\u662f\u7531 ",(0,i.jsx)(n.code,{children:"/etc/cni/net.d/10-containerd-net.conflist "})," \u8fd9\u4e2a\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\uff0c\u800c ",(0,i.jsx)(n.code,{children:"10-flannel.conflist"})," \u624d\u662f\u6211\u4eec\u60f3\u8981\u7684\u6587\u4ef6"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'$ cat /etc/cni/net.d/10-containerd-net.conflist \n{\n  "cniVersion": "0.4.0",\n  "name": "containerd-net",\n  "plugins": [\n    {\n      "type": "bridge",\n      "bridge": "cni0",\n      "isGateway": true,\n      "ipMasq": true,\n      "promiscMode": true,\n      "ipam": {\n        "type": "host-local",\n        "ranges": [\n          [{\n            "subnet": "10.88.0.0/16"\n          }],\n          [{\n            "subnet": "2001:4860:4860::/64"\n          }]\n        ],\n        "routes": [\n          { "dst": "0.0.0.0/0" },\n          { "dst": "::/0" }\n        ]\n      }\n    },\n    {\n      "type": "portmap",\n      "capabilities": {"portMappings": true}\n    }\n  ]\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u8fd9\u4e2a cni \u63d2\u4ef6\u7c7b\u578b\u662f ",(0,i.jsx)(n.code,{children:"bridge"})," \u7f51\u7edc\uff0c\u7f51\u6865\u7684\u540d\u79f0\u4e3a ",(0,i.jsx)(n.code,{children:"cni0"}),"\uff0c\u4f46\u662f\u4f7f\u7528 bridge \u7f51\u7edc\u7684\u5bb9\u5668\u65e0\u6cd5\u8de8\u591a\u4e2a\u5bbf\u4e3b\u673a\u8fdb\u884c\u901a\u4fe1\uff0c\u8de8\u4e3b\u673a\u901a\u4fe1\u9700\u8981\u501f\u52a9\u5176\u4ed6\u7684 cni \u63d2\u4ef6\uff0c\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u5b89\u88c5\u7684 Flannel\uff0c\u6216\u8005 Calico \u7b49\u7b49\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u6709\u4e24\u4e2a cni \u914d\u7f6e\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5c06 ",(0,i.jsx)(n.code,{children:"10-containerd-net.conflist"})," \u8fd9\u4e2a\u914d\u7f6e\u5220\u9664\uff0c\u56e0\u4e3a\u5982\u679c\u8fd9\u4e2a\u76ee\u5f55\u4e2d\u6709\u591a\u4e2a cni \u914d\u7f6e\u6587\u4ef6\uff0ckubelet \u5c06\u4f1a\u4f7f\u7528\u6309\u6587\u4ef6\u540d\u7684\u5b57\u5178\u987a\u5e8f\u6392\u5217\u7684\u7b2c\u4e00\u4e2a\u4f5c\u4e3a\u914d\u7f6e\u6587\u4ef6\uff0c\u6240\u4ee5\u524d\u9762\u9ed8\u8ba4\u9009\u62e9\u4f7f\u7528\u7684\u662f ",(0,i.jsx)(n.code,{children:"containerd-net"})," \u8fd9\u4e2a\u63d2\u4ef6\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"mv /etc/cni/net.d/10-containerd-net.conflist /etc/cni/net.d/10-containerd-net.conflist.bak\nifconfig cni0 down && ip link delete cni0\nsystemctl daemon-reload\nsystemctl restart containerd kubelet\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u518d\u6b21\u67e5\u770bcoredns\u5c31\u6ca1\u6709\u95ee\u9898\u4e86"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2021-11-14%2017.53.34.png",alt:"iShot2021-11-14 17.53.34"})}),"\n",(0,i.jsx)(n.h3,{id:"244-\u5b89\u88c5\u5b8c\u6210\u540e\u7a0d\u7b49\u4e00\u4f1a\u67e5\u770bpods\u72b6\u6001\u5168\u90e8\u4e3arunning\u5373\u4e3a\u6b63\u786e",children:"2.4.4 \u5b89\u88c5\u5b8c\u6210\u540e\u7a0d\u7b49\u4e00\u4f1a\u67e5\u770bpods\u72b6\u6001\uff0c\u5168\u90e8\u4e3arunning\u5373\u4e3a\u6b63\u786e"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"$ kubectl get pods -n kube-system\nNAME                                   READY   STATUS    RESTARTS   AGE\ncoredns-7568f67dbd-26nkx               1/1     Running   0          6d3h\ncoredns-7568f67dbd-n56bc               1/1     Running   0          6d3h\netcd-k8s-master01                      1/1     Running   0          6d3h\nkube-apiserver-k8s-master01            1/1     Running   0          6d3h\nkube-controller-manager-k8s-master01   1/1     Running   0          6d3h\nkube-flannel-ds-7rbqf                  1/1     Running   0          20m\nkube-flannel-ds-kwtzt                  1/1     Running   0          20m\nkube-flannel-ds-tswz7                  1/1     Running   0          20m\nkube-proxy-blqbn                       1/1     Running   0          6d3h\nkube-proxy-mwqmv                       1/1     Running   0          6d3h\nkube-proxy-sgwhm                       1/1     Running   0          6d3h\nkube-scheduler-k8s-master01            1/1     Running   0          6d3h\n"})}),"\n",(0,i.jsx)(n.h3,{id:"245-\u67e5\u770bnode\u72b6\u6001",children:"2.4.5 \u67e5\u770bnode\u72b6\u6001"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"$ kubectl get nodes\nNAME           STATUS   ROLES                  AGE    VERSION\nk8s-master01   Ready    control-plane,master   6d3h   v1.22.2\nk8s-node01     Ready    <none>                 6d3h   v1.22.2\nk8s-node02     Ready    <none>                 6d3h   v1.22.2\n"})}),"\n",(0,i.jsx)(n.h2,{id:"25-\u5b89\u88c5dashboard\u53ef\u9009",children:"2.5 \u5b89\u88c5Dashboard(\u53ef\u9009)"}),"\n",(0,i.jsx)(n.h3,{id:"251-\u4e0b\u8f7dyaml\u6587\u4ef6",children:"2.5.1 \u4e0b\u8f7dyaml\u6587\u4ef6"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://github.com/kubernetes/dashboard/releases",children:"\u8fd9\u91cc\u67e5\u770bdashboard\u5bf9\u5e94\u7684k8s\u7248\u672c"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"cd /opt/k8s/yaml\nwget https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml\nmv recommended.yaml dashboard-v2.4.0.yaml\n"})}),"\n",(0,i.jsx)(n.h3,{id:"252-\u4fee\u6539\u6587\u4ef6",children:"2.5.2 \u4fee\u6539\u6587\u4ef6"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u4fee\u6539Service\u4e3aNodePort\u7c7b\u578b"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"# \u539f\u5148\u5185\u5bb9\nspec:\n  ports:\n    - port: 443\n      targetPort: 8443\n  selector:\n    k8s-app: kubernetes-dashboard\n\n\n# \u4fee\u6539\u540e\u5185\u5bb9\nspec:\n  type: NodePort\t\t# \u65b0\u589e\u4e00\u884c\uff0c\u4fee\u6539\u7c7b\u578b\u4e3anodeport\n  ports:\n    - port: 443\n      targetPort: 8443\n      nodePort: 30001   # \u65b0\u589e\u4e00\u884c\uff0c\u6307\u5b9anodeport\u7aef\u53e3\n  selector:\n    k8s-app: kubernetes-dashboard\n"})}),"\n",(0,i.jsx)(n.h3,{id:"253-\u90e8\u7f72dashboard",children:"2.5.3 \u90e8\u7f72dashboard"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f dashboard-v2.4.0.yaml\n"})}),"\n",(0,i.jsx)(n.h3,{id:"254-\u67e5\u770bdashboard\u7684\u8fd0\u884c\u72b6\u6001\u53ca\u5916\u7f51\u8bbf\u95ee\u7aef\u53e3",children:"2.5.4 \u67e5\u770bdashboard\u7684\u8fd0\u884c\u72b6\u6001\u53ca\u5916\u7f51\u8bbf\u95ee\u7aef\u53e3"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# \u67e5\u770bdashboard\u8fd0\u884c\u72b6\u6001\n$ kubectl get pods -n kubernetes-dashboard -l k8s-app=kubernetes-dashboard\nNAME                                    READY   STATUS    RESTARTS   AGE\nkubernetes-dashboard-576cb95f94-nmtkl   1/1     Running   0          6m55s\n\n# \u67e5\u770bdashboard\u5916\u7f51\u8bbf\u95ee\u7aef\u53e3\n$ kubectl get svc -n kubernetes-dashboard -l k8s-app=kubernetes-dashboard\nNAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE\nkubernetes-dashboard   NodePort   10.99.205.24   <none>        443:30001/TCP   7m10s\n"})}),"\n",(0,i.jsx)(n.h3,{id:"255-\u521b\u5efa\u4e00\u4e2a\u5177\u6709\u5168\u5c40\u6240\u6709\u6743\u9650\u7684\u7528\u6237\u6765\u767b\u5f55dashboard",children:"2.5.5 \u521b\u5efa\u4e00\u4e2a\u5177\u6709\u5168\u5c40\u6240\u6709\u6743\u9650\u7684\u7528\u6237\u6765\u767b\u5f55Dashboard"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# \u7f16\u8f91admin.yaml\u6587\u4ef6\ncat > /opt/k8s/yaml/admin.yaml <<EOF\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: admin\nroleRef:\n  kind: ClusterRole\n  name: cluster-admin\n  apiGroup: rbac.authorization.k8s.io\nsubjects:\n- kind: ServiceAccount\n  name: admin\n  namespace: kubernetes-dashboard\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: admin\n  namespace: kubernetes-dashboard\nEOF\n\n# \u76f4\u63a5\u521b\u5efa\nkubectl apply -f /opt/k8s/yaml/admin.yaml\n"})}),"\n",(0,i.jsx)(n.h3,{id:"256-\u67e5\u770bdashboard-token",children:"2.5.6 \u67e5\u770bdashboard token"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"# \u67e5\u770btoken\n$ kubectl get secret -n kubernetes-dashboard|grep admin-token\nadmin-token-852sr                  kubernetes.io/service-account-token   3      103s\n\n# \u83b7\u53d6base64\u89e3\u7801\u540e\u7684\u5b57\u7b26\u4e32\uff0c\u6ce8\u610f\u9700\u8981\u7528\u5230\u4e0a\u8fb9\u547d\u4ee4\u67e5\u770b\u5230\u7684token\uff0c\u4f1a\u751f\u6210\u5f88\u957f\u7684\u4e00\u4e32\u5b57\u7b26\u4e32\nkubectl get secret admin-token-zcwfb -o jsonpath={.data.token} -n kubernetes-dashboard |base64 -d\n\n# \u76f4\u63a5\u7528\u8fd9\u6761\u547d\u4ee4\u641e\u5b9a\nkubectl get secret `kubectl get secret -n kubernetes-dashboard | grep admin-token|awk '{print $1}'` -o jsonpath={.data.token} -n kubernetes-dashboard |base64 -d && echo\n"})}),"\n",(0,i.jsx)(n.h3,{id:"256-\u8bbf\u95eedashboard",children:"2.5.6 \u8bbf\u95eedashboard"}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["\u6d4f\u89c8\u5668\u8bbf\u95ee ",(0,i.jsx)(n.code,{children:"https://ip:30001"}),"\uff0c\u6ce8\u610f\u662f ",(0,i.jsx)(n.code,{children:"https"})]})}),"\n",(0,i.jsx)(n.p,{children:"\u8c37\u6b4c\u6d4f\u89c8\u5668\u8bbf\u95ee\u4f1a\u63d0\u793a\u5982\u4e0b"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2021-10-01%2015.46.33.png",alt:"iShot2021-10-01 15.46.33"})}),"\n",(0,i.jsx)(n.p,{children:"\u901a\u8fc7\u706b\u72d0\u6d4f\u89c8\u5668\u8bbf\u95ee"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2021-10-01%2015.52.45.png",alt:"iShot2021-10-01 15.52.45"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["\u7136\u540e\u7c98\u8d342.5.6\u6b65\u9aa4\u4e2d\u751f\u6210\u7684base64\u5b57\u7b26\u4e32\u767b\u9646dashboard\uff0c\u5728\u767b\u9646\u9875\u9762\u9009\u62e9",(0,i.jsx)(n.code,{children:"\u4ee4\u724c"}),"\u4e00\u9879"]})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2021-10-01%2015.54.35.png",alt:"iShot2021-10-01 15.54.35"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u767b\u9646\u540e\u7684\u9996\u754c\u9762"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2021-11-14%2018.19.11.png",alt:"iShot2021-11-14 18.19.11"})}),"\n",(0,i.jsx)(n.h2,{id:"27-\u5b89\u88c5k8s\u5207\u6362\u547d\u540d\u7a7a\u95f4\u5de5\u5177\u53ef\u9009",children:"2.7 \u5b89\u88c5k8s\u5207\u6362\u547d\u540d\u7a7a\u95f4\u5de5\u5177(\u53ef\u9009)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# \u4e0b\u8f7d\u5305\ngit clone https://github.com/ahmetb/kubectx.git\ncp kubectx/kubens /usr/local/bin\n\n# \u67e5\u770b\u6240\u6709\u547d\u540d\u7a7a\u95f4\n$ kubens\n\n# \u5207\u6362\u5230kube-system\u547d\u540d\u7a7a\u95f4\n$ kubens kube-system\nContext "kubernetes-admin@kubernetes" modified.\nActive namespace is "kube-system".\n'})}),"\n",(0,i.jsx)("h3",{style:{color:"red"},children:"\u5230\u6b64\uff0c\u4f7f\u7528kubeadm\u5b89\u88c5k8s 1.22.2\u5b8c\u6210\uff01\uff01\uff01"})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>c});var i=s(96540);const r={},t=i.createContext(r);function o(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);