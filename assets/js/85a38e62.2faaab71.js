"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[1327],{96440:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>x,frontMatter:()=>s,metadata:()=>t,toc:()=>a});var l=i(74848),r=i(28453);const s={},d="nginx+keepalived\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u9ad8\u53ef\u7528",t={id:"linux/linux\u670d\u52a1/nginx/nginx+keepalived\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u9ad8\u53ef\u7528",title:"nginx+keepalived\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u9ad8\u53ef\u7528",description:"[toc]",source:"@site/docs/linux/linux\u670d\u52a1/nginx/14.nginx+keepalived\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u9ad8\u53ef\u7528.md",sourceDirName:"linux/linux\u670d\u52a1/nginx",slug:"/linux/linux\u670d\u52a1/nginx/nginx+keepalived\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u9ad8\u53ef\u7528",permalink:"/docs/linux/linux\u670d\u52a1/nginx/nginx+keepalived\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u9ad8\u53ef\u7528",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:14,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"nginx\u52a8\u9759\u5206\u79bb",permalink:"/docs/linux/linux\u670d\u52a1/nginx/nginx\u52a8\u9759\u5206\u79bb"},next:{title:"nginx\u589e\u52a0\u65b0\u6a21\u5757",permalink:"/docs/linux/linux\u670d\u52a1/nginx/nginx\u589e\u52a0\u65b0\u6a21\u5757"}},c={},a=[{value:"1.keepalived\u7b80\u4ecb",id:"1keepalived\u7b80\u4ecb",level:2},{value:"2.keepalived\u8d1f\u8f7d\u5747\u8861\u9ad8\u53ef\u7528\u914d\u7f6e\u8fc7\u7a0b",id:"2keepalived\u8d1f\u8f7d\u5747\u8861\u9ad8\u53ef\u7528\u914d\u7f6e\u8fc7\u7a0b",level:2},{value:"2.1 \u8d1f\u8f7d\u5747\u8861\u7aef\u914d\u7f6e",id:"21-\u8d1f\u8f7d\u5747\u8861\u7aef\u914d\u7f6e",level:3},{value:"2.1.1 \u5b89\u88c5keepalived",id:"211-\u5b89\u88c5keepalived",level:4},{value:"2.1.2 lb01(keepalived master)\u7f16\u8f91\u914d\u7f6e\u6587\u4ef6",id:"212-lb01keepalived-master\u7f16\u8f91\u914d\u7f6e\u6587\u4ef6",level:4},{value:"2.1.3 lb02(keepalived backup)\u7f16\u8f91\u914d\u7f6e\u6587\u4ef6",id:"213-lb02keepalived-backup\u7f16\u8f91\u914d\u7f6e\u6587\u4ef6",level:4},{value:"2.1.4 \u542f\u52a8keepalived",id:"214-\u542f\u52a8keepalived",level:4},{value:"2.1.5 \u68c0\u6d4blb01\u662f\u5426\u6709vip",id:"215-\u68c0\u6d4blb01\u662f\u5426\u6709vip",level:4},{value:"2.1.6 \u9a8c\u8bc1VIP\u662f\u5426\u80fd\u591f\u6b63\u5e38\u6f02\u79fb",id:"216-\u9a8c\u8bc1vip\u662f\u5426\u80fd\u591f\u6b63\u5e38\u6f02\u79fb",level:4},{value:"2.1.7 \u7f16\u8f91nginx\u914d\u7f6e\u6587\u4ef6",id:"217-\u7f16\u8f91nginx\u914d\u7f6e\u6587\u4ef6",level:4},{value:"2.2 \u540e\u7aef\u771f\u5b9e\u670d\u52a1web\u914d\u7f6e",id:"22-\u540e\u7aef\u771f\u5b9e\u670d\u52a1web\u914d\u7f6e",level:3},{value:"2.2.1 \u7f16\u8f91nginx\u914d\u7f6e\u6587\u4ef6",id:"221-\u7f16\u8f91nginx\u914d\u7f6e\u6587\u4ef6",level:4},{value:"2.2.2 \u521b\u5efa\u7f51\u7ad9\u6839\u76ee\u5f55",id:"222-\u521b\u5efa\u7f51\u7ad9\u6839\u76ee\u5f55",level:4},{value:"2.2.3 \u68c0\u6d4bnginx\u8bed\u6cd5\u5e76\u91cd\u8f7dnginx",id:"223-\u68c0\u6d4bnginx\u8bed\u6cd5\u5e76\u91cd\u8f7dnginx",level:4},{value:"2.2.4 \u7f16\u8f91nginx\u914d\u7f6e\u6587\u4ef6",id:"224-\u7f16\u8f91nginx\u914d\u7f6e\u6587\u4ef6",level:4},{value:"2.2.5 \u521b\u5efa\u7f51\u7ad9\u6839\u76ee\u5f55",id:"225-\u521b\u5efa\u7f51\u7ad9\u6839\u76ee\u5f55",level:4},{value:"2.2.6 \u68c0\u6d4bnginx\u8bed\u6cd5\u5e76\u91cd\u8f7dnginx",id:"226-\u68c0\u6d4bnginx\u8bed\u6cd5\u5e76\u91cd\u8f7dnginx",level:4},{value:"2.3 \u6d4f\u89c8\u5668\u9a8c\u8bc1\u8d1f\u8f7d\u5747\u8861\u662f\u5426\u6b63\u5e38\u5de5\u4f5c",id:"23-\u6d4f\u89c8\u5668\u9a8c\u8bc1\u8d1f\u8f7d\u5747\u8861\u662f\u5426\u6b63\u5e38\u5de5\u4f5c",level:3},{value:"3.nginx\u5b95\u673a\u95ee\u9898",id:"3nginx\u5b95\u673a\u95ee\u9898",level:2},{value:"3.1 \u7f16\u8f91\u811a\u672c",id:"31-\u7f16\u8f91\u811a\u672c",level:3},{value:"3.2 \u9a8c\u8bc1\u811a\u672c\u662f\u5426\u751f\u6548",id:"32-\u9a8c\u8bc1\u811a\u672c\u662f\u5426\u751f\u6548",level:3},{value:"3.3 \u5728keepalived\u4e2d\u8c03\u7528\u68c0\u6d4b\u811a\u672c",id:"33-\u5728keepalived\u4e2d\u8c03\u7528\u68c0\u6d4b\u811a\u672c",level:3},{value:"4.keepalived\u9ad8\u53ef\u7528\u8111\u88c2",id:"4keepalived\u9ad8\u53ef\u7528\u8111\u88c2",level:2},{value:"4.1 \u6a21\u62df\u8111\u88c2",id:"41-\u6a21\u62df\u8111\u88c2",level:3},{value:"4.2 \u6d4b\u8bd5\u8111\u88c2\u95ee\u9898",id:"42-\u6d4b\u8bd5\u8111\u88c2\u95ee\u9898",level:3},{value:"5.\u6e90\u7801\u5b89\u88c5keepalived",id:"5\u6e90\u7801\u5b89\u88c5keepalived",level:2},{value:"5.1 \u4e0b\u8f7d\u5305",id:"51-\u4e0b\u8f7d\u5305",level:3},{value:"5.2 \u7f16\u8bd1\u5b89\u88c5",id:"52-\u7f16\u8bd1\u5b89\u88c5",level:3},{value:"5.3 \u914d\u7f6ekeepalived",id:"53-\u914d\u7f6ekeepalived",level:3},{value:"5.3.1 \u8f6f\u8fde\u63a5keepalived\u547d\u4ee4",id:"531-\u8f6f\u8fde\u63a5keepalived\u547d\u4ee4",level:4},{value:"5.3.2 keepalived.service\u6587\u4ef6",id:"532-keepalivedservice\u6587\u4ef6",level:4},{value:"5.3.3 \u62f7\u8d1d\u5b89\u88c5\u76ee\u5f55\u4e0bkeepalived\u914d\u7f6e\u6587\u4ef6",id:"533-\u62f7\u8d1d\u5b89\u88c5\u76ee\u5f55\u4e0bkeepalived\u914d\u7f6e\u6587\u4ef6",level:4},{value:"5.3.4 \u62f7\u8d1d\u542f\u52a8\u6587\u4ef6(\u53ef\u9009)",id:"534-\u62f7\u8d1d\u542f\u52a8\u6587\u4ef6\u53ef\u9009",level:4},{value:"5.3.5 \u542f\u52a8keepalived\u5e76\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f",id:"535-\u542f\u52a8keepalived\u5e76\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f",level:4}];function h(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.p,{children:"[toc]"}),"\n",(0,l.jsx)(n.h1,{id:"nginxkeepalived\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u9ad8\u53ef\u7528",children:"nginx+keepalived\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u9ad8\u53ef\u7528"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"https://www.keepalived.org/",children:"keepalived\u5b98\u7f51"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"https://github.com/acassen/keepalived",children:"keepalived github\u5730\u5740"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"https://www.keepalived.org/manpage.html",children:"keepalived\u5b98\u65b9\u6587\u6863"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"https://www.keepalived.org/download.html",children:"keepalived\u6e90\u7801\u5305\u5b98\u65b9\u4e0b\u8f7d\u5730\u5740"})}),"\n",(0,l.jsx)(n.h2,{id:"1keepalived\u7b80\u4ecb",children:"1.keepalived\u7b80\u4ecb"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsxs)(n.strong,{children:["Keepalived\u662f\u7528C\u8bed\u8a00\u7f16\u5199\u7684\u8def\u7531\u8f6f\u4ef6\u3002\u8be5\u9879\u76ee\u7684\u4e3b\u8981\u76ee\u6807\u662f\u4e3aLinux\u7cfb\u7edf\u548c\u57fa\u4e8eLinux\u7684\u57fa\u7840\u67b6\u6784\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u548c\u9ad8\u53ef\u7528\u6027\u7684\u7b80\u5355\u800c\u5f3a\u5927\u7684\u529f\u80fd\u3002 \u8d1f\u8f7d\u5e73\u8861\u6846\u67b6\u4f9d\u8d56\u4e8e\u63d0\u4f9b\u7b2c4\u5c42\u8d1f\u8f7d",(0,l.jsx)(n.a,{href:"http://www.linux-vs.org/",children:"\u5e73\u8861"}),"\u7684\u8457\u540d\u4e14\u5e7f\u6cdb\u4f7f\u7528\u7684",(0,l.jsx)(n.a,{href:"http://www.linux-vs.org/",children:"Linux\u865a\u62df\u670d\u52a1\u5668\uff08IPVS\uff09"}),"\u5185\u6838\u6a21\u5757\u3002Keepalived\u5b9e\u73b0\u4e86\u4e00\u7ec4\u68c0\u67e5\u5668\uff0c\u4ee5\u6839\u636e\u5176\u8fd0\u884c\u72b6\u51b5\u52a8\u6001\uff0c\u81ea\u9002\u5e94\u5730\u7ef4\u62a4\u548c\u7ba1\u7406\u8d1f\u8f7d\u5e73\u8861\u7684\u670d\u52a1\u5668\u6c60\u3002\u53e6\u4e00\u65b9\u9762\uff0c",(0,l.jsx)(n.a,{href:"http://datatracker.ietf.org/wg/vrrp/",children:"VRRP"}),"\u5b9e\u73b0\u4e86\u9ad8\u53ef\u7528\u6027\u534f\u8bae\u3002VRRP\u662f\u8def\u7531\u5668\u6545\u969c\u8f6c\u79fb\u7684\u57fa\u7840\u3002\u6b64\u5916\uff0cKeepalived\u8fd8\u5b9e\u73b0\u4e86\u4e00\u7ec4VRRP\u6709\u9650\u72b6\u6001\u673a\u7684\u94a9\uff0c\u4ece\u800c\u63d0\u4f9b\u4e86\u4f4e\u7ea7\u548c\u9ad8\u901f\u534f\u8bae\u4ea4\u4e92\u3002\u4e3a\u4e86\u63d0\u4f9b\u6700\u5feb\u7684\u7f51\u7edc\u6545\u969c\u68c0\u6d4b\uff0cKeepalived\u5b9e\u65bd",(0,l.jsx)(n.a,{href:"http://datatracker.ietf.org/wg/bfd/",children:"BFD"}),"\u534f\u8bae\u3002VRRP\u72b6\u6001\u8f6c\u6362\u53ef\u4ee5\u8003\u8651BFD\u63d0\u793a\u6765\u9a71\u52a8\u5feb\u901f\u72b6\u6001\u8f6c\u6362\u3002Keepalived\u6846\u67b6\u53ef\u4ee5\u72ec\u7acb\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4e00\u8d77\u4f7f\u7528\u4ee5\u63d0\u4f9b\u5f39\u6027\u57fa\u7840\u67b6\u6784\u3002"]})}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"2keepalived\u8d1f\u8f7d\u5747\u8861\u9ad8\u53ef\u7528\u914d\u7f6e\u8fc7\u7a0b",children:"2.keepalived\u8d1f\u8f7d\u5747\u8861\u9ad8\u53ef\u7528\u914d\u7f6e\u8fc7\u7a0b"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u5b9e\u9a8c\u73af\u5883"})}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:(0,l.jsx)(n.strong,{children:"\u89d2\u8272"})}),(0,l.jsx)(n.th,{children:(0,l.jsx)(n.strong,{children:"IP"})}),(0,l.jsx)(n.th,{children:(0,l.jsx)(n.strong,{children:"\u4e3b\u673a\u540d"})})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"keepalived-master"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"10.0.0.10"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"keepalived01"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"keepalived-slave"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"10.0.0.11"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"keepalived02"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"web01"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"10.0.0.51"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"nginx01"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"web02"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"10.0.0.52"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"nginx02"})})]})]})]}),"\n",(0,l.jsx)(n.h3,{id:"21-\u8d1f\u8f7d\u5747\u8861\u7aef\u914d\u7f6e",children:"2.1 \u8d1f\u8f7d\u5747\u8861\u7aef\u914d\u7f6e"}),"\n",(0,l.jsx)(n.h4,{id:"211-\u5b89\u88c5keepalived",children:"2.1.1 \u5b89\u88c5keepalived"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"yum -y install keepalived\n"})}),"\n",(0,l.jsxs)(n.p,{children:["centos7.7\u4e2d\u9ed8\u8ba4\u7684keepalive\u7248\u672c\u662f1.3.5\uff0c\u5982\u679c\u9700\u8981\u9ad8\u7248\u672c\u8bf7\u5230",(0,l.jsx)(n.a,{href:"https://github.com/acassen/keepalived",children:"keepalived github\u5730\u5740"}),"\u6216\u8005",(0,l.jsx)(n.a,{href:"https://www.keepalived.org/",children:"keepalived\u5b98\u7f51"}),"\u4e0b\u8f7d\uff0c\u8fd9\u91cc\u4ec5\u505a\u5b9e\u9a8c\u76f4\u63a5yum\u5b89\u88c5"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"$ keepalived -version\nKeepalived v1.3.5 (03/19,2017), git commit v1.3.5-6-g6fa32f2\n"})}),"\n",(0,l.jsx)(n.h4,{id:"212-lb01keepalived-master\u7f16\u8f91\u914d\u7f6e\u6587\u4ef6",children:"2.1.2 lb01(keepalived master)\u7f16\u8f91\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsxs)(n.strong,{children:["lb01\u7f16\u8f91keepalived\u914d\u7f6e\u6587\u4ef6",(0,l.jsx)(n.code,{children:"/etc/keepalived/keepalived.conf"})]})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"#\u5907\u4efd\u539f\u6709\u6587\u4ef6\nmv /etc/keepalived/keepalived.conf{,.bak}\n\n#\u91cd\u65b0\u7f16\u8f91\u6587\u4ef6\ncat > /etc/keepalived/keepalived.conf <<EOF\nglobal_defs {     \n    router_id lb01\n}\n      \nvrrp_instance VI_1 {\n    state MASTER\t\t\t        \n    interface eth0\t\t\t    \n    virtual_router_id 50\t\t   \n    priority 150\t\t\t\t\n    advert_int 1\t\t\t\t \n    authentication {\t\t\t\n        auth_type PASS\n        auth_pass 123456\n}\n    virtual_ipaddress {\n        10.0.0.100\t\t\n    }\n}\nEOF\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u914d\u7f6e\u6587\u4ef6\u53c2\u6570\u542b\u4e49"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"#\u914d\u7f6e\u542b\u4e49\nglobal_defs {     \n    router_id lb01   \t\t\t#\u8868\u793aid\u8eab\u4efd\uff0c\u540d\u79f0\u968f\u610f\n}\n      \nvrrp_instance VI_1 {\n    state MASTER\t\t\t    #\u72b6\u6001\uff0c\u89d2\u8272\u4e3amaster\n    interface eth0\t\t\t    #VIP\u7ed1\u5b9a\u7684\u7f51\u5361\n    virtual_router_id 50\t\t#\u4e3b\u548c\u5907\u7684\u865a\u62dfid\u53f7\u8981\u76f8\u540c\uff0c\u8868\u660e\u5728\u4e00\u4e2a\u7ec4\u5f53\u4e2d\uff0c\u540d\u79f0\u968f\u610f\uff0c\u4e0d\u8981\u8d85\u8fc7255\n    priority 150\t\t\t\t#\u4f18\u5148\u7ea7\uff0c\u8d8a\u5927\u4f18\u5148\u7ea7\u8d8a\u9ad8\n    advert_int 1\t\t\t\t#\u5fc3\u8df3\u68c0\u6d4b\uff0c\u5355\u4f4d\u79d2\uff0c\u5907\u673a\u6bcf\u96941\u79d2\u68c0\u6d4b\u4e00\u6b21\u4e3b\u7684\u5b58\u6d3b\u72b6\u6001 \n    authentication {\t\t\t#\u8ba4\u8bc1\u4fe1\u606f\n        auth_type PASS\n        auth_pass 123456\n}\n    virtual_ipaddress {\n        10.0.0.100\t\t\t\t#\u865a\u62dfIP\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h4,{id:"213-lb02keepalived-backup\u7f16\u8f91\u914d\u7f6e\u6587\u4ef6",children:"2.1.3 lb02(keepalived backup)\u7f16\u8f91\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"#\u5907\u4efd\u539f\u6709\u6587\u4ef6\nmv /etc/keepalived/keepalived.conf{,.bak}\n\n#\u91cd\u65b0\u7f16\u8f91\u6587\u4ef6\ncat > /etc/keepalived/keepalived.conf <<EOF\nglobal_defs {     \n    router_id lb02\n}\n      \nvrrp_instance VI_1 {\n    state BACKUP\t\t\t\n    interface eth0\t\t\t\n    virtual_router_id 50\t\t                                                 \n    priority 100\t\t\t\t\n    advert_int 1\t\t\t\t\n    authentication {\t\t\t\n        auth_type PASS\n        auth_pass 123456\n}\n    virtual_ipaddress {\n        10.0.0.100\n    }\n}\nEOF\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u914d\u7f6e\u6587\u4ef6\u53c2\u6570\u542b\u4e49"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"global_defs {     \n    router_id lb02  \t\t\t#\u8868\u793aid\u8eab\u4efd\uff0c\u540d\u79f0\u968f\u610f\n}\n      \nvrrp_instance VI_1 {\n    state BACKUP\t\t\t    #\u72b6\u6001\uff0c\u56e0\u4e3a\u662fslave\uff0c\u6240\u4ee5\u662fBACKUP\n    interface eth0\t\t\t    #VIP\u7ed1\u5b9a\u7684\u7f51\u5361\n    virtual_router_id 50\t\t#\u4e3b\u548c\u5907\u7684\u865a\u62dfid\u53f7\u8981\u76f8\u540c\uff0c\u8868\u660e\u5728\u4e00\u4e2a\u7ec4\u5f53\u4e2d\uff0c\u540d\u79f0\u968f\u610f\uff0c\u4e0d\u8981                                                     \u8d85\u8fc7255\n    priority 100\t\t\t\t#\u4f18\u5148\u7ea7\uff0c\u8d8a\u5927\u4f18\u5148\u7ea7\u8d8a\u9ad8\n    advert_int 1\t\t\t\t#\u5fc3\u8df3\u68c0\u6d4b\uff0c\u5355\u4f4d\u79d2\uff0c\u5907\u673a\u6bcf\u96941\u79d2\u68c0\u6d4b\u4e00\u6b21\u4e3b\u7684\u5b58\u6d3b\u72b6\u6001 \n    authentication {\t\t\t#\u8ba4\u8bc1\u4fe1\u606f\n        auth_type PASS\n        auth_pass 123456\n}\n    virtual_ipaddress {\n        10.0.0.100\t\t\t\t#\u865a\u62dfIP\n    }\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u5bf9\u6bd4keepalived\u7684master\u4e0ebackup\u914d\u7f6e\u7684\u533a\u522b"})}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:(0,l.jsx)(n.strong,{children:"Keepalived\u914d\u7f6e\u533a\u522b"})}),(0,l.jsx)(n.th,{children:(0,l.jsx)(n.strong,{children:"Master\u914d\u7f6e"})}),(0,l.jsx)(n.th,{children:(0,l.jsx)(n.strong,{children:"Backup\u8282\u914d\u7f6e"})})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"route_id(\u552f\u4e00\u6807\u8bc6)"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"route_id lb01"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"route_id lb02"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"state(\u89d2\u8272\u72b6\u6001)"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"state Master"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"state Backup"})})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"priority(\u7ade\u9009\u4f18\u5148\u7ea7)"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"priority 150"})}),(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"priority 100"})})]})]})]}),"\n",(0,l.jsx)(n.h4,{id:"214-\u542f\u52a8keepalived",children:"2.1.4 \u542f\u52a8keepalived"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"lb01\u548clb02\u76f8\u540c\u64cd\u4f5c"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"systemctl start keepalived && systemctl enable keepalived\n"})}),"\n",(0,l.jsx)(n.h4,{id:"215-\u68c0\u6d4blb01\u662f\u5426\u6709vip",children:"2.1.5 \u68c0\u6d4blb01\u662f\u5426\u6709vip"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u53ef\u4ee5\u770b\u5230\uff0c\u542f\u52a8keepalived\u540e\uff0clb01 eth0\u7f51\u5361\u5c31\u6709\u4e86VIP 10.0.0.100"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"$ ip a s eth0\n2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:1c:42:f3:3c:78 brd ff:ff:ff:ff:ff:ff\n    inet 10.0.0.10/24 brd 10.0.0.255 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet 10.0.0.100/32 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::21c:42ff:fef3:3c78/64 scope link\n       valid_lft forever preferred_lft forever\n"})}),"\n",(0,l.jsx)(n.h4,{id:"216-\u9a8c\u8bc1vip\u662f\u5426\u80fd\u591f\u6b63\u5e38\u6f02\u79fb",children:"2.1.6 \u9a8c\u8bc1VIP\u662f\u5426\u80fd\u591f\u6b63\u5e38\u6f02\u79fb"}),"\n",(0,l.jsx)(n.admonition,{type:"tip",children:(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"VIP\u9996\u5148\u5728master\u4e0a\uff0c\u5f53master\u5b95\u673a\u540e\uff0cVIP\u4f1a\u6f02\u79fb\u81f3backup\uff0c\u5f53master\u6062\u590d\u65f6VIP\u4f1a\u81ea\u52a8\u6f02\u79fb\u56de\u6765\uff01\uff01\uff01"})})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u5148\u505c\u6b62lb01\u4e0a\u7684keepalived"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"systemctl stop keepalived\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u67e5\u770blb01\u4e0a\u662f\u5426\u6709VIP"})}),"\n",(0,l.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5230\uff0cVIP\u6b64\u65f6\u5df2\u7ecf\u6ca1\u6709\u4e86"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"$ ip a s eth0\n2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:1c:42:f3:3c:78 brd ff:ff:ff:ff:ff:ff\n    inet 10.0.0.10/24 brd 10.0.0.255 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::21c:42ff:fef3:3c78/64 scope link\n       valid_lft forever preferred_lft forever\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u67e5\u770blb02\u4e0a\u662f\u5426\u6709VIP"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u5f53keepalived master\u5b95\u673a\u540e\uff0cVIP\u5c31\u4f1a\u6f02\u79fb\u5230lb02"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"$ ip a s eth0\n2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:1c:42:c1:0b:16 brd ff:ff:ff:ff:ff:ff\n    inet 10.0.0.11/24 brd 10.0.0.255 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet 10.0.0.100/32 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::21c:42ff:fec1:b16/64 scope link\n       valid_lft forever preferred_lft forever\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u91cd\u65b0\u542f\u52a8lb01\u4e0a\u7684keepalived"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"systemctl start keepalived\n\n#\u67e5\u770bVIP\n$ ip a s eth0\n2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:1c:42:f3:3c:78 brd ff:ff:ff:ff:ff:ff\n    inet 10.0.0.10/24 brd 10.0.0.255 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet 10.0.0.100/32 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::21c:42ff:fef3:3c78/64 scope link\n       valid_lft forever preferred_lft forever\n"})}),"\n",(0,l.jsx)(n.h4,{id:"217-\u7f16\u8f91nginx\u914d\u7f6e\u6587\u4ef6",children:"2.1.7 \u7f16\u8f91nginx\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"lb01\u548clb02\u7f16\u8f91nginx\u914d\u7f6e\u6587\u4ef6"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-nginx",children:"cat > /etc/nginx/conf.d/kd.test.conf <<'EOF'\nupstream kd {\n  server 10.0.0.51;\n  server 10.0.0.52;\n}\n\nserver {\n  listen 80;\n  server_name _;\n\n  location / {\n    proxy_pass http://kd;\n  }\n}\nEOF\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u68c0\u6d4bnginx\u8bed\u6cd5\u5e76\u91cd\u8f7dnginx"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"$ nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n\n$ nginx -s reload\n"})}),"\n",(0,l.jsx)(n.h3,{id:"22-\u540e\u7aef\u771f\u5b9e\u670d\u52a1web\u914d\u7f6e",children:"2.2 \u540e\u7aef\u771f\u5b9e\u670d\u52a1web\u914d\u7f6e"}),"\n",(0,l.jsx)("h3",{style:{color:"red"},children:"web01\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.h4,{id:"221-\u7f16\u8f91nginx\u914d\u7f6e\u6587\u4ef6",children:"2.2.1 \u7f16\u8f91nginx\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-nginx",children:"cat >> /etc/nginx/conf.d/kd.test.conf <<EOF\nserver {\n listen 80;\n server_name _;\n root /code;\n index index.html;\n}\nEOF\n"})}),"\n",(0,l.jsx)(n.h4,{id:"222-\u521b\u5efa\u7f51\u7ad9\u6839\u76ee\u5f55",children:"2.2.2 \u521b\u5efa\u7f51\u7ad9\u6839\u76ee\u5f55"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:'mkdir /code && echo "web01 web01 web01" > /code/index.html\n'})}),"\n",(0,l.jsx)(n.h4,{id:"223-\u68c0\u6d4bnginx\u8bed\u6cd5\u5e76\u91cd\u8f7dnginx",children:"2.2.3 \u68c0\u6d4bnginx\u8bed\u6cd5\u5e76\u91cd\u8f7dnginx"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"$ nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n\n$ nginx -s reload\n"})}),"\n",(0,l.jsx)("h3",{style:{color:"red"},children:"web02\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.h4,{id:"224-\u7f16\u8f91nginx\u914d\u7f6e\u6587\u4ef6",children:"2.2.4 \u7f16\u8f91nginx\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-nginx",children:"cat >> /etc/nginx/conf.d/kd.test.conf <<EOF \nserver {\n\tlisten 80;\n\tserver_name _;\n\troot /code;\n\tindex index.html;\n}\nEOF\n"})}),"\n",(0,l.jsx)(n.h4,{id:"225-\u521b\u5efa\u7f51\u7ad9\u6839\u76ee\u5f55",children:"2.2.5 \u521b\u5efa\u7f51\u7ad9\u6839\u76ee\u5f55"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:'mkdir /code && echo "web02 web02 web02" > /code/index.html\n'})}),"\n",(0,l.jsx)(n.h4,{id:"226-\u68c0\u6d4bnginx\u8bed\u6cd5\u5e76\u91cd\u8f7dnginx",children:"2.2.6 \u68c0\u6d4bnginx\u8bed\u6cd5\u5e76\u91cd\u8f7dnginx"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"$ nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n\n$ nginx -s reload\n"})}),"\n",(0,l.jsx)(n.h3,{id:"23-\u6d4f\u89c8\u5668\u9a8c\u8bc1\u8d1f\u8f7d\u5747\u8861\u662f\u5426\u6b63\u5e38\u5de5\u4f5c",children:"2.3 \u6d4f\u89c8\u5668\u9a8c\u8bc1\u8d1f\u8f7d\u5747\u8861\u662f\u5426\u6b63\u5e38\u5de5\u4f5c"}),"\n",(0,l.jsx)(n.p,{children:"\u6d4f\u89c8\u5668\u8bbf\u95eeVIP 10.0.0.100"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/kd.gif",alt:"kd"})}),"\n",(0,l.jsx)(n.h2,{id:"3nginx\u5b95\u673a\u95ee\u9898",children:"3.nginx\u5b95\u673a\u95ee\u9898"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u5982\u679cNginx\u5b95\u673a\uff0c\u4f1a\u5bfc\u81f4\u7528\u6237\u8bf7\u6c42\u5931\u8d25\uff0c \u4f46Keepalived\u5e76\u4e0d\u4f1a\u8fdb\u884c\u5207\u6362\uff0c\u6240\u4ee5\u7f16\u5199nginx\u68c0\u6d4b\u811a\u672c\uff0c\u68c0\u6d4bnginx\u5b58\u6d3b\u72b6\u6001\uff0c\u4e0d\u5b58\u6d3b\u5219kill\u6389nginx\u548ckeepalived\uff0c\u7136\u540eVIP\u8fdb\u884c\u6f02\u79fb"})}),"\n",(0,l.jsx)(n.h3,{id:"31-\u7f16\u8f91\u811a\u672c",children:"3.1 \u7f16\u8f91\u811a\u672c"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"lb01\u64cd\u4f5c"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"#\u521b\u5efa\u5b58\u653e\u811a\u672c\u7684\u76ee\u5f55\nmkdir -p /server/scripts\n\n#\u7f16\u8f91\u811a\u672c\u5185\u5bb9\ncat >> /server/scripts/check_web.sh <<\\EOF\n#!/bin/sh\n#\u4f7f\u7528while\u6b7b\u5faa\u73af\nwhile true;do\nnginxpid=$(ps -C nginx --no-header|wc -l)\n#\u5224\u65adNginx\u662f\u5426\u5b58\u6d3b,\u5982\u679c\u4e0d\u5b58\u6d3b\u5219\u5c1d\u8bd5\u542f\u52a8Nginx\nif [ $nginxpid -eq 0 ];then\n    systemctl start nginx\n    sleep 5\n    #5\u79d2\u540e\u518d\u6b21\u83b7\u53d6\u4e00\u6b21Nginx\u72b6\u6001\n    nginxpid=$(ps -C nginx --no-header|wc -l) \n    #\u518d\u6b21\u8fdb\u884c\u5224\u65ad, \u5982Nginx\u8fd8\u4e0d\u5b58\u6d3b\u5219\u505c\u6b62Keepalived,\u8ba9\u5730\u5740\u8fdb\u884c\u6f02\u79fb,\u5e76\u9000\u51fa\u811a\u672c  \n    if [ $nginxpid -eq 0 ];then\n        systemctl stop keepalived\n        exit 1\n   fi\nfi\n     sleep 5\ndone\nEOF\n\n#\u7ed9\u811a\u672c\u8d4b\u4e88\u6267\u884c\u6743\u9650\nchmod +x /server/scripts/check_web.sh\n\n#\u540e\u53f0\u8fd0\u884c\u811a\u672c\nnohup sh /server/scripts/check_web.sh &\n"})}),"\n",(0,l.jsx)(n.h3,{id:"32-\u9a8c\u8bc1\u811a\u672c\u662f\u5426\u751f\u6548",children:"3.2 \u9a8c\u8bc1\u811a\u672c\u662f\u5426\u751f\u6548"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u6545\u610f\u628anginx\u914d\u7f6e\u6587\u4ef6\u4fee\u6539\u9519\u8bef(\u6bd4\u5982\u5220\u9664\u4e00\u4e2a\u62ec\u53f7\u6216\u8005\u5206\u53f7)\uff0c\u7136\u540e\u505c\u6b62lb01\u4e0a\u7684nginx\uff0c\u56e0\u4e3a\u4e0a\u8fb9\u7684\u811a\u672c\u4e2d\u4f1a\u5224\u65adnginx\u5982\u679c\u4e0d\u5b58\u6d3b\u5c31\u542f\u52a8nginx\uff0c\u628anginx\u914d\u7f6e\u6587\u4ef6\u6539\u9519\u4e86nginx\u5c31\u65e0\u6cd5\u6b63\u5e38\u542f\u52a8\u8fc7\u4e86"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"systemctl stop nginx\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u540e\u53f0\u811a\u672c\u68c0\u6d4b\u5230nginx\u4e0d\u5b58\u6d3b\u4f1akill\u6389keepalived\uff0c\u6b64\u65f6\u6d4f\u89c8\u5668\u8bbf\u95ee\u4f1a\u62a5\u9519\uff0c\u9694\u51e0\u79d2\u5c31\u6062\u590d\u4e86\uff0c\u56e0\u4e3aVIP\u5df2\u7ecf\u6f02\u79fb\u81f3lb02\u4e0a"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/kdnginx.gif",alt:"kdnginx"})}),"\n",(0,l.jsx)(n.h3,{id:"33-\u5728keepalived\u4e2d\u8c03\u7528\u68c0\u6d4b\u811a\u672c",children:"3.3 \u5728keepalived\u4e2d\u8c03\u7528\u68c0\u6d4b\u811a\u672c"}),"\n",(0,l.jsx)(n.admonition,{type:"tip",children:(0,l.jsx)(n.p,{children:(0,l.jsxs)(n.strong,{children:[(0,l.jsx)(n.code,{children:"nohup sh /server/scripts/check_web.sh &"})," \u6267\u884c\u811a\u672c\u5c5e\u4e8e\u624b\u52a8\u6267\u884c\uff0c\u8fd8\u53ef\u4ee5\u5728keepalived\u914d\u7f6e\u6587\u4ef6\u4e2d\u914d\u7f6e\u8c03\u7528\u76d1\u63a7\u811a\u672c"]})})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"lb01\u3001lb02\u90fd\u9700\u8981\u64cd\u4f5c"})}),"\n",(0,l.jsxs)(n.p,{children:["\u7f16\u8f91keepalived\u914d\u7f6e\u6587\u4ef6",(0,l.jsx)(n.code,{children:"/etc/keepalived/keepalived.conf"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:'#\u5728global_defs\u6807\u7b7e\u4e0b\u589e\u52a0\u5982\u4e0b\u5185\u5bb9\nvrrp_script check_web {\n    script "/server/scripts/check_web.sh"\n    interval 10\n    weight 50\n}\n\n#track_script\u6807\u7b7e\u8981\u5199\u5728vrrp_instance VI_1{}\u4e2d\ntrack_script {\n    check_web\n}\n'})}),"\n",(0,l.jsx)(n.admonition,{type:"caution",children:(0,l.jsx)(n.p,{children:(0,l.jsxs)(n.strong,{children:["vrrp_script","\u4e2d\u7684interval\u65f6\u95f4\u9700\u5927\u4e8e\u811a\u672c\u4e2d\u7684sleep\u65f6\u95f4"]})})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsxs)(n.strong,{children:["\u5426\u5219\u4f1a\u62a5\u9519",(0,l.jsx)(n.code,{children:"Keepalived_vrrp[2612]: /server/scripts/check_web.sh exited due to signal 15"})]})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsxs)(n.strong,{children:["\u8fd9\u6837\u5c31\u80fd\u591f\u4f7fkeepalived\u81ea\u52a8\u8c03\u7528\u76d1\u63a7\u811a\u672c\u4e86\uff0ckeepalived\u4f1a\u6839\u636e\u914d\u7f6e\u6587\u4ef6\u4e2d",(0,l.jsx)(n.code,{children:"vrrp_script {}\u4e2d\u7684interval\u53c2\u6570\u6765\u51b3\u5b9a\u6bcf\u9694\u51e0\u79d2\u6267\u884c\u811a\u672c\uff0cinterval\u540e\u9762\u7684\u6570\u5b57\u5c31\u8868\u660e\u6267\u884c\u811a\u672c\u7684\u95f4\u9694\u65f6\u95f4"})]})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u5728\u811a\u672c\u4e2d\u6211\u4eec\u5b9a\u4e49\u4e86\uff0ckeepalived master\u4e0a\u68c0\u6d4bnginx\u662f\u5426\u5b58\u6d3b\uff0c\u4e0d\u5b58\u6d3b\u5c1d\u8bd5\u542f\u52a8nginx\uff0c\u5f53\u65e0\u6cd5\u6210\u529f\u542f\u52a8nginx\u7684\u65f6\u5019\u505c\u6b62master\u4e0a\u7684keepalived\uff0c\u7136\u540e\u8ba9VIP\u6f02\u79fb\uff0c\u8fd9\u6837\u7684\u8bdd\u5c31\u5b9e\u73b0\u4e86\u5f53nginx\u670d\u52a1\u6302\u6389\u65f6keepalived VIP\u80fd\u591f\u6f02\u79fb\u4ece\u800c\u4e0d\u5f71\u54cd\u5ba2\u6237\u7aef\u8bbf\u95ee"})}),"\n",(0,l.jsx)(n.h2,{id:"4keepalived\u9ad8\u53ef\u7528\u8111\u88c2",children:"4.keepalived\u9ad8\u53ef\u7528\u8111\u88c2"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u6982\u5ff5"})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u8111\u88c2\u5c31\u662f\u7531\u4e8e\u67d0\u4e9b\u539f\u56e0\uff0c\u5bfc\u81f4\u4e24\u53f0keepalived\u9ad8\u53ef\u7528\u670d\u52a1\u5668\u5728\u6307\u5b9a\u65f6\u95f4\u5185\uff0c\u65e0\u6cd5\u68c0\u6d4b\u5230\u5bf9\u65b9\u7684\u5fc3\u8df3\u6d88\u606f\uff0c\u5404\u81ea\u53d6\u5f97\u8d44\u6e90\u53ca\u670d\u52a1\u7684\u6240\u6709\u6743\uff0c\u800c\u6b64\u65f6\u7684\u4e24\u53f0\u9ad8\u53ef\u7528\u670d\u52a1\u5668\u53c8\u90fd\u8fd8\u6d3b\u7740\uff0c\u4ea7\u751f\u88c2\u8111\u7684\u60c5\u51b5\u4e0b\uff0cmaster\u548cbackup\u4e0a\u90fd\u4f1a\u6709VIP"})}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u4ea7\u751f\u8111\u88c2\u7684\u539f\u56e0"})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"1.\u670d\u52a1\u5668\u7f51\u7edc\u6545\u969c"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"2.\u670d\u52a1\u5668\u786c\u4ef6\u6545\u969c\u53d1\u751f\u635f\u574f\u73b0\u8c61\u800c\u5d29\u6e83"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"3.\u4e3b\u5907\u90fd\u5f00\u542ffirewalld\u9632\u706b\u5899"})}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"41-\u6a21\u62df\u8111\u88c2",children:"4.1 \u6a21\u62df\u8111\u88c2"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"lb01\u548clb02\u5f00\u542ffirewalld\u9632\u706b\u5899"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"systemctl start firewalld\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u5f00\u542f\u9632\u706b\u5899\u540e\u4ea7\u751f\u88c2\u8111\u539f\u56e0"})}),"\n",(0,l.jsx)(n.admonition,{type:"info",children:(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"lb01\u548clb02\u90fd\u5f00\u542f\u9632\u706b\u5899\u540e\uff0c\u56e0\u4e3a\u6ca1\u6709\u5141\u8bb8vrrp\uff0c\u5f53backup\u53bb\u68c0\u6d4bmaster\u7684\u65f6\u5019\u65e0\u6cd5\u68c0\u6d4b\u5230\uff0c\u6b64\u65f6backup\u8ba4\u4e3amaster\u5df2\u7ecf\u5b95\u673a\uff0c\u6240\u4ee5\u5c06VIP\u62a2\u5360\uff1b\u800cmaster\u5b9e\u9645\u4e0a\u5e76\u6ca1\u6709\u5b95\u673a\uff0c\u6240\u4ee5VIP\u4e0d\u4f1a\u6f02\u79fb\uff0c\u8fd9\u6837\u5c31\u9020\u6210\u4e86master\u548cbackup\u90fd\u5728\u62a2\u5360VIP\u3002\u6b64\u65f6\u5c31\u51fa\u73b0\u4e86\u88c2\u8111\u7684\u60c5\u51b5"})})}),"\n",(0,l.jsx)(n.h3,{id:"42-\u6d4b\u8bd5\u8111\u88c2\u95ee\u9898",children:"4.2 \u6d4b\u8bd5\u8111\u88c2\u95ee\u9898"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u5728keepalived\u5907\u4e0a\u7f16\u5199\u68c0\u6d4b\u811a\u672c, \u6d4b\u8bd5\u5982\u679c\u80fdping\u901a\u4e3bkeepalived\u5e76\u4e14\u5907\u8282\u70b9\u8fd8\u6709VIP\u7684\u8bdd\u5219\u8ba4\u4e3a\u4ea7\u751f\u4e86\u8111\u88c2"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"lb02\u64cd\u4f5c"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'#\u521b\u5efa\u5b58\u653e\u811a\u672c\u7684\u76ee\u5f55\nmkdir -p /server/scripts\n\n#\u7f16\u8f91\u811a\u672c\u5185\u5bb9\ncat >/server/scripts/check_split_brain.sh <<\'EOF\'\n#!/bin/sh\nlb01_vip=10.0.0.10\nlb01_ip=10.0.0.11\nwhile true;do\n    ping -c 2 -W 3 $lb01_ip &>/dev/null\n    if [ $? -eq 0 -a `ip add|grep "$lb01_vip"|wc -l` -eq 1 ];then\n        echo "keepalived\u51fa\u73b0\u4e86\u8111\u88c2\uff01\uff01\uff01"\n    else\n        echo "keepalived\u5b8c\u5168objk"\n    fi\nsleep 5\ndone\nEOF\n'})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u8fd0\u884c\u811a\u672c\uff0c\u56e0\u4e3a\u6b64\u65f6\u662f\u8111\u88c2\u7684\uff0ckeepalived\u4e3b\u5907\u4e0a\u90fd\u6709VIP\uff0c\u56e0\u4e3a\u524d\u671f\u4f1a\u62a5\u51fa\u73b0\u8111\u88c2\uff0c\u5f53\u628a\u4e3b\u5907\u4e0a\u7684firewalld\u5173\u6389\u65f6\u5c31\u6ca1\u6709\u95ee\u9898\u4e86"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"#\u811a\u672c\u4f1a\u4e00\u76f4\u8fd0\u884c\uff0cctrl+c\u505c\u6b62\n$ sh /server/scripts/check_split_brain.sh\nkeepalived\u51fa\u73b0\u4e86\u8111\u88c2\uff01\uff01\uff01\nkeepalived\u51fa\u73b0\u4e86\u8111\u88c2\uff01\uff01\uff01\nkeepalived\u51fa\u73b0\u4e86\u8111\u88c2\uff01\uff01\uff01\nkeepalived\u51fa\u73b0\u4e86\u8111\u88c2\uff01\uff01\uff01\nkeepalived\u51fa\u73b0\u4e86\u8111\u88c2\uff01\uff01\uff01\nkeepalived\u51fa\u73b0\u4e86\u8111\u88c2\uff01\uff01\uff01\nkeepalived\u51fa\u73b0\u4e86\u8111\u88c2\uff01\uff01\uff01\nkeepalived\u5b8c\u5168objk\nkeepalived\u5b8c\u5168objk\n"})}),"\n",(0,l.jsx)(n.h2,{id:"5\u6e90\u7801\u5b89\u88c5keepalived",children:"5.\u6e90\u7801\u5b89\u88c5keepalived"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"https://www.keepalived.org/download.html",children:"keepalived\u6e90\u7801\u5305\u5b98\u65b9\u4e0b\u8f7d\u5730\u5740"})}),"\n",(0,l.jsx)(n.h3,{id:"51-\u4e0b\u8f7d\u5305",children:"5.1 \u4e0b\u8f7d\u5305"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"wget https://www.keepalived.org/software/keepalived-2.1.2.tar.gz\n"})}),"\n",(0,l.jsx)(n.h3,{id:"52-\u7f16\u8bd1\u5b89\u88c5",children:"5.2 \u7f16\u8bd1\u5b89\u88c5"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u5b89\u88c5\u4f9d\u8d56\u5305"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"yum -y install openssl openssl-devel libnl3-devel pcre-devel\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u89e3\u538b\u7f29\u5305"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"tar xf keepalived-2.1.2.tar.gz && cd keepalived-2.1.2\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u7f16\u8bd1\u5b89\u88c5"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"./configure --prefix=/usr/local/keepalived\nmake && make install\n"})}),"\n",(0,l.jsx)(n.h3,{id:"53-\u914d\u7f6ekeepalived",children:"5.3 \u914d\u7f6ekeepalived"}),"\n",(0,l.jsx)(n.h4,{id:"531-\u8f6f\u8fde\u63a5keepalived\u547d\u4ee4",children:"5.3.1 \u8f6f\u8fde\u63a5keepalived\u547d\u4ee4"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"ln -s /usr/local/keepalived/sbin/keepalived /usr/sbin\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u9a8c\u8bc1"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"$ keepalived -v\nKeepalived v2.1.2 (06/14,2020)\n\nCopyright(C) 2001-2020 Alexandre Cassen, <acassen@gmail.com>\n\nBuilt with kernel headers for Linux 3.10.0\nRunning on Linux 3.10.0-1127.el7.x86_64 #1 SMP Tue Mar 31 23:36:51 UTC 2020\n\nconfigure options: --prefix=/etc/keepalived --sysconfdir=/etc/keepalived\n\nConfig options:  LVS VRRP VRRP_AUTH OLD_CHKSUM_COMPAT FIB_ROUTING\n\nSystem options:  PIPE2 SIGNALFD INOTIFY_INIT1 VSYSLOG EPOLL_CREATE1 IPV6_ADVANCED_API RTA_ENCAP RTA_EXPIRES RTA_PREF FRA_SUPPRESS_PREFIXLEN FRA_TUN_ID RTAX_CC_ALGO RTAX_QUICKACK RTA_VIA FRA_OIFNAME IFA_FLAGS IP_MULTICAST_ALL NET_LINUX_IF_H_COLLISION LIBIPTC_LINUX_NET_IF_H_COLLISION VRRP_VMAC IFLA_LINK_NETNSID CN_PROC SOCK_NONBLOCK SOCK_CLOEXEC O_PATH GLOB_BRACE INET6_ADDR_GEN_MODE SO_MARK SCHED_RESET_ON_FORK\n"})}),"\n",(0,l.jsx)(n.h4,{id:"532-keepalivedservice\u6587\u4ef6",children:"5.3.2 keepalived.service\u6587\u4ef6"}),"\n",(0,l.jsx)(n.admonition,{type:"info",children:(0,l.jsx)(n.p,{children:(0,l.jsxs)(n.strong,{children:["keepalived\u7f16\u8bd1\u5b89\u88c5\u5b8c\u6210\u540e\u4f1a\u81ea\u52a8\u751f\u6210\u6587\u4ef6",(0,l.jsx)(n.code,{children:"/usr/lib/systemd/system/keepalived.service"})]})})}),"\n",(0,l.jsx)(n.h4,{id:"533-\u62f7\u8d1d\u5b89\u88c5\u76ee\u5f55\u4e0bkeepalived\u914d\u7f6e\u6587\u4ef6",children:"5.3.3 \u62f7\u8d1d\u5b89\u88c5\u76ee\u5f55\u4e0bkeepalived\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsxs)(n.strong,{children:["\u5426\u5219\u4f1a\u62a5\u9519",(0,l.jsx)(n.code,{children:"Unable to find configuration file /etc/keepalived/keepalived.conf (glob returned 3)"})]})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"mkdir /etc/keepalived\ncp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/\n"})}),"\n",(0,l.jsx)(n.h4,{id:"534-\u62f7\u8d1d\u542f\u52a8\u6587\u4ef6\u53ef\u9009",children:"5.3.4 \u62f7\u8d1d\u542f\u52a8\u6587\u4ef6(\u53ef\u9009)"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"cp /root/keepalived-2.1.2/keepalived/etc/init.d/keepalived /etc/init.d\n"})}),"\n",(0,l.jsx)(n.h4,{id:"535-\u542f\u52a8keepalived\u5e76\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f",children:"5.3.5 \u542f\u52a8keepalived\u5e76\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"systemctl daemon-reload && systemctl enable keepalived && systemctl start keepalived\n"})})]})}function x(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(h,{...e})}):h(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>d,x:()=>t});var l=i(96540);const r={},s=l.createContext(r);function d(e){const n=l.useContext(s);return l.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),l.createElement(s.Provider,{value:n},e.children)}}}]);