"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[6227],{1636:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>o,contentTitle:()=>t,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});var r=s(74848),l=s(28453);const a={},t="MHA\u57fa\u4e8eGTID\u4e3b\u4ece\u590d\u5236\u9ad8\u53ef\u7528",i={id:"\u6570\u636e\u5e93/mysql/mysql\u8fdb\u9636/MHA\u57fa\u4e8eGTID\u4e3b\u4ece\u590d\u5236\u9ad8\u53ef\u7528",title:"MHA\u57fa\u4e8eGTID\u4e3b\u4ece\u590d\u5236\u9ad8\u53ef\u7528",description:"[toc]",source:"@site/docs/\u6570\u636e\u5e93/mysql/mysql\u8fdb\u9636/MHA\u57fa\u4e8eGTID\u4e3b\u4ece\u590d\u5236\u9ad8\u53ef\u7528.md",sourceDirName:"\u6570\u636e\u5e93/mysql/mysql\u8fdb\u9636",slug:"/\u6570\u636e\u5e93/mysql/mysql\u8fdb\u9636/MHA\u57fa\u4e8eGTID\u4e3b\u4ece\u590d\u5236\u9ad8\u53ef\u7528",permalink:"/docs/\u6570\u636e\u5e93/mysql/mysql\u8fdb\u9636/MHA\u57fa\u4e8eGTID\u4e3b\u4ece\u590d\u5236\u9ad8\u53ef\u7528",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"mysql\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b",permalink:"/docs/\u6570\u636e\u5e93/mysql/mysql\u77e5\u8bc6\u70b9/mysql\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b"},next:{title:"MHA\u57fa\u4e8e\u666e\u901a\u4e3b\u4ece\u590d\u5236\u9ad8\u53ef\u7528",permalink:"/docs/\u6570\u636e\u5e93/mysql/mysql\u8fdb\u9636/MHA\u57fa\u4e8e\u666e\u901a\u4e3b\u4ece\u590d\u5236\u9ad8\u53ef\u7528"}},o={},c=[{value:"1.MHA\u7b80\u4ecb",id:"1mha\u7b80\u4ecb",level:2},{value:"2.MHA\u67b6\u6784",id:"2mha\u67b6\u6784",level:2},{value:"3.\u90e8\u7f72\u8fc7\u7a0b",id:"3\u90e8\u7f72\u8fc7\u7a0b",level:2},{value:"3.1 \u4e0b\u8f7d\u5b89\u88c5\u5305",id:"31-\u4e0b\u8f7d\u5b89\u88c5\u5305",level:3},{value:"3.2 \u6240\u6709\u673a\u5668\u505a\u76f8\u4e92\u514d\u5bc6\u94a5\u914d\u7f6e",id:"32-\u6240\u6709\u673a\u5668\u505a\u76f8\u4e92\u514d\u5bc6\u94a5\u914d\u7f6e",level:3},{value:"3.3 mysql\u4e3b\u4ece\u914d\u7f6e-GTID",id:"33-mysql\u4e3b\u4ece\u914d\u7f6e-gtid",level:3},{value:"3.3.1 \u7f16\u8f91 <code>/etc/my.cnf</code>",id:"331-\u7f16\u8f91-etcmycnf",level:4},{value:"3.3.2 \u521b\u5efa\u4e13\u7528\u590d\u5236\u7528\u6237\u548c\u8bbe\u7f6e\u76d1\u63a7\u7528\u6237",id:"332-\u521b\u5efa\u4e13\u7528\u590d\u5236\u7528\u6237\u548c\u8bbe\u7f6e\u76d1\u63a7\u7528\u6237",level:4},{value:"3.3.3 \u914d\u7f6e\u6587\u4ef6 <code>/etc/my.cnf</code>",id:"333-\u914d\u7f6e\u6587\u4ef6-etcmycnf",level:4},{value:"3.3.4 \u4ece\u5e93\u62c9\u53d6",id:"334-\u4ece\u5e93\u62c9\u53d6",level:4},{value:"3.3.5 \u9a8c\u8bc1\u4e3b\u4ece\u540c\u6b65",id:"335-\u9a8c\u8bc1\u4e3b\u4ece\u540c\u6b65",level:4},{value:"3.4 \u90e8\u7f72MHA node",id:"34-\u90e8\u7f72mha-node",level:3},{value:"3.5 \u90e8\u7f72MHA Manager",id:"35-\u90e8\u7f72mha-manager",level:3},{value:"3.5.1 \u589e\u52a0epel\u6e90",id:"351-\u589e\u52a0epel\u6e90",level:4},{value:"3.5.2 \u5b89\u88c5\u4f9d\u8d56\u5305",id:"352-\u5b89\u88c5\u4f9d\u8d56\u5305",level:4},{value:"3.5.3 \u5b89\u88c5manager",id:"353-\u5b89\u88c5manager",level:4},{value:"3.5.4 mysql\u4e3b\u5e93\u8282\u70b9\u914d\u7f6eeth0:0\u7f51\u5361\uff0c\u7528\u4f5cVIP\uff0c\u8fd9\u91cc\u8bbe\u7f6e\u4e3a10.0.0.200",id:"354-mysql\u4e3b\u5e93\u8282\u70b9\u914d\u7f6eeth00\u7f51\u5361\u7528\u4f5cvip\u8fd9\u91cc\u8bbe\u7f6e\u4e3a1000200",level:4},{value:"3.5.5 \u4f7f\u7528\u811a\u672c\u7ba1\u7406vip",id:"355-\u4f7f\u7528\u811a\u672c\u7ba1\u7406vip",level:4},{value:"3.5.6 \u914d\u7f6emha\u914d\u7f6e\u6587\u4ef6",id:"356-\u914d\u7f6emha\u914d\u7f6e\u6587\u4ef6",level:4},{value:"3.5.7 \u6d4b\u8bd5MHA Manager",id:"357-\u6d4b\u8bd5mha-manager",level:4},{value:"3.5.7.1 \u6d4b\u8bd5ssh\u8fde\u63a5",id:"3571-\u6d4b\u8bd5ssh\u8fde\u63a5",level:5},{value:"3.5.7.2 \u6d4b\u8bd5mysql\u96c6\u7fa4\u8fde\u63a5\u60c5\u51b5",id:"3572-\u6d4b\u8bd5mysql\u96c6\u7fa4\u8fde\u63a5\u60c5\u51b5",level:5},{value:"3.5.8 \u542f\u52a8mha",id:"358-\u542f\u52a8mha",level:4},{value:"3.6 \u6d4b\u8bd5MHA",id:"36-\u6d4b\u8bd5mha",level:3},{value:"3.6.1 \u624b\u52a8\u5173\u95ed\u4e3b\u5e93\uff0c\u6a21\u62df\u5b95\u673a",id:"361-\u624b\u52a8\u5173\u95ed\u4e3b\u5e93\u6a21\u62df\u5b95\u673a",level:4},{value:"3.6.2 \u9a8c\u8bc1slave1\uff0c\u537310.0.0.134",id:"362-\u9a8c\u8bc1slave1\u53731000134",level:4},{value:"3.7 \u4fee\u590d\u5b95\u673a\u4e3b\u5e93\u6b65\u9aa4",id:"37-\u4fee\u590d\u5b95\u673a\u4e3b\u5e93\u6b65\u9aa4",level:3},{value:"\u7b2c\u4e00\u6b65\u3001\u4fee\u590d\u5b95\u673a\u4e3b\u5e93",id:"\u7b2c\u4e00\u6b65\u4fee\u590d\u5b95\u673a\u4e3b\u5e93",level:4},{value:"\u7b2c\u4e8c\u6b65\u3001\u4eceMHA\u914d\u7f6e\u6587\u4ef6<code>/etc/masterha/app1.conf</code>\u4e2d\u7684<code>[server default]</code>\u6807\u7b7e\u4e0b\u5b9a\u4e49\u7684<code>manager_log=/var/log/masterha/app1/manager.log</code>\u65e5\u5fd7\u6587\u4ef6\u4e2d\u627e\u5230<code>change master to</code>\u8bed\u53e5\uff0c\u4fee\u6539\u4ece\u5e93\u590d\u5236\u7528\u6237\u7684\u5bc6\u7801\uff0c\u5e76\u4e14\u6307\u5b9a\u4e3b\u5e93\u4e3a\u65b0\u4e3b\u5e93",id:"\u7b2c\u4e8c\u6b65\u4ecemha\u914d\u7f6e\u6587\u4ef6etcmasterhaapp1conf\u4e2d\u7684server-default\u6807\u7b7e\u4e0b\u5b9a\u4e49\u7684manager_logvarlogmasterhaapp1managerlog\u65e5\u5fd7\u6587\u4ef6\u4e2d\u627e\u5230change-master-to\u8bed\u53e5\u4fee\u6539\u4ece\u5e93\u590d\u5236\u7528\u6237\u7684\u5bc6\u7801\u5e76\u4e14\u6307\u5b9a\u4e3b\u5e93\u4e3a\u65b0\u4e3b\u5e93",level:4},{value:"\u7b2c\u4e09\u6b65\u3001\u8fde\u63a5\u65e7\u4e3b\u5e93\uff0c\u6267\u884c\u4e0a\u4e00\u6b65\u627e\u5230\u7684<code>change master to</code>\u8bed\u53e5\u5e76\u6253\u5f00IO\u3001SQL\u7ebf\u7a0b",id:"\u7b2c\u4e09\u6b65\u8fde\u63a5\u65e7\u4e3b\u5e93\u6267\u884c\u4e0a\u4e00\u6b65\u627e\u5230\u7684change-master-to\u8bed\u53e5\u5e76\u6253\u5f00iosql\u7ebf\u7a0b",level:4},{value:"\u7b2c\u56db\u6b65\u3001\u628a\u65e7\u4e3b\u5e93\u7684server\u6807\u7b7e\u5728MHA\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u56de\u6765\uff0cMHA\u6267\u884c\u5207\u6362\u540e\uff0c\u4f1a\u628adown\u673a\u7684\u4e3b\u673aserver\u6807\u7b7e\u5220\u9664",id:"\u7b2c\u56db\u6b65\u628a\u65e7\u4e3b\u5e93\u7684server\u6807\u7b7e\u5728mha\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u56de\u6765mha\u6267\u884c\u5207\u6362\u540e\u4f1a\u628adown\u673a\u7684\u4e3b\u673aserver\u6807\u7b7e\u5220\u9664",level:4},{value:"\u7b2c\u4e94\u6b65\u3001\u542f\u52a8MHA",id:"\u7b2c\u4e94\u6b65\u542f\u52a8mha",level:4},{value:"4.\u914d\u7f6ebinlog-server",id:"4\u914d\u7f6ebinlog-server",level:2},{value:"4.1 MHA\u914d\u7f6e\u6587\u4ef6<code>/etc/masterha/app1.cnf</code>\u52a0\u5165binlog-server\u914d\u7f6e",id:"41-mha\u914d\u7f6e\u6587\u4ef6etcmasterhaapp1cnf\u52a0\u5165binlog-server\u914d\u7f6e",level:3},{value:"4.2 \u624b\u52a8\u5907\u4efdbinlog",id:"42-\u624b\u52a8\u5907\u4efdbinlog",level:3},{value:"4.3 \u542f\u52a8MHA",id:"43-\u542f\u52a8mha",level:3},{value:"4.4 \u9a8c\u8bc1",id:"44-\u9a8c\u8bc1",level:3},{value:"5.MHA\u5e38\u7528\u547d\u4ee4\u603b\u7ed3",id:"5mha\u5e38\u7528\u547d\u4ee4\u603b\u7ed3",level:2}];function d(n){const e={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",hr:"hr",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.p,{children:"[toc]"}),"\n",(0,r.jsx)(e.h1,{id:"mha\u57fa\u4e8egtid\u4e3b\u4ece\u590d\u5236\u9ad8\u53ef\u7528",children:"MHA\u57fa\u4e8eGTID\u4e3b\u4ece\u590d\u5236\u9ad8\u53ef\u7528"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.a,{href:"https://github.com/yoshinorim/mha4mysql-manager",children:"MHA gIthub\u5730\u5740"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.a,{href:"https://github.com/yoshinorim/mha4mysql-manager/wiki",children:"MHA github wiki\u5730\u5740"})}),"\n",(0,r.jsx)(e.h2,{id:"1mha\u7b80\u4ecb",children:"1.MHA\u7b80\u4ecb"}),"\n",(0,r.jsx)(e.p,{children:"MHA\u901a\u5e38\u572810\u523030\u79d2\u5185\u4ee5\u6700\u5c11\u7684\u505c\u673a\u65f6\u95f4\u6267\u884c\u81ea\u52a8\u7684\u4e3b\u6545\u969c\u8f6c\u79fb\u548c\u4ece\u5347\u7ea7\u3002MHA\u53ef\u4ee5\u9632\u6b62\u590d\u5236\u4e00\u81f4\u6027\u95ee\u9898\uff0c\u5e76\u8282\u7701\u4e86\u5fc5\u987b\u8d2d\u4e70\u5176\u4ed6\u670d\u52a1\u5668\u7684\u8d39\u7528\u3002\u6240\u6709\u8fd9\u4e9b\u90fd\u5177\u6709\u96f6\u6027\u80fd\u4e0b\u964d\uff0c\u65e0\u590d\u6742\u6027\uff08\u6613\u4e8e\u5b89\u88c5\uff09\u5e76\u4e14\u65e0\u9700\u66f4\u6539\u73b0\u6709\u90e8\u7f72\u7684\u60c5\u51b5\u3002"}),"\n",(0,r.jsx)(e.p,{children:"MHA\u8fd8\u63d0\u4f9b\u4e86\u8ba1\u5212\u7684\u5728\u7ebf\u4e3b\u8bbe\u5907\u5207\u6362\uff0c\u53ef\u4ee5\u5728\u505c\u673a\uff08\u4ec5\u963b\u6b62\u5199\u5165\uff09\u7684\u51e0\u79d2\u949f\uff080.5-2\u79d2\uff09\u5185\u5c06\u5f53\u524d\u6b63\u5728\u8fd0\u884c\u7684\u4e3b\u8bbe\u5907\u5b89\u5168\u5730\u66f4\u6539\u4e3a\u65b0\u7684\u4e3b\u8bbe\u5907\u3002"}),"\n",(0,r.jsx)(e.p,{children:"MHA\u63d0\u4f9b\u4ee5\u4e0b\u529f\u80fd\uff0c\u5728\u9700\u8981\u9ad8\u53ef\u7528\u6027\uff0c\u6570\u636e\u5b8c\u6574\u6027\u548c\u8fd1\u4e4e\u4e0d\u95f4\u65ad\u7684\u4e3b\u7ef4\u62a4\u7684\u8bb8\u591a\u90e8\u7f72\u4e2d\u5f88\u6709\u7528\u3002"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u81ea\u52a8\u5316\u7684\u4e3b\u7ad9\u76d1\u89c6\u548c\u6545\u969c\u8f6c\u79fb"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"MHA\u53ef\u4ee5\u76d1\u89c6\u73b0\u6709\u590d\u5236\u73af\u5883\u4e2d\u7684MySQL\u4e3b\u670d\u52a1\u5668\uff0c\u5e76\u5728\u68c0\u6d4b\u5230\u4e3b\u670d\u52a1\u5668\u6545\u969c\u65f6\u6267\u884c\u81ea\u52a8\u4e3b\u670d\u52a1\u5668\u6545\u969c\u8f6c\u79fb\u3002MHA\u901a\u8fc7\u8bc6\u522b\u6765\u81ea\u6700\u65b0\u4ece\u7ad9\u7684\u5dee\u5206\u4e2d\u7ee7\u65e5\u5fd7\u4e8b\u4ef6\u5e76\u5c06\u5176\u5e94\u7528\u4e8e\u6240\u6709\u5176\u4ed6\u4ece\u7ad9\uff0c\u5305\u62ec\u90a3\u4e9b\u5c1a\u672a\u6536\u5230\u6700\u65b0\u4e2d\u7ee7\u65e5\u5fd7\u4e8b\u4ef6\u7684\u4ece\u7ad9\uff0c\u6765\u4fdd\u8bc1\u6240\u6709\u4ece\u7ad9\u7684\u4e00\u81f4\u6027\u3002MHA\u901a\u5e38\u53ef\u4ee5\u5728\u51e0\u79d2\u949f\u5185\u6267\u884c\u6545\u969c\u8f6c\u79fb\uff1a9\u523012\u79d2\u949f\u7528\u4e8e\u68c0\u6d4b\u4e3b\u8bbe\u5907\u6545\u969c\uff0c\u53ef\u9009\u57307\u523010\u79d2\u949f\u7528\u4e8e\u5173\u95ed\u4e3b\u8ba1\u7b97\u673a\u7535\u6e90\uff0c\u4ee5\u907f\u514d\u8111\u90e8\u5206\u88c2\uff1b\u51e0\u79d2\u949f\u7684\u65f6\u95f4\u5c06\u5dee\u5206\u4e2d\u7ee7\u65e5\u5fd7\u5e94\u7528\u4e8e\u65b0\u7684\u4e3b\u8bbe\u5907\u3002\u603b\u505c\u673a\u65f6\u95f4\u901a\u5e38\u4e3a10-30\u79d2\u3002\u53ef\u4ee5\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u5c06\u7279\u5b9a\u4ece\u7ad9\u6307\u5b9a\u4e3a\u5019\u9009\u4e3b\u7ad9\uff08\u8bbe\u7f6e\u4f18\u5148\u7ea7\uff09\u3002\u7531\u4e8eMHA\u7ef4\u62a4\u4ece\u7ad9\u4e4b\u95f4\u7684\u4e00\u81f4\u6027\uff0c\u4efb\u4f55\u5974\u96b6\u90fd\u53ef\u4ee5\u664b\u5347\u4e3a\u65b0\u4e3b\u4eba\u3002\u901a\u5e38\u4e0d\u4f1a\u5bfc\u81f4\u7a81\u7136\u7684\u590d\u5236\u5931\u8d25\u7684\u4e00\u81f4\u6027\u95ee\u9898\u5c06\u4e0d\u4f1a\u53d1\u751f\u3002"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u4ea4\u4e92\u5f0f\uff08\u624b\u52a8\u542f\u52a8\uff09\u4e3b\u6545\u969c\u8f6c\u79fb"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u53ef\u4ee5\u5c06MHA\u914d\u7f6e\u4e3a\u624b\u52a8\u542f\u52a8\uff08\u975e\u81ea\u52a8\uff09\uff0c\u4ea4\u4e92\u5f0f\u6545\u969c\u8f6c\u79fb\uff0c\u800c\u65e0\u9700\u76d1\u89c6\u4e3b\u670d\u52a1\u5668\u3002"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u975e\u4ea4\u4e92\u5f0f\u4e3b\u670d\u52a1\u5668\u6545\u969c\u8f6c\u79fb"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u8fd8\u652f\u6301\u4e0d\u76d1\u89c6\u4e3b\u670d\u52a1\u5668\u7684\u975e\u4ea4\u4e92\u5f0f\u81ea\u52a8\u4e3b\u670d\u52a1\u5668\u6545\u969c\u8f6c\u79fb\u3002\u5f53\u5df2\u7ecf\u4f7f\u7528MySQL\u4e3b\u8f6f\u4ef6\u76d1\u89c6\u65f6\uff0c\u6b64\u529f\u80fd\u7279\u522b\u6709\u7528\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528",(0,r.jsx)(e.a,{href:"http://www.linux-ha.org/wiki/Pacemaker",children:"Pacemaker\uff08Heartbeat\uff09"}),"\u68c0\u6d4b\u4e3b\u670d\u52a1\u5668\u6545\u969c\u548c\u865a\u62dfIP\u5730\u5740\u63a5\u7ba1\uff0c\u800c\u4f7f\u7528MHA\u8fdb\u884c\u4e3b\u670d\u52a1\u5668\u6545\u969c\u8f6c\u79fb\u548c\u4ece\u5c5e\u5347\u7ea7\u3002"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"\u5728\u7ebf\u5c06\u4e3b\u670d\u52a1\u5668\u5207\u6362\u5230\u5176\u4ed6\u4e3b\u673a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u901a\u5e38\u6709\u5fc5\u8981\u5c06\u73b0\u6709\u7684\u4e3b\u670d\u52a1\u5668\u8fc1\u79fb\u5230\u53e6\u4e00\u53f0\u8ba1\u7b97\u673a\u4e0a\uff0c\u4f8b\u5982\u5f53\u524d\u4e3b\u670d\u52a1\u5668\u5b58\u5728\u786c\u4ef6RAID\u63a7\u5236\u5668\u6216RAM\u95ee\u9898\uff0c\u6216\u8005\u8981\u7528\u901f\u5ea6\u66f4\u5feb\u7684\u8ba1\u7b97\u673a\u66ff\u6362\u5b83\u7b49\u65f6\uff0c\u8fd9\u4e0d\u662f\u4e3b\u670d\u52a1\u5668\u5d29\u6e83\uff0c\u4f46\u9700\u8981\u5b9a\u671f\u8fdb\u884c\u4e3b\u7ef4\u62a4\u3002\u8ba1\u5212\u7684\u4e3b\u673a\u7ef4\u62a4\u5e94\u5c3d\u5feb\u5b8c\u6210\uff0c\u56e0\u4e3a\u8fd9\u4f1a\u5bfc\u81f4\u90e8\u5206\u505c\u673a\uff08\u7981\u7528\u4e3b\u673a\u5199\u5165\uff09\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u60a8\u5e94\u8be5\u975e\u5e38\u4ed4\u7ec6\u5730\u963b\u6b62/\u6740\u6b7b\u5f53\u524d\u6b63\u5728\u8fd0\u884c\u7684\u4f1a\u8bdd\uff0c\u56e0\u4e3a\u4e0d\u540c\u7684master\u4e4b\u95f4\u53ef\u80fd\u4f1a\u53d1\u751f\u4e00\u81f4\u6027\u95ee\u9898\uff08\u5373\u201c\u66f4\u65b0master1\uff0c\u66f4\u65b0master 2\uff0c\u63d0\u4ea4master1\uff0c\u5728\u63d0\u4ea4master 2\u65f6\u51fa\u9519\u201d\u4f1a\u5bfc\u81f4\u6570\u636e\u4e0d\u4e00\u81f4\uff09\u3002\u5feb\u901f\u4e3b\u5f00\u5173\u548c\u5e73\u7a33\u963b\u6b62\u5199\u5165\u90fd\u662f\u5fc5\u9700\u7684\u3002"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"MHA\u5728\u5199\u5165\u5668\u963b\u585e\u540e\u76840.5-2\u79d2\u5185\u63d0\u4f9b\u6b63\u5e38\u7684\u4e3b\u8bbe\u5907\u5207\u6362\u3002\u901a\u5e38\u53ef\u4ee5\u63a5\u53d70.5-2\u79d2\u7684\u5199\u5165\u5668\u505c\u673a\u65f6\u95f4\uff0c\u56e0\u6b64\u5373\u4f7f\u4e0d\u5206\u914d\u8ba1\u5212\u7684\u7ef4\u62a4\u65f6\u6bb5\uff0c\u60a8\u4e5f\u53ef\u4ee5\u5207\u6362\u4e3b\u673a\u3002\u5347\u7ea7\u5230\u66f4\u9ad8\u7248\u672c\uff0c\u66f4\u5feb\u7684\u8ba1\u7b97\u673a\u7b49\u64cd\u4f5c\u53d8\u5f97\u66f4\u52a0\u5bb9\u6613\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"2mha\u67b6\u6784",children:"2.MHA\u67b6\u6784"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.a,{href:"https://raw/branch.githubusercontent.com/wiki/yoshinorim/mha4mysql-manager/Architecture.md",children:"MHA\u67b6\u6784\u5b98\u65b9\u6587\u6863"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u6b63\u5e38\u5de5\u4f5c\u65f6\u67b6\u6784"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-06-0517.48.35.png",alt:"iShot2020-06-0517.48.35"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u4e3b\u5e93down\u673a\u65f6\u67b6\u6784"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-06-0517.49.03.png",alt:"iShot2020-06-0517.49.03"})}),"\n",(0,r.jsxs)(e.p,{children:["\u8be5\u8f6f\u4ef6\u7531\u4e24\u90e8\u5206\u7ec4\u6210\uff1a",(0,r.jsxs)(e.strong,{children:["MHA Manager\uff08\u7ba1\u7406\u8282\u70b9\uff09",(0,r.jsx)(e.strong,{children:"\u548c"}),"MHA Node\uff08\u6570\u636e\u8282\u70b9\uff09"]}),"\u3002"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"MHA Manager"}),"\u53ef\u4ee5\u5355\u72ec\u90e8\u7f72\u5728\u4e00\u53f0\u72ec\u7acb\u7684\u673a\u5668\u4e0a\u7ba1\u7406\u591a\u4e2amaster-slave\u96c6\u7fa4\uff0c\u4e5f\u53ef\u4ee5\u90e8\u7f72\u5728\u4e00\u53f0slave\u8282\u70b9\u4e0a\u3002"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"MHA Node"}),"\u8fd0\u884c\u5728\u6bcf\u53f0MySQL\u670d\u52a1\u5668\u4e0a\uff0cMHA Manager\u4f1a\u5b9a\u65f6\u63a2\u6d4b\u96c6\u7fa4\u4e2d\u7684master\u8282\u70b9\uff0c\u5f53master\u51fa\u73b0\u6545\u969c\u65f6\uff0c\u5b83\u53ef\u4ee5\u81ea\u52a8\u5c06\u6700\u65b0\u6570\u636e\u7684slave\u63d0\u5347\u4e3a\u65b0\u7684master\uff0c\u7136\u540e\u5c06\u6240\u6709\u5176\u4ed6\u7684slave\u91cd\u65b0\u6307\u5411\u65b0\u7684master\u3002\u6574\u4e2a\u6545\u969c\u8f6c\u79fb\u8fc7\u7a0b\u5bf9\u5e94\u7528\u7a0b\u5e8f\u5b8c\u5168\u900f\u660e\u3002"]}),"\n",(0,r.jsx)(e.p,{children:"\u5728MHA\u81ea\u52a8\u6545\u969c\u5207\u6362\u8fc7\u7a0b\u4e2d\uff0cMHA\u8bd5\u56fe\u4ece\u5b95\u673a\u7684\u4e3b\u670d\u52a1\u5668\u4e0a\u4fdd\u5b58\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u6700\u5927\u7a0b\u5ea6\u7684\u4fdd\u8bc1\u6570\u636e\u7684\u4e0d\u4e22\u5931(\u914d\u5408mysql\u534a\u540c\u6b65\u590d\u5236\u6548\u679c\u66f4\u4f73)\uff0c\u4f46\u8fd9\u5e76\u4e0d\u603b\u662f\u53ef\u884c\u7684\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4e3b\u670d\u52a1\u5668\u786c\u4ef6\u6545\u969c\u6216\u65e0\u6cd5\u901a\u8fc7ssh\u8bbf\u95ee\uff0cMHA\u6ca1\u6cd5\u4fdd\u5b58\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u53ea\u8fdb\u884c\u6545\u969c\u8f6c\u79fb\u800c\u4e22\u5931\u4e86\u6700\u65b0\u7684\u6570\u636e\u3002\u4f7f\u7528MySQL 5.5\u7684\u534a\u540c\u6b65\u590d\u5236\uff0c\u53ef\u4ee5\u5927\u5927\u964d\u4f4e\u6570\u636e\u4e22\u5931\u7684\u98ce\u9669\u3002MHA\u53ef\u4ee5\u4e0e\u534a\u540c\u6b65\u590d\u5236\u7ed3\u5408\u8d77\u6765\u3002\u5982\u679c\u53ea\u6709\u4e00\u4e2aslave\u5df2\u7ecf\u6536\u5230\u4e86\u6700\u65b0\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0cMHA\u53ef\u4ee5\u5c06\u6700\u65b0\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5e94\u7528\u4e8e\u5176\u4ed6\u6240\u6709\u7684slave\u670d\u52a1\u5668\u4e0a\uff0c\u56e0\u6b64\u53ef\u4ee5\u4fdd\u8bc1\u6240\u6709\u8282\u70b9\u7684\u6570\u636e\u4e00\u81f4\u6027\u3002"}),"\n",(0,r.jsx)(e.p,{children:"\u6ce8\u610f\uff1a\u76ee\u524dMHA\u4e3b\u8981\u652f\u6301\u4e00\u4e3b\u591a\u4ece\u7684\u67b6\u6784\uff0c\u8981\u642d\u5efaMHA,\u8981\u6c42\u4e00\u4e2a\u590d\u5236\u96c6\u7fa4\u4e2d\u5fc5\u987b\u6700\u5c11\u6709\u4e09\u53f0\u6570\u636e\u5e93\u670d\u52a1\u5668\uff0c\u4e00\u4e3b\u4e8c\u4ece\uff0c\u5373\u4e00\u53f0\u5145\u5f53master\uff0c\u4e00\u53f0\u5145\u5f53\u5907\u7528master\uff0c\u53e6\u5916\u4e00\u53f0\u5145\u5f53\u4ece\u5e93\uff0c\u56e0\u4e3a\u81f3\u5c11\u9700\u8981\u4e09\u53f0\u670d\u52a1\u5668\u3002"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"\u5de5\u4f5c\u8fc7\u7a0b\uff1amanager\u8282\u70b9\u5b9a\u65f6\u68c0\u6d4b\u590d\u5236\u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e00\u4e2anode,\u5982\u679cmaster\u5b95\u673a\u4f1a\u9009\u51fa\u6570\u636e\u4e0emaster\u6700\u63a5\u8fd1\u7684\u4e00\u53f0slave\u6765\u4f5c\u4e3a\u65b0master\uff0c\u53bb\u5230\u65e7master\u4e2d\u62f7\u8d1dbinlog\u5230\u65b0master\u4e2d\u5e76\u5e94\u7528binlog\u4ee5\u4fdd\u8bc1\u65b0master\u4e0e\u65e7master\u6570\u636e\u4e00\u81f4\uff0c\u7136\u540e\u5c06\u5269\u4f59\u7684slave\u91cd\u65b0changer master to,\u5c06slave\u7684\u4e3b\u5207\u6362\u4e3a\u65b0master"})})}),"\n",(0,r.jsx)(e.h2,{id:"3\u90e8\u7f72\u8fc7\u7a0b",children:"3.\u90e8\u7f72\u8fc7\u7a0b"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u5b9e\u9a8c\u73af\u5883"})}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u89d2\u8272"}),(0,r.jsx)(e.th,{children:"IP"}),(0,r.jsx)(e.th,{children:"\u4e3b\u673a\u540d"}),(0,r.jsx)(e.th,{children:"\u7cfb\u7edf"}),(0,r.jsx)(e.th,{children:"\u673a\u5668\u914d\u7f6e"}),(0,r.jsx)(e.th,{children:"mysql\u7248\u672c"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"manager"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"10.0.0.130"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"mha"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"centos7.8"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"2c4g"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"5.7.28"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"mysql-master"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"10.0.0.133"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"mysql01"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"centos7.8"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"2c4g"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"5.7.28"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"mysql-slave1"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"10.0.0.134"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"mysql02"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"centos7.8"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"2c4g"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"5.7.28"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"mysql-slave2"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"10.0.0.135"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"mysql03"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"centos7.8"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"2c4g"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"5.7.28"})})]})]})]}),"\n",(0,r.jsx)(e.h3,{id:"31-\u4e0b\u8f7d\u5b89\u88c5\u5305",children:"3.1 \u4e0b\u8f7d\u5b89\u88c5\u5305"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.a,{href:"https://github.com/yoshinorim/mha4mysql-manager/releases",children:"MHA manager0.58\u4e0b\u8f7d\u5730\u5740"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.a,{href:"https://github.com/yoshinorim/mha4mysql-node/releases",children:"MHA node0.58\u4e0b\u8f7d\u5730\u5740"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.a,{href:"https://github.com/yoshinorim/mha4mysql-manager/wiki/Downloads",children:"MHA 0.56 \u4e0b\u8f7d\u5730\u5740"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Manager\u5de5\u5177\u5305\u4e3b\u8981\u5305\u62ec\u4ee5\u4e0b\u51e0\u4e2a\u5de5\u5177\uff1a"})}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u540d\u79f0"}),(0,r.jsx)(e.th,{children:"\u542b\u4e49"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_check_ssh"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u68c0\u67e5MHA\u7684SSH\u914d\u7f6e\u72b6\u51b5"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_check_repl"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u68c0\u67e5MySQL\u590d\u5236\u72b6\u51b5"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_manger"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u542f\u52a8MHA"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_check_status"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u68c0\u6d4b\u5f53\u524dMHA\u8fd0\u884c\u72b6\u6001"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_master_monitor"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u68c0\u6d4bmaster\u662f\u5426\u5b95\u673a"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_master_switch"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u63a7\u5236\u6545\u969c\u8f6c\u79fb\uff08\u81ea\u52a8\u6216\u8005\u624b\u52a8\uff09"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_conf_host"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u6dfb\u52a0\u6216\u5220\u9664\u914d\u7f6e\u7684server\u4fe1\u606f"})})]})]})]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Node\u5de5\u5177\u5305\uff08\u8fd9\u4e9b\u5de5\u5177\u901a\u5e38\u7531MHA Manager\u7684\u811a\u672c\u89e6\u53d1\uff0c\u65e0\u9700\u4eba\u4e3a\u64cd\u4f5c\uff09\u4e3b\u8981\u5305\u62ec\u4ee5\u4e0b\u51e0\u4e2a\u5de5\u5177\uff1a"})}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u540d\u79f0"}),(0,r.jsx)(e.th,{children:"\u542b\u4e49"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"save_binary_logs"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u4fdd\u5b58\u548c\u590d\u5236master\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"apply_diff_relay_logs"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u8bc6\u522b\u5dee\u5f02\u7684\u4e2d\u7ee7\u65e5\u5fd7\u4e8b\u4ef6\u5e76\u5c06\u5176\u5dee\u5f02\u7684\u4e8b\u4ef6\u5e94\u7528\u4e8e\u5176\u4ed6\u7684slave"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"filter_mysqlbinlog"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u53bb\u9664\u4e0d\u5fc5\u8981\u7684ROLLBACK\u4e8b\u4ef6\uff08MHA\u5df2\u4e0d\u518d\u4f7f\u7528\u8fd9\u4e2a\u5de5\u5177\uff09"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"purge_relay_logs"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u6e05\u9664\u4e2d\u7ee7\u65e5\u5fd7\uff08\u4e0d\u4f1a\u963b\u585eSQL\u7ebf\u7a0b\uff09"})})]})]})]}),"\n",(0,r.jsx)(e.h3,{id:"32-\u6240\u6709\u673a\u5668\u505a\u76f8\u4e92\u514d\u5bc6\u94a5\u914d\u7f6e",children:"3.2 \u6240\u6709\u673a\u5668\u505a\u76f8\u4e92\u514d\u5bc6\u94a5\u914d\u7f6e"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"\u26a0\ufe0f\u590d\u5236\u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e2a\u8282\u70b9\u90fd\u6709\u53ef\u80fd\u6210\u4e3amaster\uff0c\u90fd\u5f97\u5f00\u542fbinlog\u548cssh\u5bc6\u94a5\u8ba4\u8bc1\uff0c\u56e0\u4e3a\u5f53\u65e7master\u5b95\u673a\u540e\uff0cmha\u8981\u62f7\u8d1dbinlog\u5230\u6240\u6709node\u8282\u70b9\u4e0a\uff0c\u800c\u4e14\u6240\u6709\u8282\u70b9\u90fd\u6709\u53ef\u80fd\u6210\u4e3amaster\uff0c\u6545\u6bcf\u4e2a\u8282\u70b9\u90fd\u8981\u5f7c\u6b64\u5bc6\u94a5\u8ba4\u8bc1"})})}),"\n",(0,r.jsx)(e.p,{children:"lowB\u811a\u672c\u8fd0\u884c\u4e00\u4e0b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:'#!/bin/bash\nfile_path=/root\nfile_name=host.txt\nfile=$file_path/$file_name\nuser=root\npwd=1\nssh_file=~/.ssh/id_rsa\n\nyum -y install expect &> /dev/null\n\n# \u751f\u6210\u5bc6\u94a5\n[ -f "$ssh_file" ] || ssh-keygen -q -N "" -f ~/.ssh/id_rsa\n\nread -p "\u8bf7\u8f93\u5165\u5f00\u59cb\u6570\u503c: " start_num\nread -p "\u8bf7\u8f93\u5165\u7ed3\u675f\u6570\u503c: " end_num\nread -p "\u8bf7\u8f93\u5165\u7f51\u6bb5(\u7c7b\u4f3c\u683c\u5f0f\uff1a10.0.0.)\uff1a" sub_net\nseq $start_num $end_num >$file\n\n# \u5728\u6587\u4ef6\u5f00\u5934\u52a0\u4e0a\u7f51\u6bb5\uff0c\u5728\u6587\u4ef6\u672b\u5c3e\u52a0\u4e0a\u7528\u6237\u540d\u548c\u5bc6\u7801\nsed -i \'s/^/\'$sub_net\'/g\' $file\nsed -i \'s/$/ \'$user\' \'$pwd\'/g\' $file\n\necho -e "\u6267\u884c\u6210\u529f\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b:\\n`cat $file`"\n\nwhile read line;do\n    ip=`echo $line | awk \'{print $1}\'`\n    username=`echo $line | awk \'{print $2}\'`\n    password=`echo $line | awk \'{print $3}\'`\nexpect <<EOF\n    spawn ssh-copy-id -i $username@$ip\n    expect {\n        "yes/no" {send "yes\\n";exp_continue}\n        "password" {send "$password\\n"}\n        }\n    expect eof\nEOF\ndone < $file\n'})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"master\u64cd\u4f5c(mysql01 10.0.0.133)"})})}),"\n",(0,r.jsx)(e.h3,{id:"33-mysql\u4e3b\u4ece\u914d\u7f6e-gtid",children:"3.3 mysql\u4e3b\u4ece\u914d\u7f6e-GTID"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u8fd9\u91cc\u662f\u628a10.0.0.133(mysql01)\u300110.0.0.134(mysql02)\u300110.0.0.135(mysql03)\u642d\u5efa\u4e3aABB\uff0c\u5373\u4e00\u4e3b\u4e24\u4ece\uff0c\u5176\u4e2dmysql01\u662f\u4e3b\u5e93\uff0c\u5176\u4f59\u4e24\u4e2a\u8282\u70b9\u662f\u4ece\u5e93"})}),"\n"]}),"\n",(0,r.jsxs)(e.h4,{id:"331-\u7f16\u8f91-etcmycnf",children:["3.3.1 \u7f16\u8f91 ",(0,r.jsx)(e.code,{children:"/etc/my.cnf"})]}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["\u6307\u5b9a",(0,r.jsx)(e.code,{children:"serverid"}),"\uff0c\u5e76\u5f00\u542f",(0,r.jsx)(e.code,{children:"binlog"})]})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"# \u6307\u5b9aserver id\nserver_id=1\n\n# \u5f00\u542fbinlog\u65e5\u5fd7\uff0c\u4f4d\u7f6e\u5728mysql\u6570\u636e\u76ee\u5f55data\u4e0b\nlog_bin=binlog\n\n# \u5f00\u542fbinlog\u65e5\u5fd7\u7d22\u5f15\uff0c\u4f4d\u7f6e\u5728mysql\u6570\u636e\u76ee\u5f55data\u4e0b\nlog_bin_index=binlog.index\t\n\n# \u5f00\u542fGTID\ngtid_mode=ON\n\n# \u5f00\u542fGTID\u7684\u4e00\u4e9b\u5b89\u5168\u9650\u5236 \u6267\u884cGTID\u4e00\u81f4\nenforce_gtid_consistency\n\n# \u901a\u5e38\u60c5\u51b5\uff0c\u4ece\u670d\u52a1\u5668\u4ece\u4e3b\u670d\u52a1\u5668\u63a5\u6536\u5230\u7684\u66f4\u65b0\u4e0d\u8bb0\u5165\u5b83\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\u3002\u8be5\u9009\u9879\u544a\u8bc9\u4ece\u670d\u52a1\u5668\u5c06\u5176SQL\u7ebf\u7a0b\u6267\u884c\u7684\u66f4\u65b0\u8bb0\u5165\u5230\u4ece\u670d\u52a1\u5668\u81ea\u5df1\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0cmysql-5.6\u5fc5\u987b\u52a0\u8fd9\u4e2a\u53c2\u6570\uff0c5.7\u53ef\u4ee5\u4e0d\u52a0\nlog-slave-updates\n\n# \u7981\u6b62mysql\u57df\u540d\u89e3\u6790\nskip_name_resolve\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u91cd\u542fmysql"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"systemctl restart mysqld\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["\u67e5\u770bgit\u5f00\u542f\u60c5\u51b5\uff0c",(0,r.jsx)(e.code,{children:"enforce_gtid_consistency"}),"\u4e0e",(0,r.jsx)(e.code,{children:"gtid_mode"}),"\u90fd\u4e3aon\u5373\u4e3a\u6b63\u786e"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"mysql> show global variables like '%gtid%';\n+----------------------------------+-------+\n| Variable_name                    | Value |\n+----------------------------------+-------+\n| binlog_gtid_simple_recovery      | ON    |\n| enforce_gtid_consistency         | ON    |\n| gtid_executed                    |       |\n| gtid_executed_compression_period | 1000  |\n| gtid_mode                        | ON    |\n| gtid_owned                       |       |\n| gtid_purged                      |       |\n| session_track_gtids              | OFF   |\n+----------------------------------+-------+\n8 rows in set (0.00 sec)\n"})}),"\n",(0,r.jsx)(e.h4,{id:"332-\u521b\u5efa\u4e13\u7528\u590d\u5236\u7528\u6237\u548c\u8bbe\u7f6e\u76d1\u63a7\u7528\u6237",children:"3.3.2 \u521b\u5efa\u4e13\u7528\u590d\u5236\u7528\u6237\u548c\u8bbe\u7f6e\u76d1\u63a7\u7528\u6237"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"\u5141\u8bb8\u4eceslave\u4e0a\u8fde\u63a5\u8fc7\u6765\u7684\u590d\u5236\u7528\u6237\uff0c3\u53f0mysql\u670d\u52a1\u5668\u90fd\u8981\u521b\u5efa\u590d\u5236\u7528\u6237\u548c\u76d1\u63a7\u7528\u6237\uff01\uff01\uff01"})})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u26a0\ufe0f\u590d\u5236\u7528\u6237\u540d\u79f0\u4e3arepl\uff0c\u4e5f\u53ef\u4ee5\u5728MHA\u914d\u7f6e\u6587\u4ef6\u4e2d\u4fee\u6539\u590d\u5236\u7528\u6237"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u521b\u5efa\u4e13\u7528\u590d\u5236\u7528\u6237"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"mysql> grant replication slave on *.* to 'repl'@'10.0.0.%' identified by 'Bxb123.com';\nQuery OK, 0 rows affected, 1 warning (0.00 sec)\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u8bbe\u7f6e\u76d1\u63a7\u7528\u6237"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"\u26a0\ufe0f\u6240\u6709\u8282\u70b9\u8fdb\u884c\u6388\u6743"})})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"mysql> grant all privileges on *.* to 'mha'@'10.0.0.%' identified by 'Bxb123.com';\nQuery OK, 0 rows affected, 1 warning (0.00 sec)\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["mysql5.7\u4f1a\u9ed8\u8ba4\u52a0\u8f7dvalidate_password \u6a21\u5757\uff0c\u662f\u6765\u63a7\u5236\u5bc6\u7801\u957f\u5ea6\u548c\u89c4\u5219\u7684\uff0c\u53ef\u4ee5\u5728\u914d\u7f6e\u6587\u4ef6\u91cc\u9762\u5173\u95ed\u8be5\u6a21\u5757\u52a0\u4e0a",(0,r.jsx)(e.code,{children:"validate_password = off "}),"\uff0c\u6216\u8005\u5728mysql\u547d\u4ee4\u884c\u6267\u884c",(0,r.jsx)(e.code,{children:"set global validate_password_policy=0;"}),"\u6765\u4e34\u65f6\u53d6\u6d88\u5bc6\u7801\u89c4\u5219"]})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u7981\u7528\u81ea\u52a8\u5220\u9664relay log\u529f\u80fd"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"set global relay_log_purge=0;\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"slave\u64cd\u4f5c(mysql02\u300103 10.0.0.134\u3001135)"})})}),"\n",(0,r.jsxs)(e.h4,{id:"333-\u914d\u7f6e\u6587\u4ef6-etcmycnf",children:["3.3.3 \u914d\u7f6e\u6587\u4ef6 ",(0,r.jsx)(e.code,{children:"/etc/my.cnf"})]}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u6307\u5b9aserverid\uff0c\u5e76\u5f00\u542fbinlog\u65e5\u5fd7"})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"# \u6307\u5b9aserver id mysql02\u4e3a2 mysql03\u4e3a3\nserver_id=2\n\n# \u5f00\u542fbinlog\u65e5\u5fd7\uff0c\u4f4d\u7f6e\u5728mysql\u6570\u636e\u76ee\u5f55data\u4e0b\nlog_bin=binlog\n\n# \u5f00\u542fbinlog\u65e5\u5fd7\u7d22\u5f15\uff0c\u4f4d\u7f6e\u5728mysql\u6570\u636e\u76ee\u5f55data\u4e0b\nlog_bin_index=binlog.index\t\n\n# \u5f00\u542fGTID\ngtid_mode=ON\n\n# \u5f00\u542fGTID\u7684\u4e00\u4e9b\u5b89\u5168\u9650\u5236 \u6267\u884cGTID\u4e00\u81f4\nenforce_gtid_consistency\n\n# \u901a\u5e38\u60c5\u51b5\uff0c\u4ece\u670d\u52a1\u5668\u4ece\u4e3b\u670d\u52a1\u5668\u63a5\u6536\u5230\u7684\u66f4\u65b0\u4e0d\u8bb0\u5165\u5b83\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\u3002\u8be5\u9009\u9879\u544a\u8bc9\u4ece\u670d\u52a1\u5668\u5c06\u5176SQL\u7ebf\u7a0b\u6267\u884c\u7684\u66f4\u65b0\u8bb0\u5165\u5230\u4ece\u670d\u52a1\u5668\u81ea\u5df1\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0cmysql-5.6\u5fc5\u987b\u52a0\u8fd9\u4e2a\u53c2\u6570\uff0c5.7\u53ef\u4ee5\u4e0d\u52a0\nlog-slave-updates\n\n# \u7981\u6b62mysql\u57df\u540d\u89e3\u6790\nskip_name_resolve\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u91cd\u542fmysql"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"systemctl restart mysqld\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["\u67e5\u770bgit\u5f00\u542f\u60c5\u51b5\uff0c",(0,r.jsx)(e.code,{children:"enforce_gtid_consistency"}),"\u4e0e",(0,r.jsx)(e.code,{children:"gtid_mode"}),"\u90fd\u4e3aon\u5373\u4e3a\u6b63\u786e"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"mysql> show variables like '%gtid%';\n+----------------------------------+-----------+\n| Variable_name                    | Value     |\n+----------------------------------+-----------+\n| binlog_gtid_simple_recovery      | ON        |\n| enforce_gtid_consistency         | ON        |\n| gtid_executed_compression_period | 1000      |\n| gtid_mode                        | ON        |\n| gtid_next                        | AUTOMATIC |\n| gtid_owned                       |           |\n| gtid_purged                      |           |\n| session_track_gtids              | OFF       |\n+----------------------------------+-----------+\n8 rows in set (0.00 sec)\n"})}),"\n",(0,r.jsx)(e.h4,{id:"334-\u4ece\u5e93\u62c9\u53d6",children:"3.3.4 \u4ece\u5e93\u62c9\u53d6"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"# \u8bbe\u7f6e\u53ea\u8bfb\uff0c\u4e0d\u8981\u5728\u914d\u7f6e\u6587\u4ef6\u91cc\u5199\nmysql> set global read_only=1;\nQuery OK, 0 rows affected (0.00 sec)\n\n# \u7981\u7528\u81ea\u52a8\u5220\u9664relay log\nset global relay_log_purge=0;\n\n# \u62c9\u53d6\nchange master to \\\n    master_host='10.0.0.133', \\\n    master_user='repl', \\\n    master_password='Bxb123.com', \\\n    master_auto_position=1;\nQuery OK, 0 rows affected, 2 warnings (0.00 sec)    \n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u542f\u52a8slave\u5e76\u67e5\u770bslave\u72b6\u6001"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"# \u542f\u52a8slave\nmysql> start slave;\nQuery OK, 0 rows affected (0.00 sec)\n\n# \u67e5\u770bslave\u72b6\u6001\uff0cSQL\u548cIO\u7ebf\u7a0b\u90fd\u4e3aYes\u5e76\u4e14Auto_Position\u4e3a1\u5373\u4e3a\u6b63\u786e\nSlave_IO_Running: Yes\nSlave_SQL_Running: Yes\nAuto_Position: 1  \n  \n# \u8fd9\u4e2a\u503c\u662f\u4e3b\u4ece\u5ef6\u8fdf\uff0c\u5373slave\u843d\u540emaster\u7684\u79d2\u6570\uff0c\u4e5f\u662f\u4e00\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u67e5\u770b\u4e3b\u4ece\u662f\u5426\u6b63\u5e38\u7684\u6807\u51c6\u503c  \nSeconds_Behind_Master: 0  \n"})}),"\n",(0,r.jsx)(e.h4,{id:"335-\u9a8c\u8bc1\u4e3b\u4ece\u540c\u6b65",children:"3.3.5 \u9a8c\u8bc1\u4e3b\u4ece\u540c\u6b65"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"master\u64cd\u4f5c"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"# \u5728\u4e3b\u5e93\u4e0a\u521b\u5efa\u4e00\u4e2a\u6570\u636e\u5e93db1\nmysql> create database db1;\nQuery OK, 1 row affected (0.00 sec)\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"slave\u64cd\u4f5c"})}),"\n",(0,r.jsx)(e.p,{children:"\u67e5\u770b\u4e3b\u5e93\u4e0a\u521b\u5efa\u7684\u6570\u636e\u5e93\u662f\u5426\u5df2\u7ecf\u540c\u6b65\u8fc7\u6765\uff0c\u540c\u6b65\u5b8c\u6210\u5373\u4e3a\u6210\u529f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"mysql> show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| db1                |\n| mysql              |\n| performance_schema |\n| sys                |\n+--------------------+\n5 rows in set (0.00 sec)\n"})}),"\n",(0,r.jsx)(e.h3,{id:"34-\u90e8\u7f72mha-node",children:"3.4 \u90e8\u7f72MHA node"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u6240\u6709\u8282\u70b9\u6267\u884c"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"# \u4e0b\u8f7d\u5305\nwget https://github.com/yoshinorim/mha4mysql-node/releases/download/v0.58/mha4mysql-node-0.58.tar.gz\n  \n# \u7f16\u8bd1\u5b89\u88c5\n$ cd mha4mysql-node-0.58\n$ ls\nAUTHORS  bin  COPYING  debian  inc  lib  Makefile.PL  MANIFEST  META.yml  README  rpm  t\n\n$ perl Makefile.PL\n$ make && make install\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["\u5b89\u88c5\u5b8c\u6210\u540e\u62f7\u8d1d",(0,r.jsx)(e.code,{children:"mha4mysql-node-0.58/bin"}),"\u4e0b\u7684\u6240\u6709\u53ef\u6267\u884c\u6587\u4ef6\u5230",(0,r.jsx)(e.code,{children:"/usr/local/bin"})]})}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"apply_diff_relay_logs\t\t\t#\u8bc6\u522b\u5dee\u5f02\u65e5\u5fd7\u5e76\u5e94\u7528\u4e8e\u5176\u4ed6slave"}),"\n",(0,r.jsx)(e.strong,{children:"save_binary_logs\t\t\t\t   #\u4fdd\u5b58\u548c\u590d\u5236\u4e8c\u8fdb\u5236\u65e5\u5fd7"}),"\n",(0,r.jsx)(e.strong,{children:"filter_mysqlbinlog\t\t\t     #\u53bb\u9664\u4e0d\u5fc5\u8981\u7684ROLLBACK\u4e8b\u4ef6\uff08MHA\u5df2\u4e0d\u518d\u4f7f\u7528\u8fd9\u4e2a\u5de5\u5177\uff09"}),"\n",(0,r.jsx)(e.strong,{children:"purge_relay_logs\t\t\t       #\u6e05\u9664\u4e2d\u7ee7\u65e5\u5fd7"})]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"manager\u64cd\u4f5c(mha 10.0.0.130)"})})}),"\n",(0,r.jsx)(e.h3,{id:"35-\u90e8\u7f72mha-manager",children:"3.5 \u90e8\u7f72MHA Manager"}),"\n",(0,r.jsx)(e.h4,{id:"351-\u589e\u52a0epel\u6e90",children:"3.5.1 \u589e\u52a0epel\u6e90"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\n"})}),"\n",(0,r.jsx)(e.h4,{id:"352-\u5b89\u88c5\u4f9d\u8d56\u5305",children:"3.5.2 \u5b89\u88c5\u4f9d\u8d56\u5305"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"yum -y install perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker perl-ExtUtils-Embed perl-CPAN\n"})}),"\n",(0,r.jsx)(e.h4,{id:"353-\u5b89\u88c5manager",children:"3.5.3 \u5b89\u88c5manager"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"# \u4e0b\u8f7d\u5305\nwget https://github.com/yoshinorim/mha4mysql-manager/releases/download/v0.58/mha4mysql-manager-0.58.tar.gz\n\n# \u7f16\u8bd1\u5b89\u88c5\n$ cd cd mha4mysql-manager-0.58\n$ ls\nAUTHORS  bin  COPYING  debian  inc  lib  Makefile.PL  MANIFEST  META.yml  README  rpm  samples  t  tests\n\n$ perl Makefile.PL\n$ make && make install\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["\u5b89\u88c5\u5b8c\u6210\u540e\u4f1a\u62f7\u8d1d",(0,r.jsx)(e.code,{children:"mha4mysql-manager-0.58/bin"}),"\u4e0b\u7684\u6240\u6709\u53ef\u6267\u884c\u6587\u4ef6\u5230",(0,r.jsx)(e.code,{children:"/usr/local/bin"})]})}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:(0,r.jsx)(e.strong,{children:"\u53ef\u6267\u884c\u6587\u4ef6"})}),(0,r.jsx)(e.th,{children:(0,r.jsx)(e.strong,{children:"\u542b\u4e49"})})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_manager"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u5728\u4e3b\u670d\u52a1\u5668\u5173\u95ed\u7684\u60c5\u51b5\u4e0b\uff0c\u4e3b\u670d\u52a1\u5668\u81ea\u52a8\u76d1\u89c6\u548c\u8fd0\u884c\u6545\u969c\u8f6c\u79fb"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_master_switch"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u624b\u52a8\u6216\u975e\u4ea4\u4e92\u5f0f\u4e3b\u6545\u969c\u8f6c\u79fb\u6216\u5728\u7ebf\u4e3b\u5e93"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_master_monitor"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"MHA Manager\u76d1\u63a7\u7a0b\u5e8f"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_stop"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u505c\u6b62MHA Manager"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_check_repl"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u68c0\u67e5MySQL\u590d\u5236\u8fd0\u884c\u72b6\u51b5"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_check_status"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u68c0\u67e5Manager\u662f\u5426\u6b63\u786e\u76d1\u89c6MySQL master"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_check_ssh"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u68c0\u67e5ssh\u914d\u7f6e"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_conf_host"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"\u4e00\u4e2a\u5e2e\u52a9\u7a0b\u5e8f\u811a\u672c\uff0c\u7528\u4e8e\u4ece\u914d\u7f6e\u6587\u4ef6\u6dfb\u52a0/\u5220\u9664\u4e3b\u673a\u6761\u76ee"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"masterha_secondary_check"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"MHA Manager\u4e8c\u6b21\u68c0\u67e5"})})]})]})]}),"\n",(0,r.jsx)(e.h4,{id:"354-mysql\u4e3b\u5e93\u8282\u70b9\u914d\u7f6eeth00\u7f51\u5361\u7528\u4f5cvip\u8fd9\u91cc\u8bbe\u7f6e\u4e3a1000200",children:"3.5.4 mysql\u4e3b\u5e93\u8282\u70b9\u914d\u7f6eeth0:0\u7f51\u5361\uff0c\u7528\u4f5cVIP\uff0c\u8fd9\u91cc\u8bbe\u7f6e\u4e3a10.0.0.200"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"\u8fd9\u4e00\u6b65\u5728mysql\u4e3b\u5e93\u4e0a(10.0.0.133)\u6267\u884c"})})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"$ ifconfig eth0:0 10.0.0.200\n$ ip a s eth0    \neth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:1c:42:62:a8:c1 brd ff:ff:ff:ff:ff:ff\n    inet 10.0.0.133/24 brd 10.0.0.255 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet 10.0.0.200/8 brd 10.255.255.255 scope global eth0:0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::21c:42ff:fe62:a8c1/64 scope link \n       valid_lft forever preferred_lft forever    \n"})}),"\n",(0,r.jsx)(e.h4,{id:"355-\u4f7f\u7528\u811a\u672c\u7ba1\u7406vip",children:"3.5.5 \u4f7f\u7528\u811a\u672c\u7ba1\u7406vip"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u26a0\ufe0f\u9700\u8981\u4fee\u6539\u7684\u662fVIP\u7684\u5730\u5740\u548c\u7f51\u5361\u7684\u540d\u79f0"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"VIP\u662f\u7ed1\u5b9a\u5728\u4e3b\u5e93\u4e0a\u7684\uff0c\u8fd9\u6837\u5f53\u4e3b\u5e93\u5b95\u673a\u540eVIP\u624d\u4f1a\u6f02\u79fb\u5230\u65b0\u4e3b\u5e93\u4e0a"})})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:'cat > /usr/local/bin/master_ip_failover <<\'EOF\'\n#!/usr/bin/env perl\n\nuse strict;\nuse warnings FATAL => \'all\';\n\nuse Getopt::Long;\n\nmy (\n    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,\n    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port\n);\n\n# \u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u4e00\u4e0b eth1:$key\u7684\u610f\u601d\u662f vip\u5fc5\u987b\u7ed1\u5b9a\u5728 eth0:0\u4e0a\nmy $vip = \'10.0.0.200/24\';  #\u6b64\u5904\u4e3a\u4f60\u8981\u8bbe\u7f6e\u7684\u865a\u62dfip\nmy $key = \'0\';\nmy $ssh_start_vip = "/usr//sbin/ifconfig eth0:$key $vip"; #\u6b64\u5904\u6539\u4e3a\u4f60\u7684\u7f51\u5361\u540d\u79f0\nmy $ssh_stop_vip = "/usr/sbin/ifconfig eth0:$key down";\n\nGetOptions(\n    \'command=s\'          => \\$command,\n    \'ssh_user=s\'         => \\$ssh_user,\n    \'orig_master_host=s\' => \\$orig_master_host,\n    \'orig_master_ip=s\'   => \\$orig_master_ip,\n    \'orig_master_port=i\' => \\$orig_master_port,\n    \'new_master_host=s\'  => \\$new_master_host,\n    \'new_master_ip=s\'    => \\$new_master_ip,\n    \'new_master_port=i\'  => \\$new_master_port,\n);\n\nexit &main();\n\nsub main {\n\n    print "\\n\\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\\n\\n";\n\n    if ( $command eq "stop" || $command eq "stopssh" ) {\n\n        my $exit_code = 1;\n        eval {\n            print "Disabling the VIP on old master: $orig_master_host \\n";\n            &stop_vip();\n            $exit_code = 0;\n        };\n        if ($@) {\n            warn "Got Error: $@\\n";\n            exit $exit_code;\n        }\n        exit $exit_code;\n    }\n    elsif ( $command eq "start" ) {\n\n        my $exit_code = 10;\n        eval {\n            print "Enabling the VIP - $vip on the new master - $new_master_host \\n";\n            &start_vip();\n            $exit_code = 0;\n        };\n        if ($@) {\n            warn $@;\n            exit $exit_code;\n        }\n        exit $exit_code;\n    }\n    elsif ( $command eq "status" ) {\n        print "Checking the Status of the script.. OK \\n";\n        exit 0;\n    }\n    else {\n        &usage();\n        exit 1;\n    }\n}\n\nsub start_vip() {\n    `ssh $ssh_user\\@$new_master_host \\" $ssh_start_vip \\"`;\n}\nsub stop_vip() {\n     return 0  unless  ($ssh_user);\n    `ssh $ssh_user\\@$orig_master_host \\" $ssh_stop_vip \\"`;\n}\n\nsub usage {\n    print\n    "Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\\n";\n}\nEOF\n'})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u7ed9\u811a\u672c\u8d4b\u4e88\u6267\u884c\u6743\u9650"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"chmod +x /usr/local/bin/master_ip_failover\n"})}),"\n",(0,r.jsx)(e.h4,{id:"356-\u914d\u7f6emha\u914d\u7f6e\u6587\u4ef6",children:"3.5.6 \u914d\u7f6emha\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u521b\u5efamha\u914d\u7f6e\u6587\u4ef6\u76ee\u5f55\u53ca\u65e5\u5fd7\u76ee\u5f55"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"mkdir /etc/masterha\nmkdir -p /var/log/masterha/app1\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["\u7f16\u8f91mha\u914d\u7f6e\u6587\u4ef6",(0,r.jsx)(e.code,{children:"/etc/masterha/app1.conf"})]})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsxs)("span",{style:{color:"red"},children:[(0,r.jsx)(e.code,{children:"mha4mysql-manager-0.58/samples/conf/app1.conf"}),"\u662fmha\u7684\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6"]})})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:'cat > /etc/masterha/app1.cnf <<EOF\n[server default]\n# \u8bbe\u7f6emanager\u7684\u5de5\u4f5c\u76ee\u5f55\nmanager_workdir=/var/log/masterha/app1  \n\n# \u8bbe\u7f6emanager\u7684\u65e5\u5fd7\nmanager_log=/var/log/masterha/app1/manager.log   \n\n# \u8bbe\u7f6emaster\u4fdd\u5b58binlog\u7684\u4f4d\u7f6e\uff0c\u4ee5\u4fbfMHA\u53ef\u4ee5\u627e\u5230master\u7684\u65e5\u5fd7\uff0c\u6211\u8fd9\u91cc\u7684\u4e5f\u5c31\u662fmysql\u7684\u6570\u636e\u76ee\u5f55\nmaster_binlog_dir=/usr/local/mysql/data         \n\n# \u8bbe\u7f6e\u81ea\u52a8failover\u65f6\u5019\u7684\u5207\u6362\u811a\u672c\uff0c\u4e5f\u5c31\u662f3.5.5\u6b65\u9aa4\u4e2d\u7684\u90a3\u4e2a\u811a\u672c\nmaster_ip_failover_script=/usr/local/bin/master_ip_failover \n\n# \u8bbe\u7f6e\u624b\u52a8\u5207\u6362\u65f6\u5019\u7684\u5207\u6362\u811a\u672c\nmaster_ip_online_change_script=/usr/local/bin/master_ip_online_change\n\n# \u8bbe\u7f6emysql\u4e2dmha\u7528\u6237\u7684\u5bc6\u7801\uff0c\u8fd9\u4e2a\u5bc6\u7801\u662f\u524d\u6587\u4e2d\u521b\u5efa\u76d1\u63a7\u7528\u6237mha\u7684\u5bc6\u7801\npassword=Bxb123.com         \n\n# \u8bbe\u7f6e\u76d1\u63a7\u7528\u6237root\nuser=mha   \n\n# \u8bbe\u7f6e\u76d1\u63a7\u4e3b\u5e93\uff0c\u53d1\u9001ping\u5305\u7684\u65f6\u95f4\u95f4\u9694\uff0c\u9ed8\u8ba4\u662f3\u79d2\uff0c\u5c1d\u8bd5\u4e09\u6b21\u6ca1\u6709\u56de\u5e94\u7684\u65f6\u5019\u81ea\u52a8\u8fdb\u884crailover\nping_interval=1   \n\n# \u8bbe\u7f6e\u8fdc\u7aefmysql\u5728\u53d1\u751f\u5207\u6362\u65f6binlog\u7684\u4fdd\u5b58\u4f4d\u7f6e\nremote_workdir=/tmp    \n\n# \u8bbe\u7f6e\u590d\u5236\u7528\u6237\u7684\u5bc6\u7801\nrepl_password=Bxb123.com    \n\n# \u8bbe\u7f6e\u590d\u5236\u73af\u5883\u4e2d\u7684\u590d\u5236\u7528\u6237\u540d\nrepl_user=repl          \n\n# \u8bbe\u7f6e\u53d1\u751f\u5207\u6362\u540e\u53d1\u9001\u7684\u62a5\u8b66\u7684\u811a\u672c\nreport_script=/etc/masterha/send_report\n\n# \u68c0\u6d4b\u4e24\u4e2a\u4ece\u5e93\nsecondary_check_script=/usr/local/bin/masterha_secondary_check -s 10.0.0.134 -s 10.0.0.135\n\n# \u8bbe\u7f6e\u6545\u969c\u53d1\u751f\u540e\u5173\u95ed\u6545\u969c\u4e3b\u673a\u811a\u672c\uff08\u8be5\u811a\u672c\u7684\u4e3b\u8981\u4f5c\u7528\u662f\u5173\u95ed\u4e3b\u673a\u653e\u5728\u53d1\u751f\u8111\u88c2,\u8fd9\u91cc\u6ca1\u6709\u4f7f\u7528\uff09\nshutdown_script=""      \n\n# \u8bbe\u7f6essh\u7684\u767b\u5f55\u7528\u6237\u540d\nssh_user=root           \n\n# server1\u662f\u4e3b\u5e93\n[server1]\nhostname=10.0.0.133\nport=3306\n\n# server2\u548cserver3\u662f\u4ece\u5e93\n[server2]\nhostname=10.0.0.134\nport=3306\n\n# \u8bbe\u7f6e\u4e3a\u5019\u9009master\uff0c\u5982\u679c\u8bbe\u7f6e\u8be5\u53c2\u6570\u4ee5\u540e\uff0c\u53d1\u751f\u4e3b\u4ece\u5207\u6362\u4ee5\u540e\u5c06\u4f1a\u5c06\u6b64\u4ece\u5e93\u63d0\u5347\u4e3a\u4e3b\u5e93\uff0c\u5373\u4f7f\u8fd9\u4e2a\u4e3b\u5e93\u4e0d\u662f\u96c6\u7fa4\u4e2d\u4e8b\u4ef6\u6700\u65b0\u7684slave\ncandidate_master=1   \n\n# \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5982\u679c\u4e00\u4e2aslave\u843d\u540emaster 100M\u7684relay logs\u7684\u8bdd\uff0cMHA\u5c06\u4e0d\u4f1a\u9009\u62e9\u8be5slave\u4f5c\u4e3a\u4e00\u4e2a\u65b0\u7684master\uff0c\u56e0\u4e3a\u5bf9\u4e8e\u8fd9\u4e2aslave\u7684\u6062\u590d\u9700\u8981\u82b1\u8d39\u5f88\u957f\u65f6\u95f4\uff0c\u901a\u8fc7\u8bbe\u7f6echeck_repl_delay=0,MHA\u89e6\u53d1\u5207\u6362\u5728\u9009\u62e9\u4e00\u4e2a\u65b0\u7684master\u7684\u65f6\u5019\u5c06\u4f1a\u5ffd\u7565\u590d\u5236\u5ef6\u65f6\uff0c\u8fd9\u4e2a\u53c2\u6570\u5bf9\u4e8e\u8bbe\u7f6e\u4e86candidate_master=1\u7684\u4e3b\u673a\u975e\u5e38\u6709\u7528\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u5019\u9009\u4e3b\u5728\u5207\u6362\u7684\u8fc7\u7a0b\u4e2d\u4e00\u5b9a\u662f\u65b0\u7684master\ncheck_repl_delay=0   \n\n[server3]\nhostname=10.0.0.135\nport=3306\nEOF\n'})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u7f16\u8f91\u53d1\u751f\u5207\u6362\u540e\u53d1\u9001\u62a5\u8b66\u7684\u811a\u672c\uff0c\u9700\u8981\u81ea\u884c\u914d\u7f6e\u90ae\u7bb1\u8bbe\u7f6e"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"cat > /etc/masterha/send_report <<'EOF'\n#!/usr/bin/perl\n  \nuse strict;\nuse warnings FATAL => 'all';\nuse Mail::Sender;\nuse Getopt::Long;\n  \n#new_master_host and new_slave_hosts are set only when recovering master succeeded\nmy ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );\nmy $smtp='smtp\u670d\u52a1\u5668\u5730\u5740';\nmy $mail_from='\u53d1\u4ef6\u4eba\u90ae\u7bb1';\nmy $mail_user='\u90ae\u7bb1\u767b\u9646\u7528\u6237\u540d';\nmy $mail_pass='\u90ae\u7bb1\u767b\u9646\u5bc6\u7801';\nmy $mail_to=['\u6536\u4ef6\u4eba\u5730\u5740'];\nGetOptions(\n  'orig_master_host=s' => \\$dead_master_host,\n  'new_master_host=s'  => \\$new_master_host,\n  'new_slave_hosts=s'  => \\$new_slave_hosts,\n  'subject=s'          => \\$subject,\n  'body=s'             => \\$body,\n);\n  \nmailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);\n  \nsub mailToContacts {\n    my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_;\n    open my $DEBUG, \"> /tmp/monitormail.log\"\n        or die \"Can't open the debug      file:$!\\n\";\n    my $sender = new Mail::Sender {\n        ctype       => 'text/plain; charset=utf-8',\n        encoding    => 'utf-8',\n        smtp        => $smtp,\n        from        => $mail_from,\n        auth        => 'LOGIN',\n        TLS_allowed => '0',\n        authid      => $user,\n        authpwd     => $passwd,\n        to          => $mail_to,\n        subject     => $subject,\n        debug       => $DEBUG\n    };\n  \n    $sender->MailMsg(\n        {   msg   => $msg,\n            debug => $DEBUG\n        }\n    ) or print $Mail::Sender::Error;\n    return 1;\n}\n  \n# Do whatever you want here\n  \nexit 0;\nEOF\n"})}),"\n",(0,r.jsx)(e.h4,{id:"357-\u6d4b\u8bd5mha-manager",children:"3.5.7 \u6d4b\u8bd5MHA Manager"}),"\n",(0,r.jsx)(e.h5,{id:"3571-\u6d4b\u8bd5ssh\u8fde\u63a5",children:"3.5.7.1 \u6d4b\u8bd5ssh\u8fde\u63a5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"$ masterha_check_ssh --conf=/etc/masterha/app1.cnf\nSat Jun  6 10:27:32 2020 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.\nSat Jun  6 10:27:32 2020 - [info] Reading application default configuration from /etc/mha/mha.conf..\nSat Jun  6 10:27:32 2020 - [info] Reading server configuration from /etc/mha/mha.conf..\nSat Jun  6 10:27:32 2020 - [info] Starting SSH connection tests..\nSat Jun  6 10:27:33 2020 - [debug] \nSat Jun  6 10:27:32 2020 - [debug]  Connecting via SSH from root@10.0.0.133(10.0.0.133:22) to root@10.0.0.134(10.0.0.134:22)..\nSat Jun  6 10:27:32 2020 - [debug]   ok.\nSat Jun  6 10:27:32 2020 - [debug]  Connecting via SSH from root@10.0.0.133(10.0.0.133:22) to root@10.0.0.135(10.0.0.135:22)..\nSat Jun  6 10:27:33 2020 - [debug]   ok.\nSat Jun  6 10:27:33 2020 - [debug] \nSat Jun  6 10:27:32 2020 - [debug]  Connecting via SSH from root@10.0.0.134(10.0.0.134:22) to root@10.0.0.133(10.0.0.133:22)..\nSat Jun  6 10:27:33 2020 - [debug]   ok.\nSat Jun  6 10:27:33 2020 - [debug]  Connecting via SSH from root@10.0.0.134(10.0.0.134:22) to root@10.0.0.135(10.0.0.135:22)..\nSat Jun  6 10:27:33 2020 - [debug]   ok.\nSat Jun  6 10:27:34 2020 - [debug] \nSat Jun  6 10:27:33 2020 - [debug]  Connecting via SSH from root@10.0.0.135(10.0.0.135:22) to root@10.0.0.133(10.0.0.133:22)..\nSat Jun  6 10:27:33 2020 - [debug]   ok.\nSat Jun  6 10:27:33 2020 - [debug]  Connecting via SSH from root@10.0.0.135(10.0.0.135:22) to root@10.0.0.134(10.0.0.134:22)..\nSat Jun  6 10:27:33 2020 - [debug]   ok.\nSat Jun  6 10:27:34 2020 - [info] All SSH connection tests passed successfully.\n"})}),"\n",(0,r.jsx)(e.h5,{id:"3572-\u6d4b\u8bd5mysql\u96c6\u7fa4\u8fde\u63a5\u60c5\u51b5",children:"3.5.7.2 \u6d4b\u8bd5mysql\u96c6\u7fa4\u8fde\u63a5\u60c5\u51b5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"$ masterha_check_repl --conf=/etc/masterha/app1.cnf\nSat Jun  6 12:45:42 2020 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.\nSat Jun  6 12:45:42 2020 - [info] Reading application default configuration from /etc/masterha/app1.cnf..\nSat Jun  6 12:45:42 2020 - [info] Reading server configuration from /etc/masterha/app1.cnf..\nSat Jun  6 12:45:42 2020 - [info] MHA::MasterMonitor version 0.58.\nSat Jun  6 12:45:43 2020 - [info] GTID failover mode = 0\nSat Jun  6 12:45:43 2020 - [info] Dead Servers:\nSat Jun  6 12:45:43 2020 - [info] Alive Servers:\nSat Jun  6 12:45:43 2020 - [info]   10.0.0.133(10.0.0.133:3306)\nSat Jun  6 12:45:43 2020 - [info]   10.0.0.134(10.0.0.134:3306)\nSat Jun  6 12:45:43 2020 - [info]   10.0.0.135(10.0.0.135:3306)\nSat Jun  6 12:45:43 2020 - [info] Alive Slaves:\nSat Jun  6 12:45:43 2020 - [info]   10.0.0.134(10.0.0.134:3306)  Version=5.7.28-log (oldest major version between slaves) log-bin:enabled\nSat Jun  6 12:45:43 2020 - [info]     Replicating from 10.0.0.133(10.0.0.133:3306)\nSat Jun  6 12:45:43 2020 - [info]     Primary candidate for the new Master (candidate_master is set)\nSat Jun  6 12:45:43 2020 - [info]   10.0.0.135(10.0.0.135:3306)  Version=5.7.28-log (oldest major version between slaves) log-bin:enabled\nSat Jun  6 12:45:43 2020 - [info]     Replicating from 10.0.0.133(10.0.0.133:3306)\nSat Jun  6 12:45:43 2020 - [info] Current Alive Master: 10.0.0.133(10.0.0.133:3306)\nSat Jun  6 12:45:43 2020 - [info] Checking slave configurations..\nSat Jun  6 12:45:43 2020 - [info]  read_only=1 is not set on slave 10.0.0.134(10.0.0.134:3306).\nSat Jun  6 12:45:43 2020 - [warning]  relay_log_purge=0 is not set on slave 10.0.0.134(10.0.0.134:3306).\nSat Jun  6 12:45:43 2020 - [info]  read_only=1 is not set on slave 10.0.0.135(10.0.0.135:3306).\nSat Jun  6 12:45:43 2020 - [warning]  relay_log_purge=0 is not set on slave 10.0.0.135(10.0.0.135:3306).\nSat Jun  6 12:45:43 2020 - [info] Checking replication filtering settings..\nSat Jun  6 12:45:43 2020 - [info]  binlog_do_db= , binlog_ignore_db= \nSat Jun  6 12:45:43 2020 - [info]  Replication filtering check ok.\nSat Jun  6 12:45:43 2020 - [info] GTID (with auto-pos) is not supported\nSat Jun  6 12:45:43 2020 - [info] Starting SSH connection tests..\nSat Jun  6 12:45:50 2020 - [info] All SSH connection tests passed successfully.\nSat Jun  6 12:45:50 2020 - [info] Checking MHA Node version..\nSat Jun  6 12:45:51 2020 - [info]  Version check ok.\nSat Jun  6 12:45:51 2020 - [info] Checking SSH publickey authentication settings on the current master..\nSat Jun  6 12:45:51 2020 - [info] HealthCheck: SSH to 10.0.0.133 is reachable.\nSat Jun  6 12:45:51 2020 - [info] Master MHA Node version is 0.58.\nSat Jun  6 12:45:51 2020 - [info] Checking recovery script configurations on 10.0.0.133(10.0.0.133:3306)..\nSat Jun  6 12:45:51 2020 - [info]   Executing command: save_binary_logs --command=test --start_pos=4 --binlog_dir=/usr/local/mysql/data --output_file=/tmp/save_binary_logs_test --manager_version=0.58 --start_file=binlog.000001 \nSat Jun  6 12:45:51 2020 - [info]   Connecting to root@10.0.0.133(10.0.0.133:22).. \n  Creating /tmp if not exists..    ok.\n  Checking output directory is accessible or not..\n   ok.\n  Binlog found at /usr/local/mysql/data, up to binlog.000001\nSat Jun  6 12:45:51 2020 - [info] Binlog setting check done.\nSat Jun  6 12:45:51 2020 - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..\nSat Jun  6 12:45:51 2020 - [info]   Executing command : apply_diff_relay_logs --command=test --slave_user='root' --slave_host=10.0.0.134 --slave_ip=10.0.0.134 --slave_port=3306 --workdir=/tmp --target_version=5.7.28-log --manager_version=0.58 --relay_log_info=/usr/local/mysql/data/relay-log.info  --relay_dir=/usr/local/mysql/data/  --slave_pass=xxx\nSat Jun  6 12:45:51 2020 - [info]   Connecting to root@10.0.0.134(10.0.0.134:22).. \n  Checking slave recovery environment settings..\n    Opening /usr/local/mysql/data/relay-log.info ... ok.\n    Relay log found at /usr/local/mysql/data, up to mysql02-relay-bin.000002\n    Temporary relay log file is /usr/local/mysql/data/mysql02-relay-bin.000002\n    Checking if super_read_only is defined and turned on.. not present or turned off, ignoring.\n    Testing mysql connection and privileges..\nmysql: [Warning] Using a password on the command line interface can be insecure.\n done.\n    Testing mysqlbinlog output.. done.\n    Cleaning up test file(s).. done.\nSat Jun  6 12:45:51 2020 - [info]   Executing command : apply_diff_relay_logs --command=test --slave_user='root' --slave_host=10.0.0.135 --slave_ip=10.0.0.135 --slave_port=3306 --workdir=/tmp --target_version=5.7.28-log --manager_version=0.58 --relay_log_info=/usr/local/mysql/data/relay-log.info  --relay_dir=/usr/local/mysql/data/  --slave_pass=xxx\nSat Jun  6 12:45:51 2020 - [info]   Connecting to root@10.0.0.135(10.0.0.135:22).. \n  Checking slave recovery environment settings..\n    Opening /usr/local/mysql/data/relay-log.info ... ok.\n    Relay log found at /usr/local/mysql/data, up to mysql03-relay-bin.000002\n    Temporary relay log file is /usr/local/mysql/data/mysql03-relay-bin.000002\n    Checking if super_read_only is defined and turned on.. not present or turned off, ignoring.\n    Testing mysql connection and privileges..\nmysql: [Warning] Using a password on the command line interface can be insecure.\n done.\n    Testing mysqlbinlog output.. done.\n    Cleaning up test file(s).. done.\nSat Jun  6 12:45:52 2020 - [info] Slaves settings check done.\nSat Jun  6 12:45:52 2020 - [info] \n10.0.0.133(10.0.0.133:3306) (current master)\n +--10.0.0.134(10.0.0.134:3306)\n +--10.0.0.135(10.0.0.135:3306)\n\nSat Jun  6 12:45:52 2020 - [info] Checking replication health on 10.0.0.134..\nSat Jun  6 12:45:52 2020 - [info]  ok.\nSat Jun  6 12:45:52 2020 - [info] Checking replication health on 10.0.0.135..\nSat Jun  6 12:45:52 2020 - [info]  ok.\nSat Jun  6 12:45:52 2020 - [info] Checking master_ip_failover_script status:\nSat Jun  6 12:45:52 2020 - [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=10.0.0.133 --orig_master_ip=10.0.0.133 --orig_master_port=3306 \n\n\nIN SCRIPT TEST====/usr/sbin/ifconfig eth1:1 down==/usr//sbin/ifconfig eth1:1 10.0.0.200/24===\n\nChecking the Status of the script.. OK \nSat Jun  6 12:45:52 2020 - [info]  OK.\nSat Jun  6 12:45:52 2020 - [warning] shutdown_script is not defined.\nSat Jun  6 12:45:52 2020 - [info] Got exit code 0 (Not master dead).\n\nMySQL Replication Health is OK.\n"})}),"\n",(0,r.jsx)(e.h4,{id:"358-\u542f\u52a8mha",children:"3.5.8 \u542f\u52a8mha"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u542f\u52a8mha"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover < /dev/null > /var/log/masterha/app1/manager.log 2>&1 &\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u542f\u52a8\u53c2\u6570\u8bf4\u660e"})}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"--remove_dead_master_conf"})," \t\u8be5\u53c2\u6570\u4ee3\u8868\u5f53\u53d1\u751f\u4e3b\u4ece\u5207\u6362\u540e\uff0c\u8001\u7684\u4e3b\u5e93\u7684ip\u5c06\u4f1a\u4ece\u914d\u7f6e\u6587\u4ef6\u4e2d\u79fb\u9664\u3002\n",(0,r.jsx)(e.strong,{children:"< /dev/null > /var/log/masterha/app1/manager.log 2>&1 &"}),"\t\t\u6253\u5370\u65e5\u5fd7\n",(0,r.jsx)(e.strong,{children:"--ignore_last_failover"})," \t\u5728\u7f3a\u7701\u60c5\u51b5\u4e0b\uff0c\u5982\u679cMHA\u68c0\u6d4b\u5230\u8fde\u7eed\u53d1\u751f\u5b95\u673a\uff0c\u4e14\u4e24\u6b21\u5b95\u673a\u95f4\u9694\u4e0d\u8db38\u5c0f\u65f6\u7684\u8bdd\uff0c\u5219\u4e0d\u4f1a\u8fdb\u884cFailover\uff0c\u4e4b\u6240\u4ee5\u8fd9\u6837\u9650\u5236\u662f\u4e3a\u4e86\u907f\u514dping-pong\u6548\u5e94\u3002\u8be5\u53c2\u6570\u4ee3\u8868\u5ffd\u7565\u4e0a\u6b21MHA\u89e6\u53d1\u5207\u6362\u4ea7\u751f\u7684\u6587\u4ef6\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cMHA\u53d1\u751f\u5207\u6362\u540e\u4f1a\u5728\u65e5\u5fd7\u76ee\u5f55\uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u6211\u8bbe\u7f6e\u7684/data\u4ea7\u751fapp1.failover.complete\u6587\u4ef6\uff0c\u4e0b\u6b21\u518d\u6b21\u5207\u6362\u7684\u65f6\u5019\u5982\u679c\u53d1\u73b0\u8be5\u76ee\u5f55\u4e0b\u5b58\u5728\u8be5\u6587\u4ef6\u5c06\u4e0d\u5141\u8bb8\u89e6\u53d1\u5207\u6362\uff0c\u9664\u975e\u5728\u7b2c\u4e00\u6b21\u5207\u6362\u540e\u6536\u5230\u5220\u9664\u8be5\u6587\u4ef6\uff0c\u4e3a\u4e86\u65b9\u4fbf\uff0c\u8fd9\u91cc\u8bbe\u7f6e\u4e3a--ignore_last_failover"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"MHA\u5207\u6362\u673a\u5236"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"1\u3001\u5207\u6362\u540e\u4f1a\u751f\u6210\u4e00\u4e2a\u4e34\u65f6\u6587\u4ef6\uff0c\u5728MHA\u7684\u5de5\u4f5c\u76ee\u5f55\u4e0b"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"2\u3001\u4e0b\u4e00\u6b21\u5207\u6362\u4e4b\u524d\u5148\u76d1\u6d4b\u662f\u5426\u5b58\u5728\u8fd9\u4e2a\u4e34\u65f6\u6587\u4ef6"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"3\u3001\u5982\u679c\u5b58\u5728\uff0c\u5219\u4e0d\u505a\u5207\u6362"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"4\u3001\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u5207\u6362"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"5\u3001\u8be5\u4e34\u65f6\u6587\u4ef6\u5b58\u5728\u65f6\u95f48\u5c0f\u65f6"})}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u6d4b\u8bd5mha\u72b6\u6001"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"$ masterha_check_status --conf=/etc/masterha/app1.cnf\napp1 (pid:2262) is running(0:PING_OK), master:10.0.0.133\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u505c\u6b62mha"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"$ masterha_stop --conf=/etc/masterha/app1.cnf\nStopped app1 successfully.\n[1]+  Exit 1                  nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover < /dev/null > /var/log/masterha/app1/manager.log 2>&1\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u91cd\u542fmha"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"masterha_stop --conf=/etc/masterha/app1.cnf  &&  nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover < /dev/null > /var/log/masterha/app1/manager.log 2>&1 &\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"\u5230\u6b64\uff0cMHA\u90e8\u7f72\u5b8c\u6210\uff01"})})}),"\n",(0,r.jsx)(e.h3,{id:"36-\u6d4b\u8bd5mha",children:"3.6 \u6d4b\u8bd5MHA"}),"\n",(0,r.jsx)(e.h4,{id:"361-\u624b\u52a8\u5173\u95ed\u4e3b\u5e93\u6a21\u62df\u5b95\u673a",children:"3.6.1 \u624b\u52a8\u5173\u95ed\u4e3b\u5e93\uff0c\u6a21\u62df\u5b95\u673a"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"10.0.0.133 mysql01\u64cd\u4f5c"})})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"systemctl stop mysqld\n"})}),"\n",(0,r.jsx)(e.h4,{id:"362-\u9a8c\u8bc1slave1\u53731000134",children:"3.6.2 \u9a8c\u8bc1slave1\uff0c\u537310.0.0.134"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["\u56e0\u4e3a\u5728mha\u914d\u7f6e\u6587\u4ef6",(0,r.jsx)(e.code,{children:"/etc/masterha/app1.conf"}),"\u4e2d\u5b9a\u4e49\u4e86\u53c2\u6570",(0,r.jsx)(e.code,{children:"candidate_master=1"}),"\uff0c\u5373\u8bbe\u7f6e\u4e3a\u5019\u9009master\uff0c\u5982\u679c\u8bbe\u7f6e\u8be5\u53c2\u6570\u4ee5\u540e\uff0c\u53d1\u751f\u4e3b\u4ece\u5207\u6362\u4ee5\u540e\u5c06\u4f1a\u5c06\u6b64\u4ece\u5e93\u63d0\u5347\u4e3a\u4e3b\u5e93\uff0c\u5373\u4f7f\u8fd9\u4e2a\u4e3b\u5e93\u4e0d\u662f\u96c6\u7fa4\u4e2d\u4e8b\u4ef6\u6700\u65b0\u7684slave\uff0c\u56e0\u6b64\uff0c\u5f53\u4e3b\u5e93\u6302\u6389\u65f6\uff0cslave1 10.0.0.134\u4f1a\u6210\u4e3a\u65b0\u7684\u4e3b\u5e93"]})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"10.0.0.135 mysql02\u64cd\u4f5c"})})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u53ef\u4ee5\u770b\u5230\uff0c\u5f53\u4e3b\u5e9310.0.0.133\u5b95\u673a\u540e\uff0c10.0.0.134\u6210\u4e3a\u4e86\u65b0\u7684\u4e3b\u5e93"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"$ show slave status\\G\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: 10.0.0.134\n                  Master_User: repl\n                  Master_Port: 3306\n                Connect_Retry: 60\n              Master_Log_File: binlog.000002\n          Read_Master_Log_Pos: 1331\n               Relay_Log_File: mysql03-relay-bin.000002\n                Relay_Log_Pos: 317\n        Relay_Master_Log_File: binlog.000002\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002\u3002                        \n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u9a8c\u8bc1VIP\u662f\u5426\u5df2\u7ecf\u6f02\u79fb"})}),"\n",(0,r.jsx)(e.p,{children:"\u5728\u65b0\u4e3b\u5e93\u4e0a\u80fd\u591f\u770b\u5230VIP\u5373\u4e3a\u6210\u529f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"$ ip a s eth0\n2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:1c:42:09:c2:b1 brd ff:ff:ff:ff:ff:ff\n    inet 10.0.0.134/24 brd 10.0.0.255 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet 10.0.0.200/24 brd 10.0.0.255 scope global secondary eth0:0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::21c:42ff:fe09:c2b1/64 scope link \n       valid_lft forever preferred_lft forever\n"})}),"\n",(0,r.jsx)(e.h3,{id:"37-\u4fee\u590d\u5b95\u673a\u4e3b\u5e93\u6b65\u9aa4",children:"3.7 \u4fee\u590d\u5b95\u673a\u4e3b\u5e93\u6b65\u9aa4"}),"\n",(0,r.jsx)(e.h4,{id:"\u7b2c\u4e00\u6b65\u4fee\u590d\u5b95\u673a\u4e3b\u5e93",children:"\u7b2c\u4e00\u6b65\u3001\u4fee\u590d\u5b95\u673a\u4e3b\u5e93"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u7528\u5404\u79cd\u65b9\u6cd5\u628a\u5b95\u6389\u7684\u65e7\u4e3b\u5e93\u6210\u529f\u542f\u52a8"})}),"\n",(0,r.jsxs)(e.h4,{id:"\u7b2c\u4e8c\u6b65\u4ecemha\u914d\u7f6e\u6587\u4ef6etcmasterhaapp1conf\u4e2d\u7684server-default\u6807\u7b7e\u4e0b\u5b9a\u4e49\u7684manager_logvarlogmasterhaapp1managerlog\u65e5\u5fd7\u6587\u4ef6\u4e2d\u627e\u5230change-master-to\u8bed\u53e5\u4fee\u6539\u4ece\u5e93\u590d\u5236\u7528\u6237\u7684\u5bc6\u7801\u5e76\u4e14\u6307\u5b9a\u4e3b\u5e93\u4e3a\u65b0\u4e3b\u5e93",children:["\u7b2c\u4e8c\u6b65\u3001\u4eceMHA\u914d\u7f6e\u6587\u4ef6",(0,r.jsx)(e.code,{children:"/etc/masterha/app1.conf"}),"\u4e2d\u7684",(0,r.jsx)(e.code,{children:"[server default]"}),"\u6807\u7b7e\u4e0b\u5b9a\u4e49\u7684",(0,r.jsx)(e.code,{children:"manager_log=/var/log/masterha/app1/manager.log"}),"\u65e5\u5fd7\u6587\u4ef6\u4e2d\u627e\u5230",(0,r.jsx)(e.code,{children:"change master to"}),"\u8bed\u53e5\uff0c\u4fee\u6539\u4ece\u5e93\u590d\u5236\u7528\u6237\u7684\u5bc6\u7801\uff0c\u5e76\u4e14\u6307\u5b9a\u4e3b\u5e93\u4e3a\u65b0\u4e3b\u5e93"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"MHA\u8282\u70b9\u64cd\u4f5c"})})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"$ grep -i 'change master to' /var/log/masterha/app1/manager.log \nSun Jun  7 13:17:49 2020 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='10.0.0.134', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='xxx';\n"})}),"\n",(0,r.jsxs)(e.h4,{id:"\u7b2c\u4e09\u6b65\u8fde\u63a5\u65e7\u4e3b\u5e93\u6267\u884c\u4e0a\u4e00\u6b65\u627e\u5230\u7684change-master-to\u8bed\u53e5\u5e76\u6253\u5f00iosql\u7ebf\u7a0b",children:["\u7b2c\u4e09\u6b65\u3001\u8fde\u63a5\u65e7\u4e3b\u5e93\uff0c\u6267\u884c\u4e0a\u4e00\u6b65\u627e\u5230\u7684",(0,r.jsx)(e.code,{children:"change master to"}),"\u8bed\u53e5\u5e76\u6253\u5f00IO\u3001SQL\u7ebf\u7a0b"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"10.0.0.133 mysql01(\u65e7\u4e3b\u5e93)\u64cd\u4f5c"})})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"# \u6267\u884cchange master to\nmysql> CHANGE MASTER TO \\\n       MASTER_HOST='10.0.0.134', \\\n       MASTER_PORT=3306, \\\n       MASTER_AUTO_POSITION=1, \\\n       MASTER_USER='repl', \\\n       MASTER_PASSWORD='Bxb123.com';\nQuery OK, 0 rows affected, 2 warnings (0.01 sec)\n\n# \u542f\u52a8IO\u3001SQL\u7ebf\u7a0b\nmysql> start slave;\nQuery OK, 0 rows affected (0.01 sec)\n"})}),"\n",(0,r.jsx)(e.h4,{id:"\u7b2c\u56db\u6b65\u628a\u65e7\u4e3b\u5e93\u7684server\u6807\u7b7e\u5728mha\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u56de\u6765mha\u6267\u884c\u5207\u6362\u540e\u4f1a\u628adown\u673a\u7684\u4e3b\u673aserver\u6807\u7b7e\u5220\u9664",children:"\u7b2c\u56db\u6b65\u3001\u628a\u65e7\u4e3b\u5e93\u7684server\u6807\u7b7e\u5728MHA\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u56de\u6765\uff0cMHA\u6267\u884c\u5207\u6362\u540e\uff0c\u4f1a\u628adown\u673a\u7684\u4e3b\u673aserver\u6807\u7b7e\u5220\u9664"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["\u7f16\u8f91MHA\u914d\u7f6e\u6587\u4ef6",(0,r.jsx)(e.code,{children:"/etc/masterha/app1.cnf"}),"\u6dfb\u52a0",(0,r.jsx)(e.code,{children:"server1"}),"\u6807\u7b7e"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"[server1]\nhostname=10.0.0.133\nport=3306\n"})}),"\n",(0,r.jsx)(e.h4,{id:"\u7b2c\u4e94\u6b65\u542f\u52a8mha",children:"\u7b2c\u4e94\u6b65\u3001\u542f\u52a8MHA"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover < /dev/null > /var/log/masterha/app1/manager.log 2>&1 &\n"})}),"\n",(0,r.jsx)(e.h2,{id:"4\u914d\u7f6ebinlog-server",children:"4.\u914d\u7f6ebinlog-server"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.a,{href:"https://dev.mysql.com/doc/refman/5.7/en/mysqlbinlog-backup.html#mysqlbinlog-backup-options",children:"mysql5.7\u5b98\u65b9binlog-server\u6587\u6863"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.a,{href:"https://github.com/yoshinorim/mha4mysql-manager/wiki/Configuration",children:"MHA\u5b98\u65b9\u5bf9\u4e8ebinlog-server\u7684\u7b80\u5355\u8bf4\u660e"})}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["\u4eceMHA\u7248\u672c0.56\u5f00\u59cb\uff0cMHA\u652f\u6301new\u90e8\u5206",(0,r.jsx)(e.code,{children:"[binlogN]"}),"\u3002\u5728binlog\u90e8\u5206\uff0c\u60a8\u53ef\u4ee5\u5b9a\u4e49",(0,r.jsx)(e.a,{href:"http://dev.mysql.com/doc/refman/5.6/en/mysqlbinlog-backup.html",children:"mysqlbinlog\u6d41\u670d\u52a1\u5668"}),"\u3002\u5f53MHA\u8fdb\u884c\u57fa\u4e8eGTID\u7684\u6545\u969c\u8f6c\u79fb\u65f6\uff0cMHA\u4f1a\u68c0\u67e5binlog\u670d\u52a1\u5668\uff0c\u5e76\u4e14\u5982\u679cbinlog\u670d\u52a1\u5668\u5728\u5176\u4ed6\u4ece\u670d\u52a1\u5668\u4e4b\u524d\uff0c\u5219MHA\u4f1a\u5728\u6062\u590d\u4e4b\u524d\u5c06\u5dee\u5206binlog\u4e8b\u4ef6\u5e94\u7528\u4e8e\u65b0\u7684\u4e3b\u670d\u52a1\u5668\u3002\u5f53MHA\u8fdb\u884c\u57fa\u4e8e\u975eGTID\u7684\uff08\u4f20\u7edf\uff09\u6545\u969c\u8f6c\u79fb\u65f6\uff0cMHA\u5c06\u5ffd\u7565\u4e8c\u8fdb\u5236\u65e5\u5fd7\u670d\u52a1\u5668\u3002"]})}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u4f5c\u7528:\t\u9632\u6b62master\u65ad\u7535\u6216\u5176\u4ed6\u539f\u56e0\u5bfc\u81f4binlog\u7f3a\u5931"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u524d\u63d0:\tmysql\u4e3b\u4ece\u5fc5\u987b\u4e3aGTID\u6a21\u5f0f"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u914d\u7f6e\u597dGTID\u4e3b\u4ece\u540e\u6267\u884c\u4ee5\u4e0b\u6b65\u9aa4"})}),"\n",(0,r.jsxs)(e.h3,{id:"41-mha\u914d\u7f6e\u6587\u4ef6etcmasterhaapp1cnf\u52a0\u5165binlog-server\u914d\u7f6e",children:["4.1 MHA\u914d\u7f6e\u6587\u4ef6",(0,r.jsx)(e.code,{children:"/etc/masterha/app1.cnf"}),"\u52a0\u5165binlog-server\u914d\u7f6e"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u8fd9\u91cc\u628amysql03 10.0.0.135\u5f53\u4f5cbinlog-server"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"[binlog1]\n# \u4e0d\u8ba9\u8fd9\u4e2a\u673a\u5668\u5f53\u4e3b\u5e93\nno_master=1\nhostname=10.0.0.135\nmaster_binlog_dir=/data/mysql/binlog\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u521b\u5efabinlog\u5907\u4efd\u76ee\u5f55"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"mkdir -p /data/mysql/binlog && chown mysql.mysql /data/mysql/binlog\n"})}),"\n",(0,r.jsx)(e.h3,{id:"42-\u624b\u52a8\u5907\u4efdbinlog",children:"4.2 \u624b\u52a8\u5907\u4efdbinlog"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"\u26a0\ufe0f\u5907\u4efdbinlog\uff0c--host\u540e\u7684IP\u4e00\u5b9a\u8981\u586b\u5199VIP\u5730\u5740"})})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)("span",{style:{color:"red"},children:"\u26a0\ufe0f\u4e00\u5b9a\u8981\u6ce8\u610f\u5199\u5bf9mysql binlog\u6587\u4ef6\u7684\u540d\u79f0"})})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"# \u8fdb\u5165binlog\u5907\u4efd\u76ee\u5f55\ncd /data/mysql/binlog\n\n# \u624b\u52a8\u5907\u4efd\nmysqlbinlog -R --host=10.0.0.200 --user=mha --password=Bxb123.com --raw/branch --stop-never binlog.000001 &\n"})}),"\n",(0,r.jsx)(e.h3,{id:"43-\u542f\u52a8mha",children:"4.3 \u542f\u52a8MHA"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover < /dev/null > /var/log/masterha/app1/manager.log 2>&1 &\n"})}),"\n",(0,r.jsx)(e.h3,{id:"44-\u9a8c\u8bc1",children:"4.4 \u9a8c\u8bc1"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["mysql master\u8282\u70b9\u6267\u884c\u547d\u4ee4",(0,r.jsx)(e.code,{children:"flush logs"}),"\u5237\u65b0binlog"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"master\u5237\u65b0binlog\uff0c\u591a\u6267\u884c\u51e0\u6b21\nmysql> flush logs;\nQuery OK, 0 rows affected (0.01 sec)\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["mysql03 10.0.0.135\u8282\u70b9",(0,r.jsx)(e.code,{children:"/data/mysql/binlog"}),"\u67e5\u770bbinlog\uff0c\u4f1a\u540c\u6b65master\u4e0a\u7684binlog"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"$ pwd\n/data/mysql/binlog\n$ ls\nbinlog.000001  binlog.000002  binlog.000003\n"})}),"\n",(0,r.jsx)(e.h2,{id:"5mha\u5e38\u7528\u547d\u4ee4\u603b\u7ed3",children:"5.MHA\u5e38\u7528\u547d\u4ee4\u603b\u7ed3"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"1\u3001\u68c0\u67e5mha\u7684ssh\u514d\u5bc6\u767b\u5f55\u72b6\u6001"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"masterha_check_ssh --conf=/etc/masterha/app1.cnf\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"2\u3001\u68c0\u67e5mha\u7684\u8fd0\u884c\u72b6\u6001"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"masterha_check_status --conf=/etc/masterha/app1.cnf\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"3\u3001\u68c0\u67e5\u4e3b\u5907\u5e93\u7684\u590d\u5236\u60c5\u51b5"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"masterha_check_repl --conf=/etc/masterha/app1.cnf\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"4\u3001\u505c\u6b62mha"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"masterha_stop --conf=/etc/masterha/app1.cnf\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"5\u3001\u542f\u52a8mha"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover < /dev/null > /var/log/masterha/app1/manager.log 2>&1 &\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"6\u3001mha\u624b\u52a8\u5207\u6362\u4e3b\u5e93"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"masterha_master_switch --conf=/etc/masterha/app1.cnf --master_state=alive --new_master_host=10.0.0.135 --new_master_port=3106 --orig_master_is_new_slave\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"7\u3001mha\u91cd\u65b0\u7ed1\u5b9a\u6570\u636e\u5e93\u5b9e\u4f8b"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"master_ip_failover --command=status --ssh_user=root --orig_master_host=10.0.0.133 --orig_master_ip=10.0.0.200 --orig_master_port=3306\n"})})]})}function h(n={}){const{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(d,{...n})}):d(n)}},28453:(n,e,s)=>{s.d(e,{R:()=>t,x:()=>i});var r=s(96540);const l={},a=r.createContext(l);function t(n){const e=r.useContext(a);return r.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function i(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:t(n.components),r.createElement(a.Provider,{value:e},n.children)}}}]);