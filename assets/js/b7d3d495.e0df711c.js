"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[799],{63610:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>g,frontMatter:()=>r,metadata:()=>a,toc:()=>d});var t=i(74848),l=i(28453);const r={},s="gitlab\u5907\u4efd",a={id:"linux/\u81ea\u52a8\u5316\u8fd0\u7ef4\u5e73\u53f0/gitlab/gitlab\u77e5\u8bc6\u70b9/gitlab\u5907\u4efd",title:"gitlab\u5907\u4efd",description:"[toc]",source:"@site/docs/linux/\u81ea\u52a8\u5316\u8fd0\u7ef4\u5e73\u53f0/gitlab/gitlab\u77e5\u8bc6\u70b9/4.gitlab\u5907\u4efd.md",sourceDirName:"linux/\u81ea\u52a8\u5316\u8fd0\u7ef4\u5e73\u53f0/gitlab/gitlab\u77e5\u8bc6\u70b9",slug:"/linux/\u81ea\u52a8\u5316\u8fd0\u7ef4\u5e73\u53f0/gitlab/gitlab\u77e5\u8bc6\u70b9/gitlab\u5907\u4efd",permalink:"/docs/linux/\u81ea\u52a8\u5316\u8fd0\u7ef4\u5e73\u53f0/gitlab/gitlab\u77e5\u8bc6\u70b9/gitlab\u5907\u4efd",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:4,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"gitlab\u79bb\u7ebf\u5b98\u65b9\u6587\u6863",permalink:"/docs/linux/\u81ea\u52a8\u5316\u8fd0\u7ef4\u5e73\u53f0/gitlab/gitlab\u77e5\u8bc6\u70b9/gitlab\u79bb\u7ebf\u5b98\u65b9\u6587\u6863"},next:{title:"\u5173\u95edgitlab\u53cc\u91cd\u8ba4\u8bc1",permalink:"/docs/linux/\u81ea\u52a8\u5316\u8fd0\u7ef4\u5e73\u53f0/gitlab/gitlab\u77e5\u8bc6\u70b9/\u5173\u95edgitlab\u53cc\u91cd\u8ba4\u8bc1"}},c={},d=[{value:"1.gitlab\u7684\u5907\u4efd\u76ee\u5f55\u8def\u5f84\u8bbe\u7f6e",id:"1gitlab\u7684\u5907\u4efd\u76ee\u5f55\u8def\u5f84\u8bbe\u7f6e",level:2},{value:"2.\u8bbe\u7f6egitlab\u5907\u4efd",id:"2\u8bbe\u7f6egitlab\u5907\u4efd",level:2},{value:"3.gitlab\u6062\u590d",id:"3gitlab\u6062\u590d",level:2}];function o(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",strong:"strong",...(0,l.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"[toc]"}),"\n",(0,t.jsx)(n.h1,{id:"gitlab\u5907\u4efd",children:"gitlab\u5907\u4efd"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://docs.gitlab.com/ee/raketasks/backup_restore.html",children:"gitlab\u5907\u4efd\u6062\u590d\u5b98\u65b9\u6587\u6863"})}),"\n",(0,t.jsx)(n.p,{children:"\u5b98\u65b9\u6587\u6863\u4e2d\u5199\u7684\u5f88\u8be6\u7ec6\u4e86\uff0c\u8fd9\u91cc\u793a\u4f8b\u7684\u7248\u672c\u662f 10.6 \uff0c\u53ea\u5217\u51fa\u4e86\u51e0\u4e2a\u6bd4\u8f83\u5e38\u7528\u7684\u547d\u4ee4"}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"gitlab\u5907\u4efd\u7684\u65f6\u5019gitlab\u5fc5\u987b\u5904\u4e8e\u8fd0\u884c\u72b6\u6001"})})}),"\n",(0,t.jsx)(n.h2,{id:"1gitlab\u7684\u5907\u4efd\u76ee\u5f55\u8def\u5f84\u8bbe\u7f6e",children:"1.gitlab\u7684\u5907\u4efd\u76ee\u5f55\u8def\u5f84\u8bbe\u7f6e"}),"\n",(0,t.jsxs)(n.p,{children:["rpm\u5305\u5b89\u88c5\u7684gitlab\u914d\u7f6e\u6587\u4ef6\u662f ",(0,t.jsx)(n.code,{children:"/etc/gitlab/gitlab.rb"}),"\uff0cdocker\u5b89\u88c5\u7684gitlab\u914d\u7f6e\u6587\u4ef6\u662f ",(0,t.jsx)(n.code,{children:"volume path/config/gitlab.rb"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"# \u81ea\u5b9a\u4e49\u5907\u4efd\u8def\u5f84\ngitlab_rails['manage_backup_path'] = true\n\n# gitlab\u5907\u4efd\u76ee\u5f55\ngitlab_rails['backup_path'] = \"/var/opt/gitlab/backups\"  \n\n# \u751f\u6210\u7684\u5907\u4efd\u6587\u4ef6\u6743\u9650\ngitlab_rails['backup_archive_permissions'] = 0644  \n\n# \u5907\u4efd\u4fdd\u7559\u5929\u6570\u4e3a3\u4e2a\u6708\uff08\u537390\u5929\uff0c\u8fd9\u91cc\u662f7776000\u79d2\uff0c\u5355\u4f4d\u662f\u79d2\uff09\ngitlab_rails['backup_keep_time'] = 7776000              \n"})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:["\u4fee\u6539\u4ee5\u4e0a\u914d\u7f6e\u9700\u8981\u6267\u884c\u547d\u4ee4 ",(0,t.jsx)(n.code,{children:"gitlab-ctl reconfigure"})," \u751f\u6548"]})})}),"\n",(0,t.jsx)(n.h2,{id:"2\u8bbe\u7f6egitlab\u5907\u4efd",children:"2.\u8bbe\u7f6egitlab\u5907\u4efd"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"gitLab 12.2\u6216\u66f4\u9ad8\u7248\u672c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u8fdb\u884c\u5907\u4efd"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"gitlab-backup create\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"gitLab 12.1\u548c\u66f4\u65e9\u7248\u672c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u8fdb\u884c\u5907\u4efd"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"gitlab-rake gitlab:backup:create CRON=1\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u73af\u5883\u53d8\u91cfCRON=1\u7684\u4f5c\u7528\u662f\u5982\u679c\u6ca1\u6709\u4efb\u4f55\u9519\u8bef\u53d1\u751f\u65f6\uff0c \u9690\u85cf\u5907\u4efd\u811a\u672c\u7684\u6240\u6709\u8fdb\u5ea6\u8f93\u51fa"})})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:["The ",(0,t.jsx)(n.code,{children:"CRON=1"})," environment setting directs the backup script to hide all progress output if there aren\u2019t any errors. This is recommended to reduce cron spam."]})}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u5982\u679cgitlab\u662fdocker\u5b89\u88c5\uff0c\u5219\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"docker exec -t gitlab /bin/sh -c 'gitlab-rake gitlab:backup:create'\n"})}),"\n",(0,t.jsxs)(n.p,{children:["![iShot2020-11-15 23.35.47](",(0,t.jsx)(n.a,{href:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-11-15",children:"https://gitea.pptfz.cn/pptfz/picgo-images/raw/branch/master/img/iShot2020-11-15"})," 23.35.47.png)"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:["\u4f7f\u7528\u4ee5\u4e0a\u547d\u4ee4\u4f1a\u5728 ",(0,t.jsx)(n.code,{children:"/var/opt/gitlab/backups"})," \u76ee\u5f55\u4e0b(rpm\u5305\u5b89\u88c5)\u521b\u5efa\u4e00\u4e2a\u540d\u79f0\u7c7b\u4f3c\u4e3a"]})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"1605454369_2020_11_15_10.6.1_gitlab_backup.tar"})," \u7684\u538b\u7f29\u5305"]})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u914d\u5408\u8ba1\u5212\u4efb\u52a1\u6bcf\u5929\u5b9a\u65f6\u5907\u4efd"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"00 1 * * * docker exec -t gitlab /bin/bash -c 'gitlab-rake gitlab:backup:create CRON=1'\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u8fd8\u9700\u8981\u5907\u4efd\u4e24\u4e2a\u6587\u4ef6"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"# gitlab\u5bc6\u94a5\u6587\u4ef6\n/etc/gitlab/gitlab-secrets.json\n\n# gitlab\u914d\u7f6e\u6587\u4ef6\n/etc/gitlab/gitlab.rb\n"})}),"\n",(0,t.jsx)(n.h2,{id:"3gitlab\u6062\u590d",children:"3.gitlab\u6062\u590d"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u5148\u505c\u6b62\u76f8\u5173\u6570\u636e\u8fde\u63a5\u670d\u52a1"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"gitlab-ctl stop unicorn\ngitlab-ctl stop sidekiq\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u786e\u8ba4\u6570\u636e\u8fde\u63a5\u670d\u52a1\u5df2\u7ecf\u505c\u6b62"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"gitlab-ctl status\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u6062\u590dgitlab\u6570\u636e\uff0c\u4e2d\u95f4\u9700\u8981\u8f93\u5165\u4e24\u6b21 yes\uff0cBACKUP\u540e\u9762\u5c31\u662f\u8981\u6062\u590d\u7684\u5907\u4efd\u538b\u7f29\u6587\u4ef6\u65f6\u95f4\u540d\u79f0\u90e8\u5206"})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"gitlab\u7684\u6062\u590d\u64cd\u4f5c\u4f1a\u5148\u5c06\u5f53\u524d\u6240\u6709\u7684\u6570\u636e\u6e05\u7a7a\uff0c\u7136\u540e\u518d\u6839\u636e\u5907\u4efd\u6570\u636e\u8fdb\u884c\u6062\u590d"})})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"gitlab-rake gitlab:backup:restore BACKUP=1605454369_2020_11_15_10.6.1\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u6062\u590d\u5b8c\u6210\u540e\u542f\u52a8gitlab"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"gitlab-ctl start\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u6062\u590d\u547d\u4ee4\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5check\u68c0\u67e5\u4e00\u4e0b\u6062\u590d\u60c5\u51b5"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"gitlab-rake gitlab:check SANITIZE=true\n"})})]})}function g(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>s,x:()=>a});var t=i(96540);const l={},r=t.createContext(l);function s(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:s(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);